<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al-Quran Pro | Ultimate Study Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary: #0d9488; --primary-hover: #0f766e; --bg: #f8fafc;
            --surface: #ffffff; --text: #0f172a; --muted: #64748b;
            --border: #e2e8f0; --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --arabic-font: 'Amiri', serif;
        }

        [data-theme="dark"] {
            --bg: #020617; --surface: #0f172a; --text: #f1f5f9; --muted: #94a3b8; --border: #1e293b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; }
        .hidden { display: none !important; }
        
        /* Sidebar Navigation */
        .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 80px; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 2rem 0; z-index: 1000; transition: width 0.3s; }
        .sidebar:hover { width: 220px; }
        .nav-item { width: 100%; padding: 1rem 1.5rem; display: flex; align-items: center; gap: 15px; color: var(--muted); cursor: pointer; text-decoration: none; overflow: hidden; white-space: nowrap; }
        .nav-item:hover, .nav-item.active { color: var(--primary); background: rgba(13, 148, 136, 0.1); }
        .nav-item span { opacity: 0; transition: opacity 0.2s; font-weight: 600; }
        .sidebar:hover .nav-item span { opacity: 1; }

        /* Content Area */
        main { margin-left: 80px; padding: 2rem; min-height: 100vh; }
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; gap: 20px; }
        .search-box { position: relative; flex: 1; max-width: 600px; }
        .search-box input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.8rem; border-radius: 12px; border: 1px solid var(--border); background: var(--surface); color: var(--text); font-size: 1rem; }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--muted); }

        /* Grid & Cards */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .card { background: var(--surface); padding: 1.5rem; border-radius: 16px; border: 1px solid var(--border); transition: 0.3s; cursor: pointer; position: relative; }
        .card:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: var(--shadow); }
        .card h3 { font-size: 1.1rem; margin-bottom: 5px; }
        .card p { font-size: 0.85rem; color: var(--muted); }
        .card .arabic-name { position: absolute; right: 1.5rem; top: 1.5rem; font-family: var(--arabic-font); font-size: 1.8rem; color: var(--primary); }

        /* Reader Mode */
        .ayah-container { max-width: 850px; margin: 0 auto; padding-bottom: 120px; }
        .ayah-card { background: var(--surface); padding: 2.5rem; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 1.5rem; transition: 0.3s; }
        .ayah-card.active { border-color: var(--primary); background: rgba(13, 148, 136, 0.05); }
        .arabic-text { font-family: var(--arabic-font); font-size: 2.8rem; text-align: right; line-height: 2.2; margin-bottom: 1.5rem; direction: rtl; }
        .translation-text { font-size: 1.15rem; color: var(--text); opacity: 0.85; line-height: 1.8; }
        .ayah-actions { display: flex; gap: 12px; margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1rem; }

        /* Sticky Audio Player */
        .player-bar { position: fixed; bottom: 20px; left: 100px; right: 20px; background: var(--surface); border: 1px solid var(--border); border-radius: 100px; padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow); z-index: 1001; }
        .audio-btns { display: flex; align-items: center; gap: 20px; }
        .repeat-badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; }

        /* Journal View */
        .note-input { width: 100%; height: 100px; padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin-top: 10px; font-family: inherit; }

        @media (max-width: 768px) {
            .sidebar { width: 100%; height: 60px; bottom: 0; top: auto; flex-direction: row; justify-content: space-around; padding: 0; }
            .sidebar:hover { width: 100%; }
            .sidebar .nav-item span { display: none; }
            main { margin-left: 0; padding: 1rem; padding-bottom: 80px; }
            .player-bar { left: 10px; right: 10px; bottom: 70px; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="nav-item active" onclick="showSection('surah')" id="btn-surah"><i data-lucide="book"></i> <span>Surahs</span></div>
        <div class="nav-item" onclick="showSection('juz')" id="btn-juz"><i data-lucide="layers"></i> <span>Juz / Para</span></div>
        <div class="nav-item" onclick="showSection('journal')" id="btn-journal"><i data-lucide="pen-tool"></i> <span>My Journal</span></div>
        <div class="nav-item" onclick="showSection('search-results')" id="btn-search"><i data-lucide="search"></i> <span>Global Search</span></div>
        <div style="flex: 1;"></div>
        <div class="nav-item" onclick="toggleTheme()"><i data-lucide="moon"></i> <span>Theme</span></div>
    </aside>

    <main>
        <div class="header-actions">
            <div class="search-box">
                <i data-lucide="search"></i>
                <input type="text" id="globalSearch" placeholder="Search the whole Quran (e.g. 'Patience', 'Sky')..." onkeypress="if(event.key==='Enter') runGlobalSearch()">
            </div>
            <div id="statusBadge" style="font-size: 0.8rem; color: var(--primary); font-weight: 600;">Online</div>
        </div>

        <section id="surah-section">
            <h2 style="margin-bottom: 1.5rem;">The 114 Surahs</h2>
            <div class="grid" id="surahGrid"></div>
        </section>

        <section id="juz-section" class="hidden">
            <h2 style="margin-bottom: 1.5rem;">Browse by Juz (30 Parts)</h2>
            <div class="grid" id="juzGrid"></div>
        </section>

        <section id="journal-section" class="hidden">
            <h2 style="margin-bottom: 1.5rem;">My Reflections</h2>
            <div id="journalList" class="grid"></div>
        </section>

        <section id="search-results-section" class="hidden">
            <h2 id="searchTitle">Search Results</h2>
            <div id="searchResultsList" style="margin-top: 1.5rem;"></div>
        </section>

        <section id="reader-section" class="hidden">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:2rem;">
                <button onclick="backToPrev()" class="card" style="padding: 10px 20px;"><i data-lucide="arrow-left"></i></button>
                <h1 id="readerTitle" style="font-family: var(--arabic-font); font-size: 2.5rem;">Surah</h1>
            </div>
            <div class="ayah-container" id="ayahList"></div>
        </section>
    </main>

    <div class="player-bar hidden" id="playerBar">
        <div id="playerMeta">
            <div id="pSurahName" style="font-weight: 700;">Surah</div>
            <div id="pAyahNum" style="font-size: 0.8rem; color: var(--muted);">Ayah 1</div>
        </div>
        <div class="audio-btns">
            <div style="display:flex; flex-direction:column; align-items:center;">
                <button onclick="toggleRepeat()" class="repeat-badge" id="repeatBtn">Repeat: Off</button>
            </div>
            <button onclick="toggleAudio()" id="playBtn" style="background:var(--primary); color:white; width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                <i data-lucide="play"></i>
            </button>
            <select id="speedSelect" onchange="changeSpeed()" style="border:none; background:var(--bg); border-radius:5px; padding:2px 5px;">
                <option value="1">1.0x</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
                <option value="0.75">0.75x</option>
            </select>
        </div>
        <audio id="mainAudio"></audio>
    </div>

    <script>
        const API = "https://api.alquran.cloud/v1";
        let surahs = [], currentAyahs = [], currentSection = 'surah', prevSection = 'surah';
        let notes = JSON.parse(localStorage.getItem('qNotes') || '{}');
        let repeatCount = 0; // 0 = no repeat, 1+ = repeat X times
        let currentRepeatLeft = 0;
        let playingIdx = -1;

        window.onload = () => {
            fetchSurahs();
            renderJuzGrid();
            lucide.createIcons();
            if(localStorage.getItem('qTheme') === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
        };

        async function fetchSurahs() {
            const res = await fetch(`${API}/surah`);
            const data = await res.json();
            surahs = data.data;
            renderSurahGrid(surahs);
        }

        function renderSurahGrid(data) {
            document.getElementById('surahGrid').innerHTML = data.map(s => `
                <div class="card" onclick="openSurah(${s.number})">
                    <h3>${s.number}. ${s.englishName}</h3>
                    <p>${s.englishNameTranslation} â€¢ ${s.numberOfAyahs} Ayahs</p>
                    <div class="arabic-name">${s.name}</div>
                </div>
            `).join('');
        }

        function renderJuzGrid() {
            let html = '';
            for(let i=1; i<=30; i++) {
                html += `<div class="card" onclick="openJuz(${i})"><h3>Juz ${i}</h3><p>Para ${i}</p></div>`;
            }
            document.getElementById('juzGrid').innerHTML = html;
        }

        function showSection(name) {
            prevSection = currentSection;
            currentSection = name;
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${name}-section`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`btn-${name}`).classList.add('active');
            if(name === 'journal') renderJournal();
        }

        async function openSurah(num) {
            showSection('reader');
            document.getElementById('ayahList').innerHTML = "Loading Revelations...";
            const [ar, en, au] = await Promise.all([
                fetch(`${API}/surah/${num}/ar.tajweed`).then(r => r.json()),
                fetch(`${API}/surah/${num}/en.asad`).then(r => r.json()),
                fetch(`${API}/surah/${num}/ar.alafasy`).then(r => r.json())
            ]);
            document.getElementById('readerTitle').innerText = ar.data.name;
            currentAyahs = ar.data.ayahs.map((a, i) => ({
                ar: a.text, en: en.data.ayahs[i].text, aud: au.data.ayahs[i].audio, num: a.numberInSurah, globalId: a.number
            }));
            renderAyahs();
        }

        async function openJuz(num) {
            showSection('reader');
            document.getElementById('ayahList').innerHTML = "Loading Juz...";
            const res = await fetch(`${API}/juz/${num}/quran-uthmani`);
            const data = await res.json();
            // In a real app, we'd fetch translations/audio for Juz too. Simplified here.
            document.getElementById('readerTitle').innerText = `Juz ${num}`;
            currentAyahs = data.data.ayahs.map(a => ({ ar: a.text, en: "Translation loading...", num: a.numberInSurah, globalId: a.number }));
            renderAyahs();
        }

        function renderAyahs() {
            document.getElementById('ayahList').innerHTML = currentAyahs.map((a, i) => `
                <div class="ayah-card" id="ayah-${i}">
                    <div class="arabic-text">${a.ar} <span style="font-size:1.2rem; border:1px solid var(--primary); padding:2px 8px; border-radius:50%;">${a.num}</span></div>
                    <div class="translation-text">${a.en}</div>
                    <div class="ayah-actions">
                        <button onclick="playAyah(${i})" style="color:var(--primary);"><i data-lucide="play-circle"></i> Listen</button>
                        <button onclick="toggleNote(${i})"><i data-lucide="edit-3"></i> Note</button>
                    </div>
                    <div id="note-box-${i}" class="hidden">
                        <textarea class="note-input" id="input-${i}" placeholder="Write your reflection...">${notes[a.globalId] || ''}</textarea>
                        <button onclick="saveNote(${i}, ${a.globalId})" style="background:var(--primary); color:white; padding:5px 15px; border-radius:5px; margin-top:5px;">Save Note</button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function runGlobalSearch() {
            const query = document.getElementById('globalSearch').value;
            if(!query) return;
            showSection('search-results');
            document.getElementById('searchResultsList').innerHTML = "Searching the whole Quran...";
            const res = await fetch(`${API}/search/${query}/all/en.asad`);
            const data = await res.json();
            
            if(data.data.results.length === 0) {
                document.getElementById('searchResultsList').innerHTML = "No verses found.";
                return;
            }

            document.getElementById('searchResultsList').innerHTML = data.data.results.map(r => `
                <div class="card" style="margin-bottom:1rem; cursor:default;">
                    <div style="color:var(--primary); font-weight:bold; margin-bottom:10px;">Surah ${r.surah.englishName} | Ayah ${r.numberInSurah}</div>
                    <p style="color:var(--text); font-size:1rem;">"${r.text}"</p>
                </div>
            `).join('');
        }

        // --- Audio Logic ---
        const audio = document.getElementById('mainAudio');
        function playAyah(idx) {
            playingIdx = idx;
            const a = currentAyahs[idx];
            audio.src = a.aud;
            audio.play();
            document.getElementById('playerBar').classList.remove('hidden');
            document.getElementById('pSurahName').innerText = document.getElementById('readerTitle').innerText;
            document.getElementById('pAyahNum').innerText = `Ayah ${a.num}`;
            document.querySelectorAll('.ayah-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`ayah-${idx}`).classList.add('active');
            updatePlayIcon(true);
        }

        audio.onended = () => {
            if (currentRepeatLeft > 0) {
                currentRepeatLeft--;
                audio.play();
            } else {
                if (playingIdx < currentAyahs.length - 1) {
                    currentRepeatLeft = repeatCount;
                    playAyah(playingIdx + 1);
                }
            }
        };

        function toggleRepeat() {
            const options = [0, 1, 3, 5];
            let curIdx = options.indexOf(repeatCount);
            repeatCount = options[(curIdx + 1) % options.length];
            currentRepeatLeft = repeatCount;
            document.getElementById('repeatBtn').innerText = repeatCount === 0 ? "Repeat: Off" : `Repeat: ${repeatCount}x`;
        }

        function toggleAudio() {
            if(audio.paused) { audio.play(); updatePlayIcon(true); }
            else { audio.pause(); updatePlayIcon(false); }
        }

        function updatePlayIcon(isPlay) {
            document.getElementById('playBtn').innerHTML = `<i data-lucide="${isPlay ? 'pause' : 'play'}"></i>`;
            lucide.createIcons();
        }

        function changeSpeed() { audio.playbackRate = document.getElementById('speedSelect').value; }

        // --- Journal / Notes Logic ---
        function toggleNote(idx) { document.getElementById(`note-box-${idx}`).classList.toggle('hidden'); }
        
        function saveNote(idx, globalId) {
            const val = document.getElementById(`input-${idx}`).value;
            notes[globalId] = val;
            localStorage.setItem('qNotes', JSON.stringify(notes));
            alert("Reflection saved to your journal!");
            toggleNote(idx);
        }

        function renderJournal() {
            const list = document.getElementById('journalList');
            const entries = Object.entries(notes);
            if(entries.length === 0) { list.innerHTML = "<p>Your journal is empty. Start reflecting on Ayahs!</p>"; return; }
            
            list.innerHTML = entries.map(([id, text]) => `
                <div class="card">
                    <div style="color:var(--primary); font-weight:bold;">Ayah #${id}</div>
                    <p style="margin-top:10px; font-style:italic;">"${text}"</p>
                </div>
            `).join('');
        }

        function toggleTheme() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('qTheme', isDark ? 'light' : 'dark');
        }

        function backToPrev() { showSection(prevSection); }
    </script>
</body>
</html>
