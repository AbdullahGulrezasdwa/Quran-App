<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Omni ‚Äî Light & Animated</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;700&family=Amiri+Quran&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Dark Mode (Default) */
            --bg:#02070d; --bg2:#0a121e; --p:#38bdf8; --pd:rgba(56,189,248,0.12);
            --pb:rgba(56,189,248,0.2); --t:#e2eff8; --td:rgba(226,239,248,0.4);
            --taj-m:#fb7185; --taj-g:#34d399; --taj-q:#38bdf8;
            --font-ar:'Amiri Quran', serif; --tr: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        body.light-mode {
            --bg:#f8fafc; --bg2:#ffffff; --p:#0284c7; --pd:rgba(2,132,199,0.08);
            --pb:rgba(2,132,199,0.15); --t:#0f172a; --td:rgba(15,23,42,0.6);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--t); display: flex; height: 100dvh; overflow: hidden; transition: background 0.5s ease; }

        /* ANIMATIONS */
        @keyframes fadeInUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
        .entry-anim { animation: fadeInUp 0.6s var(--tr) forwards; }

        /* NAV RAIL */
        .nav { width: 85px; border-right: 1px solid var(--pb); display: flex; flex-direction: column; align-items: center; padding: 25px 0; gap: 20px; background: var(--bg2); z-index: 2000; box-shadow: 10px 0 30px rgba(0,0,0,0.05); }
        .btn { background: transparent; border: 1px solid transparent; color: var(--t); cursor: pointer; padding: 12px; border-radius: 18px; transition: var(--tr); opacity: 0.6; }
        .btn:hover, .btn.on { opacity: 1; background: var(--pd); border-color: var(--p); color: var(--p); transform: scale(1.1); }

        /* MAIN STAGE */
        main { flex: 1; overflow-y: auto; padding: 40px; scroll-behavior: smooth; position: relative; }
        .container { max-width: 1000px; margin: 0 auto; position: relative; z-index: 10; }
        
        /* SURAH GRID */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: var(--bg2); border: 1px solid var(--pb); padding: 30px; border-radius: 24px; cursor: pointer; transition: var(--tr); display: flex; align-items: center; gap: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        .card:hover { border-color: var(--p); transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 40px var(--pd); }

        /* READING MODE */
        .ayah-row { padding: 50px 0; border-bottom: 1px solid var(--pb); transition: var(--tr); position: relative; opacity: 0; animation: fadeInUp 0.8s forwards; }
        .arabic { font-family: var(--font-ar); font-size: 3.6rem; direction: rtl; line-height: 2.8; margin-bottom: 25px; transition: 0.3s; }
        
        /* TAJWEED OFF/ON */
        body.tajweed-off .tm, body.tajweed-off .tg, body.tajweed-off .tq { color: inherit !important; font-weight: normal !important; }
        .tm { color: var(--taj-m); font-weight: bold; } .tg { color: var(--taj-g); font-weight: bold; } .tq { color: var(--taj-q); font-weight: bold; }

        /* PLAYER DOCK */
        .player { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 850px; background: var(--bg2); backdrop-filter: blur(40px); border: 1px solid var(--pb); border-radius: 100px; padding: 15px 35px; display: flex; align-items: center; gap: 25px; z-index: 4000; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
        .p-fill { height: 100%; background: var(--p); width: 0%; transition: width 0.1s linear; }

        /* DRAWERS */
        .drawer { position: fixed; right: 0; top: 0; width: 450px; height: 100%; background: var(--bg2); border-left: 1px solid var(--pb); transform: translateX(100%); transition: var(--tr); z-index: 3000; padding: 40px; overflow-y: auto; }
        .drawer.open { transform: translateX(0); box-shadow: -20px 0 60px rgba(0,0,0,0.1); }
        
        .search-box { background: var(--bg2); border: 1px solid var(--pb); border-radius: 20px; padding: 15px 25px; display: flex; align-items: center; gap: 15px; margin-bottom: 40px; }
        .search-input { background: none; border: none; color: var(--t); width: 100%; font-size: 1.1rem; outline: none; }
    </style>
</head>
<body class="">

<nav class="nav">
    <div style="font-family:var(--font-ar); font-size:2.5rem; color:var(--p); cursor:pointer" onclick="App.renderDashboard()">ŸÇ</div>
    <button class="btn on" onclick="App.renderDashboard()"><i data-lucide="home"></i></button>
    <button class="btn" onclick="App.toggleTheme()" id="theme-btn"><i data-lucide="moon"></i></button>
    <button class="btn" onclick="App.toggleTajweed()" id="taj-btn"><i data-lucide="sparkles"></i></button>
    <button class="btn" onclick="App.toggleDrawer('study')"><i data-lucide="book-open"></i></button>
    <div style="flex:1"></div>
    <button class="btn" onclick="App.toggleHifz()"><i data-lucide="eye-off"></i></button>
</nav>

<main id="scroller">
    <div class="container" id="view"></div>
</main>

<div id="study" class="drawer">
    <h2>Ayah Insights</h2>
    <div id="study-content" style="margin-top:20px; line-height:1.8; color:var(--td)">Select a verse to explore the Tafsir and record your reflections.</div>
    <textarea id="note-area" style="width:100%; height:150px; background:var(--pd); border:1px solid var(--pb); border-radius:15px; margin-top:30px; padding:15px; color:var(--t); outline:none" placeholder="Write your reflection here..."></textarea>
    <button class="btn on" style="width:100%; margin-top:10px" onclick="App.saveNote()">Save Reflection</button>
</div>

<div class="player">
    <button class="btn on" onclick="App.togglePlay()"><i data-lucide="play" id="play-icon"></i></button>
    <div style="flex:1">
        <div style="display:flex; justify-content:space-between; font-size:0.75rem; font-weight:bold; margin-bottom:8px">
            <span id="p-title">SELECT SURAH</span>
            <span id="p-time">00:00</span>
        </div>
        <div style="width:100%; height:4px; background:var(--pb); border-radius:2px; overflow:hidden">
            <div class="p-fill" id="progress-bar"></div>
        </div>
    </div>
    <select onchange="App.setReciter(this.value)" style="background:none; border:none; color:var(--p); font-weight:bold; cursor:pointer">
        <option value="ar.alafasy">Alafasy</option>
        <option value="ar.husary">Husary</option>
    </select>
</div>

<audio id="audio-core"></audio>

<script>
const App = (() => {
    let state = { surahs: [], reciter: 'ar.alafasy', notes: JSON.parse(localStorage.getItem('notes_v2') || '{}') };
    const audio = document.getElementById('audio-core');

    const init = async () => {
        const res = await fetch('https://api.alquran.cloud/v1/surah');
        const d = await res.json();
        state.surahs = d.data;
        renderDashboard();
        lucide.createIcons();
        audio.ontimeupdate = () => {
            document.getElementById('progress-bar').style.width = (audio.currentTime/audio.duration*100)+'%';
            document.getElementById('p-time').innerText = Math.floor(audio.currentTime/60)+":"+Math.floor(audio.currentTime%60).toString().padStart(2,'0');
        };
    };

    const tajweedify = (text) => {
        return text.replace(/([ÿ¢ÿ£ÿ•ÿ§ÿ¶])|([ÿßŸâ]?[ŸãŸåŸç])|([Ÿà]?[ÿßÿ£Ÿâ])|([Ÿä]?[ÿßÿ£Ÿà])/g, '<span class="tm">$1$2$3$4</span>')
                   .replace(/([ŸÜŸëŸÖŸë])/g, '<span class="tg">$1</span>')
                   .replace(/([ÿØÿ¨ÿ®ÿ∑ŸÇ])(?=[Ÿí\s]|$)/g, '<span class="tq">$1</span>');
    };

    const renderDashboard = (filter = "") => {
        const list = state.surahs.filter(s => s.englishName.toLowerCase().includes(filter.toLowerCase()) || s.number == filter);
        document.getElementById('view').innerHTML = `
            <div class="entry-anim">
                <h1 style="font-size:3.5rem; margin-bottom:10px">The Noble Quran</h1>
                <div class="search-box">
                    <i data-lucide="search"></i>
                    <input class="search-input" placeholder="Search 114 Surahs..." oninput="App.renderDashboard(this.value)">
                </div>
                <div class="grid">
                    ${list.map((s, i) => `
                        <div class="card" style="animation: fadeInUp 0.5s ${i*0.02}s forwards; opacity:0" onclick="App.openSurah(${s.number})">
                            <div style="font-size:0.8rem; opacity:0.3">#${s.number}</div>
                            <div style="flex:1"><strong>${s.englishName}</strong><br><small style="opacity:0.5">${s.englishNameTranslation}</small></div>
                            <div style="font-family:var(--font-ar); color:var(--p); font-size:1.6rem">${s.name}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        lucide.createIcons();
    };

    const openSurah = async (id) => {
        const [ar, en] = await Promise.all([
            fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-uthmani`).then(r => r.json()),
            fetch(`https://api.alquran.cloud/v1/surah/${id}/en.sahih`).then(r => r.json())
        ]);
        let html = `<div class="entry-anim" style="text-align:center; padding:80px 0"><h1 style="font-family:var(--font-ar); font-size:6rem; color:var(--p)">${ar.data.name}</h1></div>`;
        ar.data.ayahs.forEach((v, i) => {
            html += `
                <div class="ayah-row" style="animation-delay:${i*0.05}s" onclick="App.study(${id}, ${i+1}, ${v.number})">
                    <div class="arabic">${tajweedify(v.text)}</div>
                    <div style="opacity:0.6; font-size:1.2rem; line-height:1.7">${en.data.ayahs[i].text}</div>
                    ${state.notes[`${id}:${i+1}`] ? `<div style="margin-top:15px; color:var(--p); font-size:0.9rem">üìù ${state.notes[`${id}:${i+1}`]}</div>` : ''}
                </div>`;
        });
        document.getElementById('view').innerHTML = html;
        document.getElementById('scroller').scrollTop = 0;
    };

    return {
        init, renderDashboard, openSurah,
        toggleTheme: () => {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            document.getElementById('theme-btn').innerHTML = `<i data-lucide="${isLight ? 'sun' : 'moon'}"></i>`;
            lucide.createIcons();
        },
        toggleTajweed: () => {
            document.body.classList.toggle('tajweed-off');
            document.getElementById('taj-btn').classList.toggle('on');
        },
        toggleHifz: () => {
            const ayahTexts = document.querySelectorAll('.arabic');
            ayahTexts.forEach(t => t.style.filter = t.style.filter ? '' : 'blur(15px)');
        },
        toggleDrawer: (id) => document.getElementById(id).classList.toggle('open'),
        study: async (s, a, gid) => {
            state.activeKey = `${s}:${a}`;
            document.getElementById('study').classList.add('open');
            document.getElementById('study-content').innerText = "Loading Tafsir...";
            document.getElementById('note-area').value = state.notes[state.activeKey] || "";
            
            const res = await fetch(`https://api.alquran.cloud/v1/ayah/${s}:${a}/en.asad`);
            const d = await res.json();
            document.getElementById('study-content').innerHTML = `<strong>Tafsir (Muhammad Asad):</strong><br><br>${d.data.text}`;
            
            audio.src = `https://cdn.islamic.network/quran/audio/128/${state.reciter}/${gid}.mp3`;
            audio.play();
            document.getElementById('p-title').innerText = `Surah ${s} : Ayah ${a}`;
            document.getElementById('play-icon').setAttribute('data-lucide', 'pause');
            lucide.createIcons();
        },
        saveNote: () => {
            state.notes[state.activeKey] = document.getElementById('note-area').value;
            localStorage.setItem('notes_v2', JSON.stringify(state.notes));
            alert("Reflection Saved to this verse!");
        },
        togglePlay: () => { if(audio.paused) audio.play(); else audio.pause(); lucide.createIcons(); },
        setReciter: (r) => state.reciter = r
    };
})();
document.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>
