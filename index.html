<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Sanctuary | v6.3 Apex</title>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Plus+Jakarta+Sans:wght@300;600;800&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --p: #00f2ff; --bg: #020204; --card-bg: rgba(255,255,255,0.02);
            --border: rgba(255,255,255,0.06); --text: #f1f5f9; --text-dim: #64748b;
            --f-ar: 'Amiri', serif;
        }

        body.light-mode {
            --bg: #ffffff; --card-bg: rgba(0,0,0,0.02); --border: rgba(0,0,0,0.08); --text: #0f172a; --text-dim: #94a3b8;
        }

        body { 
            background: var(--bg); color: var(--text); margin: 0; 
            font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden;
            height: 100vh; display: flex; transition: background 0.8s ease;
        }

        .ar { 
            font-size: 2.8rem; color: var(--text); font-family: var(--f-ar); 
            direction: rtl; line-height: 2.5; transition: color 0.4s ease;
        }
        .ayah-card:hover .ar { color: var(--p); }

        nav, header, .settings-card { user-select: none; }

        #view-port::-webkit-scrollbar { width: 4px; }
        #view-port::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        #view-port::-webkit-scrollbar-thumb:hover { background: var(--p); }

        .ayah-card {
            padding: 40px; border-bottom: 1px solid var(--border);
            border-left: 2px solid transparent; transition: all 0.5s ease;
            animation: fadeIn 0.8s ease forwards; opacity: 0;
        }
        .ayah-card:hover {
            border-left: 2px solid var(--p);
            background: linear-gradient(90deg, var(--card-bg) 0%, transparent 100%);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        #view-port { flex: 1; overflow-y: auto; padding: 0; scroll-behavior: smooth; }
        
        nav { width: 80px; height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 30px 0; gap: 25px; border-right: 1px solid var(--border); background: var(--bg); z-index: 10; }
        .nav-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; padding: 12px; transition: 0.3s; }
        .nav-btn:hover, .nav-btn.active { color: var(--p); }

        header { height: 80px; display: flex; align-items: center; padding: 0 50px; justify-content: space-between; border-bottom: 1px solid var(--border); background: var(--bg); }
        #breadcrumb { font-family: 'Fira Code'; color: var(--p); font-size: 0.7rem; letter-spacing: 2px; text-transform: uppercase; }

        #settings-layer { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(20px); }
        .settings-card { width: 380px; padding: 40px; border: 1px solid var(--border); background: var(--bg); border-radius: 4px; }
    </style>
</head>
<body>

    <div id="settings-layer" onclick="if(event.target===this) App.ui.toggleSettings()">
        <div class="settings-card">
            <h4 style="font-family:'Fira Code'; color:var(--p); margin-top:0;">ENVIRONMENT_ADJUST</h4>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="App.themes.set(false)" style="flex:1; padding:15px; background:#111; color:#fff; border:1px solid #333; cursor:pointer; font-family:'Fira Code';">OBSIDIAN</button>
                <button onclick="App.themes.set(true)" style="flex:1; padding:15px; background:#eee; color:#111; border:1px solid #ccc; cursor:pointer; font-family:'Fira Code';">IVORY</button>
            </div>
            <button onclick="App.ui.toggleSettings()" style="width:100%; margin-top:30px; background:none; border:1px solid var(--p); color:var(--p); padding:10px; cursor:pointer; font-family:'Fira Code';">EXIT_TERMINAL</button>
        </div>
    </div>

    <nav>
        <button onclick="App.renderHome()" class="nav-btn active" aria-label="Library Home"><i data-lucide="book-open"></i></button>
        <button onclick="App.ui.toggleSettings()" class="nav-btn" aria-label="Settings"><i data-lucide="sliders"></i></button>
        <div style="flex:1"></div>
        <div id="progress-indicator" style="font-family:'Fira Code'; font-size:0.6rem; color:var(--p); transform: rotate(-90deg);">00%</div>
    </nav>

    <section style="flex:1; display:flex; flex-direction:column;">
        <header>
            <div id="breadcrumb">SYSTEM // IDLE</div>
            <input type="text" placeholder="QUERY SURAH..." style="background:none; border:none; color:var(--text); font-family:'Fira Code'; outline:none; font-size:0.8rem; width:200px;" oninput="App.ui.search(this.value)">
        </header>
        <div id="view-port" onscroll="App.ui.updateScroll()"></div>
    </section>

    <script>
        const App = {
            state: { chapters: [], isLight: false },
            activeRequest: 0, // Fix 1: Track concurrent requests

            init() {
                // Keyboard Listener for ESC
                window.onkeydown = (e) => { if(e.key === "Escape") this.ui.toggleSettings(); }

                const cv = document.createElement('canvas'); const ctx = cv.getContext('2d'); document.body.appendChild(cv);
                cv.style = "position:fixed; inset:0; z-index:-1;";
                let pts = []; window.onresize = () => { cv.width = innerWidth; cv.height = innerHeight; }; window.onresize();
                
                class P { 
                    constructor() { this.reset(); } 
                    reset() { this.x = Math.random()*cv.width; this.y = Math.random()*cv.height; this.v = 0.08 + Math.random()*0.12; }
                    draw() { 
                        this.y -= this.v; if(this.y < 0) this.reset(); 
                        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--p').trim();
                        ctx.globalAlpha = App.state.isLight ? 0.05 : 0.1; 
                        ctx.fillRect(this.x, this.y, 1, 1); 
                    } 
                }
                for(let i=0; i<40; i++) pts.push(new P());
                const loop = () => { ctx.clearRect(0,0,cv.width,cv.height); pts.forEach(p => p.draw()); requestAnimationFrame(loop); }; loop();

                this.renderHome();
            },

            async renderHome() {
                const res = await fetch('https://api.alquran.cloud/v1/surah');
                const json = await res.json();
                this.state.chapters = json.data;
                document.getElementById('breadcrumb').innerText = "SYSTEM // REPOSITORY";
                this.ui.drawDirectory(this.state.chapters);
                lucide.createIcons();
            },

            async loadSurah(id) {
                const currentReq = ++this.activeRequest; // Increment local request ID
                const vp = document.getElementById('view-port');
                
                vp.scrollTop = 0;
                document.getElementById('progress-indicator').innerText = '00%';
                document.querySelector('header input').value = '';
                
                vp.innerHTML = `<div style="padding:100px; text-align:center; font-family:'Fira Code'; color:var(--p);">SYNCING_SURAH_${id}...</div>`;
                
                const [ar, en] = await Promise.all([
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-uthmani`).then(r => r.json()),
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/en.sahih`).then(r => r.json())
                ]);

                // Fix 1: Check if this request is still the latest one
                if (currentReq !== this.activeRequest) return;

                document.getElementById('breadcrumb').innerText = `NODE // SURAH.${id} // ${ar.data.englishName.toUpperCase()}`;

                const bismillahText = "بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ";
                let bismillahHeader = "";

                vp.innerHTML = `
                    <div style="max-width: 1000px; margin: 0 auto; padding: 60px 0 200px 0;">
                        ${ar.data.ayahs.map((v, i) => {
                            let text = v.text;
                            if (id != 1 && id != 9 && i === 0) {
                                if (text.startsWith(bismillahText)) {
                                    text = text.replace(bismillahText, "").trim();
                                    bismillahHeader = `<div style='text-align:center; font-size:2.5rem; padding-bottom:60px; font-family:var(--f-ar); opacity:0.8;'>${bismillahText}</div>`;
                                }
                            }
                            return `
                            ${i === 0 ? bismillahHeader : ''}
                            <div class="ayah-card" style="animation-delay: ${i*0.01}s">
                                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 20px;">
                                    <span style="font-family:'Fira Code'; font-size:0.7rem; color:var(--p); opacity:0.5;">[ ${v.numberInSurah} ]</span>
                                    <div class="ar">${text}</div>
                                </div>
                                <div style="color:var(--text-dim); font-size:1.15rem; line-height:1.9; font-weight:300; max-width: 800px;">${en.data.ayahs[i].text}</div>
                            </div>`;
                        }).join('')}
                    </div>`;
                lucide.createIcons();
            },

            ui: {
                toggleSettings() { const el = document.getElementById('settings-layer'); el.style.display = el.style.display==='flex' ? 'none' : 'flex'; },
                drawDirectory(list) {
                    document.getElementById('view-port').innerHTML = `<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));">
                        ${list.map((s, i) => `<div class="ayah-card" style="animation-delay:${i*0.01}s; cursor:pointer;" onclick="App.loadSurah(${s.number})">
                            <h3 style="margin:0; font-weight:600;">${s.englishName}</h3>
                            <p style="font-family:'Fira Code'; font-size:0.65rem; color:var(--p); margin-top:10px;">NODE_${s.number} // ${s.numberOfAyahs}_VERSES</p>
                        </div>`).join('')}</div>`;
                },
                updateScroll() {
                    const vp = document.getElementById('view-port');
                    const total = vp.scrollHeight - vp.clientHeight;
                    if (total <= 0) return; 
                    const pct = Math.min(100, Math.max(0, Math.round((vp.scrollTop / total) * 100)));
                    document.getElementById('progress-indicator').innerText = pct.toString().padStart(2, '0') + '%';
                },
                search(q) { this.drawDirectory(App.state.chapters.filter(c => c.englishName.toLowerCase().includes(q.toLowerCase()))); }
            },

            themes: {
                set(isLight) {
                    App.state.isLight = isLight;
                    document.body.className = isLight ? 'light-mode' : '';
                    document.documentElement.style.setProperty('--p', isLight ? '#007aff' : '#00f2ff');
                    App.ui.toggleSettings();
                }
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
