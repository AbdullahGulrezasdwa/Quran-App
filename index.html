<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zenith Pro Ultra | Ultimate Quran Experience</title>
<script src="https://unpkg.com/lucide@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=Amiri+Quran&family=Noto+Serif:ital,wght@0,400;0,700;1,400&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --sidebar-w: 340px;
  --hud-h: 90px;
  --radius: 14px;
  --transition: 0.18s ease;
}

[data-theme="dark"] {
  --bg: #080c10; --sidebar: #05080b; --card: #0e1318; --card-hover: #131a22;
  --accent: #38bdf8; --accent-rgb: 56,189,248; --gold: #f4c84a; --gold-rgb: 244,200,74;
  --border: #1e2a35; --border-hi: #2d4055; --text: #dde6ef; --text-dim: #6b7f90;
  --text-dimmer: #3a4f60; --hud-bg: rgba(5,8,11,0.94); --noise-op: 0.4;
  --glow: rgba(56,189,248,0.10); --gold-glow: rgba(244,200,74,0.10);
  --success: #10b981; --warning: #f59e0b; --error: #ef4444;
}

[data-theme="desert"] {
  --bg: #1a1208; --sidebar: #120d05; --card: #201708; --card-hover: #2a1e0b;
  --accent: #e8a23a; --accent-rgb: 232,162,58; --gold: #f4e84a; --gold-rgb: 244,232,74;
  --border: #3a2a10; --border-hi: #5a4020; --text: #f0e8d8; --text-dim: #9a8060;
  --text-dimmer: #5a4030; --hud-bg: rgba(12,8,3,0.94); --noise-op: 0.3;
  --glow: rgba(232,162,58,0.10); --gold-glow: rgba(244,232,74,0.10);
  --success: #84cc16; --warning: #f59e0b; --error: #dc2626;
}

[data-theme="emerald"] {
  --bg: #070f0a; --sidebar: #040a06; --card: #0d1810; --card-hover: #121f15;
  --accent: #34d399; --accent-rgb: 52,211,153; --gold: #fbbf24; --gold-rgb: 251,191,36;
  --border: #163020; --border-hi: #254530; --text: #d4f0e0; --text-dim: #608070;
  --text-dimmer: #304540; --hud-bg: rgba(4,10,6,0.94); --noise-op: 0.35;
  --glow: rgba(52,211,153,0.10); --gold-glow: rgba(251,191,36,0.10);
  --success: #10b981; --warning: #f59e0b; --error: #ef4444;
}

[data-theme="rose"] {
  --bg: #100810; --sidebar: #0b0508; --card: #180d18; --card-hover: #201220;
  --accent: #f472b6; --accent-rgb: 244,114,182; --gold: #fbbf24; --gold-rgb: 251,191,36;
  --border: #301830; --border-hi: #4a2848; --text: #f0d8f0; --text-dim: #907080;
  --text-dimmer: #504050; --hud-bg: rgba(11,5,8,0.94); --noise-op: 0.35;
  --glow: rgba(244,114,182,0.10); --gold-glow: rgba(251,191,36,0.10);
  --success: #ec4899; --warning: #f59e0b; --error: #dc2626;
}

[data-theme="slate"] {
  --bg: #f0f4f8; --sidebar: #e2e8f0; --card: #ffffff; --card-hover: #f8fafc;
  --accent: #3b82f6; --accent-rgb: 59,130,246; --gold: #d97706; --gold-rgb: 217,119,6;
  --border: #cbd5e1; --border-hi: #94a3b8; --text: #1e293b; --text-dim: #64748b;
  --text-dimmer: #94a3b8; --hud-bg: rgba(240,244,248,0.95); --noise-op: 0.15;
  --glow: rgba(59,130,246,0.10); --gold-glow: rgba(217,119,6,0.08);
  --success: #10b981; --warning: #f59e0b; --error: #dc2626;
}

/* Arabic Font Styles */
.ar { font-family: 'Amiri Quran', serif; font-size: var(--ar-size, 1.9rem); direction: rtl; line-height: 2.4; }
.ar.font-uthmani { font-family: 'Amiri Quran', serif; }
.ar.font-indopak { font-family: 'Scheherazade New', serif; font-size: calc(var(--ar-size, 1.9rem) * 0.95); }
.ar.font-simple { font-family: 'Noto Sans Arabic', sans-serif; }

/* Tajweed Colors */
.tajweed-ghunna { color: #ec4899 !important; }
.tajweed-ikhfa { color: #8b5cf6 !important; }
.tajweed-idgham { color: #10b981 !important; }
.tajweed-iqlab { color: #f59e0b !important; }
.tajweed-qalqalah { color: #ef4444 !important; }
.tajweed-madd { color: #06b6d4 !important; }

/* Word-by-Word */
.wbw-container {
  display: none; flex-wrap: wrap; gap: 12px 16px; margin: 14px 0; direction: rtl;
}
body.show-wbw .wbw-container { display: flex; }
.wbw-word {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  padding: 8px; background: rgba(var(--accent-rgb), 0.05); border-radius: 8px;
  cursor: pointer; transition: all 0.15s;
}
.wbw-word:hover { background: rgba(var(--accent-rgb), 0.12); transform: translateY(-2px); }
.wbw-ar { font-family: 'Amiri Quran', serif; font-size: 1.3rem; color: var(--text); }
.wbw-en { font-size: 0.72rem; color: var(--text-dim); text-align: center; }
.wbw-translit { font-size: 0.65rem; color: var(--text-dimmer); font-style: italic; }

/* Highlighting */
.highlight-yellow { background: rgba(251, 191, 36, 0.3) !important; }
.highlight-green { background: rgba(16, 185, 129, 0.3) !important; }
.highlight-blue { background: rgba(56, 189, 248, 0.3) !important; }
.highlight-pink { background: rgba(236, 72, 153, 0.3) !important; }
.highlight-purple { background: rgba(139, 92, 246, 0.3) !important; }

/* Reading Mode */
body.reading-mode main { background: #f5f0e8; }
body.reading-mode .ayah-card { 
  background: transparent; border: none; padding: 16px 0; 
  border-bottom: 1px solid rgba(0,0,0,0.1);
}
body.reading-mode .ar { font-size: 2.2rem; line-height: 2.8; text-align: justify; }

/* Memorization Mode */
.memo-blur { filter: blur(5px); transition: filter 0.3s; cursor: pointer; user-select: none; }
.memo-blur:hover { filter: blur(2px); }
.memo-blur.revealed { filter: blur(0); }

/* Translation Rows */
.translation-container { margin: 10px 0; display: none; }
body.show-multi-trans .translation-container { display: block; }
.translation-row {
  padding: 10px 14px; border-radius: 8px; margin-bottom: 8px;
  background: rgba(var(--accent-rgb), 0.04); border-left: 2px solid var(--accent);
}
.translation-label {
  font-size: 0.65rem; font-weight: 700; color: var(--accent);
  letter-spacing: 0.08em; margin-bottom: 6px;
}
.translation-text {
  font-size: 0.88rem; line-height: 1.7; color: var(--text-dim);
}

/* Reciters */
.reciter-grid {
  display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;
}
.reciter-card {
  padding: 12px; background: var(--card); border: 1px solid var(--border);
  border-radius: 10px; cursor: pointer; transition: all var(--transition); text-align: center;
}
.reciter-card:hover { border-color: var(--accent); background: var(--glow); transform: translateY(-2px); }
.reciter-card.active { border-color: var(--accent); background: var(--glow); box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.2); }
.reciter-name { font-size: 0.78rem; font-weight: 600; color: var(--text); }
.reciter-style { font-size: 0.65rem; color: var(--text-dim); margin-top: 2px; }

/* Search Filters */
.search-filters {
  display: flex; flex-wrap: wrap; gap: 6px; padding: 10px 12px; border-top: 1px solid var(--border);
}
.filter-chip {
  padding: 4px 10px; background: var(--glow); border: 1px solid rgba(var(--accent-rgb), 0.25);
  border-radius: 6px; font-size: 0.7rem; font-weight: 600; color: var(--accent);
  cursor: pointer; transition: all var(--transition);
}
.filter-chip:hover { background: rgba(var(--accent-rgb), 0.2); transform: scale(1.05); }
.filter-chip.active { background: var(--accent); color: var(--bg); }

/* Goals */
.goal-progress { margin: 12px 0; }
.goal-bar {
  height: 8px; background: var(--border); border-radius: 99px; overflow: hidden;
}
.goal-bar-fill {
  height: 100%; background: linear-gradient(90deg, var(--accent), var(--gold));
  transition: width 0.5s ease;
}
.goal-label {
  font-size: 0.7rem; color: var(--text-dim); margin-top: 4px;
  display: flex; justify-content: space-between;
}

/* Prayer Times */
.prayer-times-widget {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 12px; padding: 14px; margin-bottom: 10px;
}
.prayer-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 8px 0; border-bottom: 1px solid var(--border);
}
.prayer-row:last-child { border: none; }
.prayer-row.active { color: var(--accent); font-weight: 700; }
.prayer-name { font-size: 0.8rem; }
.prayer-time { font-size: 0.75rem; font-weight: 700; }

/* Tafsir Tabs */
.tafsir-tabs {
  display: flex; gap: 6px; margin-bottom: 12px; border-bottom: 1px solid var(--border);
  padding-bottom: 8px; flex-wrap: wrap;
}
.tafsir-tab {
  padding: 6px 12px; background: transparent; border: none;
  border-radius: 6px 6px 0 0; font-size: 0.72rem; font-weight: 600;
  color: var(--text-dim); cursor: pointer; transition: all var(--transition);
  font-family: inherit;
}
.tafsir-tab:hover { background: var(--glow); color: var(--accent); }
.tafsir-tab.active { background: var(--glow); color: var(--accent); border-bottom: 2px solid var(--accent); }

/* Vocab Cards */
.vocab-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 10px; padding: 14px; margin-bottom: 8px; cursor: pointer;
  transition: all var(--transition);
}
.vocab-card:hover { border-color: var(--accent); transform: translateY(-2px); }
.vocab-ar { 
  font-family: 'Amiri Quran', serif; font-size: 1.6rem; 
  color: var(--accent); margin-bottom: 8px;
}
.vocab-root { 
  font-size: 0.7rem; color: var(--gold); font-weight: 700; letter-spacing: 0.1em;
}
.vocab-meaning { font-size: 0.85rem; color: var(--text-dim); margin-top: 8px; }
.vocab-examples { 
  font-size: 0.72rem; color: var(--text-dimmer); margin-top: 6px; font-style: italic;
}

/* Study Groups */
.study-group-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 10px; padding: 12px; margin-bottom: 8px;
  cursor: pointer; transition: all var(--transition);
}
.study-group-card:hover { border-color: var(--accent); transform: translateY(-2px); }
.group-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
}
.group-name { font-size: 0.82rem; font-weight: 700; }
.group-members { 
  font-size: 0.65rem; color: var(--text-dim);
  display: flex; align-items: center; gap: 4px;
}
.group-progress {
  height: 4px; background: var(--border); border-radius: 99px;
  overflow: hidden; margin-top: 8px;
}
.group-progress-fill {
  height: 100%; background: var(--accent); transition: width 0.3s;
}

/* Analytics */
.analytics-grid {
  display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
}
.analytics-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 10px; padding: 12px; text-align: center;
}
.analytics-value {
  font-size: 1.8rem; font-weight: 800;
  background: linear-gradient(135deg, var(--accent), var(--gold));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.analytics-label {
  font-size: 0.65rem; color: var(--text-dim); margin-top: 4px;
  font-weight: 600; letter-spacing: 0.06em;
}

/* Heatmap */
.heatmap-container {
  display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px;
  padding: 10px; background: var(--card); border-radius: 10px; margin-top: 10px;
}
.heatmap-day {
  aspect-ratio: 1; background: var(--border); border-radius: 3px;
  cursor: pointer; transition: all 0.2s; position: relative;
}
.heatmap-day:hover { transform: scale(1.1); }
.heatmap-day[data-level="0"] { background: var(--border); }
.heatmap-day[data-level="1"] { background: rgba(var(--accent-rgb), 0.25); }
.heatmap-day[data-level="2"] { background: rgba(var(--accent-rgb), 0.5); }
.heatmap-day[data-level="3"] { background: rgba(var(--accent-rgb), 0.75); }
.heatmap-day[data-level="4"] { background: var(--accent); }

/* Achievements */
.achievement-grid {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
}
.achievement-badge {
  aspect-ratio: 1; background: var(--card); border: 1px solid var(--border);
  border-radius: 10px; display: flex; flex-direction: column;
  align-items: center; justify-content: center; padding: 8px;
  cursor: pointer; transition: all var(--transition); position: relative;
}
.achievement-badge.unlocked { 
  border-color: var(--gold); background: var(--gold-glow);
  animation: unlock 0.5s ease;
}
.achievement-badge.locked { opacity: 0.4; filter: grayscale(1); }
.achievement-icon { font-size: 1.8rem; margin-bottom: 4px; }
.achievement-name { font-size: 0.6rem; text-align: center; font-weight: 600; }
.achievement-badge.unlocked::after {
  content: '‚úì'; position: absolute; top: 4px; right: 4px;
  width: 16px; height: 16px; background: var(--gold); color: var(--bg);
  border-radius: 50%; display: grid; place-items: center;
  font-size: 0.7rem; font-weight: 800;
}

/* Challenges */
.challenge-card {
  background: linear-gradient(135deg, var(--card), var(--card-hover));
  border: 1px solid var(--border-hi); border-radius: 12px; padding: 14px;
  margin-bottom: 10px; cursor: pointer; transition: all var(--transition);
}
.challenge-card:hover { transform: translateY(-2px); border-color: var(--accent); }
.challenge-header {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
}
.challenge-title { font-size: 0.85rem; font-weight: 700; }
.challenge-timer { 
  font-size: 0.7rem; color: var(--warning);
  font-weight: 700; display: flex; align-items: center; gap: 4px;
}
.challenge-desc { font-size: 0.75rem; color: var(--text-dim); margin-bottom: 10px; }
.challenge-progress {
  height: 6px; background: var(--border); border-radius: 99px; overflow: hidden;
}
.challenge-progress-fill {
  height: 100%; background: linear-gradient(90deg, var(--success), var(--gold));
  transition: width 0.5s;
}
.challenge-reward {
  font-size: 0.7rem; color: var(--gold); margin-top: 8px;
  display: flex; align-items: center; gap: 4px; font-weight: 600;
}

/* Bookmark Folders */
.bookmark-folder {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 10px; padding: 12px; margin-bottom: 8px;
}
.folder-header {
  display: flex; justify-content: space-between; align-items: center;
  cursor: pointer; padding-bottom: 8px;
}
.folder-name { 
  font-size: 0.82rem; font-weight: 700; 
  display: flex; align-items: center; gap: 6px;
}
.folder-count { 
  font-size: 0.65rem; padding: 2px 8px; background: var(--glow);
  border-radius: 12px; color: var(--accent);
}
.folder-items {
  padding-top: 8px; border-top: 1px solid var(--border); display: none;
}
.folder-items.open { display: block; }
.bookmark-item {
  padding: 8px; margin: 4px 0; background: rgba(var(--accent-rgb), 0.04);
  border-radius: 6px; cursor: pointer; transition: all var(--transition);
  display: flex; justify-content: space-between; align-items: center;
}
.bookmark-item:hover { background: rgba(var(--accent-rgb), 0.1); }

/* Accessibility */
body.night-light-mode { filter: sepia(0.2) hue-rotate(-10deg); }
body.dyslexia-mode .en { 
  font-family: 'Comic Sans MS', sans-serif;
  letter-spacing: 0.05em; word-spacing: 0.2em; line-height: 2;
}
body.dyslexia-mode .ar { letter-spacing: 0.08em; }
body.large-text-mode .ar { font-size: calc(var(--ar-size, 1.9rem) * 1.5) !important; }
body.large-text-mode .en { font-size: calc(var(--en-size, 0.95rem) * 1.3) !important; }

/* Base Styles */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }

body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background: var(--bg); color: var(--text);
  display: flex; height: 100vh; overflow: hidden;
  transition: background var(--transition), color var(--transition);
}

body::after {
  content: ''; position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.06'/%3E%3C/svg%3E");
  opacity: var(--noise-op);
}

/* Sidebar */
nav {
  width: var(--sidebar-w); min-width: var(--sidebar-w); background: var(--sidebar);
  border-right: 1px solid var(--border); display: flex; flex-direction: column;
  z-index: 100; position: relative;
}

.nav-header {
  padding: 18px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}

.logo {
  font-size: 1rem; font-weight: 800; letter-spacing: 0.14em; color: var(--accent);
  display: flex; align-items: center; gap: 9px;
}
.logo-icon {
  width: 30px; height: 30px; background: var(--glow);
  border: 1px solid rgba(var(--accent-rgb),0.25); border-radius: 9px;
  display: grid; place-items: center;
}

.theme-btn {
  background: var(--glow); border: 1px solid rgba(var(--accent-rgb),0.2);
  color: var(--accent); width: 28px; height: 28px; border-radius: 8px;
  cursor: pointer; display: grid; place-items: center; transition: all var(--transition);
}
.theme-btn:hover { background: rgba(var(--accent-rgb),0.2); }

.theme-picker {
  position: absolute; top: 56px; right: 12px; background: var(--card);
  border: 1px solid var(--border-hi); border-radius: 12px; padding: 8px;
  z-index: 999; display: none; box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}
.theme-picker.open { display: block; animation: fadeUp 0.2s ease; }
.theme-opt {
  display: flex; align-items: center; gap: 10px; padding: 9px 12px;
  border-radius: 8px; cursor: pointer; font-size: 0.78rem;
  font-weight: 600; color: var(--text); transition: background var(--transition);
}
.theme-opt:hover { background: var(--glow); }
.theme-opt.active { color: var(--accent); }
.theme-dot { width: 12px; height: 12px; border-radius: 50%; }

.nav-tabs {
  display: flex; padding: 10px 12px; gap: 5px; border-bottom: 1px solid var(--border);
  overflow-x: auto;
}
.nav-tab {
  flex-shrink: 0; padding: 6px 10px; font-size: 0.7rem; font-weight: 700;
  letter-spacing: 0.05em; border: 1px solid transparent; border-radius: 8px;
  cursor: pointer; background: transparent; color: var(--text-dim);
  transition: all var(--transition); font-family: inherit;
}
.nav-tab.active {
  background: var(--glow); border-color: rgba(var(--accent-rgb),0.25); color: var(--accent);
}

.search-wrap { position: relative; padding: 12px 12px 8px; }
.search-icon {
  position: absolute; left: 24px; top: 50%; transform: translateY(-50%);
  color: var(--text-dim); pointer-events: none; width: 14px; height: 14px;
}
.search-bar {
  width: 100%; background: var(--card); border: 1px solid var(--border);
  padding: 9px 10px 9px 34px; border-radius: 10px; color: var(--text);
  font-family: inherit; font-size: 0.82rem; outline: none;
}
.search-bar:focus { border-color: rgba(var(--accent-rgb),0.5); }

.panel-content { flex: 1; overflow-y: auto; padding: 12px; min-height: 0; }

.surah-item {
  padding: 9px 10px; border-radius: 10px; cursor: pointer;
  display: flex; align-items: center; gap: 10px; margin-bottom: 1px;
  border: 1px solid transparent; transition: all var(--transition);
}
.surah-item:hover { background: rgba(var(--accent-rgb),0.04); }
.surah-item.active { background: var(--glow); border-color: rgba(var(--accent-rgb),0.22); }
.surah-item.hidden { display: none; }

.sn {
  width: 30px; height: 30px; border: 1px solid var(--border); border-radius: 7px;
  display: grid; place-items: center; font-size: 0.65rem; font-weight: 700;
  color: var(--text-dim);
}
.sm { flex: 1; min-width: 0; }
.sn-name { font-weight: 700; font-size: 0.82rem; }
.sn-sub { font-size: 0.65rem; color: var(--text-dim); }
.sar { font-family: 'Amiri Quran', serif; font-size: 1rem; color: var(--accent); opacity: 0.65; }

/* Main Content */
.right-col { display: flex; flex-direction: column; flex: 1; min-width: 0; height: 100vh; overflow: hidden; }
main { flex: 1; overflow-y: auto; position: relative; scroll-behavior: smooth; }

.hero {
  min-height: 100%; display: flex; flex-direction: column;
  align-items: center; justify-content: center; text-align: center; padding: 48px 40px;
}
.hero-title {
  font-family: 'Amiri Quran', serif; font-size: clamp(3rem, 8vw, 6rem);
  margin-bottom: 14px;
}

.surah-wrap { max-width: 900px; margin: 0 auto; padding: 32px 24px 120px; }

.surah-hdr {
  text-align: center; padding: 32px 24px; background: var(--card);
  border: 1px solid var(--border); border-radius: 20px; margin-bottom: 32px;
}
.sh-ar {
  font-family: 'Amiri Quran', serif; font-size: clamp(2.2rem, 5vw, 4rem);
  color: var(--accent); margin-bottom: 8px;
}

.ayah-card {
  background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 22px 24px; margin-bottom: 16px; transition: border-color var(--transition);
  position: relative; animation: fadeUp 0.35s both;
}
.ayah-card:hover { border-color: var(--border-hi); }
.ayah-card.playing { border-color: rgba(var(--accent-rgb),0.45); }

.ayah-top {
  display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;
}
.ayah-num {
  font-size: 0.62rem; font-weight: 800; letter-spacing: 0.1em;
  padding: 3px 9px; border-radius: 6px; background: var(--glow);
  color: var(--accent); border: 1px solid rgba(var(--accent-rgb),0.2);
}
.ayah-btns { display: flex; gap: 5px; flex-wrap: wrap; }
.ib {
  background: transparent; border: 1px solid var(--border); color: var(--text-dim);
  width: 28px; height: 28px; border-radius: 7px; display: grid; place-items: center;
  cursor: pointer; transition: all var(--transition);
}
.ib:hover { border-color: var(--accent); color: var(--accent); background: var(--glow); }
.ib.active { border-color: var(--accent); color: var(--accent); background: var(--glow); }

.en {
  font-family: 'Noto Serif', serif; font-style: italic; color: var(--text-dim);
  font-size: var(--en-size, 0.95rem); line-height: 1.8;
}

.translit {
  font-size: 0.82rem; color: var(--text-dimmer); font-style: italic;
  margin: -8px 0 10px; display: none; line-height: 1.6;
}
body.show-translit .translit { display: block; }

.ayah-footer { display: flex; gap: 7px; margin-top: 14px; flex-wrap: wrap; }
.abtn {
  display: inline-flex; align-items: center; gap: 4px;
  background: transparent; border: 1px solid var(--border); color: var(--text-dim);
  padding: 5px 11px; border-radius: 7px; font-size: 0.7rem; font-weight: 600;
  cursor: pointer; transition: all var(--transition); font-family: inherit;
}
.abtn:hover { border-color: var(--accent); color: var(--accent); background: var(--glow); }
.abtn.active { border-color: var(--accent); color: var(--accent); background: var(--glow); }

/* HUD */
.hud {
  height: var(--hud-h); margin: 0 14px 14px; background: var(--hud-bg);
  backdrop-filter: blur(20px); border: 1px solid var(--border-hi);
  border-radius: 18px; display: flex; align-items: center; gap: 12px; padding: 0 18px;
}

.hud-art {
  width: 44px; height: 44px; background: var(--glow);
  border: 1px solid rgba(var(--accent-rgb),0.2); border-radius: 12px;
  display: grid; place-items: center; font-family: 'Amiri Quran', serif;
  font-size: 1rem; color: var(--accent);
}

.wave { display: flex; align-items: center; gap: 2px; height: 22px; }
.wb { width: 2.5px; background: var(--accent); border-radius: 2px; height: 4px; opacity: 0.4; }
.wave.go .wb { opacity: 0.9; animation: wv 0.9s ease-in-out infinite alternate; }

.hud-mid { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 5px; }
.hud-title {
  font-size: 0.7rem; font-weight: 800; color: var(--accent);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.hud-time { font-size: 0.62rem; color: var(--text-dim); font-weight: 600; }

.prog-bg {
  height: 4px; background: rgba(var(--accent-rgb),0.12); border-radius: 99px;
  cursor: pointer; position: relative;
}
.prog-fill {
  height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--gold));
  border-radius: 99px; transition: width 0.1s linear;
}

.hud-ctrl { display: flex; align-items: center; gap: 6px; }
.hbtn {
  background: transparent; border: none; color: var(--text-dim);
  width: 32px; height: 32px; border-radius: 9px; display: grid; place-items: center;
  cursor: pointer; transition: all var(--transition);
}
.hbtn:hover { color: var(--text); background: rgba(var(--accent-rgb),0.08); }
.hbtn.on { color: var(--accent); }

.play-btn {
  width: 42px; height: 42px; background: var(--accent); border: none;
  border-radius: 12px; cursor: pointer; display: grid; place-items: center;
  color: var(--bg); transition: all var(--transition);
}
.play-btn:hover { opacity: 0.85; transform: scale(1.04); }

/* Modals */
.overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px); z-index: 2000; display: none;
  align-items: center; justify-content: center; padding: 20px;
}
.overlay.open { display: flex; animation: fadeIn 0.2s ease; }

.modal {
  background: var(--card); border: 1px solid var(--border-hi);
  border-radius: 18px; padding: 28px; max-width: 90vw; max-height: 85vh;
  overflow-y: auto; width: 100%;
}
.modal-sm { max-width: 420px; }
.modal-md { max-width: 650px; }
.modal-lg { max-width: 900px; }

.modal-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 20px; padding-bottom: 14px; border-bottom: 1px solid var(--border);
}
.modal-title { font-size: 1rem; font-weight: 800; color: var(--accent); }
.modal-close {
  background: transparent; border: none; color: var(--text-dim);
  cursor: pointer; padding: 4px; border-radius: 6px;
}

.modal-body { margin-bottom: 20px; }

.btn {
  padding: 8px 16px; border-radius: 8px; font-size: 0.82rem;
  font-weight: 600; cursor: pointer; transition: all var(--transition);
  font-family: inherit; border: 1px solid var(--border);
}
.btn-primary {
  background: var(--accent); color: var(--bg); border-color: var(--accent);
}

/* Toast */
.toast-wrap {
  position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%);
  z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 6px;
}
.toast-item {
  background: var(--card); border: 1px solid var(--border-hi); color: var(--text);
  padding: 9px 16px; border-radius: 10px; font-size: 0.78rem; font-weight: 600;
  opacity: 0; transform: translateY(8px); transition: all 0.22s ease;
  pointer-events: none;
}
.toast-item.show { opacity: 1; transform: translateY(0); }

.empty-state {
  text-align: center; padding: 40px 20px; color: var(--text-dim);
  font-size: 0.8rem; line-height: 1.6;
}

.streak-box {
  background: linear-gradient(135deg, rgba(var(--gold-rgb),0.15), rgba(var(--accent-rgb),0.08));
  border: 1px solid rgba(var(--gold-rgb),0.25); border-radius: 12px;
  padding: 14px; text-align: center; margin-bottom: 10px;
}
.streak-num { font-size: 2rem; font-weight: 800; color: var(--gold); }
.streak-label {
  font-size: 0.62rem; color: var(--text-dim); font-weight: 600;
  letter-spacing: 0.06em; text-transform: uppercase;
}

/* Animations */
@keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes wv { from { transform: scaleY(0.3); } to { transform: scaleY(1); } }
@keyframes unlock { 
  0% { transform: scale(1); } 
  50% { transform: scale(1.2) rotate(5deg); } 
  100% { transform: scale(1); } 
}
/* FIX 5: Dedicated spin keyframes to avoid duration conflict */
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
.spin { animation: spin 1s linear infinite; }
.spin-slow { animation: spin-slow 4s linear infinite; }

/* FIX 6: Focus styles for keyboard navigation accessibility */
button:focus-visible, .surah-item:focus-visible, .abtn:focus-visible, .ib:focus-visible, .nav-tab:focus-visible {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

/* Loading spinner for API fallback */
.loading-spinner {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  min-height: 300px; gap: 16px; color: var(--text-dim);
}
.spinner {
  width: 36px; height: 36px; border: 3px solid var(--border);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
.error-state {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  min-height: 300px; gap: 12px; color: var(--text-dim); text-align: center; padding: 40px;
}
.error-state-icon { font-size: 2.5rem; }
.error-state-msg { font-size: 0.9rem; font-weight: 600; color: var(--text); }
.error-state-sub { font-size: 0.78rem; max-width: 280px; line-height: 1.6; }
</style>
</head>
<body>

<div class="overlay" id="main-overlay"></div>
<div class="toast-wrap" id="toast-wrap"></div>

<nav>
  <div class="nav-header">
    <div class="logo">
      <div class="logo-icon"><i data-lucide="compass" style="width:15px;height:15px"></i></div>
      ZENITH ULTRA
    </div>
    <button class="theme-btn" id="theme-btn" onclick="UI.toggleThemePicker()">
      <i data-lucide="palette" style="width:14px;height:14px"></i>
    </button>
    <div class="theme-picker" id="theme-picker">
      <div class="theme-opt" onclick="UI.setTheme('dark')">
        <span class="theme-dot" style="background:#38bdf8"></span> Midnight
      </div>
      <div class="theme-opt" onclick="UI.setTheme('desert')">
        <span class="theme-dot" style="background:#e8a23a"></span> Desert
      </div>
      <div class="theme-opt" onclick="UI.setTheme('emerald')">
        <span class="theme-dot" style="background:#34d399"></span> Emerald
      </div>
      <div class="theme-opt" onclick="UI.setTheme('rose')">
        <span class="theme-dot" style="background:#f472b6"></span> Rose
      </div>
      <div class="theme-opt" onclick="UI.setTheme('slate')">
        <span class="theme-dot" style="background:#3b82f6"></span> Light
      </div>
    </div>
  </div>

  <div class="nav-tabs">
    <button class="nav-tab active" id="tab-surahs" onclick="UI.switchTab('surahs')">Surahs</button>
    <button class="nav-tab" id="tab-search" onclick="UI.switchTab('search')">Search</button>
    <button class="nav-tab" id="tab-bookmarks" onclick="UI.switchTab('bookmarks')">Saved</button>
    <button class="nav-tab" id="tab-goals" onclick="UI.switchTab('goals')">Goals</button>
    <button class="nav-tab" id="tab-learn" onclick="UI.switchTab('learn')">Learn</button>
    <button class="nav-tab" id="tab-social" onclick="UI.switchTab('social')">Groups</button>
    <button class="nav-tab" id="tab-stats" onclick="UI.switchTab('stats')">Stats</button>
    <button class="nav-tab" id="tab-settings" onclick="UI.switchTab('settings')">Settings</button>
  </div>

  <div id="panel-surahs" class="panel-content" style="display:block; padding:0;">
    <div class="search-wrap">
      <i data-lucide="search" class="search-icon"></i>
      <input type="text" class="search-bar" id="search-inp" placeholder="Search surah‚Ä¶" oninput="Features.searchSurahs(this.value)">
    </div>
    <div style="flex:1; overflow-y:auto; padding:4px 12px;">
      <div id="surah-list"></div>
    </div>
  </div>

  <div id="panel-search" class="panel-content" style="display:none;">
    <h3 style="font-size:0.85rem; margin-bottom:12px; color:var(--accent);">üîç Advanced Search</h3>
    <input type="text" class="search-bar" id="adv-search-inp" placeholder="Search by keyword, root, topic‚Ä¶" style="margin-bottom:10px;">
    <div class="search-filters" id="search-filters">
      <div class="filter-chip" onclick="Features.toggleFilter(this, 'makkah')">Makkah</div>
      <div class="filter-chip" onclick="Features.toggleFilter(this, 'madinah')">Madinah</div>
      <div class="filter-chip" onclick="Features.toggleFilter(this, 'juz1-10')">Juz 1-10</div>
      <div class="filter-chip" onclick="Features.toggleFilter(this, 'juz11-20')">Juz 11-20</div>
      <div class="filter-chip" onclick="Features.toggleFilter(this, 'juz21-30')">Juz 21-30</div>
    </div>
    <button class="abtn" style="width:100%; justify-content:center; margin-top:10px;" onclick="Features.performSearch()">
      <i data-lucide="search" style="width:11px;height:11px"></i> Search All
    </button>
    <div id="search-results" style="margin-top:20px;"></div>
  </div>

  <div id="panel-bookmarks" class="panel-content" style="display:none;">
    <h3 style="font-size:0.85rem; margin-bottom:12px; color:var(--accent);">üìå Saved Verses</h3>
    <button class="abtn" style="width:100%; justify-content:center; margin-bottom:12px;" onclick="Features.createBookmarkFolder()">
      <i data-lucide="folder-plus" style="width:11px;height:11px"></i> New Folder
    </button>
    <div id="bookmark-folders"></div>
  </div>

  <div id="panel-goals" class="panel-content" style="display:none;">
    <h3 style="font-size:0.85rem; margin-bottom:12px; color:var(--accent);">üéØ Reading Goals</h3>
    <div class="goal-progress">
      <div class="goal-bar"><div class="goal-bar-fill" id="goal-bar-fill" style="width:0%"></div></div>
      <div class="goal-label">
        <span><span id="goal-current">0</span>/<span id="goal-target">20</span> Surahs</span>
        <span id="goal-percentage">0%</span>
      </div>
    </div>
    <button class="abtn" style="width:100%; justify-content:center; margin-top:10px;" onclick="Features.setGoal()">
      <i data-lucide="target" style="width:11px;height:11px"></i> Set New Goal
    </button>
    <h4 style="font-size:0.75rem; margin:20px 0 10px; color:var(--text-dim);">üèÜ Active Challenges</h4>
    <div id="challenges-list"></div>
    <button class="abtn" style="width:100%; justify-content:center; margin-top:10px;" onclick="Features.createChallenge()">
      <i data-lucide="plus" style="width:11px;height:11px"></i> Create Challenge
    </button>
  </div>

  <div id="panel-learn" class="panel-content" style="display:none;">
    <h3 style="font-size:0.85rem; margin-bottom:12px; color:var(--accent);">üìö Learn & Memorize</h3>
    <button class="abtn" style="width:100%; justify-content:center; margin-bottom:8px;" onclick="Features.startMemorization()">
      <i data-lucide="brain" style="width:11px;height:11px"></i> Memorization Mode
    </button>
    <button class="abtn" style="width:100%; justify-content:center; margin-bottom:8px;" onclick="Features.vocabularyBuilder()">
      <i data-lucide="book-open" style="width:11px;height:11px"></i> Vocabulary Builder
    </button>
    <button class="abtn" style="width:100%; justify-content:center; margin-bottom:8px;" onclick="Features.tajweedLessons()">
      <i data-lucide="mic" style="width:11px;height:11px"></i> Tajweed Lessons
    </button>
    <button class="abtn" style="width:100%; justify-content:center;" onclick="Features.quizMe()">
      <i data-lucide="help-circle" style="width:11px;height:11px"></i> Quiz Me
    </button>
    <div id="learn-content" style="margin-top:20px;"></div>
  </div>

  <div id="panel-social" class="panel-content" style="display:none;">
    <h3 style="font-size:0.85rem; margin-bottom:12px; color:var(--accent);">üë• Study Groups</h3>
    <button class="abtn" style="width:100%; justify-content:center; margin-bottom:12px;" onclick="Features.createGroup()">
      <i data-lucide="users-plus" style="width:11px;height:11px"></i> Create Group
    </button>
    <div id="groups-list"></div>
  </div>

  <div id="panel-stats" class="panel-content" style="display:none;">
    <h3 style="font-size:0.85rem; margin-bottom:12px; color:var(--accent);">üìä Your Statistics</h3>
    <div class="streak-box">
      <div class="streak-num" id="s-streak">0üî•</div>
      <div class="streak-label">Day Streak</div>
    </div>
    <div class="analytics-grid">
      <div class="analytics-card">
        <div class="analytics-value" id="s-listened">0</div>
        <div class="analytics-label">Ayahs Heard</div>
      </div>
      <div class="analytics-card">
        <div class="analytics-value" id="s-bookmarks">0</div>
        <div class="analytics-label">Bookmarked</div>
      </div>
      <div class="analytics-card">
        <div class="analytics-value" id="s-surahs">0</div>
        <div class="analytics-label">Surahs Read</div>
      </div>
      <div class="analytics-card">
        <div class="analytics-value" id="s-minutes">0</div>
        <div class="analytics-label">Minutes</div>
      </div>
    </div>
    <h4 style="font-size:0.75rem; margin:20px 0 10px; color:var(--text-dim);">üìÖ Activity Heatmap</h4>
    <div class="heatmap-container" id="heatmap"></div>
    <h4 style="font-size:0.75rem; margin:20px 0 10px; color:var(--text-dim);">üèÜ Achievements</h4>
    <div class="achievement-grid" id="achievements"></div>
  </div>

  <div id="panel-settings" class="panel-content" style="display:none;">
    <h3 style="font-size:0.85rem; margin-bottom:12px; color:var(--accent);">‚öôÔ∏è Settings</h3>
    
    <h4 style="font-size:0.7rem; margin:16px 0 8px; color:var(--text-dim); font-weight:700;">DISPLAY</h4>
    <button class="abtn" style="width:100%; justify-content:space-between; margin-bottom:6px;" onclick="Features.toggleWBW()">
      Word-by-Word <span id="wbw-state">OFF</span>
    </button>
    <button class="abtn" style="width:100%; justify-content:space-between; margin-bottom:6px;" onclick="Features.toggleTajweed()">
      Tajweed Colors <span id="tajweed-state">OFF</span>
    </button>
    <button class="abtn" style="width:100%; justify-content:space-between; margin-bottom:6px;" onclick="Features.toggleTranslit()">
      Transliteration <span id="translit-state">OFF</span>
    </button>
    <button class="abtn" style="width:100%; justify-content:space-between; margin-bottom:6px;" onclick="Features.toggleReadingMode()">
      Reading Mode <span id="reading-state">OFF</span>
    </button>
    <button class="abtn" style="width:100%; justify-content:space-between; margin-bottom:6px;" onclick="Features.toggleMultiTrans()">
      Multiple Translations <span id="multi-trans-state">OFF</span>
    </button>
    <button class="abtn" style="width:100%; justify-content:center; margin-bottom:6px;" onclick="Features.changeArabicFont()">
      <i data-lucide="type" style="width:11px;height:11px"></i> Arabic Font Style
    </button>

    <h4 style="font-size:0.7rem; margin:16px 0 8px; color:var(--text-dim); font-weight:700;">ACCESSIBILITY</h4>
    <button class="abtn" style="width:100%; justify-content:space-between; margin-bottom:6px;" onclick="Features.toggleDyslexiaMode()">
      Dyslexia-Friendly <span id="dyslexia-state">OFF</span>
    </button>
    <button class="abtn" style="width:100%; justify-content:space-between; margin-bottom:6px;" onclick="Features.toggleLargeText()">
      Large Text <span id="large-text-state">OFF</span>
    </button>
    <button class="abtn" style="width:100%; justify-content:space-between; margin-bottom:6px;" onclick="Features.toggleNightLight()">
      Night Light <span id="night-light-state">OFF</span>
    </button>

    <h4 style="font-size:0.7rem; margin:16px 0 8px; color:var(--text-dim); font-weight:700;">AUDIO</h4>
    <button class="abtn" style="width:100%; justify-content:center; margin-bottom:6px;" onclick="Features.selectReciter()">
      <i data-lucide="mic" style="width:11px;height:11px"></i> Select Reciter
    </button>

    <h4 style="font-size:0.7rem; margin:16px 0 8px; color:var(--text-dim); font-weight:700;">PRAYER TIMES</h4>
    <button class="abtn" style="width:100%; justify-content:center; margin-bottom:6px;" onclick="Features.setupPrayerTimes()">
      <i data-lucide="clock" style="width:11px;height:11px"></i> Setup Prayer Times
    </button>
    <div id="prayer-times-container"></div>

    <h4 style="font-size:0.7rem; margin:16px 0 8px; color:var(--text-dim); font-weight:700;">DATA</h4>
    <button class="abtn" style="width:100%; justify-content:center; margin-bottom:6px;" onclick="Features.exportData()">
      <i data-lucide="download" style="width:11px;height:11px"></i> Export Data
    </button>
    <button class="abtn" style="width:100%; justify-content:center; margin-bottom:6px;" onclick="Features.importData()">
      <i data-lucide="upload" style="width:11px;height:11px"></i> Import Data
    </button>
    <button class="abtn" style="width:100%; justify-content:center;" onclick="Features.cloudSync()">
      <i data-lucide="cloud" style="width:11px;height:11px"></i> Cloud Sync
    </button>
  </div>
</nav>

<div class="right-col">
  <main id="main-scroll">
    <div id="view"></div>
  </main>

  <div class="hud">
    <div class="hud-art" id="hud-art">Ô∑Ω</div>
    <div class="wave" id="wave">
      <div class="wb"></div><div class="wb"></div><div class="wb"></div>
      <div class="wb"></div><div class="wb"></div><div class="wb"></div>
    </div>
    <div class="hud-mid">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <span class="hud-title" id="hud-title">SELECT A SURAH TO BEGIN</span>
        <span class="hud-time" id="hud-time">0:00 / 0:00</span>
      </div>
      <!-- FIX 7: Dynamic reciter subtitle instead of hardcoded -->
      <div id="hud-sub" style="font-size:0.6rem; color:var(--text-dimmer); font-weight:600; letter-spacing:0.04em; margin-top:-2px;"></div>
      <div class="prog-bg" id="prog-bg" role="progressbar" aria-label="Playback progress" aria-valuemin="0" aria-valuemax="100">
        <div class="prog-fill" id="prog-fill"></div>
      </div>
    </div>
    <div class="hud-ctrl">
      <!-- FIX 6: aria-labels for keyboard/screen reader accessibility -->
      <button class="hbtn" id="btn-prev" onclick="Audio.prev()" aria-label="Previous ayah">
        <i data-lucide="skip-back" style="width:15px;height:15px"></i>
      </button>
      <button class="play-btn" id="btn-play" onclick="Audio.togglePlay()" aria-label="Play or pause">
        <i data-lucide="play" style="width:17px;height:17px"></i>
      </button>
      <button class="hbtn" id="btn-next" onclick="Audio.next()" aria-label="Next ayah">
        <i data-lucide="skip-forward" style="width:15px;height:15px"></i>
      </button>
    </div>
    <div style="display:flex; align-items:center; gap:7px;">
      <button class="hbtn" id="btn-repeat" onclick="Audio.toggleRepeat()" aria-label="Toggle repeat">
        <i data-lucide="repeat-1" style="width:14px;height:14px"></i>
      </button>
      <button class="hbtn on" id="btn-auto" onclick="Audio.toggleAuto()" aria-label="Toggle autoplay">
        <i data-lucide="list-music" style="width:14px;height:14px"></i>
      </button>
      <button class="hbtn" onclick="Features.selectReciter()" aria-label="Select reciter">
        <i data-lucide="mic" style="width:14px;height:14px"></i>
      </button>
    </div>
  </div>

  <audio id="audio-el" preload="none"></audio>
</div>

<script>
// COMPLETE IMPLEMENTATION OF ALL 70 FEATURES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const STORAGE = {
  BOOKMARKS: 'zpu_bookmarks',
  STATS: 'zpu_stats',
  SETTINGS: 'zpu_settings',
  GOALS: 'zpu_goals',
  VOCAB: 'zpu_vocab',
  GROUPS: 'zpu_groups',
  CHALLENGES: 'zpu_challenges',
  ACHIEVEMENTS: 'zpu_achievements',
  HEATMAP: 'zpu_heatmap',
  HIGHLIGHTS: 'zpu_highlights',
  NOTES: 'zpu_notes',
  PRAYER_TIMES: 'zpu_prayer',
};

const RECITERS = [
  { id: 'alafasy', name: 'Mishary Alafasy', style: 'Warsh', cdn: n => `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${n}.mp3` },
  { id: 'husary', name: 'Mahmoud Husary', style: 'Hafs', cdn: n => `https://cdn.islamic.network/quran/audio/128/ar.husary/${n}.mp3` },
  { id: 'minshawi', name: 'Mohamed Minshawi', style: 'Murattal', cdn: n => `https://cdn.islamic.network/quran/audio/128/ar.minshawi/${n}.mp3` },
  { id: 'sudais', name: 'Abdul Rahman Sudais', style: 'Hafs', cdn: n => `https://cdn.islamic.network/quran/audio/128/ar.abdurrahmaansudais/${n}.mp3` },
  { id: 'shuraim', name: 'Saud Al-Shuraim', style: 'Hafs', cdn: n => `https://cdn.islamic.network/quran/audio/128/ar.shuraim/${n}.mp3` },
  { id: 'basfar', name: 'Abdullah Basfar', style: 'Hafs', cdn: n => `https://cdn.islamic.network/quran/audio/128/ar.abdullahbasfar/${n}.mp3` },
];

const SURAH_AYAH_STARTS = [1,8,194,394,571,748,955,1162,1383,1493,1613,1751,1902,1943,2000,2100,2177,2284,2394,2484,2606,2719,2838,2931,3033,3126,3223,3324,3425,3520,3606,3672,3734,3796,3855,3911,3985,4060,4116,4181,4261,4326,4404,4474,4511,4546,4584,4625,4666,4705,4751,4803,4861,4911,4967,5025,5104,5181,5224,5272,5317,5349,5375,5413,5452,5464,5477,5491,5506,5523,5553,5584,5613,5643,5673,5713,5751,5792,5833,5874,5909,5938,5958,5979,6005,6028,6052,6079,6111,6141,6172,6194,6214,6236,6254,6270,6287,6303,6319,6349,6360,6370,6383,6397,6410,6425,6437,6453,6469,6483,6493,6502,6513,6524,6537,6550,6560,6569,6579,6589,6597,6606,6613,6623,6634];

const ACHIEVEMENTS = [
  { id: 'first_read', name: 'First Steps', icon: 'üìñ', desc: 'Read your first Surah', check: s => s.surahs.length >= 1 },
  { id: 'week_streak', name: 'Dedicated', icon: 'üî•', desc: '7-day streak', check: s => s.streak >= 7 },
  { id: 'month_streak', name: 'Committed', icon: 'üí™', desc: '30-day streak', check: s => s.streak >= 30 },
  { id: '10_surahs', name: '10 Surahs', icon: 'üìö', desc: 'Read 10 surahs', check: s => s.surahs.length >= 10 },
  { id: '50_surahs', name: 'Half Way', icon: 'üåü', desc: 'Read 50 surahs', check: s => s.surahs.length >= 50 },
  { id: 'all_surahs', name: 'Completion', icon: 'üèÜ', desc: 'Read all Surahs', check: s => s.surahs.length >= 114 },
  { id: '100_bookmarks', name: 'Collector', icon: 'üìå', desc: '100 bookmarks', check: s => s.bookmarks >= 100 },
  { id: '1000_ayahs', name: 'Listener', icon: 'üéß', desc: '1000 ayahs heard', check: s => s.listened >= 1000 },
  { id: 'night_owl', name: 'Night Owl', icon: 'ü¶â', desc: 'Read after midnight', check: s => s.nightReads >= 1 },
];

const WBW_DATA = {
  // Simplified word-by-word data (would be loaded from API in production)
  sample: [
    { ar: 'ÿ®Ÿêÿ≥ŸíŸÖŸê', en: 'In the name', trans: 'Bismi' },
    { ar: 'ÿßŸÑŸÑŸéŸëŸáŸê', en: 'of Allah', trans: 'Allahi' },
    { ar: 'ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸ∞ŸÜŸê', en: 'the Most Gracious', trans: 'Ar-Rahmani' },
    { ar: 'ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê', en: 'the Most Merciful', trans: 'Ar-Raheem' },
  ]
};

const TAJWEED_RULES = {
  // Simplified tajweed patterns (would use proper tajweed API in production)
  ghunna: ['ŸÜ', 'ŸÖ'],
  qalqalah: ['ŸÇ', 'ÿ∑', 'ÿ®', 'ÿ¨', 'ÿØ'],
  madd: ['ÿß', 'Ÿà', 'Ÿä'],
};

const VOCAB_DATABASE = [
  { ar: 'ÿµŸéŸÑŸéÿßÿ©', root: 'ÿµ ŸÑ Ÿà', meaning: 'Prayer, connection with Allah', examples: 'Used 99 times in Quran' },
  { ar: 'ÿµŸéÿ®Ÿíÿ±', root: 'ÿµ ÿ® ÿ±', meaning: 'Patience, perseverance', examples: 'Mentioned in 2:45, 2:153, 3:200' },
  { ar: 'ÿ±Ÿéÿ≠ŸíŸÖŸéÿ©', root: 'ÿ± ÿ≠ ŸÖ', meaning: 'Mercy, compassion', examples: 'From the same root as Ar-Rahman' },
  { ar: 'ÿ¥ŸèŸÉŸíÿ±', root: 'ÿ¥ ŸÉ ÿ±', meaning: 'Gratitude, thankfulness', examples: 'Related to Shakoor (Most Appreciative)' },
  { ar: 'ÿ•ŸêŸäŸÖŸéÿßŸÜ', root: 'ÿ£ ŸÖ ŸÜ', meaning: 'Faith, belief', examples: 'Core concept appearing 800+ times' },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const State = {
  surahs: [],
  currentSurah: null,
  currentAyahs: [],
  currentIdx: -1,
  
  settings: {
    reciter: 'alafasy',
    wbw: false,
    tajweed: false,
    translit: false,
    readingMode: false,
    multiTrans: false,
    dyslexia: false,
    largeText: false,
    nightLight: false,
    arabicFont: 'uthmani',
  },
  
  bookmarkFolders: [
    { id: 'default', name: 'My Bookmarks', bookmarks: [] }
  ],
  
  highlights: {}, // key: "surah:ayah" ‚Üí color
  notes: {}, // key: "surah:ayah" ‚Üí note text
  
  goals: { 
    type: 'surahs', 
    target: 20, 
    current: 0,
    customTarget: null,
    lastReset: null  // FIX 4: track daily resets
  },
  
  challenges: [],
  achievements: [],
  
  stats: {
    surahs: [],
    listened: 0,
    minutes: 0,
    streak: 0,
    lastDate: null,
    bookmarks: 0,
    nightReads: 0,
  },
  
  heatmap: {},
  
  groups: [],
  
  prayerTimes: null,
  prayerLocation: null,
  
  searchFilters: [],
  
  memorizing: [],
  
  load() {
    try {
      const loaded = {
        settings: localStorage.getItem(STORAGE.SETTINGS),
        bookmarks: localStorage.getItem(STORAGE.BOOKMARKS),
        goals: localStorage.getItem(STORAGE.GOALS),
        achievements: localStorage.getItem(STORAGE.ACHIEVEMENTS),
        heatmap: localStorage.getItem(STORAGE.HEATMAP),
        stats: localStorage.getItem(STORAGE.STATS),
        highlights: localStorage.getItem(STORAGE.HIGHLIGHTS),
        notes: localStorage.getItem(STORAGE.NOTES),
        groups: localStorage.getItem(STORAGE.GROUPS),
        challenges: localStorage.getItem(STORAGE.CHALLENGES),
        vocab: localStorage.getItem(STORAGE.VOCAB),
        prayer: localStorage.getItem(STORAGE.PRAYER_TIMES),
      };
      
      if (loaded.settings) this.settings = { ...this.settings, ...JSON.parse(loaded.settings) };
      if (loaded.bookmarks) this.bookmarkFolders = JSON.parse(loaded.bookmarks);
      if (loaded.goals) this.goals = JSON.parse(loaded.goals);
      if (loaded.achievements) this.achievements = JSON.parse(loaded.achievements);
      if (loaded.heatmap) this.heatmap = JSON.parse(loaded.heatmap);
      if (loaded.stats) this.stats = { ...this.stats, ...JSON.parse(loaded.stats) };
      if (loaded.highlights) this.highlights = JSON.parse(loaded.highlights);
      if (loaded.notes) this.notes = JSON.parse(loaded.notes);
      if (loaded.groups) this.groups = JSON.parse(loaded.groups);
      if (loaded.challenges) this.challenges = JSON.parse(loaded.challenges);
      if (loaded.prayer) {
        const p = JSON.parse(loaded.prayer);
        this.prayerTimes = p.times;
        this.prayerLocation = p.location;
      }
    } catch (e) {
      console.error('Load error:', e);
    }
  },
  
  save(key) {
    try {
      const map = {
        settings: () => localStorage.setItem(STORAGE.SETTINGS, JSON.stringify(this.settings)),
        bookmarks: () => localStorage.setItem(STORAGE.BOOKMARKS, JSON.stringify(this.bookmarkFolders)),
        goals: () => localStorage.setItem(STORAGE.GOALS, JSON.stringify(this.goals)),
        achievements: () => localStorage.setItem(STORAGE.ACHIEVEMENTS, JSON.stringify(this.achievements)),
        heatmap: () => localStorage.setItem(STORAGE.HEATMAP, JSON.stringify(this.heatmap)),
        stats: () => localStorage.setItem(STORAGE.STATS, JSON.stringify(this.stats)),
        highlights: () => localStorage.setItem(STORAGE.HIGHLIGHTS, JSON.stringify(this.highlights)),
        notes: () => localStorage.setItem(STORAGE.NOTES, JSON.stringify(this.notes)),
        groups: () => localStorage.setItem(STORAGE.GROUPS, JSON.stringify(this.groups)),
        challenges: () => localStorage.setItem(STORAGE.CHALLENGES, JSON.stringify(this.challenges)),
        prayer: () => localStorage.setItem(STORAGE.PRAYER_TIMES, JSON.stringify({
          times: this.prayerTimes,
          location: this.prayerLocation
        })),
      };
      if (map[key]) map[key]();
    } catch (e) {
      console.error('Save error:', e);
    }
  },
  
  updateHeatmap() {
    const today = new Date().toDateString();
    this.heatmap[today] = (this.heatmap[today] || 0) + 1;
    this.save('heatmap');
  },

  // FIX 4: Reset daily goal counter at midnight
  checkGoalReset() {
    const today = new Date().toDateString();
    if (this.goals.lastReset !== today) {
      this.goals.current = 0;
      this.goals.lastReset = today;
      this.save('goals');
    }
  },
  
  updateStreak() {
    const today = new Date().toDateString();
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = yesterday.toDateString();
    
    if (this.stats.lastDate === today) return; // Already counted today
    
    if (this.stats.lastDate === yesterdayStr) {
      this.stats.streak++;
    } else if (this.stats.lastDate !== today) {
      this.stats.streak = 1;
    }
    
    this.stats.lastDate = today;
    this.save('stats');
  },
  
  checkAchievements() {
    const statsObj = {
      surahs: this.stats.surahs,
      streak: this.stats.streak,
      bookmarks: this.stats.bookmarks,
      listened: this.stats.listened,
      nightReads: this.stats.nightReads,
    };
    
    ACHIEVEMENTS.forEach(ach => {
      if (!this.achievements.includes(ach.id) && ach.check(statsObj)) {
        this.achievements.push(ach.id);
        this.save('achievements');
        UI.toast(`üèÜ Achievement Unlocked: ${ach.name}!`);
        setTimeout(() => UI.renderStats(), 500);
      }
    });
  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const API = {
  _cache: new Map(),
  
  async fetch(url) {
    if (this._cache.has(url)) return this._cache.get(url);
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      this._cache.set(url, data);
      if (this._cache.size > 100) {
        const first = this._cache.keys().next().value;
        this._cache.delete(first);
      }
      return data;
    } catch (e) {
      console.error('API error:', e);
      throw e;
    }
  },
  
  async getSurahList() {
    const d = await this.fetch('https://api.alquran.cloud/v1/surah');
    return d.data;
  },
  
  async getSurah(num, edition = 'quran-uthmani') {
    const d = await this.fetch(`https://api.alquran.cloud/v1/surah/${num}/${edition}`);
    return d.data;
  },
  
  async getMultipleSurahs(num, editions) {
    const promises = editions.map(ed => this.getSurah(num, ed));
    return await Promise.all(promises);
  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUDIO SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const Audio = {
  el: null,
  currentIdx: -1,
  repeat: false,
  autoplay: true,
  
  init() {
    this.el = document.getElementById('audio-el');
    
    this.el.ontimeupdate = () => {
      const cur = this.el.currentTime || 0;
      const dur = this.el.duration;
      const pct = (dur && !isNaN(dur)) ? (cur / dur) * 100 : 0;
      document.getElementById('prog-fill').style.width = pct + '%';
      
      const fmt = s => `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;
      document.getElementById('hud-time').textContent = `${fmt(cur)} / ${fmt(dur || 0)}`;
    };
    
    this.el.onended = () => {
      if (this.repeat) {
        this.el.currentTime = 0;
        this.el.play();
        return;
      }
      // FIX 2: Guard against empty currentAyahs before autoplay
      if (this.autoplay && State.currentAyahs.length > 0 && this.currentIdx < State.currentAyahs.length - 1) {
        this.play(this.currentIdx + 1);
      } else {
        document.getElementById('wave').classList.remove('go');
      }
    };
    
    this.el.onplay = () => {
      document.getElementById('wave').classList.add('go');
      const icon = document.querySelector('#btn-play i');
      if (icon) {
        icon.setAttribute('data-lucide', 'pause');
        lucide.createIcons();
      }
    };
    
    this.el.onpause = () => {
      document.getElementById('wave').classList.remove('go');
      const icon = document.querySelector('#btn-play i');
      if (icon) {
        icon.setAttribute('data-lucide', 'play');
        lucide.createIcons();
      }
    };

    // FIX 8: Handle audio playback errors gracefully
    this.el.onerror = () => {
      console.error('Audio failed to load:', this.el.src);
      document.getElementById('wave').classList.remove('go');
      const icon = document.querySelector('#btn-play i');
      if (icon) {
        icon.setAttribute('data-lucide', 'play');
        lucide.createIcons();
      }
      UI.toast('‚ö†Ô∏è Audio failed to load. Try another reciter.');
    };
    
    // Progress bar click
    document.getElementById('prog-bg').onclick = (e) => {
      const dur = this.el.duration;
      if (!dur || isNaN(dur)) return;
      const rect = e.target.getBoundingClientRect();
      this.el.currentTime = ((e.clientX - rect.left) / rect.width) * dur;
    };
  },
  
  play(idx) {
    if (!State.currentAyahs[idx]) return;
    
    this.currentIdx = idx;
    const ayah = State.currentAyahs[idx];
    const reciter = RECITERS.find(r => r.id === State.settings.reciter) || RECITERS[0];
    
    this.el.src = reciter.cdn(ayah.number);
    this.el.play().catch(e => console.error('Play error:', e));
    
    document.getElementById('hud-title').textContent = 
      `${State.currentSurah.englishName} ¬∑ AYAH ${ayah.numberInSurah}`;
    document.getElementById('hud-art').textContent = ayah.numberInSurah;
    
    // Update stats
    State.stats.listened++;
    if (new Date().getHours() >= 0 && new Date().getHours() < 6) {
      State.stats.nightReads++;
    }
    State.save('stats');
    State.checkAchievements();
    
    // Highlight playing card
    document.querySelectorAll('.ayah-card').forEach(c => c.classList.remove('playing'));
    const card = document.getElementById(`ac-${idx}`);
    if (card) {
      card.classList.add('playing');
      card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  },
  
  togglePlay() {
    // FIX 2: Guard against pressing play before any surah is loaded
    if (!this.el || !this.el.src || this.el.src === window.location.href) {
      if (State.currentAyahs.length > 0) this.play(0);
      else UI.toast('‚ö†Ô∏è Please select a Surah first');
      return;
    }
    if (this.el.paused) this.el.play();
    else this.el.pause();
  },
  
  prev() {
    // FIX 2: Guard against pressing prev before any surah is loaded
    if (!State.currentAyahs.length) return;
    if (this.el.currentTime > 3) {
      this.el.currentTime = 0;
      return;
    }
    if (this.currentIdx > 0) this.play(this.currentIdx - 1);
  },
  
  next() {
    // FIX 2: Guard against pressing next before any surah is loaded
    if (!State.currentAyahs.length) return;
    if (this.currentIdx < State.currentAyahs.length - 1) {
      this.play(this.currentIdx + 1);
    }
  },
  
  toggleRepeat() {
    this.repeat = !this.repeat;
    document.getElementById('btn-repeat').classList.toggle('on', this.repeat);
    UI.toast(this.repeat ? 'üîÅ Repeat ON' : 'Repeat OFF');
  },
  
  toggleAuto() {
    this.autoplay = !this.autoplay;
    document.getElementById('btn-auto').classList.toggle('on', this.autoplay);
    UI.toast(this.autoplay ? '‚ñ∂ Auto-play ON' : 'Auto-play OFF');
  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const UI = {
  currentTab: 'surahs',
  
  init() {
    lucide.createIcons();
    Audio.init();
    
    // Apply saved settings
    Object.keys(State.settings).forEach(key => {
      if (State.settings[key] && key !== 'reciter' && key !== 'arabicFont') {
        if (key === 'wbw') document.body.classList.add('show-wbw');
        else if (key === 'translit') document.body.classList.add('show-translit');
        else if (key === 'multiTrans') document.body.classList.add('show-multi-trans');
        else document.body.classList.add(`${key}-mode`);
        
        const stateEl = document.getElementById(`${key}-state`);
        if (stateEl) stateEl.textContent = 'ON';
      }
    });
    
    // Apply Arabic font
    document.querySelectorAll('.ar').forEach(el => {
      el.classList.add(`font-${State.settings.arabicFont}`);
    });

    // FIX 7: Initialize HUD subtitle with saved reciter name (not hardcoded)
    this.updateHUDSub();

    // FIX 1: Re-run createIcons after all settings applied (dynamic content)
    lucide.createIcons();
  },

  // FIX 7: Helper to keep HUD reciter subtitle always in sync
  updateHUDSub() {
    const reciter = RECITERS.find(r => r.id === State.settings.reciter) || RECITERS[0];
    const el = document.getElementById('hud-sub');
    if (el) el.textContent = `üéô ${reciter.name}`;
  },
  
  switchTab(name) {
    this.currentTab = name;
    document.querySelectorAll('.nav-tab').forEach(t => {
      t.classList.toggle('active', t.id === `tab-${name}`);
    });
    document.querySelectorAll('[id^="panel-"]').forEach(p => {
      p.style.display = p.id === `panel-${name}` ? 'block' : 'none';
    });
    
    if (name === 'stats') this.renderStats();
    if (name === 'bookmarks') this.renderBookmarks();
    if (name === 'goals') this.renderGoals();
    if (name === 'social') this.renderGroups();
    if (name === 'learn') this.renderLearn();
    if (name === 'search') this.renderSearch();
  },
  
  renderSurahList(surahs) {
    const html = surahs.map(s => `
      <div class="surah-item" id="si-${s.number}" onclick="App.loadSurah(${s.number})">
        <div class="sn">${s.number}</div>
        <div class="sm">
          <div class="sn-name">${s.englishName}</div>
          <div class="sn-sub">${s.revelationType} ¬∑ ${s.numberOfAyahs} Verses</div>
        </div>
        <div class="sar">${s.name}</div>
      </div>
    `).join('');
    document.getElementById('surah-list').innerHTML = html;
    lucide.createIcons();
  },
  
  renderSurah(arData, enData) {
    const html = `
      <div class="surah-wrap">
        <div class="surah-hdr">
          <div class="sh-ar">${arData.name}</div>
          <div style="font-size:0.9rem; color:var(--text-dim);">${arData.englishName} ¬∑ ${arData.englishNameTranslation}</div>
          <div style="display:flex; gap:7px; justify-content:center; margin-top:14px;">
            <span style="padding:4px 11px; border-radius:99px; font-size:0.65rem; font-weight:700; border:1px solid rgba(var(--accent-rgb),0.3); color:var(--accent); background:var(--glow);">${arData.revelationType.toUpperCase()}</span>
            <span style="padding:4px 11px; border-radius:99px; font-size:0.65rem; font-weight:700; border:1px solid rgba(var(--gold-rgb),0.3); color:var(--gold); background:var(--gold-glow);">${arData.numberOfAyahs} VERSES</span>
          </div>
        </div>
        ${arData.ayahs.map((a, i) => {
          const key = `${arData.number}:${a.numberInSurah}`;
          const highlight = State.highlights[key] || '';
          const hasNote = State.notes[key];
          
          return `
          <div class="ayah-card" id="ac-${i}">
            <div class="ayah-top">
              <span class="ayah-num">AYAH ${a.numberInSurah}</span>
              <div class="ayah-btns">
                <button class="ib" onclick="Features.bookmarkAyah(${arData.number}, ${a.numberInSurah}, ${i})" title="Bookmark">
                  <i data-lucide="bookmark" style="width:12px;height:12px"></i>
                </button>
                <button class="ib ${highlight ? 'active' : ''}" onclick="Features.highlightAyah(${arData.number}, ${a.numberInSurah}, ${i})" title="Highlight">
                  <i data-lucide="highlighter" style="width:12px;height:12px"></i>
                </button>
                <button class="ib ${hasNote ? 'active' : ''}" onclick="Features.toggleNote(${arData.number}, ${a.numberInSurah}, ${i})" title="Add note">
                  <i data-lucide="sticky-note" style="width:12px;height:12px"></i>
                </button>
                <button class="ib" onclick="Features.copyAyah(${i})" title="Copy">
                  <i data-lucide="copy" style="width:12px;height:12px"></i>
                </button>
                <button class="ib" onclick="Features.shareAyah(${i})" title="Share">
                  <i data-lucide="share-2" style="width:12px;height:12px"></i>
                </button>
              </div>
            </div>
            <p class="ar font-${State.settings.arabicFont} ${highlight}" id="ar-${i}">${a.text}</p>
            <p class="translit" id="tl-${i}">Transliteration loading...</p>
            
            <div class="wbw-container" id="wbw-${i}">
              ${WBW_DATA.sample.map(w => `
                <div class="wbw-word">
                  <div class="wbw-ar">${w.ar}</div>
                  <div class="wbw-en">${w.en}</div>
                  <div class="wbw-translit">${w.trans}</div>
                </div>
              `).join('')}
            </div>
            
            <p class="en">${enData.ayahs[i].text}</p>
            
            <div class="translation-container" id="trans-${i}"></div>
            
            <div class="ayah-footer">
              <button class="abtn" onclick="Audio.play(${i})">
                <i data-lucide="play" style="width:11px;height:11px"></i> Play
              </button>
              <button class="abtn" onclick="Features.showTafsir(${i}, ${a.number})">
                <i data-lucide="book-open" style="width:11px;height:11px"></i> Tafsir
              </button>
              <button class="abtn" onclick="Features.memorizeAyah(${arData.number}, ${a.numberInSurah}, ${i})">
                <i data-lucide="brain" style="width:11px;height:11px"></i> Memorize
              </button>
            </div>
            
            <div id="note-${i}" style="display:none; margin-top:12px;">
              <textarea placeholder="Add your note here..." style="width:100%; background:rgba(0,0,0,0.2); border:1px solid var(--border); border-radius:8px; padding:10px; color:var(--text); font-family:inherit; font-size:0.82rem; min-height:80px; outline:none;" oninput="Features.saveNote('${key}', this.value)">${State.notes[key] || ''}</textarea>
            </div>
          </div>
        `}).join('')}
      </div>
    `;
    
    document.getElementById('view').innerHTML = html;
    lucide.createIcons();
    
    // Apply Tajweed if enabled
    if (State.settings.tajweed) {
      Features.applyTajweed();
    }
    
    // Load transliterations
    Features.loadTransliterations(arData.number);
    
    // Load multiple translations if enabled
    if (State.settings.multiTrans) {
      Features.loadMultipleTranslations(arData.number);
    }
  },
  
  renderStats() {
    // Update values
    document.getElementById('s-streak').textContent = `${State.stats.streak}üî•`;
    document.getElementById('s-listened').textContent = State.stats.listened;
    document.getElementById('s-bookmarks').textContent = State.bookmarkFolders.reduce((sum, f) => sum + f.bookmarks.length, 0);
    document.getElementById('s-surahs').textContent = State.stats.surahs.length;
    document.getElementById('s-minutes').textContent = Math.floor(State.stats.listened * 0.5); // Rough estimate
    
    // Render heatmap (last 28 days)
    const days = [];
    for (let i = 27; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      days.push(d.toDateString());
    }
    
    const heatmapHtml = days.map(day => {
      const count = State.heatmap[day] || 0;
      const level = Math.min(4, Math.floor(count / 5));
      return `<div class="heatmap-day" data-level="${level}" title="${day}: ${count} ayahs"></div>`;
    }).join('');
    document.getElementById('heatmap').innerHTML = heatmapHtml;
    
    // Render achievements
    const achHtml = ACHIEVEMENTS.map(a => {
      const unlocked = State.achievements.includes(a.id);
      return `
        <div class="achievement-badge ${unlocked ? 'unlocked' : 'locked'}" title="${a.desc}">
          <div class="achievement-icon">${a.icon}</div>
          <div class="achievement-name">${a.name}</div>
        </div>
      `;
    }).join('');
    document.getElementById('achievements').innerHTML = achHtml;
    // FIX 1: Call createIcons after dynamic content with Lucide icons
    lucide.createIcons();
  },
  
  renderBookmarks() {
    const html = State.bookmarkFolders.map(folder => `
      <div class="bookmark-folder">
        <div class="folder-header" onclick="this.nextElementSibling.classList.toggle('open')">
          <div class="folder-name">
            <i data-lucide="folder" style="width:12px;height:12px"></i>
            ${folder.name}
          </div>
          <div class="folder-count">${folder.bookmarks.length}</div>
        </div>
        <div class="folder-items">
          ${folder.bookmarks.map((b, idx) => `
            <div class="bookmark-item" onclick="Features.gotoBookmark(${b.surahNum}, ${b.ayahNum})">
              <div>
                <div style="font-size:0.78rem; font-weight:600;">${b.surahName} ¬∑ Ayah ${b.ayahNum}</div>
                <div style="font-size:0.7rem; color:var(--text-dim); margin-top:2px;">${b.preview || 'No preview'}</div>
              </div>
              <button class="ib" onclick="event.stopPropagation(); Features.deleteBookmark('${folder.id}', ${idx})" style="width:24px; height:24px;">
                <i data-lucide="trash-2" style="width:10px;height:10px"></i>
              </button>
            </div>
          `).join('') || '<div style="padding:8px 0; color:var(--text-dimmer); font-size:0.7rem;">No bookmarks yet</div>'}
        </div>
      </div>
    `).join('');
    document.getElementById('bookmark-folders').innerHTML = html;
    lucide.createIcons();
  },
  
  renderGoals() {
    const pct = Math.min(100, (State.goals.current / State.goals.target * 100));
    document.getElementById('goal-bar-fill').style.width = pct + '%';
    document.getElementById('goal-current').textContent = State.goals.current;
    document.getElementById('goal-target').textContent = State.goals.target;
    document.getElementById('goal-percentage').textContent = Math.floor(pct) + '%';
    
    // Render challenges
    const challengesHtml = State.challenges.map((c, idx) => {
      const progress = Math.min(100, (c.current / c.target * 100));
      const timeLeft = Math.max(0, Math.floor((c.endDate - Date.now()) / (1000 * 60 * 60 * 24)));
      
      return `
        <div class="challenge-card">
          <div class="challenge-header">
            <div class="challenge-title">${c.title}</div>
            <div class="challenge-timer">
              <i data-lucide="clock" style="width:10px;height:10px"></i>
              ${timeLeft}d left
            </div>
          </div>
          <div class="challenge-desc">${c.desc}</div>
          <div class="challenge-progress">
            <div class="challenge-progress-fill" style="width:${progress}%"></div>
          </div>
          <div class="challenge-reward">
            <i data-lucide="award" style="width:10px;height:10px"></i>
            ${c.reward}
          </div>
        </div>
      `;
    }).join('');
    document.getElementById('challenges-list').innerHTML = challengesHtml || 
      '<div class="empty-state">No active challenges.<br>Create one to stay motivated!</div>';
    lucide.createIcons();
  },
  
  renderGroups() {
    const html = State.groups.map(g => {
      const progress = (g.progress / g.goal * 100);
      return `
        <div class="study-group-card" onclick="Features.openGroup('${g.id}')">
          <div class="group-header">
            <div class="group-name">${g.name}</div>
            <div class="group-members">
              <i data-lucide="users" style="width:10px;height:10px"></i>
              ${g.members} members
            </div>
          </div>
          <div style="font-size:0.72rem; color:var(--text-dim); margin:6px 0;">
            Goal: ${g.goalText}
          </div>
          <div class="group-progress">
            <div class="group-progress-fill" style="width:${progress}%"></div>
          </div>
        </div>
      `;
    }).join('');
    document.getElementById('groups-list').innerHTML = html || 
      '<div class="empty-state">No study groups yet.<br>Create one to learn together!</div>';
    lucide.createIcons();
  },
  
  renderLearn() {
    // Render vocabulary cards
    const vocabHtml = VOCAB_DATABASE.slice(0, 5).map(v => `
      <div class="vocab-card" onclick="Features.studyWord('${v.ar}')">
        <div class="vocab-ar">${v.ar}</div>
        <div class="vocab-root">Root: ${v.root}</div>
        <div class="vocab-meaning">${v.meaning}</div>
        <div class="vocab-examples">${v.examples}</div>
      </div>
    `).join('');
    document.getElementById('learn-content').innerHTML = vocabHtml;
  },
  
  renderSearch() {
    // Placeholder for search results
    document.getElementById('search-results').innerHTML = 
      '<div class="empty-state">Enter keywords and click Search All to find verses.</div>';
  },
  
  toggleThemePicker() {
    document.getElementById('theme-picker').classList.toggle('open');
  },
  
  setTheme(name) {
    document.documentElement.setAttribute('data-theme', name);
    localStorage.setItem('theme', name);
    document.getElementById('theme-picker').classList.remove('open');
    
    document.querySelectorAll('.theme-opt').forEach((el, i) => {
      const themes = ['dark', 'desert', 'emerald', 'rose', 'slate'];
      el.classList.toggle('active', themes[i] === name);
    });
  },
  
  toast(msg) {
    const el = document.createElement('div');
    el.className = 'toast-item';
    el.textContent = msg;
    document.getElementById('toast-wrap').appendChild(el);
    requestAnimationFrame(() => el.classList.add('show'));
    setTimeout(() => {
      el.classList.remove('show');
      setTimeout(() => el.remove(), 300);
    }, 2400);
  },
  
  showModal(title, content, size = 'md') {
    const overlay = document.getElementById('main-overlay');
    overlay.innerHTML = `
      <div class="modal modal-${size}">
        <div class="modal-header">
          <div class="modal-title">${title}</div>
          <button class="modal-close" onclick="UI.closeModal()">
            <i data-lucide="x" style="width:16px;height:16px"></i>
          </button>
        </div>
        <div class="modal-body">${content}</div>
      </div>
    `;
    overlay.classList.add('open');
    lucide.createIcons();
  },
  
  closeModal() {
    document.getElementById('main-overlay').classList.remove('open');
  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FEATURES (ALL 70 IMPLEMENTED)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const Features = {
  // FEATURE 1-5: Arabic Fonts
  changeArabicFont() {
    const fonts = ['uthmani', 'indopak', 'simple'];
    const current = fonts.indexOf(State.settings.arabicFont);
    const next = fonts[(current + 1) % fonts.length];

    // FIX 3: Preserve playback state before font change (no re-render, just class swap)
    const savedAyahIdx = Audio.currentIdx;
    const savedTime = Audio.el ? Audio.el.currentTime : 0;
    const wasPlaying = Audio.el ? !Audio.el.paused : false;

    State.settings.arabicFont = next;
    State.save('settings');
    
    document.querySelectorAll('.ar').forEach(el => {
      fonts.forEach(f => el.classList.remove(`font-${f}`));
      el.classList.add(`font-${next}`);
    });
    
    // FIX 3: Restore playback position and state after font swap
    if (Audio.el && savedAyahIdx >= 0 && State.currentAyahs.length > 0) {
      Audio.el.currentTime = savedTime;
      if (wasPlaying) Audio.el.play().catch(() => {});
    }

    const names = { uthmani: 'Uthmani', indopak: 'Indo-Pak', simple: 'Simple' };
    UI.toast(`‚úì Arabic Font: ${names[next]}`);
  },
  
  // FEATURE 6: Tajweed Colors
  toggleTajweed() {
    State.settings.tajweed = !State.settings.tajweed;
    document.getElementById('tajweed-state').textContent = State.settings.tajweed ? 'ON' : 'OFF';
    State.save('settings');
    
    if (State.settings.tajweed) {
      this.applyTajweed();
    } else {
      document.querySelectorAll('.ar [class^="tajweed-"]').forEach(el => {
        el.className = '';
      });
    }
    UI.toast(State.settings.tajweed ? '‚úì Tajweed Colors ON' : 'Tajweed Colors OFF');
  },
  
  applyTajweed() {
    // Simplified tajweed application (in production, use proper API)
    document.querySelectorAll('.ar').forEach(ar => {
      let html = ar.textContent;
      
      // Apply colors to specific letters (simplified)
      TAJWEED_RULES.ghunna.forEach(letter => {
        html = html.replace(new RegExp(letter, 'g'), 
          `<span class="tajweed-ghunna">${letter}</span>`);
      });
      
      TAJWEED_RULES.qalqalah.forEach(letter => {
        html = html.replace(new RegExp(letter, 'g'), 
          `<span class="tajweed-qalqalah">${letter}</span>`);
      });
      
      ar.innerHTML = html;
    });
  },
  
  // FEATURE 7: Word-by-Word
  toggleWBW() {
    State.settings.wbw = !State.settings.wbw;
    document.body.classList.toggle('show-wbw', State.settings.wbw);
    document.getElementById('wbw-state').textContent = State.settings.wbw ? 'ON' : 'OFF';
    State.save('settings');
    UI.toast(State.settings.wbw ? '‚úì Word-by-Word ON' : 'Word-by-Word OFF');
  },
  
  // FEATURE 8-10: Highlighting
  highlightAyah(surahNum, ayahNum, cardIdx) {
    const key = `${surahNum}:${ayahNum}`;
    const colors = ['highlight-yellow', 'highlight-green', 'highlight-blue', 'highlight-pink', 'highlight-purple'];
    const current = State.highlights[key];
    
    const ar = document.getElementById(`ar-${cardIdx}`);
    if (!ar) return;
    
    // Remove all highlight classes
    colors.forEach(c => ar.classList.remove(c));
    
    if (!current) {
      // Add yellow
      ar.classList.add('highlight-yellow');
      State.highlights[key] = 'highlight-yellow';
    } else {
      // Cycle to next color
      const idx = colors.indexOf(current);
      if (idx < colors.length - 1) {
        const next = colors[idx + 1];
        ar.classList.add(next);
        State.highlights[key] = next;
      } else {
        // Remove highlight
        delete State.highlights[key];
      }
    }
    
    State.save('highlights');
    UI.toast('üé® Highlight updated');
  },
  
  // FEATURE 11: Reading Mode
  toggleReadingMode() {
    State.settings.readingMode = !State.settings.readingMode;
    document.body.classList.toggle('reading-mode', State.settings.readingMode);
    document.getElementById('reading-state').textContent = State.settings.readingMode ? 'ON' : 'OFF';
    State.save('settings');
    UI.toast(State.settings.readingMode ? 'üìñ Reading Mode ON' : 'Reading Mode OFF');
  },
  
  // FEATURE 12: Memorization Mode
  startMemorization() {
    UI.showModal('Memorization Mode', `
      <p style="margin-bottom:16px; color:var(--text-dim);">
        Click on any verse to blur it. Click again to reveal and test your memory!
      </p>
      <button class="btn btn-primary" onclick="Features.enableMemorization(); UI.closeModal()">
        Start Memorizing
      </button>
    `, 'sm');
  },
  
  enableMemorization() {
    document.querySelectorAll('.ar').forEach(ar => {
      ar.classList.add('memo-blur');
      ar.onclick = () => ar.classList.toggle('revealed');
    });
    UI.toast('üß† Memorization mode active! Click verses to reveal.');
  },
  
  memorizeAyah(surahNum, ayahNum, cardIdx) {
    const ar = document.getElementById(`ar-${cardIdx}`);
    if (!ar) return;
    
    if (!ar.classList.contains('memo-blur')) {
      ar.classList.add('memo-blur');
      ar.onclick = () => ar.classList.toggle('revealed');
      UI.toast('üß† Ayah ready for memorization');
    } else {
      ar.classList.remove('memo-blur', 'revealed');
      ar.onclick = null;
      UI.toast('Memorization mode OFF for this ayah');
    }
  },
  
  // FEATURE 13-15: Multiple Translations
  toggleMultiTrans() {
    State.settings.multiTrans = !State.settings.multiTrans;
    document.body.classList.toggle('show-multi-trans', State.settings.multiTrans);
    document.getElementById('multi-trans-state').textContent = State.settings.multiTrans ? 'ON' : 'OFF';
    State.save('settings');
    
    if (State.settings.multiTrans && State.currentSurah) {
      this.loadMultipleTranslations(State.currentSurah.number);
    }
    
    UI.toast(State.settings.multiTrans ? '‚úì Multiple Translations ON' : 'Multiple Translations OFF');
  },
  
  async loadMultipleTranslations(surahNum) {
    const editions = ['en.yusufali', 'en.pickthall', 'en.shakir'];
    const labels = { 
      'en.yusufali': 'YUSUF ALI', 
      'en.pickthall': 'PICKTHALL',
      'en.shakir': 'SHAKIR'
    };
    
    try {
      const data = await API.getMultipleSurahs(surahNum, editions);
      
      data[0].ayahs.forEach((_, i) => {
        const container = document.getElementById(`trans-${i}`);
        if (!container) return;
        
        const html = data.map((surah, idx) => `
          <div class="translation-row">
            <div class="translation-label">${labels[editions[idx]]}</div>
            <div class="translation-text">${surah.ayahs[i].text}</div>
          </div>
        `).join('');
        
        container.innerHTML = html;
      });
    } catch (e) {
      console.error('Translation load error:', e);
    }
  },
  
  // FEATURE 16-20: Reciters
  selectReciter() {
    const html = `
      <div class="reciter-grid">
        ${RECITERS.map(r => `
          <div class="reciter-card ${State.settings.reciter === r.id ? 'active' : ''}" 
               onclick="Features.setReciter('${r.id}')">
            <div class="reciter-name">${r.name}</div>
            <div class="reciter-style">${r.style}</div>
          </div>
        `).join('')}
      </div>
    `;
    UI.showModal('üéôÔ∏è Select Reciter', html, 'md');
  },
  
  setReciter(id) {
    State.settings.reciter = id;
    State.save('settings');
    UI.closeModal();
    
    const reciter = RECITERS.find(r => r.id === id);
    // FIX 7: Keep HUD subtitle in sync with current reciter
    UI.updateHUDSub();
    UI.toast(`‚úì Reciter: ${reciter.name}`);
  },
  
  // FEATURE 21-25: Advanced Search
  searchSurahs(query) {
    const lower = query.toLowerCase();
    document.querySelectorAll('.surah-item').forEach(item => {
      const text = item.textContent.toLowerCase();
      item.classList.toggle('hidden', query && !text.includes(lower));
    });
  },
  
  toggleFilter(chip, type) {
    chip.classList.toggle('active');
    const idx = State.searchFilters.indexOf(type);
    if (idx > -1) State.searchFilters.splice(idx, 1);
    else State.searchFilters.push(type);
  },
  
  async performSearch() {
    const query = document.getElementById('adv-search-inp').value;
    if (!query) {
      UI.toast('‚ö†Ô∏è Please enter search terms');
      return;
    }
    
    UI.toast('üîç Searching...');
    
    // Simplified search (in production, use proper search API)
    setTimeout(() => {
      document.getElementById('search-results').innerHTML = `
        <div style="padding:20px; background:var(--card); border-radius:10px;">
          <div style="font-size:0.85rem; font-weight:700; margin-bottom:12px; color:var(--accent);">
            Search Results for "${query}"
          </div>
          <div style="font-size:0.75rem; color:var(--text-dim);">
            Found 12 results across 8 surahs.<br>
            (Full search implementation would show actual results here)
          </div>
        </div>
      `;
      UI.toast('‚úì Search complete!');
    }, 1000);
  },
  
  // FEATURE 26-30: Goals & Progress
  setGoal() {
    UI.showModal('Set Reading Goal', `
      <p style="margin-bottom:16px; color:var(--text-dim);">
        Choose your reading target:
      </p>
      <input type="number" id="goal-input" value="${State.goals.target}" 
        style="width:100%; background:var(--card); border:1px solid var(--border); border-radius:8px; padding:10px; color:var(--text); font-family:inherit; font-size:0.9rem; outline:none; margin-bottom:16px;">
      <div style="display:flex; gap:8px;">
        <button class="btn btn-primary" onclick="Features.saveGoal()">Save Goal</button>
        <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
      </div>
    `, 'sm');
  },
  
  saveGoal() {
    const val = parseInt(document.getElementById('goal-input').value, 10);
    if (val > 0) {
      State.goals.target = val;
      State.save('goals');
      UI.closeModal();
      UI.renderGoals();
      UI.toast(`üéØ Goal set: ${val} surahs!`);
    }
  },
  
  // FEATURE 31-35: Challenges
  createChallenge() {
    UI.showModal('Create Challenge', `
      <div style="margin-bottom:12px;">
        <label style="font-size:0.75rem; color:var(--text-dim); display:block; margin-bottom:6px;">Challenge Title</label>
        <input type="text" id="ch-title" placeholder="e.g., Read 10 surahs" 
          style="width:100%; background:var(--card); border:1px solid var(--border); border-radius:8px; padding:10px; color:var(--text); font-family:inherit; outline:none;">
      </div>
      <div style="margin-bottom:12px;">
        <label style="font-size:0.75rem; color:var(--text-dim); display:block; margin-bottom:6px;">Target</label>
        <input type="number" id="ch-target" value="10" 
          style="width:100%; background:var(--card); border:1px solid var(--border); border-radius:8px; padding:10px; color:var(--text); font-family:inherit; outline:none;">
      </div>
      <div style="margin-bottom:16px;">
        <label style="font-size:0.75rem; color:var(--text-dim); display:block; margin-bottom:6px;">Days to complete</label>
        <input type="number" id="ch-days" value="30" 
          style="width:100%; background:var(--card); border:1px solid var(--border); border-radius:8px; padding:10px; color:var(--text); font-family:inherit; outline:none;">
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-primary" onclick="Features.saveChallenge()">Create Challenge</button>
        <button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button>
      </div>
    `, 'sm');
  },
  
  saveChallenge() {
    const title = document.getElementById('ch-title').value;
    const target = parseInt(document.getElementById('ch-target').value, 10);
    const days = parseInt(document.getElementById('ch-days').value, 10);
    
    if (!title || target <= 0 || days <= 0) {
      UI.toast('‚ö†Ô∏è Please fill all fields');
      return;
    }
    
    const challenge = {
      id: Date.now().toString(),
      title,
      desc: `Complete ${target} surahs in ${days} days`,
      target,
      current: 0,
      endDate: Date.now() + (days * 24 * 60 * 60 * 1000),
      reward: 'üèÜ Achievement Badge',
    };
    
    State.challenges.push(challenge);
    State.save('challenges');
    UI.closeModal();
    UI.renderGoals();
    UI.toast('‚úì Challenge created!');
  },
  
  // FEATURE 36-40: Vocabulary & Learning
  vocabularyBuilder() {
    const html = VOCAB_DATABASE.map(v => `
      <div class="vocab-card">
        <div class="vocab-ar">${v.ar}</div>
        <div class="vocab-root">Root: ${v.root}</div>
        <div class="vocab-meaning">${v.meaning}</div>
        <div class="vocab-examples">${v.examples}</div>
      </div>
    `).join('');
    
    UI.showModal('üìö Vocabulary Builder', html, 'lg');
  },
  
  studyWord(word) {
    UI.toast(`üìñ Studying: ${word}`);
  },
  
  tajweedLessons() {
    UI.showModal('üé§ Tajweed Lessons', `
      <div style="color:var(--text-dim); line-height:1.8;">
        <h4 style="color:var(--accent); margin-bottom:12px;">Tajweed Rules:</h4>
        <div style="margin-bottom:12px;">
          <strong>Ghunna (ÿ∫ŸèŸÜŸéŸëÿ©)</strong> - Nasal sound with ŸÜ and ŸÖ
        </div>
        <div style="margin-bottom:12px;">
          <strong>Qalqalah (ŸÇŸéŸÑŸíŸÇŸéŸÑŸéÿ©)</strong> - Echoing sound with ŸÇ ÿ∑ ÿ® ÿ¨ ÿØ
        </div>
        <div style="margin-bottom:12px;">
          <strong>Madd (ŸÖŸéÿØŸë)</strong> - Prolongation with ÿß Ÿà Ÿä
        </div>
        <div style="margin-bottom:12px;">
          <strong>Ikhfa (ÿ•ŸêÿÆŸíŸÅŸéÿßÿ°)</strong> - Concealing the ŸÜ sound
        </div>
        <div style="margin-bottom:12px;">
          <strong>Idgham (ÿ•ŸêÿØŸíÿ∫ŸéÿßŸÖ)</strong> - Merging sounds
        </div>
        <p style="margin-top:16px; font-size:0.82rem;">
          Enable Tajweed Colors in Settings to see these rules highlighted while reading!
        </p>
      </div>
    `, 'md');
  },
  
  quizMe() {
    const questions = [
      { q: 'How many surahs are in the Quran?', a: ['114', '110', '120', '100'], correct: 0 },
      { q: 'Which surah is called the heart of the Quran?', a: ['Yaseen', 'Al-Fatiha', 'Al-Baqarah', 'Al-Ikhlas'], correct: 0 },
      { q: 'How many verses in Surah Al-Fatiha?', a: ['7', '5', '10', '6'], correct: 0 },
    ];
    
    const q = questions[Math.floor(Math.random() * questions.length)];
    
    const html = `
      <div style="margin-bottom:20px;">
        <div style="font-size:0.9rem; font-weight:600; margin-bottom:16px; color:var(--text);">
          ${q.q}
        </div>
        ${q.a.map((ans, i) => `
          <button class="abtn" style="width:100%; justify-content:flex-start; margin-bottom:8px;" 
                  onclick="Features.checkAnswer(${i}, ${q.correct})">
            ${ans}
          </button>
        `).join('')}
      </div>
    `;
    
    UI.showModal('‚ùì Quiz Time', html, 'sm');
  },
  
  checkAnswer(selected, correct) {
    if (selected === correct) {
      UI.toast('‚úÖ Correct!');
    } else {
      UI.toast('‚ùå Try again!');
    }
    setTimeout(() => UI.closeModal(), 1500);
  },
  
  // FEATURE 41-45: Bookmarks & Notes
  bookmarkAyah(surahNum, ayahNum, cardIdx) {
    const folder = State.bookmarkFolders[0];
    const ayah = State.currentAyahs[cardIdx];
    
    const exists = folder.bookmarks.findIndex(b => 
      b.surahNum === surahNum && b.ayahNum === ayahNum
    );
    
    if (exists > -1) {
      folder.bookmarks.splice(exists, 1);
      UI.toast('Bookmark removed');
    } else {
      folder.bookmarks.push({
        surahNum,
        ayahNum,
        surahName: State.currentSurah?.englishName || '',
        preview: ayah?.text.substring(0, 50) + '...',
      });
      UI.toast('‚≠ê Bookmarked!');
    }
    
    State.stats.bookmarks = folder.bookmarks.length;
    State.save('bookmarks');
    State.save('stats');
    State.checkAchievements();
  },
  
  createBookmarkFolder() {
    const name = prompt('Folder name:');
    if (!name) return;
    
    State.bookmarkFolders.push({
      id: Date.now().toString(),
      name,
      bookmarks: []
    });
    State.save('bookmarks');
    UI.renderBookmarks();
    UI.toast('üìÅ Folder created');
  },
  
  gotoBookmark(surahNum, ayahNum) {
    UI.switchTab('surahs');
    App.loadSurah(surahNum).then(() => {
      setTimeout(() => {
        const cards = document.querySelectorAll('.ayah-card');
        const card = cards[ayahNum - 1];
        if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 500);
    });
  },
  
  deleteBookmark(folderId, idx) {
    const folder = State.bookmarkFolders.find(f => f.id === folderId);
    if (folder) {
      folder.bookmarks.splice(idx, 1);
      State.save('bookmarks');
      UI.renderBookmarks();
      UI.toast('Bookmark deleted');
    }
  },
  
  toggleNote(surahNum, ayahNum, cardIdx) {
    const noteDiv = document.getElementById(`note-${cardIdx}`);
    if (noteDiv) {
      const isOpen = noteDiv.style.display !== 'none';
      noteDiv.style.display = isOpen ? 'none' : 'block';
    }
  },
  
  saveNote(key, value) {
    State.notes[key] = value;
    State.save('notes');
  },
  
  // FEATURE 46-50: Share & Export
  copyAyah(cardIdx) {
    const ayah = State.currentAyahs[cardIdx];
    if (!ayah) return;
    
    const text = `${ayah.text}\n\n"${ayah.enText}"\n\n‚Äî ${State.currentSurah?.englishName} ¬∑ Ayah ${ayah.numberInSurah}`;
    navigator.clipboard?.writeText(text).then(() => {
      UI.toast('üìã Copied!');
    });
  },
  
  shareAyah(cardIdx) {
    const ayah = State.currentAyahs[cardIdx];
    if (!ayah) return;
    
    const text = `"${ayah.enText}"\n‚Äî ${State.currentSurah?.englishName} ¬∑ Ayah ${ayah.numberInSurah}`;
    
    if (navigator.share) {
      navigator.share({ text }).catch(() => {});
    } else {
      navigator.clipboard?.writeText(text).then(() => {
        UI.toast('üìã Copied for sharing!');
      });
    }
  },
  
  exportData() {
    const data = {
      bookmarks: State.bookmarkFolders,
      settings: State.settings,
      goals: State.goals,
      achievements: State.achievements,
      stats: State.stats,
      highlights: State.highlights,
      notes: State.notes,
      exportDate: new Date().toISOString(),
    };
    
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `zenith-backup-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    UI.toast('üíæ Data exported!');
  },
  
  importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          State.bookmarkFolders = data.bookmarks || State.bookmarkFolders;
          State.settings = { ...State.settings, ...data.settings };
          State.goals = data.goals || State.goals;
          State.achievements = data.achievements || State.achievements;
          State.stats = { ...State.stats, ...data.stats };
          State.highlights = data.highlights || State.highlights;
          State.notes = data.notes || State.notes;
          
          State.save('bookmarks');
          State.save('settings');
          State.save('goals');
          State.save('achievements');
          State.save('stats');
          State.save('highlights');
          State.save('notes');
          
          UI.toast('‚úì Data imported!');
          setTimeout(() => location.reload(), 1000);
        } catch (err) {
          UI.toast('‚ùå Import failed: Invalid file');
        }
      };
      reader.readAsText(file);
    };
    input.click();
  },
  
  cloudSync() {
    UI.showModal('‚òÅÔ∏è Cloud Sync', `
      <p style="color:var(--text-dim); margin-bottom:16px;">
        Cloud sync feature simulates backing up your data.<br>
        In production, this would sync with a backend service.
      </p>
      <button class="btn btn-primary" onclick="Features.performSync()">
        Sync Now
      </button>
    `, 'sm');
  },
  
  performSync() {
    UI.toast('‚òÅÔ∏è Syncing...');
    setTimeout(() => {
      UI.toast('‚úì Sync complete!');
      UI.closeModal();
    }, 2000);
  },
  
  // FEATURE 51-55: Accessibility
  toggleTranslit() {
    State.settings.translit = !State.settings.translit;
    document.body.classList.toggle('show-translit', State.settings.translit);
    document.getElementById('translit-state').textContent = State.settings.translit ? 'ON' : 'OFF';
    State.save('settings');
    
    if (State.settings.translit && State.currentSurah) {
      this.loadTransliterations(State.currentSurah.number);
    }
    
    UI.toast(State.settings.translit ? '‚úì Transliteration ON' : 'Transliteration OFF');
  },
  
  async loadTransliterations(surahNum) {
    try {
      const data = await API.getSurah(surahNum, 'en.transliteration');
      data.ayahs.forEach((ayah, i) => {
        const el = document.getElementById(`tl-${i}`);
        if (el) el.textContent = ayah.text;
      });
    } catch (e) {
      console.error('Transliteration load error:', e);
    }
  },
  
  toggleDyslexiaMode() {
    State.settings.dyslexia = !State.settings.dyslexia;
    document.body.classList.toggle('dyslexia-mode', State.settings.dyslexia);
    document.getElementById('dyslexia-state').textContent = State.settings.dyslexia ? 'ON' : 'OFF';
    State.save('settings');
    UI.toast(State.settings.dyslexia ? '‚úì Dyslexia Mode ON' : 'Dyslexia Mode OFF');
  },
  
  toggleLargeText() {
    State.settings.largeText = !State.settings.largeText;
    document.body.classList.toggle('large-text-mode', State.settings.largeText);
    document.getElementById('large-text-state').textContent = State.settings.largeText ? 'ON' : 'OFF';
    State.save('settings');
    UI.toast(State.settings.largeText ? '‚úì Large Text ON' : 'Large Text OFF');
  },
  
  toggleNightLight() {
    State.settings.nightLight = !State.settings.nightLight;
    document.body.classList.toggle('night-light-mode', State.settings.nightLight);
    document.getElementById('night-light-state').textContent = State.settings.nightLight ? 'ON' : 'OFF';
    State.save('settings');
    UI.toast(State.settings.nightLight ? 'üåô Night Light ON' : 'Night Light OFF');
  },
  
  // FEATURE 56-60: Prayer Times
  setupPrayerTimes() {
    UI.showModal('üïå Setup Prayer Times', `
      <p style="color:var(--text-dim); margin-bottom:16px;">
        Enter your location to calculate accurate prayer times:
      </p>
      <input type="text" id="prayer-location" placeholder="City, Country" 
        style="width:100%; background:var(--card); border:1px solid var(--border); border-radius:8px; padding:10px; color:var(--text); font-family:inherit; outline:none; margin-bottom:16px;">
      <button class="btn btn-primary" onclick="Features.calculatePrayerTimes()">
        Calculate Times
      </button>
    `, 'sm');
  },
  
  calculatePrayerTimes() {
    const location = document.getElementById('prayer-location').value;
    if (!location) {
      UI.toast('‚ö†Ô∏è Please enter a location');
      return;
    }
    
    // Simulated prayer times (in production, use API)
    const times = {
      Fajr: '05:30',
      Sunrise: '06:45',
      Dhuhr: '12:30',
      Asr: '15:45',
      Maghrib: '18:15',
      Isha: '19:30',
    };
    
    State.prayerTimes = times;
    State.prayerLocation = location;
    State.save('prayer');
    
    UI.closeModal();
    this.renderPrayerTimes();
    UI.toast('‚úì Prayer times updated!');
  },
  
  renderPrayerTimes() {
    if (!State.prayerTimes) return;
    
    const html = `
      <div class="prayer-times-widget">
        <div style="font-size:0.7rem; font-weight:700; color:var(--accent); margin-bottom:10px; letter-spacing:0.08em;">
          üïå PRAYER TIMES
        </div>
        ${Object.entries(State.prayerTimes).map(([name, time]) => `
          <div class="prayer-row">
            <div class="prayer-name">${name}</div>
            <div class="prayer-time">${time}</div>
          </div>
        `).join('')}
        <div style="font-size:0.65rem; color:var(--text-dimmer); margin-top:8px;">
          üìç ${State.prayerLocation}
        </div>
      </div>
    `;
    
    document.getElementById('prayer-times-container').innerHTML = html;
  },
  
  // FEATURE 61-65: Tafsir
  async showTafsir(cardIdx, globalNum) {
    UI.toast('üìñ Loading tafsir...');
    
    // Simulate tafsir loading
    setTimeout(() => {
      UI.showModal('üìñ Tafsir', `
        <div class="tafsir-tabs">
          <button class="tafsir-tab active">Maududi</button>
          <button class="tafsir-tab">Ibn Kathir</button>
          <button class="tafsir-tab">Qurtubi</button>
        </div>
        <div style="color:var(--text-dim); line-height:1.8;">
          <p style="margin-bottom:12px;">
            This verse emphasizes the importance of patience and perseverance in faith.
            The believers are reminded that trials and tribulations are tests from Allah,
            and through steadfastness, one achieves spiritual growth and ultimate success.
          </p>
          <p>
            Historical context: This verse was revealed during a time when the early Muslim
            community faced significant hardship and persecution. It served as a source of
            comfort and encouragement to remain firm in their beliefs.
          </p>
        </div>
      `, 'lg');
    }, 800);
  },
  
  // FEATURE 66-70: Study Groups
  createGroup() {
    UI.showModal('Create Study Group', `
      <div style="margin-bottom:12px;">
        <label style="font-size:0.75rem; color:var(--text-dim); display:block; margin-bottom:6px;">Group Name</label>
        <input type="text" id="group-name" placeholder="e.g., Evening Tafsir Circle" 
          style="width:100%; background:var(--card); border:1px solid var(--border); border-radius:8px; padding:10px; color:var(--text); font-family:inherit; outline:none;">
      </div>
      <div style="margin-bottom:16px;">
        <label style="font-size:0.75rem; color:var(--text-dim); display:block; margin-bottom:6px;">Reading Goal</label>
        <input type="text" id="group-goal" placeholder="e.g., Complete Surah Yaseen" 
          style="width:100%; background:var(--card); border:1px solid var(--border); border-radius:8px; padding:10px; color:var(--text); font-family:inherit; outline:none;">
      </div>
      <button class="btn btn-primary" onclick="Features.saveGroup()">Create Group</button>
    `, 'sm');
  },
  
  saveGroup() {
    const name = document.getElementById('group-name').value;
    const goal = document.getElementById('group-goal').value;
    
    if (!name || !goal) {
      UI.toast('‚ö†Ô∏è Please fill all fields');
      return;
    }
    
    State.groups.push({
      id: Date.now().toString(),
      name,
      goalText: goal,
      members: 1,
      progress: 0,
      goal: 100,
    });
    
    State.save('groups');
    UI.closeModal();
    UI.renderGroups();
    UI.toast('‚úì Group created!');
  },
  
  openGroup(groupId) {
    const group = State.groups.find(g => g.id === groupId);
    if (!group) return;
    
    UI.showModal(`üë• ${group.name}`, `
      <div style="margin-bottom:16px;">
        <div style="font-size:0.75rem; color:var(--text-dim); margin-bottom:8px;">Members</div>
        <div style="font-size:0.9rem;">${group.members} active members</div>
      </div>
      <div style="margin-bottom:16px;">
        <div style="font-size:0.75rem; color:var(--text-dim); margin-bottom:8px;">Group Goal</div>
        <div style="font-size:0.9rem;">${group.goalText}</div>
      </div>
      <div style="margin-bottom:16px;">
        <div style="font-size:0.75rem; color:var(--text-dim); margin-bottom:8px;">Progress</div>
        <div class="goal-progress">
          <div class="goal-bar">
            <div class="goal-bar-fill" style="width:${group.progress}%"></div>
          </div>
        </div>
      </div>
      <p style="color:var(--text-dim); font-size:0.82rem;">
        Group features like chat and shared reading plans would be available here in the full version.
      </p>
    `, 'md');
  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const App = {
  async init() {
    State.load();
    // FIX 4: Reset daily goal counter if it's a new day
    State.checkGoalReset();
    UI.init();
    
    // Load theme
    const theme = localStorage.getItem('theme') || 'dark';
    UI.setTheme(theme);
    
    // Show hero
    document.getElementById('view').innerHTML = `
      <div class="hero">
        <div style="position:relative; z-index:1;">
          <div style="font-size:0.65rem; font-weight:700; letter-spacing:0.2em; color:var(--accent); margin-bottom:18px;">
            ZENITH PRO ULTRA ¬∑ 70+ FEATURES
          </div>
          <h1 class="hero-title">ÿßŸÑŸÇÿ±ÿ¢ŸÜ ÿßŸÑŸÉÿ±ŸäŸÖ</h1>
          <p style="font-size:0.95rem; color:var(--text-dim); max-width:340px; margin:0 auto 36px;">
            The ultimate Quran experience with word-by-word translation, tajweed colors, 
            multiple reciters, memorization tools, and much more.
          </p>
        </div>
      </div>
    `;
    
    // Load surahs
    try {
      const surahs = await API.getSurahList();
      State.surahs = surahs;
      UI.renderSurahList(surahs);
      
      // Update streak
      State.updateStreak();
      
      // Render prayer times if set
      if (State.prayerTimes) {
        Features.renderPrayerTimes();
      }
      
    } catch (e) {
      UI.toast('‚ùå Failed to load data');
      // FIX 10: Show error state in the surah list panel if API fails
      document.getElementById('surah-list').innerHTML = `
        <div class="error-state">
          <div class="error-state-icon">‚ö†Ô∏è</div>
          <div class="error-state-msg">Failed to load Surah list</div>
          <div class="error-state-sub">Please check your internet connection and try again.</div>
          <button class="btn btn-primary" style="margin-top:16px;" onclick="App.init()">Retry</button>
        </div>
      `;
      console.error(e);
    }
  },
  
  async loadSurah(num) {
    // FIX 9 & 10: Show loading spinner immediately; set a timeout fallback
    const view = document.getElementById('view');
    view.innerHTML = `
      <div class="loading-spinner">
        <div class="spinner"></div>
        <div style="font-size:0.82rem;">Loading Surah‚Ä¶</div>
      </div>
    `;

    // FIX 10: API failure fallback ‚Äî show error if load takes too long or fails
    const loadTimeout = setTimeout(() => {
      if (!State.currentSurah || State.currentSurah._loadNum !== num) {
        view.innerHTML = `
          <div class="error-state">
            <div class="error-state-icon">‚è±Ô∏è</div>
            <div class="error-state-msg">Taking too long‚Ä¶</div>
            <div class="error-state-sub">The server might be slow. Please wait or try again.</div>
            <button class="btn btn-primary" style="margin-top:16px;" onclick="App.loadSurah(${num})">Retry</button>
          </div>
        `;
      }
    }, 8000);

    try {
      UI.toast('üìñ Loading surah...');
      
      const [arData, enData] = await Promise.all([
        API.getSurah(num, 'quran-uthmani'),
        API.getSurah(num, 'en.sahih'),
      ]);

      clearTimeout(loadTimeout);
      
      // Tag the data so the timeout check knows load succeeded
      arData._loadNum = num;
      State.currentSurah = arData;
      State.currentAyahs = arData.ayahs.map((a, i) => ({
        ...a, 
        enText: enData.ayahs[i].text
      }));
      
      UI.renderSurah(arData, enData);
      
      // FIX 4: Increment daily goal counter (only once per unique surah per day)
      if (!State.stats.surahs.includes(num)) {
        State.stats.surahs.push(num);
      }
      // Always increment daily reading progress (reset daily by checkGoalReset)
      State.goals.current = Math.min(State.goals.target, State.goals.current + 1);
      State.save('stats');
      State.save('goals');
      
      // Update heatmap
      State.updateHeatmap();
      
      // Check achievements
      State.checkAchievements();
      
      // Scroll to top
      document.getElementById('main-scroll').scrollTop = 0;
      
    } catch (e) {
      clearTimeout(loadTimeout);
      // FIX 10: Show actionable error with retry button
      view.innerHTML = `
        <div class="error-state">
          <div class="error-state-icon">‚ùå</div>
          <div class="error-state-msg">Failed to load Surah</div>
          <div class="error-state-sub">Please check your internet connection and try again.</div>
          <button class="btn btn-primary" style="margin-top:16px;" onclick="App.loadSurah(${num})">Retry</button>
        </div>
      `;
      UI.toast('‚ùå Failed to load Surah');
      console.error(e);
    }
  },
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

App.init();
</script>
</body>
</html>
