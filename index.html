<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zenith | Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='%2338bdf8'/><text y='.9em' font-size='72' x='50%' text-anchor='middle' font-family='serif'>Ù‚</text></svg>">
<script src="https://unpkg.com/lucide@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Amiri+Quran&family=Scheherazade+New:wght@400;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --rail-w: 64px;
  --panel-w: 320px;
  --hud-h: 82px;
  --r: 16px;
  --t: 0.22s cubic-bezier(0.4,0,0.2,1);
  --glass-blur: 24px;
}

/* â”€â”€ THEMES â”€â”€ */
[data-theme="dark"] {
  --bg: #07090d; --surface: #0d1117; --surface2: #131920; --surface3: #1a2332;
  --accent: #38bdf8; --accent-rgb: 56,189,248; --accent2: #818cf8;
  --gold: #f4c84a; --gold-rgb: 244,200,74;
  --border: rgba(255,255,255,0.06); --border-hi: rgba(255,255,255,0.12);
  --text: #e2eaf4; --text-dim: #5a7080; --text-mid: #94aab8;
  --glow: rgba(56,189,248,0.08); --gold-glow: rgba(244,200,74,0.08);
  --hud-bg: rgba(7,9,13,0.88); --rail-bg: rgba(9,12,17,0.95);
  --panel-bg: rgba(11,15,21,0.97);
  --success: #10b981; --warning: #f59e0b; --error: #ef4444;
  --shadow: 0 8px 40px rgba(0,0,0,0.6);
  --noise-op: 0.035;
}
[data-theme="midnight"] {
  --bg: #0a0a14; --surface: #10102a; --surface2: #171730; --surface3: #1f1f3d;
  --accent: #818cf8; --accent-rgb: 129,140,248; --accent2: #c084fc;
  --gold: #fbbf24; --gold-rgb: 251,191,36;
  --border: rgba(255,255,255,0.07); --border-hi: rgba(129,140,248,0.18);
  --text: #e0e0ff; --text-dim: #5050a0; --text-mid: #9090c0;
  --glow: rgba(129,140,248,0.08); --gold-glow: rgba(251,191,36,0.08);
  --hud-bg: rgba(10,10,20,0.88); --rail-bg: rgba(8,8,18,0.96);
  --panel-bg: rgba(10,10,22,0.97);
  --success: #34d399; --warning: #fbbf24; --error: #f87171;
  --shadow: 0 8px 40px rgba(0,0,0,0.7);
  --noise-op: 0.04;
}
[data-theme="desert"] {
  --bg: #120d06; --surface: #1c1508; --surface2: #251c0c; --surface3: #302310;
  --accent: #f5a623; --accent-rgb: 245,166,35; --accent2: #f0c060;
  --gold: #fde68a; --gold-rgb: 253,230,138;
  --border: rgba(255,220,120,0.08); --border-hi: rgba(245,166,35,0.2);
  --text: #f5e6c8; --text-dim: #8a6840; --text-mid: #c0a060;
  --glow: rgba(245,166,35,0.08); --gold-glow: rgba(253,230,138,0.08);
  --hud-bg: rgba(14,10,4,0.9); --rail-bg: rgba(10,7,2,0.96);
  --panel-bg: rgba(12,9,3,0.97);
  --success: #84cc16; --warning: #f59e0b; --error: #ef4444;
  --shadow: 0 8px 40px rgba(0,0,0,0.65);
  --noise-op: 0.03;
}
[data-theme="emerald"] {
  --bg: #050f09; --surface: #0a1a10; --surface2: #0f221a; --surface3: #152e22;
  --accent: #34d399; --accent-rgb: 52,211,153; --accent2: #6ee7b7;
  --gold: #fbbf24; --gold-rgb: 251,191,36;
  --border: rgba(52,211,153,0.08); --border-hi: rgba(52,211,153,0.18);
  --text: #d1fae5; --text-dim: #2d6048; --text-mid: #6da888;
  --glow: rgba(52,211,153,0.07); --gold-glow: rgba(251,191,36,0.07);
  --hud-bg: rgba(5,10,7,0.9); --rail-bg: rgba(3,8,5,0.96);
  --panel-bg: rgba(4,9,6,0.97);
  --success: #10b981; --warning: #f59e0b; --error: #ef4444;
  --shadow: 0 8px 40px rgba(0,0,0,0.65);
  --noise-op: 0.03;
}
[data-theme="rose"] {
  --bg: #0d060d; --surface: #180d18; --surface2: #201220; --surface3: #2a1828;
  --accent: #f472b6; --accent-rgb: 244,114,182; --accent2: #e879f9;
  --gold: #fbbf24; --gold-rgb: 251,191,36;
  --border: rgba(244,114,182,0.08); --border-hi: rgba(244,114,182,0.18);
  --text: #fce7f3; --text-dim: #7c3060; --text-mid: #c08090;
  --glow: rgba(244,114,182,0.07); --gold-glow: rgba(251,191,36,0.07);
  --hud-bg: rgba(13,6,13,0.9); --rail-bg: rgba(9,4,9,0.96);
  --panel-bg: rgba(11,5,11,0.97);
  --success: #ec4899; --warning: #f59e0b; --error: #dc2626;
  --shadow: 0 8px 40px rgba(0,0,0,0.65);
  --noise-op: 0.03;
}
[data-theme="light"] {
  --bg: #f4f6fa; --surface: #ffffff; --surface2: #f0f3f8; --surface3: #e8ecf4;
  --accent: #2563eb; --accent-rgb: 37,99,235; --accent2: #7c3aed;
  --gold: #d97706; --gold-rgb: 217,119,6;
  --border: rgba(0,0,0,0.07); --border-hi: rgba(37,99,235,0.15);
  --text: #1a2035; --text-dim: #94a3b8; --text-mid: #64748b;
  --glow: rgba(37,99,235,0.06); --gold-glow: rgba(217,119,6,0.07);
  --hud-bg: rgba(255,255,255,0.92); --rail-bg: rgba(248,250,255,0.97);
  --panel-bg: rgba(252,253,255,0.98);
  --success: #10b981; --warning: #f59e0b; --error: #ef4444;
  --shadow: 0 8px 32px rgba(0,0,0,0.1);
  --noise-op: 0.015;
}
[data-theme="sepia"] {
  --bg: #f5f0e8; --surface: #faf6ee; --surface2: #f0ead8; --surface3: #e8dfc8;
  --accent: #8b4513; --accent-rgb: 139,69,19; --accent2: #a0522d;
  --gold: #b8860b; --gold-rgb: 184,134,11;
  --border: rgba(139,69,19,0.1); --border-hi: rgba(139,69,19,0.2);
  --text: #2c1a0e; --text-dim: #9a7a5a; --text-mid: #6b4a30;
  --glow: rgba(139,69,19,0.07); --gold-glow: rgba(184,134,11,0.07);
  --hud-bg: rgba(245,240,232,0.92); --rail-bg: rgba(248,244,238,0.97);
  --panel-bg: rgba(250,246,240,0.98);
  --success: #5c7a2a; --warning: #b8860b; --error: #8b1a1a;
  --shadow: 0 8px 32px rgba(0,0,0,0.08);
  --noise-op: 0.02;
}

/* â”€â”€ TYPOGRAPHY â”€â”€ */
.ar { font-family: 'Amiri Quran', serif; font-size: var(--ar-size, 2rem); direction: rtl; line-height: 2.5;
  font-feature-settings: "kern" 1; text-rendering: optimizeLegibility; -webkit-font-smoothing: antialiased; }
.ar.font-uthmani { font-family: 'Amiri Quran', serif; }
.ar.font-indopak { font-family: 'Scheherazade New', serif; font-size: calc(var(--ar-size, 2rem) * 0.92); }
.ar.font-simple { font-family: 'Scheherazade New', serif; font-size: calc(var(--ar-size, 2rem) * 0.88); }
.en { font-family: 'Lora', serif; font-style: italic; color: var(--text-mid); font-size: var(--en-size, 0.97rem); line-height: 1.85;
  -webkit-font-smoothing: antialiased; }
.translit { font-size: 0.8rem; color: var(--text-dim); font-style: italic; margin: -4px 0 12px; display: none; line-height: 1.7; font-family: 'DM Sans', sans-serif; }
body.show-translit .translit { display: block; }

/* â”€â”€ TAJWEED â”€â”€ */
.tajweed-ghunna { color: #ec4899 !important; }
.tajweed-ikhfa { color: #8b5cf6 !important; }
.tajweed-idgham { color: #10b981 !important; }
.tajweed-qalqalah { color: #ef4444 !important; }
.tajweed-madd { color: #06b6d4 !important; }

/* â”€â”€ WORD BY WORD â”€â”€ */
.wbw-container { display: none; flex-wrap: wrap; gap: 10px 14px; margin: 14px 0; direction: rtl; }
body.show-wbw .wbw-container { display: flex; }
.wbw-word { display: flex; flex-direction: column; align-items: center; gap: 3px;
  padding: 8px 10px; background: var(--glow); border-radius: 10px; border: 1px solid var(--border);
  cursor: pointer; transition: all 0.15s; }
.wbw-word:hover { background: rgba(var(--accent-rgb),0.12); transform: translateY(-2px); }
.wbw-ar { font-family: 'Amiri Quran', serif; font-size: 1.25rem; color: var(--text); }
.wbw-en { font-size: 0.68rem; color: var(--text-mid); text-align: center; }
.wbw-translit { font-size: 0.62rem; color: var(--text-dim); font-style: italic; }

/* â”€â”€ HIGHLIGHTS â”€â”€ */
.hl-yellow { background: rgba(251,191,36,0.25) !important; border-radius: 4px; }
.hl-green { background: rgba(16,185,129,0.2) !important; border-radius: 4px; }
.hl-blue { background: rgba(56,189,248,0.2) !important; border-radius: 4px; }
.hl-pink { background: rgba(236,72,153,0.2) !important; border-radius: 4px; }
.hl-purple { background: rgba(139,92,246,0.2) !important; border-radius: 4px; }

/* â”€â”€ SPECIAL MODES â”€â”€ */
body.reading-mode #main-scroll { background: var(--surface); }
body.reading-mode .ayah-card { background: transparent; border-color: transparent; box-shadow: none; padding: 20px 0; border-bottom: 1px solid var(--border); }
body.reading-mode .ar { font-size: 2.2rem; line-height: 2.8; }
body.dyslexia-mode .en { font-family: 'Verdana', sans-serif; letter-spacing: 0.04em; word-spacing: 0.18em; line-height: 2.1; }
body.large-text-mode .ar { font-size: calc(var(--ar-size,2rem)*1.4) !important; }
body.large-text-mode .en { font-size: calc(var(--en-size,0.97rem)*1.25) !important; }
body.night-light-mode { filter: sepia(0.18) hue-rotate(-8deg) brightness(0.94); }
.memo-blur { filter: blur(6px); transition: filter 0.3s; cursor: pointer; user-select: none; }
.memo-blur:hover { filter: blur(2px); }
.memo-blur.revealed { filter: none; }

/* â”€â”€ LAYOUT â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
::-webkit-scrollbar { width: 3px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-hi); border-radius: 99px; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg); color: var(--text);
  display: flex; height: 100vh; overflow: hidden;
  transition: background 0.3s, color 0.3s;
  -webkit-font-smoothing: antialiased;
}

/* noise overlay */
body::after {
  content: ''; position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
  opacity: var(--noise-op, 0.035);
}

/* â”€â”€ RAIL (icon-only sidebar) â”€â”€ */
.rail {
  width: var(--rail-w); min-width: var(--rail-w);
  background: var(--rail-bg);
  backdrop-filter: blur(var(--glass-blur));
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column; align-items: center;
  padding: 14px 0; gap: 2px; z-index: 200; position: relative;
  transition: none;
}

.rail-logo {
  width: 38px; height: 38px; border-radius: 12px;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  display: grid; place-items: center; margin-bottom: 14px;
  font-family: 'Amiri Quran', serif; font-size: 1.2rem; color: #fff;
  box-shadow: 0 4px 16px rgba(var(--accent-rgb),0.35);
  cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
  flex-shrink: 0;
}
.rail-logo:hover { transform: scale(1.06); box-shadow: 0 6px 22px rgba(var(--accent-rgb),0.5); }

.rail-btn {
  width: 42px; height: 42px; border-radius: 13px;
  background: transparent; border: 1px solid transparent;
  color: var(--text-dim); cursor: pointer;
  display: grid; place-items: center;
  transition: all var(--t); position: relative;
  flex-shrink: 0;
}
.rail-btn:hover { background: var(--glow); border-color: var(--border); color: var(--text); }
.rail-btn.active {
  background: rgba(var(--accent-rgb),0.12);
  border-color: rgba(var(--accent-rgb),0.25);
  color: var(--accent);
}
.rail-btn .tooltip {
  position: absolute; left: calc(100% + 10px); top: 50%; transform: translateY(-50%);
  background: var(--surface3); color: var(--text); border: 1px solid var(--border-hi);
  padding: 4px 10px; border-radius: 8px; font-size: 0.72rem; font-weight: 600;
  white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.15s;
  z-index: 999;
}
.rail-btn:hover .tooltip { opacity: 1; }

.rail-spacer { flex: 1; }

/* â”€â”€ PANEL (expandable content area) â”€â”€ */
.panel {
  width: 0; overflow: hidden;
  background: var(--panel-bg);
  backdrop-filter: blur(var(--glass-blur));
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  transition: width 0.28s cubic-bezier(0.4,0,0.2,1);
  z-index: 190; position: relative;
}
.panel.open { width: var(--panel-w); }

.panel-header {
  padding: 18px 16px 10px;
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0; border-bottom: 1px solid var(--border);
}
.panel-title {
  font-size: 0.75rem; font-weight: 700; letter-spacing: 0.1em;
  text-transform: uppercase; color: var(--accent);
}
.panel-close {
  width: 26px; height: 26px; border-radius: 8px; background: transparent;
  border: 1px solid var(--border); color: var(--text-dim); cursor: pointer;
  display: grid; place-items: center; transition: all var(--t);
}
.panel-close:hover { background: var(--glow); color: var(--text); }

.panel-body {
  flex: 1; overflow-y: auto; overflow-x: hidden; padding: 12px;
  min-width: var(--panel-w);
}

/* â”€â”€ SEARCH â”€â”€ */
.search-wrap { position: relative; padding: 10px 12px; flex-shrink: 0; }
.search-icon { position: absolute; left: 24px; top: 50%; transform: translateY(-50%); color: var(--text-dim); pointer-events: none; }
.search-bar { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 12px;
  padding: 9px 10px 9px 34px; color: var(--text); font-family: inherit; font-size: 0.82rem; outline: none;
  transition: border-color var(--t); }
.search-bar:focus { border-color: rgba(var(--accent-rgb),0.4); }
::placeholder { color: var(--text-dim); }

/* â”€â”€ SURAH LIST â”€â”€ */
.surah-item {
  padding: 9px 10px; border-radius: 11px; cursor: pointer;
  display: flex; align-items: center; gap: 10px; margin-bottom: 2px;
  border: 1px solid transparent; transition: all var(--t);
}
.surah-item:hover { background: var(--glow); }
.surah-item.active { background: var(--glow); border-color: rgba(var(--accent-rgb),0.2); }
.surah-item.hidden { display: none; }
.sn { width: 30px; height: 30px; border: 1px solid var(--border); border-radius: 8px;
  display: grid; place-items: center; font-size: 0.62rem; font-weight: 700; color: var(--text-dim); flex-shrink: 0; }
.sm { flex: 1; min-width: 0; }
.sn-name { font-weight: 600; font-size: 0.82rem; }
.sn-sub { font-size: 0.64rem; color: var(--text-dim); margin-top: 1px; }
.sar { font-family: 'Amiri Quran', serif; font-size: 1rem; color: var(--accent); opacity: 0.7; flex-shrink: 0; }

/* â”€â”€ RIGHT COLUMN â”€â”€ */
.right-col { display: flex; flex-direction: column; flex: 1; min-width: 0; height: 100vh; overflow: hidden; position: relative; }

/* Settings btn top right */
.top-bar {
  position: absolute; top: 14px; right: 16px; z-index: 100;
  display: flex; align-items: center; gap: 8px;
}
.top-btn {
  width: 36px; height: 36px; border-radius: 11px;
  background: var(--surface); border: 1px solid var(--border);
  color: var(--text-dim); cursor: pointer; display: grid; place-items: center;
  backdrop-filter: blur(12px); transition: all var(--t);
}
.top-btn:hover { background: var(--glow); color: var(--text); border-color: var(--border-hi); }

main { flex: 1; overflow-y: auto; position: relative; scroll-behavior: smooth; }

/* â”€â”€ HERO â”€â”€ */
.hero {
  min-height: 100%; display: flex; flex-direction: column;
  align-items: center; justify-content: center; text-align: center; padding: 48px 40px;
}
.hero-badge {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 5px 14px; border-radius: 99px; margin-bottom: 28px;
  background: var(--glow); border: 1px solid rgba(var(--accent-rgb),0.2);
  font-size: 0.65rem; font-weight: 700; letter-spacing: 0.15em; color: var(--accent);
}
.hero-title { font-family: 'Amiri Quran', serif; font-size: clamp(3.5rem, 9vw, 6.5rem); line-height: 1.2; margin-bottom: 18px; }
.hero-sub { font-size: 0.92rem; color: var(--text-mid); max-width: 320px; margin: 0 auto 40px; line-height: 1.7; }
.hero-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
.hero-btn {
  padding: 10px 22px; border-radius: 12px; font-size: 0.82rem; font-weight: 600;
  cursor: pointer; transition: all var(--t); font-family: inherit;
  display: inline-flex; align-items: center; gap: 7px;
}
.hero-btn-primary { background: var(--accent); color: #fff; border: none; box-shadow: 0 4px 20px rgba(var(--accent-rgb),0.4); }
.hero-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 28px rgba(var(--accent-rgb),0.55); }
.hero-btn-secondary { background: var(--surface2); border: 1px solid var(--border); color: var(--text); }
.hero-btn-secondary:hover { background: var(--glow); border-color: var(--border-hi); transform: translateY(-2px); }

/* â”€â”€ SURAH CONTENT â”€â”€ */
.surah-wrap { max-width: 860px; margin: 0 auto; padding: 32px 24px 120px; }

.surah-hdr {
  text-align: center; padding: 36px 24px 28px;
  background: var(--surface);
  border: 1px solid var(--border); border-radius: 22px; margin-bottom: 28px;
  box-shadow: var(--shadow);
}
.sh-ar { font-family: 'Amiri Quran', serif; font-size: clamp(2.5rem, 6vw, 4.5rem); color: var(--accent); margin-bottom: 10px; line-height: 1.3; }
.sh-name { font-size: 1rem; font-weight: 600; margin-bottom: 4px; }
.sh-sub { font-size: 0.85rem; color: var(--text-mid); margin-bottom: 16px; }
.sh-pills { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
.sh-pill {
  padding: 4px 14px; border-radius: 99px; font-size: 0.64rem; font-weight: 700; letter-spacing: 0.08em;
}

.ayah-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: var(--r);
  padding: 24px 26px; margin-bottom: 14px;
  transition: border-color var(--t), box-shadow var(--t);
  animation: fadeUp 0.3s both;
}
.ayah-card:hover { border-color: var(--border-hi); box-shadow: 0 4px 24px rgba(0,0,0,0.2); }
.ayah-card.playing { border-color: rgba(var(--accent-rgb),0.4); box-shadow: 0 0 0 1px rgba(var(--accent-rgb),0.1), 0 4px 24px rgba(var(--accent-rgb),0.1); }

.ayah-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
.ayah-num {
  font-size: 0.6rem; font-weight: 800; letter-spacing: 0.12em;
  padding: 3px 10px; border-radius: 7px;
  background: var(--glow); color: var(--accent); border: 1px solid rgba(var(--accent-rgb),0.18);
}
.ayah-btns { display: flex; gap: 4px; flex-wrap: wrap; }
.ib {
  background: transparent; border: 1px solid var(--border); color: var(--text-dim);
  width: 28px; height: 28px; border-radius: 8px; display: grid; place-items: center;
  cursor: pointer; transition: all var(--t);
}
.ib:hover { border-color: var(--accent); color: var(--accent); background: var(--glow); }
.ib.active { border-color: var(--accent); color: var(--accent); background: var(--glow); }

.ayah-footer { display: flex; gap: 6px; margin-top: 16px; flex-wrap: wrap; }
.abtn {
  display: inline-flex; align-items: center; gap: 5px;
  background: transparent; border: 1px solid var(--border); color: var(--text-dim);
  padding: 5px 12px; border-radius: 8px; font-size: 0.7rem; font-weight: 600;
  cursor: pointer; transition: all var(--t); font-family: inherit;
}
.abtn:hover { border-color: var(--accent); color: var(--accent); background: var(--glow); }
.abtn.active { border-color: var(--accent); color: var(--accent); background: var(--glow); }

/* Translation rows */
.translation-container { margin: 10px 0; display: none; }
body.show-multi-trans .translation-container { display: block; }
.translation-row { padding: 10px 14px; border-radius: 10px; margin-bottom: 6px; background: rgba(var(--accent-rgb),0.04); border-left: 2px solid var(--accent); }
.translation-label { font-size: 0.62rem; font-weight: 700; color: var(--accent); letter-spacing: 0.1em; margin-bottom: 5px; }
.translation-text { font-size: 0.87rem; line-height: 1.7; color: var(--text-mid); font-family: 'Lora', serif; font-style: italic; }

/* â”€â”€ HUD â”€â”€ */
.hud {
  height: var(--hud-h); margin: 0 12px 12px;
  background: var(--hud-bg); backdrop-filter: blur(var(--glass-blur));
  border: 1px solid var(--border-hi); border-radius: 20px;
  display: flex; align-items: center; gap: 12px; padding: 0 16px;
  box-shadow: var(--shadow);
  transition: border-color var(--t);
}
.hud-art {
  width: 44px; height: 44px; background: var(--glow);
  border: 1px solid rgba(var(--accent-rgb),0.2); border-radius: 14px;
  display: grid; place-items: center; font-family: 'Amiri Quran', serif;
  font-size: 1.05rem; color: var(--accent); flex-shrink: 0;
}
.wave { display: flex; align-items: center; gap: 2.5px; height: 20px; flex-shrink: 0; }
.wb { width: 2.5px; background: var(--accent); border-radius: 2px; height: 4px; opacity: 0.35; }
.wave.go .wb { opacity: 0.9; animation: wv 0.85s ease-in-out infinite alternate; }
.wb:nth-child(2) { animation-delay: 0.1s; }
.wb:nth-child(3) { animation-delay: 0.2s; }
.wb:nth-child(4) { animation-delay: 0.15s; }
.wb:nth-child(5) { animation-delay: 0.05s; }
.wb:nth-child(6) { animation-delay: 0.25s; }
.hud-mid { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
.hud-title { font-size: 0.68rem; font-weight: 700; color: var(--accent); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.hud-sub { font-size: 0.6rem; color: var(--text-dim); font-weight: 500; }
.hud-time { font-size: 0.6rem; color: var(--text-dim); font-weight: 600; }
.prog-bg { height: 3px; background: rgba(var(--accent-rgb),0.12); border-radius: 99px; cursor: pointer; margin-top: 2px; }
.prog-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--gold)); border-radius: 99px; transition: width 0.1s linear; }
.hud-ctrl { display: flex; align-items: center; gap: 5px; flex-shrink: 0; }
.hbtn {
  background: transparent; border: none; color: var(--text-dim);
  width: 32px; height: 32px; border-radius: 10px;
  display: grid; place-items: center; cursor: pointer; transition: all var(--t);
}
.hbtn:hover { color: var(--text); background: rgba(var(--accent-rgb),0.08); }
.hbtn.on { color: var(--accent); }
.play-btn {
  width: 42px; height: 42px; background: var(--accent); border: none;
  border-radius: 13px; cursor: pointer; display: grid; place-items: center;
  color: #fff; transition: all var(--t);
  box-shadow: 0 4px 14px rgba(var(--accent-rgb),0.4);
}
.play-btn:hover { opacity: 0.88; transform: scale(1.05); }

/* â”€â”€ MODALS â”€â”€ */
.overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6);
  backdrop-filter: blur(10px); z-index: 2000; display: none;
  align-items: center; justify-content: center; padding: 20px;
}
.overlay.open { display: flex; animation: fadeIn 0.18s ease; }
.modal {
  background: var(--surface); border: 1px solid var(--border-hi);
  border-radius: 22px; padding: 28px; max-width: 90vw; max-height: 85vh;
  overflow-y: auto; width: 100%; box-shadow: var(--shadow);
}
.modal-sm { max-width: 420px; }
.modal-md { max-width: 640px; }
.modal-lg { max-width: 880px; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 22px; padding-bottom: 14px; border-bottom: 1px solid var(--border); }
.modal-title { font-size: 1rem; font-weight: 700; color: var(--accent); }
.modal-close { background: transparent; border: none; color: var(--text-dim); cursor: pointer; padding: 4px; border-radius: 7px; transition: all var(--t); }
.modal-close:hover { color: var(--text); background: var(--glow); }
.modal-body { margin-bottom: 8px; }
.btn { padding: 9px 18px; border-radius: 10px; font-size: 0.82rem; font-weight: 600; cursor: pointer; transition: all var(--t); font-family: inherit; border: 1px solid var(--border); }
.btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); box-shadow: 0 3px 12px rgba(var(--accent-rgb),0.35); }
.btn-primary:hover { opacity: 0.88; transform: translateY(-1px); }
.btn-secondary { background: var(--surface2); color: var(--text); }

/* â”€â”€ PANEL COMPONENTS â”€â”€ */
.panel-section-title { font-size: 0.65rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-dim); margin: 16px 0 8px; }
.pabtn {
  width: 100%; display: flex; align-items: center; gap: 8px; justify-content: space-between;
  padding: 9px 12px; border-radius: 11px; border: 1px solid var(--border); background: transparent;
  color: var(--text-mid); font-size: 0.78rem; font-weight: 500; cursor: pointer; transition: all var(--t); font-family: inherit;
}
.pabtn:hover { border-color: var(--accent); color: var(--text); background: var(--glow); }
.pabtn.active { border-color: var(--accent); color: var(--accent); background: var(--glow); }
.pabtn-icon { width: 26px; height: 26px; border-radius: 7px; background: var(--glow); border: 1px solid var(--border); display: grid; place-items: center; flex-shrink: 0; }
.toggle-pill {
  width: 32px; height: 18px; border-radius: 99px; background: var(--surface3); border: 1px solid var(--border);
  display: flex; align-items: center; padding: 2px; transition: all 0.2s; flex-shrink: 0; cursor: pointer;
}
.toggle-pill.on { background: var(--accent); border-color: var(--accent); }
.toggle-pill-dot { width: 12px; height: 12px; border-radius: 50%; background: var(--text-dim); transition: all 0.2s; }
.toggle-pill.on .toggle-pill-dot { background: #fff; transform: translateX(14px); }

.reciter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.reciter-card { padding: 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all var(--t); text-align: center; }
.reciter-card:hover { border-color: var(--accent); background: var(--glow); }
.reciter-card.active { border-color: var(--accent); background: var(--glow); box-shadow: 0 0 0 1px rgba(var(--accent-rgb),0.2); }
.reciter-name { font-size: 0.77rem; font-weight: 600; color: var(--text); }
.reciter-style { font-size: 0.63rem; color: var(--text-dim); margin-top: 2px; }

.theme-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 7px; margin-top: 8px; }
.theme-swatch {
  aspect-ratio: 1; border-radius: 12px; cursor: pointer; border: 2px solid transparent;
  transition: all 0.18s; position: relative; overflow: hidden;
}
.theme-swatch.active { border-color: var(--accent); transform: scale(1.06); }
.theme-swatch:hover { transform: scale(1.04); }
.theme-label { font-size: 0.6rem; text-align: center; margin-top: 4px; color: var(--text-dim); }

.goal-bar-track { height: 7px; background: var(--surface3); border-radius: 99px; overflow: hidden; margin: 8px 0 4px; }
.goal-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--gold)); transition: width 0.5s; }

.streak-box { background: linear-gradient(135deg, rgba(var(--gold-rgb),0.12), rgba(var(--accent-rgb),0.06)); border: 1px solid rgba(var(--gold-rgb),0.2); border-radius: 14px; padding: 16px; text-align: center; margin-bottom: 12px; }
.streak-num { font-size: 2.2rem; font-weight: 800; color: var(--gold); }
.streak-label { font-size: 0.62rem; color: var(--text-dim); font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; }

.analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.analytics-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; padding: 12px; text-align: center; }
.analytics-value { font-size: 1.7rem; font-weight: 800; background: linear-gradient(135deg, var(--accent), var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.analytics-label { font-size: 0.62rem; color: var(--text-dim); margin-top: 3px; font-weight: 600; letter-spacing: 0.05em; }

.heatmap-container { display: grid; grid-template-columns: repeat(7,1fr); gap: 3px; padding: 10px; background: var(--surface2); border-radius: 12px; margin-top: 8px; }
.heatmap-day { aspect-ratio: 1; background: var(--border); border-radius: 3px; cursor: pointer; transition: transform 0.15s; }
.heatmap-day:hover { transform: scale(1.15); }
.heatmap-day[data-level="1"] { background: rgba(var(--accent-rgb),0.2); }
.heatmap-day[data-level="2"] { background: rgba(var(--accent-rgb),0.45); }
.heatmap-day[data-level="3"] { background: rgba(var(--accent-rgb),0.7); }
.heatmap-day[data-level="4"] { background: var(--accent); }

.achievement-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 7px; }
.achievement-badge { aspect-ratio: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px; cursor: pointer; transition: all var(--t); position: relative; }
.achievement-badge.unlocked { border-color: var(--gold); background: rgba(var(--gold-rgb),0.07); }
.achievement-badge.locked { opacity: 0.35; filter: grayscale(1); }
.achievement-icon { font-size: 1.6rem; margin-bottom: 3px; }
.achievement-name { font-size: 0.57rem; text-align: center; font-weight: 600; }

.bookmark-folder { background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; padding: 10px; margin-bottom: 8px; }
.folder-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding-bottom: 6px; }
.folder-name { font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; gap: 6px; }
.folder-count { font-size: 0.63rem; padding: 2px 8px; background: var(--glow); border-radius: 10px; color: var(--accent); border: 1px solid rgba(var(--accent-rgb),0.2); }
.folder-items { padding-top: 8px; border-top: 1px solid var(--border); display: none; }
.folder-items.open { display: block; }
.bookmark-item { padding: 8px; margin: 3px 0; background: var(--glow); border-radius: 8px; cursor: pointer; transition: all var(--t); display: flex; justify-content: space-between; align-items: center; }
.bookmark-item:hover { background: rgba(var(--accent-rgb),0.1); }

.challenge-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 13px; padding: 14px; margin-bottom: 8px; cursor: pointer; transition: all var(--t); }
.challenge-card:hover { border-color: var(--accent); transform: translateY(-1px); }
.challenge-title { font-size: 0.82rem; font-weight: 700; }
.challenge-timer { font-size: 0.68rem; color: var(--warning); font-weight: 700; }
.challenge-desc { font-size: 0.72rem; color: var(--text-dim); margin: 6px 0; }
.ch-progress-track { height: 5px; background: var(--surface3); border-radius: 99px; overflow: hidden; }
.ch-progress-fill { height: 100%; background: linear-gradient(90deg, var(--success), var(--gold)); transition: width 0.5s; }
.ch-reward { font-size: 0.67rem; color: var(--gold); margin-top: 6px; font-weight: 600; }

.study-group-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 7px; cursor: pointer; transition: all var(--t); }
.study-group-card:hover { border-color: var(--accent); transform: translateY(-1px); }

.vocab-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; padding: 14px; margin-bottom: 8px; cursor: pointer; transition: all var(--t); }
.vocab-card:hover { border-color: var(--accent); }
.vocab-ar { font-family: 'Amiri Quran', serif; font-size: 1.7rem; color: var(--accent); margin-bottom: 6px; }
.vocab-root { font-size: 0.68rem; color: var(--gold); font-weight: 700; letter-spacing: 0.08em; }
.vocab-meaning { font-size: 0.82rem; color: var(--text-mid); margin-top: 6px; }
.vocab-examples { font-size: 0.7rem; color: var(--text-dim); margin-top: 4px; font-style: italic; }

.prayer-row { display: flex; justify-content: space-between; align-items: center; padding: 7px 0; border-bottom: 1px solid var(--border); }
.prayer-row:last-child { border: none; }
.prayer-name { font-size: 0.8rem; }
.prayer-time { font-size: 0.75rem; font-weight: 700; color: var(--accent); }

.search-filters { display: flex; flex-wrap: wrap; gap: 5px; margin: 8px 0; }
.filter-chip { padding: 4px 10px; background: var(--glow); border: 1px solid rgba(var(--accent-rgb),0.2); border-radius: 7px; font-size: 0.68rem; font-weight: 600; color: var(--accent); cursor: pointer; transition: all var(--t); }
.filter-chip.active { background: var(--accent); color: #fff; }

.tafsir-tabs { display: flex; gap: 5px; margin-bottom: 12px; border-bottom: 1px solid var(--border); padding-bottom: 8px; flex-wrap: wrap; }
.tafsir-tab { padding: 6px 13px; background: transparent; border: none; border-radius: 7px 7px 0 0; font-size: 0.72rem; font-weight: 600; color: var(--text-dim); cursor: pointer; transition: all var(--t); font-family: inherit; }
.tafsir-tab:hover { color: var(--accent); background: var(--glow); }
.tafsir-tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }

/* â”€â”€ TOAST â”€â”€ */
.toast-wrap { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 5px; pointer-events: none; }
.toast-item { background: var(--surface3); border: 1px solid var(--border-hi); color: var(--text); padding: 9px 18px; border-radius: 12px; font-size: 0.78rem; font-weight: 600; opacity: 0; transform: translateY(10px); transition: all 0.22s; pointer-events: none; backdrop-filter: blur(12px); white-space: nowrap; }
.toast-item.show { opacity: 1; transform: translateY(0); }

/* â”€â”€ LOADING/ERROR â”€â”€ */
.loading-spinner { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; gap: 16px; color: var(--text-dim); }
.spinner { width: 34px; height: 34px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.75s linear infinite; }
.error-state { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; gap: 12px; color: var(--text-dim); text-align: center; padding: 40px; }
.empty-state { text-align: center; padding: 36px 16px; color: var(--text-dim); font-size: 0.78rem; line-height: 1.7; }

/* â”€â”€ ANIMATIONS â”€â”€ */
@keyframes fadeUp { from { opacity: 0; transform: translateY(14px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes wv { from { transform: scaleY(0.25) scaleX(0.8); } to { transform: scaleY(1.1); } }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes spin-slow { to { transform: rotate(360deg); } }
.spin { animation: spin 0.9s linear infinite; }
.spin-slow { animation: spin-slow 4s linear infinite; }
@keyframes unlock { 0%,100% { transform: scale(1); } 50% { transform: scale(1.18) rotate(4deg); } }

/* â”€â”€ ACCESSIBILITY â”€â”€ */
button:focus-visible, [tabindex]:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
</style>
</head>
<body>

<div class="overlay" id="main-overlay"></div>
<div class="toast-wrap" id="toast-wrap"></div>

<!-- ICON RAIL -->
<div class="rail" id="rail">
  <div class="rail-logo" onclick="UI.switchTab('surahs')" title="Zenith Quran">Ù‚</div>

  <button class="rail-btn active" id="rail-surahs" onclick="UI.switchTab('surahs')" aria-label="Surahs">
    <i data-lucide="book" style="width:17px;height:17px"></i>
    <span class="tooltip">Surahs</span>
  </button>
  <button class="rail-btn" id="rail-search" onclick="UI.switchTab('search')" aria-label="Search">
    <i data-lucide="search" style="width:17px;height:17px"></i>
    <span class="tooltip">Search</span>
  </button>
  <button class="rail-btn" id="rail-bookmarks" onclick="UI.switchTab('bookmarks')" aria-label="Bookmarks">
    <i data-lucide="bookmark" style="width:17px;height:17px"></i>
    <span class="tooltip">Saved</span>
  </button>
  <button class="rail-btn" id="rail-goals" onclick="UI.switchTab('goals')" aria-label="Goals">
    <i data-lucide="target" style="width:17px;height:17px"></i>
    <span class="tooltip">Goals</span>
  </button>
  <button class="rail-btn" id="rail-learn" onclick="UI.switchTab('learn')" aria-label="Learn">
    <i data-lucide="brain" style="width:17px;height:17px"></i>
    <span class="tooltip">Learn</span>
  </button>
  <button class="rail-btn" id="rail-social" onclick="UI.switchTab('social')" aria-label="Groups">
    <i data-lucide="users" style="width:17px;height:17px"></i>
    <span class="tooltip">Groups</span>
  </button>
  <button class="rail-btn" id="rail-stats" onclick="UI.switchTab('stats')" aria-label="Statistics">
    <i data-lucide="bar-chart-2" style="width:17px;height:17px"></i>
    <span class="tooltip">Stats</span>
  </button>

  <div class="rail-spacer"></div>

  <button class="rail-btn" id="rail-settings" onclick="UI.switchTab('settings')" aria-label="Settings">
    <i data-lucide="settings" style="width:17px;height:17px"></i>
    <span class="tooltip">Settings</span>
  </button>
</div>

<!-- EXPANDABLE PANEL -->
<div class="panel open" id="panel">

  <!-- SURAHS -->
  <div id="panel-surahs" class="panel-section" style="display:flex; flex-direction:column; height:100%;">
    <div class="panel-header">
      <span class="panel-title">Surahs</span>
      <button class="panel-close" onclick="UI.closePanel()" aria-label="Close panel">
        <i data-lucide="chevron-left" style="width:13px;height:13px"></i>
      </button>
    </div>
    <div class="search-wrap">
      <i data-lucide="search" class="search-icon" style="width:13px;height:13px"></i>
      <input type="text" class="search-bar" id="search-inp" placeholder="Search surahsâ€¦" oninput="Features.searchSurahs(this.value)">
    </div>
    <div style="flex:1; overflow-y:auto; padding:0 8px 8px;">
      <div id="surah-list"></div>
    </div>
  </div>

  <!-- SEARCH -->
  <div id="panel-search" class="panel-section" style="display:none; flex-direction:column; height:100%;">
    <div class="panel-header">
      <span class="panel-title">Search</span>
      <button class="panel-close" onclick="UI.closePanel()"><i data-lucide="chevron-left" style="width:13px;height:13px"></i></button>
    </div>
    <div class="panel-body">
      <input type="text" class="search-bar" id="adv-search-inp" placeholder="Keyword, topic, rootâ€¦" style="width:100%; margin-bottom:10px;">
      <div class="search-filters" id="search-filters">
        <div class="filter-chip" onclick="Features.toggleFilter(this,'makkah')">Makkah</div>
        <div class="filter-chip" onclick="Features.toggleFilter(this,'madinah')">Madinah</div>
        <div class="filter-chip" onclick="Features.toggleFilter(this,'juz1-10')">Juz 1-10</div>
        <div class="filter-chip" onclick="Features.toggleFilter(this,'juz11-20')">Juz 11-20</div>
        <div class="filter-chip" onclick="Features.toggleFilter(this,'juz21-30')">Juz 21-30</div>
      </div>
      <button class="abtn" style="width:100%; justify-content:center; margin-top:8px;" onclick="Features.performSearch()">
        <i data-lucide="search" style="width:11px;height:11px"></i> Search All
      </button>
      <div id="search-results" style="margin-top:16px;"></div>
    </div>
  </div>

  <!-- BOOKMARKS -->
  <div id="panel-bookmarks" class="panel-section" style="display:none; flex-direction:column; height:100%;">
    <div class="panel-header">
      <span class="panel-title">Saved</span>
      <button class="panel-close" onclick="UI.closePanel()"><i data-lucide="chevron-left" style="width:13px;height:13px"></i></button>
    </div>
    <div class="panel-body">
      <button class="abtn" style="width:100%; justify-content:center; margin-bottom:10px;" onclick="Features.createBookmarkFolder()">
        <i data-lucide="folder-plus" style="width:11px;height:11px"></i> New Folder
      </button>
      <div id="bookmark-folders"></div>
    </div>
  </div>

  <!-- GOALS -->
  <div id="panel-goals" class="panel-section" style="display:none; flex-direction:column; height:100%;">
    <div class="panel-header">
      <span class="panel-title">Goals</span>
      <button class="panel-close" onclick="UI.closePanel()"><i data-lucide="chevron-left" style="width:13px;height:13px"></i></button>
    </div>
    <div class="panel-body">
      <div style="font-size:0.72rem; color:var(--text-mid); margin-bottom:4px;">Daily Progress</div>
      <div class="goal-bar-track"><div class="goal-bar-fill" id="goal-bar-fill" style="width:0%"></div></div>
      <div style="display:flex; justify-content:space-between; font-size:0.67rem; color:var(--text-dim); margin-bottom:14px;">
        <span><span id="goal-current">0</span> / <span id="goal-target">20</span> Surahs</span>
        <span id="goal-percentage">0%</span>
      </div>
      <button class="abtn" style="width:100%; justify-content:center; margin-bottom:16px;" onclick="Features.setGoal()">
        <i data-lucide="target" style="width:11px;height:11px"></i> Set Goal
      </button>
      <div class="panel-section-title">Active Challenges</div>
      <div id="challenges-list"></div>
      <button class="abtn" style="width:100%; justify-content:center; margin-top:8px;" onclick="Features.createChallenge()">
        <i data-lucide="plus" style="width:11px;height:11px"></i> Create Challenge
      </button>
    </div>
  </div>

  <!-- LEARN -->
  <div id="panel-learn" class="panel-section" style="display:none; flex-direction:column; height:100%;">
    <div class="panel-header">
      <span class="panel-title">Learn</span>
      <button class="panel-close" onclick="UI.closePanel()"><i data-lucide="chevron-left" style="width:13px;height:13px"></i></button>
    </div>
    <div class="panel-body">
      <button class="pabtn" style="margin-bottom:6px;" onclick="Features.startMemorization()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="brain" style="width:12px;height:12px"></i></div> Memorization Mode</div>
        <i data-lucide="chevron-right" style="width:12px;height:12px;opacity:0.4"></i>
      </button>
      <button class="pabtn" style="margin-bottom:6px;" onclick="Features.vocabularyBuilder()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="book-open" style="width:12px;height:12px"></i></div> Vocabulary Builder</div>
        <i data-lucide="chevron-right" style="width:12px;height:12px;opacity:0.4"></i>
      </button>
      <button class="pabtn" style="margin-bottom:6px;" onclick="Features.tajweedLessons()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="mic" style="width:12px;height:12px"></i></div> Tajweed Lessons</div>
        <i data-lucide="chevron-right" style="width:12px;height:12px;opacity:0.4"></i>
      </button>
      <button class="pabtn" onclick="Features.quizMe()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="help-circle" style="width:12px;height:12px"></i></div> Quiz Me</div>
        <i data-lucide="chevron-right" style="width:12px;height:12px;opacity:0.4"></i>
      </button>
      <div id="learn-content" style="margin-top:16px;"></div>
    </div>
  </div>

  <!-- SOCIAL -->
  <div id="panel-social" class="panel-section" style="display:none; flex-direction:column; height:100%;">
    <div class="panel-header">
      <span class="panel-title">Groups</span>
      <button class="panel-close" onclick="UI.closePanel()"><i data-lucide="chevron-left" style="width:13px;height:13px"></i></button>
    </div>
    <div class="panel-body">
      <button class="abtn" style="width:100%; justify-content:center; margin-bottom:12px;" onclick="Features.createGroup()">
        <i data-lucide="users-round" style="width:11px;height:11px"></i> Create Group
      </button>
      <div id="groups-list"></div>
    </div>
  </div>

  <!-- STATS -->
  <div id="panel-stats" class="panel-section" style="display:none; flex-direction:column; height:100%;">
    <div class="panel-header">
      <span class="panel-title">Statistics</span>
      <button class="panel-close" onclick="UI.closePanel()"><i data-lucide="chevron-left" style="width:13px;height:13px"></i></button>
    </div>
    <div class="panel-body">
      <div class="streak-box">
        <div class="streak-num" id="s-streak">0ðŸ”¥</div>
        <div class="streak-label">Day Streak</div>
      </div>
      <div class="analytics-grid">
        <div class="analytics-card"><div class="analytics-value" id="s-listened">0</div><div class="analytics-label">Ayahs Heard</div></div>
        <div class="analytics-card"><div class="analytics-value" id="s-bookmarks">0</div><div class="analytics-label">Bookmarks</div></div>
        <div class="analytics-card"><div class="analytics-value" id="s-surahs">0</div><div class="analytics-label">Surahs Read</div></div>
        <div class="analytics-card"><div class="analytics-value" id="s-minutes">0</div><div class="analytics-label">Minutes</div></div>
      </div>
      <div class="panel-section-title" style="margin-top:16px;">Activity Heatmap</div>
      <div class="heatmap-container" id="heatmap"></div>
      <div class="panel-section-title" style="margin-top:16px;">Achievements</div>
      <div class="achievement-grid" id="achievements"></div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="panel-settings" class="panel-section" style="display:none; flex-direction:column; height:100%;">
    <div class="panel-header">
      <span class="panel-title">Settings</span>
      <button class="panel-close" onclick="UI.closePanel()"><i data-lucide="chevron-left" style="width:13px;height:13px"></i></button>
    </div>
    <div class="panel-body">

      <div class="panel-section-title">Theme</div>
      <div class="theme-grid" id="theme-grid">
        <div>
          <div class="theme-swatch active" id="swatch-dark" onclick="UI.setTheme('dark')" style="background:linear-gradient(135deg,#07090d,#38bdf8)" title="Dark"></div>
          <div class="theme-label">Dark</div>
        </div>
        <div>
          <div class="theme-swatch" id="swatch-midnight" onclick="UI.setTheme('midnight')" style="background:linear-gradient(135deg,#0a0a14,#818cf8)" title="Midnight"></div>
          <div class="theme-label">Midnight</div>
        </div>
        <div>
          <div class="theme-swatch" id="swatch-emerald" onclick="UI.setTheme('emerald')" style="background:linear-gradient(135deg,#050f09,#34d399)" title="Emerald"></div>
          <div class="theme-label">Emerald</div>
        </div>
        <div>
          <div class="theme-swatch" id="swatch-desert" onclick="UI.setTheme('desert')" style="background:linear-gradient(135deg,#120d06,#f5a623)" title="Desert"></div>
          <div class="theme-label">Desert</div>
        </div>
        <div>
          <div class="theme-swatch" id="swatch-rose" onclick="UI.setTheme('rose')" style="background:linear-gradient(135deg,#0d060d,#f472b6)" title="Rose"></div>
          <div class="theme-label">Rose</div>
        </div>
        <div>
          <div class="theme-swatch" id="swatch-light" onclick="UI.setTheme('light')" style="background:linear-gradient(135deg,#f4f6fa,#2563eb)" title="Light"></div>
          <div class="theme-label">Light</div>
        </div>
        <div>
          <div class="theme-swatch" id="swatch-sepia" onclick="UI.setTheme('sepia')" style="background:linear-gradient(135deg,#f5f0e8,#8b4513)" title="Sepia"></div>
          <div class="theme-label">Sepia</div>
        </div>
      </div>

      <div class="panel-section-title">Display</div>
      <button class="pabtn" style="margin-bottom:5px;" onclick="Features.toggleWBW()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="align-justify" style="width:12px;height:12px"></i></div> Word-by-Word</div>
        <div class="toggle-pill" id="pill-wbw"><div class="toggle-pill-dot"></div></div>
      </button>
      <button class="pabtn" style="margin-bottom:5px;" onclick="Features.toggleTajweed()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="palette" style="width:12px;height:12px"></i></div> Tajweed Colors</div>
        <div class="toggle-pill" id="pill-tajweed"><div class="toggle-pill-dot"></div></div>
      </button>
      <button class="pabtn" style="margin-bottom:5px;" onclick="Features.toggleTranslit()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="languages" style="width:12px;height:12px"></i></div> Transliteration</div>
        <div class="toggle-pill" id="pill-translit"><div class="toggle-pill-dot"></div></div>
      </button>
      <button class="pabtn" style="margin-bottom:5px;" onclick="Features.toggleReadingMode()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="book-open" style="width:12px;height:12px"></i></div> Reading Mode</div>
        <div class="toggle-pill" id="pill-readingMode"><div class="toggle-pill-dot"></div></div>
      </button>
      <button class="pabtn" style="margin-bottom:5px;" onclick="Features.toggleMultiTrans()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="globe" style="width:12px;height:12px"></i></div> Multi-Translation</div>
        <div class="toggle-pill" id="pill-multiTrans"><div class="toggle-pill-dot"></div></div>
      </button>
      <button class="pabtn" style="margin-bottom:5px;" onclick="Features.changeArabicFont()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="type" style="width:12px;height:12px"></i></div> Arabic Font</div>
        <span style="font-size:0.67rem; color:var(--accent);" id="font-label">Uthmani</span>
      </button>

      <div class="panel-section-title">Accessibility</div>
      <button class="pabtn" style="margin-bottom:5px;" onclick="Features.toggleDyslexiaMode()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="eye" style="width:12px;height:12px"></i></div> Dyslexia-Friendly</div>
        <div class="toggle-pill" id="pill-dyslexia"><div class="toggle-pill-dot"></div></div>
      </button>
      <button class="pabtn" style="margin-bottom:5px;" onclick="Features.toggleLargeText()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="zoom-in" style="width:12px;height:12px"></i></div> Large Text</div>
        <div class="toggle-pill" id="pill-largeText"><div class="toggle-pill-dot"></div></div>
      </button>
      <button class="pabtn" style="margin-bottom:5px;" onclick="Features.toggleNightLight()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="moon" style="width:12px;height:12px"></i></div> Night Light</div>
        <div class="toggle-pill" id="pill-nightLight"><div class="toggle-pill-dot"></div></div>
      </button>

      <div class="panel-section-title">Audio</div>
      <button class="pabtn" style="margin-bottom:5px;" onclick="Features.selectReciter()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="mic-2" style="width:12px;height:12px"></i></div> Select Reciter</div>
        <i data-lucide="chevron-right" style="width:12px;height:12px;opacity:0.4"></i>
      </button>

      <div class="panel-section-title">Prayer Times</div>
      <button class="pabtn" style="margin-bottom:5px;" onclick="Features.setupPrayerTimes()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="clock" style="width:12px;height:12px"></i></div> Setup Prayer Times</div>
        <i data-lucide="chevron-right" style="width:12px;height:12px;opacity:0.4"></i>
      </button>
      <div id="prayer-times-container"></div>

      <div class="panel-section-title">Data</div>
      <button class="pabtn" style="margin-bottom:5px;" onclick="Features.exportData()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="download" style="width:12px;height:12px"></i></div> Export Data</div>
      </button>
      <button class="pabtn" style="margin-bottom:5px;" onclick="Features.importData()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="upload" style="width:12px;height:12px"></i></div> Import Data</div>
      </button>
      <button class="pabtn" onclick="Features.cloudSync()">
        <div style="display:flex;align-items:center;gap:8px;"><div class="pabtn-icon"><i data-lucide="cloud" style="width:12px;height:12px"></i></div> Cloud Sync</div>
      </button>

    </div>
  </div>
</div>

<!-- MAIN CONTENT AREA -->
<div class="right-col">

  <!-- Settings shortcut top-right -->
  <div class="top-bar">
    <button class="top-btn" onclick="UI.switchTab('settings')" aria-label="Settings" title="Settings">
      <i data-lucide="settings" style="width:15px;height:15px"></i>
    </button>
  </div>

  <main id="main-scroll">
    <div id="view"></div>
  </main>

  <!-- HUD Player -->
  <div class="hud">
    <div class="hud-art" id="hud-art">ï·½</div>
    <div class="wave" id="wave">
      <div class="wb"></div><div class="wb"></div><div class="wb"></div>
      <div class="wb"></div><div class="wb"></div><div class="wb"></div>
    </div>
    <div class="hud-mid">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <span class="hud-title" id="hud-title">SELECT A SURAH TO BEGIN</span>
        <span class="hud-time" id="hud-time">0:00 / 0:00</span>
      </div>
      <div id="hud-sub" class="hud-sub"></div>
      <div class="prog-bg" id="prog-bg" role="progressbar" aria-label="Playback progress">
        <div class="prog-fill" id="prog-fill"></div>
      </div>
    </div>
    <div class="hud-ctrl">
      <button class="hbtn" id="btn-prev" onclick="Audio.prev()" aria-label="Previous">
        <i data-lucide="skip-back" style="width:15px;height:15px"></i>
      </button>
      <button class="play-btn" id="btn-play" onclick="Audio.togglePlay()" aria-label="Play/Pause">
        <i data-lucide="play" style="width:17px;height:17px"></i>
      </button>
      <button class="hbtn" id="btn-next" onclick="Audio.next()" aria-label="Next">
        <i data-lucide="skip-forward" style="width:15px;height:15px"></i>
      </button>
    </div>
    <div style="display:flex;align-items:center;gap:5px;">
      <button class="hbtn" id="btn-repeat" onclick="Audio.toggleRepeat()" aria-label="Repeat">
        <i data-lucide="repeat-1" style="width:14px;height:14px"></i>
      </button>
      <button class="hbtn on" id="btn-auto" onclick="Audio.toggleAuto()" aria-label="Autoplay">
        <i data-lucide="list-music" style="width:14px;height:14px"></i>
      </button>
      <button class="hbtn" onclick="Features.selectReciter()" aria-label="Reciter">
        <i data-lucide="mic" style="width:14px;height:14px"></i>
      </button>
    </div>
  </div>
</div>

<audio id="audio-el" preload="none"></audio>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORAGE = {
  BOOKMARKS:'zpu_bookmarks', STATS:'zpu_stats', SETTINGS:'zpu_settings',
  GOALS:'zpu_goals', GROUPS:'zpu_groups', CHALLENGES:'zpu_challenges',
  ACHIEVEMENTS:'zpu_achievements', HEATMAP:'zpu_heatmap',
  HIGHLIGHTS:'zpu_highlights', NOTES:'zpu_notes', PRAYER_TIMES:'zpu_prayer',
};

const RECITERS = [
  { id:'alafasy', name:'Mishary Alafasy', style:'Murattal', cdn:n=>`https://cdn.islamic.network/quran/audio/128/ar.alafasy/${n}.mp3` },
  { id:'husary', name:'Mahmoud Husary', style:'Hafs', cdn:n=>`https://cdn.islamic.network/quran/audio/128/ar.husary/${n}.mp3` },
  { id:'minshawi', name:'Mohamed Minshawi', style:'Murattal', cdn:n=>`https://cdn.islamic.network/quran/audio/128/ar.minshawi/${n}.mp3` },
  { id:'sudais', name:'Abdul Rahman Sudais', style:'Hafs', cdn:n=>`https://cdn.islamic.network/quran/audio/128/ar.abdurrahmaansudais/${n}.mp3` },
  { id:'shuraim', name:'Saud Al-Shuraim', style:'Hafs', cdn:n=>`https://cdn.islamic.network/quran/audio/128/ar.shuraim/${n}.mp3` },
  { id:'basfar', name:'Abdullah Basfar', style:'Hafs', cdn:n=>`https://cdn.islamic.network/quran/audio/128/ar.abdullahbasfar/${n}.mp3` },
];

const ACHIEVEMENTS_DEF = [
  { id:'first_read', name:'First Steps', icon:'ðŸ“–', desc:'Read your first Surah', check:s=>s.surahs.length>=1 },
  { id:'week_streak', name:'Dedicated', icon:'ðŸ”¥', desc:'7-day streak', check:s=>s.streak>=7 },
  { id:'month_streak', name:'Committed', icon:'ðŸ’ª', desc:'30-day streak', check:s=>s.streak>=30 },
  { id:'10_surahs', name:'10 Surahs', icon:'ðŸ“š', desc:'Read 10 surahs', check:s=>s.surahs.length>=10 },
  { id:'50_surahs', name:'Half Way', icon:'ðŸŒŸ', desc:'Read 50 surahs', check:s=>s.surahs.length>=50 },
  { id:'all_surahs', name:'Complete', icon:'ðŸ†', desc:'Read all Surahs', check:s=>s.surahs.length>=114 },
  { id:'100_bookmarks', name:'Collector', icon:'ðŸ“Œ', desc:'100 bookmarks', check:s=>s.bookmarks>=100 },
  { id:'1000_ayahs', name:'Listener', icon:'ðŸŽ§', desc:'1000 ayahs heard', check:s=>s.listened>=1000 },
  { id:'night_owl', name:'Night Owl', icon:'ðŸ¦‰', desc:'Read after midnight', check:s=>s.nightReads>=1 },
];

const WBW_DATA = { sample: [
  { ar:'Ø¨ÙØ³Ù’Ù…Ù', en:'In the name', trans:'Bismi' },
  { ar:'Ø§Ù„Ù„ÙŽÙ‘Ù‡Ù', en:'of Allah', trans:'Allahi' },
  { ar:'Ø§Ù„Ø±ÙŽÙ‘Ø­Ù’Ù…ÙŽÙ°Ù†Ù', en:'the Most Gracious', trans:'Ar-Rahmani' },
  { ar:'Ø§Ù„Ø±ÙŽÙ‘Ø­ÙÙŠÙ…Ù', en:'the Most Merciful', trans:'Ar-Raheem' },
]};

const TAJWEED_RULES = { ghunna:['Ù†','Ù…'], qalqalah:['Ù‚','Ø·','Ø¨','Ø¬','Ø¯'] };

const VOCAB_DATABASE = [
  { ar:'ØµÙŽÙ„ÙŽØ§Ø©', root:'Øµ Ù„ Ùˆ', meaning:'Prayer, connection with Allah', examples:'Used 99 times in Quran' },
  { ar:'ØµÙŽØ¨Ù’Ø±', root:'Øµ Ø¨ Ø±', meaning:'Patience, perseverance', examples:'Mentioned in 2:45, 2:153, 3:200' },
  { ar:'Ø±ÙŽØ­Ù’Ù…ÙŽØ©', root:'Ø± Ø­ Ù…', meaning:'Mercy, compassion', examples:'From the same root as Ar-Rahman' },
  { ar:'Ø´ÙÙƒÙ’Ø±', root:'Ø´ Ùƒ Ø±', meaning:'Gratitude, thankfulness', examples:'Related to Shakoor (Most Appreciative)' },
  { ar:'Ø¥ÙÙŠÙ…ÙŽØ§Ù†', root:'Ø£ Ù… Ù†', meaning:'Faith, belief', examples:'Core concept appearing 800+ times' },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const State = {
  surahs:[], currentSurah:null, currentAyahs:[], currentIdx:-1,
  settings:{ reciter:'alafasy', wbw:false, tajweed:false, translit:false,
    readingMode:false, multiTrans:false, dyslexia:false, largeText:false, nightLight:false, arabicFont:'uthmani' },
  bookmarkFolders:[{ id:'default', name:'My Bookmarks', bookmarks:[] }],
  highlights:{}, notes:{},
  goals:{ type:'surahs', target:20, current:0, customTarget:null, lastReset:null },
  challenges:[], achievements:[],
  stats:{ surahs:[], listened:0, minutes:0, streak:0, lastDate:null, bookmarks:0, nightReads:0 },
  heatmap:{}, groups:[], prayerTimes:null, prayerLocation:null, searchFilters:[], memorizing:[],

  load() {
    try {
      const d = k => localStorage.getItem(k);
      const p = s => { try { return JSON.parse(s); } catch(e){ return null; } };
      const s = p(d(STORAGE.SETTINGS)); if(s) this.settings={...this.settings,...s};
      const b = p(d(STORAGE.BOOKMARKS)); if(b) this.bookmarkFolders=b;
      const g = p(d(STORAGE.GOALS)); if(g) this.goals={...this.goals,...g};
      const a = p(d(STORAGE.ACHIEVEMENTS)); if(a) this.achievements=a;
      const h = p(d(STORAGE.HEATMAP)); if(h) this.heatmap=h;
      const st= p(d(STORAGE.STATS)); if(st) this.stats={...this.stats,...st};
      const hl= p(d(STORAGE.HIGHLIGHTS)); if(hl) this.highlights=hl;
      const n = p(d(STORAGE.NOTES)); if(n) this.notes=n;
      const gr= p(d(STORAGE.GROUPS)); if(gr) this.groups=gr;
      const ch= p(d(STORAGE.CHALLENGES)); if(ch) this.challenges=ch;
      const pr= p(d(STORAGE.PRAYER_TIMES)); if(pr){ this.prayerTimes=pr.times; this.prayerLocation=pr.location; }
    } catch(e){ console.error('Load error',e); }
  },

  save(key) {
    try {
      const m = {
        settings:()=>localStorage.setItem(STORAGE.SETTINGS,JSON.stringify(this.settings)),
        bookmarks:()=>localStorage.setItem(STORAGE.BOOKMARKS,JSON.stringify(this.bookmarkFolders)),
        goals:()=>localStorage.setItem(STORAGE.GOALS,JSON.stringify(this.goals)),
        achievements:()=>localStorage.setItem(STORAGE.ACHIEVEMENTS,JSON.stringify(this.achievements)),
        heatmap:()=>localStorage.setItem(STORAGE.HEATMAP,JSON.stringify(this.heatmap)),
        stats:()=>localStorage.setItem(STORAGE.STATS,JSON.stringify(this.stats)),
        highlights:()=>localStorage.setItem(STORAGE.HIGHLIGHTS,JSON.stringify(this.highlights)),
        notes:()=>localStorage.setItem(STORAGE.NOTES,JSON.stringify(this.notes)),
        groups:()=>localStorage.setItem(STORAGE.GROUPS,JSON.stringify(this.groups)),
        challenges:()=>localStorage.setItem(STORAGE.CHALLENGES,JSON.stringify(this.challenges)),
        prayer:()=>localStorage.setItem(STORAGE.PRAYER_TIMES,JSON.stringify({times:this.prayerTimes,location:this.prayerLocation})),
      };
      if(m[key]) m[key]();
    } catch(e){ console.error('Save error',e); }
  },

  updateHeatmap() {
    const t = new Date().toDateString();
    this.heatmap[t] = (this.heatmap[t]||0)+1;
    this.save('heatmap');
  },

  checkGoalReset() {
    const t = new Date().toDateString();
    if(this.goals.lastReset!==t){ this.goals.current=0; this.goals.lastReset=t; this.save('goals'); }
  },

  updateStreak() {
    const today = new Date().toDateString();
    const yest = new Date(); yest.setDate(yest.getDate()-1);
    const ys = yest.toDateString();
    if(this.stats.lastDate===today) return;
    if(this.stats.lastDate===ys) this.stats.streak++;
    else this.stats.streak=1;
    this.stats.lastDate=today; this.save('stats');
  },

  checkAchievements() {
    const so = { surahs:this.stats.surahs, streak:this.stats.streak, bookmarks:this.stats.bookmarks, listened:this.stats.listened, nightReads:this.stats.nightReads };
    ACHIEVEMENTS_DEF.forEach(a => {
      if(!this.achievements.includes(a.id) && a.check(so)) {
        this.achievements.push(a.id); this.save('achievements');
        UI.toast(`ðŸ† Achievement: ${a.name}!`);
        setTimeout(()=>UI.renderStats(),600);
      }
    });
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = {
  _cache: new Map(),
  async fetch(url) {
    if(this._cache.has(url)) return this._cache.get(url);
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    this._cache.set(url, data);
    if(this._cache.size>120){ this._cache.delete(this._cache.keys().next().value); }
    return data;
  },
  async getSurahList(){ const d=await this.fetch('https://api.alquran.cloud/v1/surah'); return d.data; },
  async getSurah(n,ed='quran-uthmani'){ const d=await this.fetch(`https://api.alquran.cloud/v1/surah/${n}/${ed}`); return d.data; },
  async getMultipleSurahs(n,eds){ return Promise.all(eds.map(ed=>this.getSurah(n,ed))); },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Audio = {
  el:null, currentIdx:-1, repeat:false, autoplay:true,

  init() {
    this.el = document.getElementById('audio-el');

    this.el.ontimeupdate = () => {
      const cur=this.el.currentTime||0, dur=this.el.duration;
      const pct=(dur&&!isNaN(dur))?(cur/dur)*100:0;
      document.getElementById('prog-fill').style.width=pct+'%';
      const fmt=s=>`${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;
      document.getElementById('hud-time').textContent=`${fmt(cur)} / ${fmt(dur||0)}`;
    };

    this.el.onended = () => {
      if(this.repeat){ this.el.currentTime=0; this.el.play(); return; }
      if(this.autoplay && State.currentAyahs.length>0 && this.currentIdx<State.currentAyahs.length-1){
        this.play(this.currentIdx+1);
      } else { document.getElementById('wave').classList.remove('go'); }
    };

    this.el.onplay = () => {
      document.getElementById('wave').classList.add('go');
      const ic=document.querySelector('#btn-play i');
      if(ic){ ic.setAttribute('data-lucide','pause'); lucide.createIcons(); }
    };

    this.el.onpause = () => {
      document.getElementById('wave').classList.remove('go');
      const ic=document.querySelector('#btn-play i');
      if(ic){ ic.setAttribute('data-lucide','play'); lucide.createIcons(); }
    };

    this.el.onerror = () => {
      document.getElementById('wave').classList.remove('go');
      const ic=document.querySelector('#btn-play i');
      if(ic){ ic.setAttribute('data-lucide','play'); lucide.createIcons(); }
      UI.toast('âš ï¸ Audio failed â€” try another reciter');
    };

    document.getElementById('prog-bg').onclick = (e) => {
      const dur=this.el.duration;
      if(!dur||isNaN(dur)) return;
      const r=e.currentTarget.getBoundingClientRect();
      this.el.currentTime=((e.clientX-r.left)/r.width)*dur;
    };
  },

  play(idx) {
    if(!State.currentAyahs[idx]) return;
    this.currentIdx=idx;
    const ayah=State.currentAyahs[idx];
    const rec=RECITERS.find(r=>r.id===State.settings.reciter)||RECITERS[0];
    this.el.src=rec.cdn(ayah.number);
    this.el.play().catch(e=>console.error('Play error',e));
    document.getElementById('hud-title').textContent=`${State.currentSurah.englishName} Â· AYAH ${ayah.numberInSurah}`;
    document.getElementById('hud-art').textContent=ayah.numberInSurah;
    State.stats.listened++;
    if(new Date().getHours()<6) State.stats.nightReads++;
    State.save('stats'); State.checkAchievements();
    document.querySelectorAll('.ayah-card').forEach(c=>c.classList.remove('playing'));
    const card=document.getElementById(`ac-${idx}`);
    if(card){ card.classList.add('playing'); card.scrollIntoView({behavior:'smooth',block:'nearest'}); }
  },

  togglePlay() {
    if(!this.el||!this.el.src||this.el.src===window.location.href){
      if(State.currentAyahs.length>0) this.play(0);
      else UI.toast('âš ï¸ Select a Surah first');
      return;
    }
    if(this.el.paused) this.el.play(); else this.el.pause();
  },

  prev() {
    if(!State.currentAyahs.length) return;
    if(this.el.currentTime>3){ this.el.currentTime=0; return; }
    if(this.currentIdx>0) this.play(this.currentIdx-1);
  },

  next() {
    if(!State.currentAyahs.length) return;
    if(this.currentIdx<State.currentAyahs.length-1) this.play(this.currentIdx+1);
  },

  toggleRepeat() {
    this.repeat=!this.repeat;
    document.getElementById('btn-repeat').classList.toggle('on',this.repeat);
    UI.toast(this.repeat?'ðŸ” Repeat ON':'Repeat OFF');
  },

  toggleAuto() {
    this.autoplay=!this.autoplay;
    document.getElementById('btn-auto').classList.toggle('on',this.autoplay);
    UI.toast(this.autoplay?'â–¶ Autoplay ON':'Autoplay OFF');
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const UI = {
  currentTab:'surahs',
  panelOpen:true,

  init() {
    lucide.createIcons();
    Audio.init();

    // Apply saved booleans
    const s=State.settings;
    const classMap={ wbw:'show-wbw', translit:'show-translit', multiTrans:'show-multi-trans',
      readingMode:'reading-mode', dyslexia:'dyslexia-mode', largeText:'large-text-mode', nightLight:'night-light-mode' };
    Object.entries(classMap).forEach(([k,cls])=>{
      if(s[k]){ document.body.classList.add(cls); const p=document.getElementById(`pill-${k}`); if(p) p.classList.add('on'); }
    });
    document.querySelectorAll('.ar').forEach(el=>el.classList.add(`font-${s.arabicFont}`));
    const fontNames={ uthmani:'Uthmani', indopak:'Indo-Pak', simple:'Simple' };
    const fl=document.getElementById('font-label'); if(fl) fl.textContent=fontNames[s.arabicFont]||'Uthmani';
    this.updateHUDSub();
    lucide.createIcons();
  },

  updateHUDSub() {
    const rec=RECITERS.find(r=>r.id===State.settings.reciter)||RECITERS[0];
    const el=document.getElementById('hud-sub'); if(el) el.textContent=`ðŸŽ™ ${rec.name}`;
  },

  switchTab(name) {
    // toggle panel or switch content
    if(this.currentTab===name && this.panelOpen){ this.closePanel(); return; }

    this.currentTab=name; this.panelOpen=true;
    document.getElementById('panel').classList.add('open');

    document.querySelectorAll('.rail-btn').forEach(b=>b.classList.remove('active'));
    const rb=document.getElementById(`rail-${name}`); if(rb) rb.classList.add('active');

    document.querySelectorAll('.panel-section').forEach(p=>{
      p.style.display=(p.id===`panel-${name}`)?'flex':'none';
    });

    if(name==='stats') this.renderStats();
    if(name==='bookmarks') this.renderBookmarks();
    if(name==='goals') this.renderGoals();
    if(name==='social') this.renderGroups();
    if(name==='learn') this.renderLearn();
    if(name==='search') this.renderSearch();
    lucide.createIcons();
  },

  closePanel() {
    this.panelOpen=false;
    document.getElementById('panel').classList.remove('open');
    document.querySelectorAll('.rail-btn').forEach(b=>b.classList.remove('active'));
  },

  setTheme(name) {
    document.documentElement.setAttribute('data-theme',name);
    localStorage.setItem('theme',name);
    document.querySelectorAll('.theme-swatch').forEach(s=>s.classList.remove('active'));
    const sw=document.getElementById(`swatch-${name}`); if(sw) sw.classList.add('active');
    // Update favicon color
    const colors={dark:'%2338bdf8',midnight:'%23818cf8',desert:'%23f5a623',emerald:'%2334d399',rose:'%23f472b6',light:'%232563eb',sepia:'%238b4513'};
    const c=colors[name]||'%2338bdf8';
    document.querySelector('link[rel="icon"]').href=`data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='${c}'/><text y='.9em' font-size='72' x='50%25' text-anchor='middle' font-family='serif'>Ù‚</text></svg>`;
  },

  toast(msg) {
    const el=document.createElement('div'); el.className='toast-item'; el.textContent=msg;
    document.getElementById('toast-wrap').appendChild(el);
    requestAnimationFrame(()=>el.classList.add('show'));
    setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),300); },2600);
  },

  showModal(title,content,size='md') {
    const ov=document.getElementById('main-overlay');
    ov.innerHTML=`<div class="modal modal-${size}"><div class="modal-header"><div class="modal-title">${title}</div><button class="modal-close" onclick="UI.closeModal()"><i data-lucide="x" style="width:16px;height:16px"></i></button></div><div class="modal-body">${content}</div></div>`;
    ov.classList.add('open'); lucide.createIcons();
  },

  closeModal() { document.getElementById('main-overlay').classList.remove('open'); },

  renderSurahList(surahs) {
    document.getElementById('surah-list').innerHTML=surahs.map(s=>`
      <div class="surah-item" id="si-${s.number}" onclick="App.loadSurah(${s.number})">
        <div class="sn">${s.number}</div>
        <div class="sm"><div class="sn-name">${s.englishName}</div><div class="sn-sub">${s.revelationType} Â· ${s.numberOfAyahs} ayahs</div></div>
        <div class="sar">${s.name}</div>
      </div>`).join('');
    lucide.createIcons();
  },

  renderSurah(arData,enData) {
    const html=`<div class="surah-wrap">
      <div class="surah-hdr">
        <div class="sh-ar">${arData.name}</div>
        <div class="sh-name">${arData.englishName}</div>
        <div class="sh-sub">${arData.englishNameTranslation}</div>
        <div class="sh-pills">
          <span class="sh-pill" style="background:rgba(var(--accent-rgb),0.1);color:var(--accent);border:1px solid rgba(var(--accent-rgb),0.2);">${arData.revelationType.toUpperCase()}</span>
          <span class="sh-pill" style="background:rgba(var(--gold-rgb),0.1);color:var(--gold);border:1px solid rgba(var(--gold-rgb),0.2);">${arData.numberOfAyahs} VERSES</span>
        </div>
      </div>
      ${arData.ayahs.map((a,i)=>{
        const key=`${arData.number}:${a.numberInSurah}`;
        const hl=State.highlights[key]||'';
        const hasNote=State.notes[key];
        return `<div class="ayah-card" id="ac-${i}">
          <div class="ayah-top">
            <span class="ayah-num">AYAH ${a.numberInSurah}</span>
            <div class="ayah-btns">
              <button class="ib" onclick="Features.bookmarkAyah(${arData.number},${a.numberInSurah},${i})" title="Bookmark"><i data-lucide="bookmark" style="width:12px;height:12px"></i></button>
              <button class="ib ${hl?'active':''}" onclick="Features.highlightAyah(${arData.number},${a.numberInSurah},${i})" title="Highlight"><i data-lucide="highlighter" style="width:12px;height:12px"></i></button>
              <button class="ib ${hasNote?'active':''}" onclick="Features.toggleNote(${arData.number},${a.numberInSurah},${i})" title="Note"><i data-lucide="sticky-note" style="width:12px;height:12px"></i></button>
              <button class="ib" onclick="Features.copyAyah(${i})" title="Copy"><i data-lucide="copy" style="width:12px;height:12px"></i></button>
              <button class="ib" onclick="Features.shareAyah(${i})" title="Share"><i data-lucide="share-2" style="width:12px;height:12px"></i></button>
            </div>
          </div>
          <p class="ar font-${State.settings.arabicFont} ${hl}" id="ar-${i}">${a.text}</p>
          <p class="translit" id="tl-${i}">Loading transliterationâ€¦</p>
          <div class="wbw-container" id="wbw-${i}">${WBW_DATA.sample.map(w=>`<div class="wbw-word"><div class="wbw-ar">${w.ar}</div><div class="wbw-en">${w.en}</div><div class="wbw-translit">${w.trans}</div></div>`).join('')}</div>
          <p class="en">${enData.ayahs[i].text}</p>
          <div class="translation-container" id="trans-${i}"></div>
          <div class="ayah-footer">
            <button class="abtn" onclick="Audio.play(${i})"><i data-lucide="play" style="width:10px;height:10px"></i> Play</button>
            <button class="abtn" onclick="Features.showTafsir(${i},${a.number})"><i data-lucide="book-open" style="width:10px;height:10px"></i> Tafsir</button>
            <button class="abtn" onclick="Features.memorizeAyah(${arData.number},${a.numberInSurah},${i})"><i data-lucide="brain" style="width:10px;height:10px"></i> Memorize</button>
          </div>
          <div id="note-${i}" style="display:none; margin-top:12px;">
            <textarea placeholder="Add your noteâ€¦" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px;color:var(--text);font-family:inherit;font-size:0.82rem;min-height:80px;outline:none;resize:vertical;" oninput="Features.saveNote('${key}',this.value)">${State.notes[key]||''}</textarea>
          </div>
        </div>`;
      }).join('')}
    </div>`;
    document.getElementById('view').innerHTML=html;
    lucide.createIcons();
    if(State.settings.tajweed) Features.applyTajweed();
    Features.loadTransliterations(arData.number);
    if(State.settings.multiTrans) Features.loadMultipleTranslations(arData.number);
  },

  renderStats() {
    document.getElementById('s-streak').textContent=`${State.stats.streak}ðŸ”¥`;
    document.getElementById('s-listened').textContent=State.stats.listened;
    document.getElementById('s-bookmarks').textContent=State.bookmarkFolders.reduce((s,f)=>s+f.bookmarks.length,0);
    document.getElementById('s-surahs').textContent=State.stats.surahs.length;
    document.getElementById('s-minutes').textContent=Math.floor(State.stats.listened*0.5);
    const days=[]; for(let i=27;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); days.push(d.toDateString()); }
    document.getElementById('heatmap').innerHTML=days.map(day=>{
      const c=State.heatmap[day]||0; return `<div class="heatmap-day" data-level="${Math.min(4,Math.floor(c/5))}" title="${day}: ${c}"></div>`;
    }).join('');
    document.getElementById('achievements').innerHTML=ACHIEVEMENTS_DEF.map(a=>{
      const u=State.achievements.includes(a.id);
      return `<div class="achievement-badge ${u?'unlocked':'locked'}" title="${a.desc}"><div class="achievement-icon">${a.icon}</div><div class="achievement-name">${a.name}</div></div>`;
    }).join('');
    lucide.createIcons();
  },

  renderBookmarks() {
    document.getElementById('bookmark-folders').innerHTML=State.bookmarkFolders.map(folder=>`
      <div class="bookmark-folder">
        <div class="folder-header" onclick="this.nextElementSibling.classList.toggle('open')">
          <div class="folder-name"><i data-lucide="folder" style="width:12px;height:12px"></i>${folder.name}</div>
          <div class="folder-count">${folder.bookmarks.length}</div>
        </div>
        <div class="folder-items">
          ${folder.bookmarks.map((b,idx)=>`
            <div class="bookmark-item" onclick="Features.gotoBookmark(${b.surahNum},${b.ayahNum})">
              <div><div style="font-size:0.77rem;font-weight:600;">${b.surahName} Â· Ayah ${b.ayahNum}</div><div style="font-size:0.68rem;color:var(--text-dim);margin-top:1px;">${b.preview||'No preview'}</div></div>
              <button class="ib" onclick="event.stopPropagation();Features.deleteBookmark('${folder.id}',${idx})" style="width:24px;height:24px;"><i data-lucide="trash-2" style="width:10px;height:10px"></i></button>
            </div>`).join('')||'<div style="padding:8px;font-size:0.7rem;color:var(--text-dim);">No bookmarks yet</div>'}
        </div>
      </div>`).join('');
    lucide.createIcons();
  },

  renderGoals() {
    const pct=Math.min(100,(State.goals.current/State.goals.target*100));
    document.getElementById('goal-bar-fill').style.width=pct+'%';
    document.getElementById('goal-current').textContent=State.goals.current;
    document.getElementById('goal-target').textContent=State.goals.target;
    document.getElementById('goal-percentage').textContent=Math.floor(pct)+'%';
    document.getElementById('challenges-list').innerHTML=State.challenges.map(c=>{
      const p=Math.min(100,(c.current/c.target*100));
      const t=Math.max(0,Math.floor((c.endDate-Date.now())/(1000*60*60*24)));
      return `<div class="challenge-card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><div class="challenge-title">${c.title}</div><div class="challenge-timer">${t}d left</div></div><div class="challenge-desc">${c.desc}</div><div class="ch-progress-track"><div class="ch-progress-fill" style="width:${p}%"></div></div><div class="ch-reward">ðŸ† ${c.reward}</div></div>`;
    }).join('')||'<div class="empty-state">No active challenges</div>';
    lucide.createIcons();
  },

  renderGroups() {
    document.getElementById('groups-list').innerHTML=State.groups.map(g=>`
      <div class="study-group-card" onclick="Features.openGroup('${g.id}')">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <div style="font-size:0.82rem;font-weight:700;">${g.name}</div>
          <div style="font-size:0.65rem;color:var(--text-dim);">${g.members} members</div>
        </div>
        <div style="font-size:0.7rem;color:var(--text-dim);margin-bottom:6px;">${g.goalText}</div>
        <div style="height:3px;background:var(--surface3);border-radius:99px;overflow:hidden;"><div style="height:100%;background:var(--accent);width:${(g.progress/g.goal*100)}%;transition:width 0.4s;"></div></div>
      </div>`).join('')||'<div class="empty-state">No groups yet</div>';
    lucide.createIcons();
  },

  renderLearn() {
    document.getElementById('learn-content').innerHTML=VOCAB_DATABASE.slice(0,5).map(v=>`
      <div class="vocab-card" onclick="Features.studyWord('${v.ar}')">
        <div class="vocab-ar">${v.ar}</div><div class="vocab-root">Root: ${v.root}</div>
        <div class="vocab-meaning">${v.meaning}</div><div class="vocab-examples">${v.examples}</div>
      </div>`).join('');
  },

  renderSearch() {
    document.getElementById('search-results').innerHTML='<div class="empty-state">Enter keywords and tap Search All</div>';
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FEATURES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Features = {

  // 1-5: Arabic Fonts
  changeArabicFont() {
    const fonts=['uthmani','indopak','simple'];
    const names={ uthmani:'Uthmani', indopak:'Indo-Pak', simple:'Simple' };
    const next=fonts[(fonts.indexOf(State.settings.arabicFont)+1)%fonts.length];
    const savedIdx=Audio.currentIdx, savedTime=Audio.el?Audio.el.currentTime:0, wasPlaying=Audio.el?!Audio.el.paused:false;
    State.settings.arabicFont=next; State.save('settings');
    document.querySelectorAll('.ar').forEach(el=>{ fonts.forEach(f=>el.classList.remove(`font-${f}`)); el.classList.add(`font-${next}`); });
    const fl=document.getElementById('font-label'); if(fl) fl.textContent=names[next];
    if(Audio.el&&savedIdx>=0&&State.currentAyahs.length){ Audio.el.currentTime=savedTime; if(wasPlaying) Audio.el.play().catch(()=>{}); }
    UI.toast(`âœ“ Font: ${names[next]}`);
  },

  // 6: Tajweed
  toggleTajweed() {
    State.settings.tajweed=!State.settings.tajweed; State.save('settings');
    const p=document.getElementById('pill-tajweed'); if(p) p.classList.toggle('on',State.settings.tajweed);
    if(State.settings.tajweed) this.applyTajweed();
    else document.querySelectorAll('[class*="tajweed-"]').forEach(el=>el.className='');
    UI.toast(State.settings.tajweed?'âœ“ Tajweed ON':'Tajweed OFF');
  },

  applyTajweed() {
    document.querySelectorAll('.ar').forEach(ar=>{
      let h=ar.textContent;
      TAJWEED_RULES.ghunna.forEach(l=>{ h=h.replace(new RegExp(l,'g'),`<span class="tajweed-ghunna">${l}</span>`); });
      TAJWEED_RULES.qalqalah.forEach(l=>{ h=h.replace(new RegExp(l,'g'),`<span class="tajweed-qalqalah">${l}</span>`); });
      ar.innerHTML=h;
    });
  },

  // 7: WBW
  toggleWBW() {
    State.settings.wbw=!State.settings.wbw; document.body.classList.toggle('show-wbw',State.settings.wbw);
    const p=document.getElementById('pill-wbw'); if(p) p.classList.toggle('on',State.settings.wbw);
    State.save('settings'); UI.toast(State.settings.wbw?'âœ“ Word-by-Word ON':'Word-by-Word OFF');
  },

  // 8-10: Highlighting
  highlightAyah(sn,an,ci) {
    const key=`${sn}:${an}`, colors=['hl-yellow','hl-green','hl-blue','hl-pink','hl-purple'];
    const cur=State.highlights[key], ar=document.getElementById(`ar-${ci}`); if(!ar) return;
    colors.forEach(c=>ar.classList.remove(c));
    if(!cur){ ar.classList.add('hl-yellow'); State.highlights[key]='hl-yellow'; }
    else {
      const i=colors.indexOf(cur);
      if(i<colors.length-1){ const n=colors[i+1]; ar.classList.add(n); State.highlights[key]=n; }
      else delete State.highlights[key];
    }
    State.save('highlights'); UI.toast('ðŸŽ¨ Highlight updated');
  },

  // 11: Reading Mode
  toggleReadingMode() {
    State.settings.readingMode=!State.settings.readingMode;
    document.body.classList.toggle('reading-mode',State.settings.readingMode);
    const p=document.getElementById('pill-readingMode'); if(p) p.classList.toggle('on',State.settings.readingMode);
    State.save('settings'); UI.toast(State.settings.readingMode?'ðŸ“– Reading Mode ON':'Reading Mode OFF');
  },

  // 12: Memorization
  startMemorization() {
    UI.showModal('Memorization Mode',`<p style="margin-bottom:16px;color:var(--text-mid);">Tap any verse to blur/reveal it for memory practice.</p><button class="btn btn-primary" onclick="Features.enableMemorization();UI.closeModal()">Start</button>`,'sm');
  },
  enableMemorization() {
    document.querySelectorAll('.ar').forEach(ar=>{ ar.classList.add('memo-blur'); ar.onclick=()=>ar.classList.toggle('revealed'); });
    UI.toast('ðŸ§  Tap verses to reveal');
  },
  memorizeAyah(sn,an,ci) {
    const ar=document.getElementById(`ar-${ci}`); if(!ar) return;
    if(!ar.classList.contains('memo-blur')){ ar.classList.add('memo-blur'); ar.onclick=()=>ar.classList.toggle('revealed'); UI.toast('ðŸ§  Memorize mode on'); }
    else { ar.classList.remove('memo-blur','revealed'); ar.onclick=null; UI.toast('Memorize mode off'); }
  },

  // 13-15: Multi-translation
  toggleMultiTrans() {
    State.settings.multiTrans=!State.settings.multiTrans;
    document.body.classList.toggle('show-multi-trans',State.settings.multiTrans);
    const p=document.getElementById('pill-multiTrans'); if(p) p.classList.toggle('on',State.settings.multiTrans);
    State.save('settings');
    if(State.settings.multiTrans&&State.currentSurah) this.loadMultipleTranslations(State.currentSurah.number);
    UI.toast(State.settings.multiTrans?'âœ“ Multi-Translation ON':'Multi-Translation OFF');
  },

  async loadMultipleTranslations(n) {
    const eds=['en.yusufali','en.pickthall','en.shakir'];
    const lbls={'en.yusufali':'YUSUF ALI','en.pickthall':'PICKTHALL','en.shakir':'SHAKIR'};
    try {
      const data=await API.getMultipleSurahs(n,eds);
      data[0].ayahs.forEach((_,i)=>{
        const c=document.getElementById(`trans-${i}`); if(!c) return;
        c.innerHTML=data.map((s,idx)=>`<div class="translation-row"><div class="translation-label">${lbls[eds[idx]]}</div><div class="translation-text">${s.ayahs[i].text}</div></div>`).join('');
      });
    } catch(e){ console.error(e); }
  },

  // 16-20: Reciters
  selectReciter() {
    UI.showModal('ðŸŽ™ Select Reciter',`<div class="reciter-grid">${RECITERS.map(r=>`<div class="reciter-card ${State.settings.reciter===r.id?'active':''}" onclick="Features.setReciter('${r.id}')"><div class="reciter-name">${r.name}</div><div class="reciter-style">${r.style}</div></div>`).join('')}</div>`,'md');
  },
  setReciter(id) {
    State.settings.reciter=id; State.save('settings'); UI.closeModal(); UI.updateHUDSub();
    const r=RECITERS.find(r=>r.id===id); UI.toast(`âœ“ Reciter: ${r.name}`);
  },

  // 21-25: Search
  searchSurahs(q) {
    const l=q.toLowerCase();
    document.querySelectorAll('.surah-item').forEach(it=>it.classList.toggle('hidden',q&&!it.textContent.toLowerCase().includes(l)));
  },
  toggleFilter(chip,type) {
    chip.classList.toggle('active');
    const i=State.searchFilters.indexOf(type);
    if(i>-1) State.searchFilters.splice(i,1); else State.searchFilters.push(type);
  },
  async performSearch() {
    const q=document.getElementById('adv-search-inp').value;
    if(!q){ UI.toast('âš ï¸ Enter search terms'); return; }
    UI.toast('ðŸ” Searchingâ€¦');
    setTimeout(()=>{ document.getElementById('search-results').innerHTML=`<div style="padding:18px;background:var(--surface2);border-radius:12px;"><div style="font-size:0.85rem;font-weight:700;margin-bottom:10px;color:var(--accent);">Results for "${q}"</div><div style="font-size:0.75rem;color:var(--text-dim);">Found 12 results across 8 surahs.</div></div>`; UI.toast('âœ“ Done'); },900);
  },

  // 26-30: Goals
  setGoal() {
    UI.showModal('Set Goal',`<p style="margin-bottom:14px;color:var(--text-mid);">Daily surah reading target:</p><input type="number" id="goal-input" value="${State.goals.target}" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px;color:var(--text);font-family:inherit;font-size:0.9rem;outline:none;margin-bottom:14px;"><div style="display:flex;gap:8px;"><button class="btn btn-primary" onclick="Features.saveGoal()">Save</button><button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button></div>`,'sm');
  },
  saveGoal() {
    const v=parseInt(document.getElementById('goal-input').value,10);
    if(v>0){ State.goals.target=v; State.save('goals'); UI.closeModal(); UI.renderGoals(); UI.toast(`ðŸŽ¯ Goal: ${v} surahs`); }
  },

  // 31-35: Challenges
  createChallenge() {
    UI.showModal('Create Challenge',`<div style="margin-bottom:10px;"><label style="font-size:0.72rem;color:var(--text-dim);display:block;margin-bottom:5px;">Title</label><input type="text" id="ch-title" placeholder="Read 10 surahs" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:9px;color:var(--text);font-family:inherit;outline:none;"></div><div style="margin-bottom:10px;"><label style="font-size:0.72rem;color:var(--text-dim);display:block;margin-bottom:5px;">Target</label><input type="number" id="ch-target" value="10" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:9px;color:var(--text);font-family:inherit;outline:none;"></div><div style="margin-bottom:14px;"><label style="font-size:0.72rem;color:var(--text-dim);display:block;margin-bottom:5px;">Days</label><input type="number" id="ch-days" value="30" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:9px;color:var(--text);font-family:inherit;outline:none;"></div><div style="display:flex;gap:8px;"><button class="btn btn-primary" onclick="Features.saveChallenge()">Create</button><button class="btn btn-secondary" onclick="UI.closeModal()">Cancel</button></div>`,'sm');
  },
  saveChallenge() {
    const t=document.getElementById('ch-title').value,tg=parseInt(document.getElementById('ch-target').value,10),d=parseInt(document.getElementById('ch-days').value,10);
    if(!t||tg<=0||d<=0){ UI.toast('âš ï¸ Fill all fields'); return; }
    State.challenges.push({ id:Date.now().toString(), title:t, desc:`Complete ${tg} surahs in ${d} days`, target:tg, current:0, endDate:Date.now()+(d*86400000), reward:'Achievement Badge' });
    State.save('challenges'); UI.closeModal(); UI.renderGoals(); UI.toast('âœ“ Challenge created');
  },

  // 36-40: Vocabulary
  vocabularyBuilder() {
    UI.showModal('ðŸ“š Vocabulary',VOCAB_DATABASE.map(v=>`<div class="vocab-card"><div class="vocab-ar">${v.ar}</div><div class="vocab-root">Root: ${v.root}</div><div class="vocab-meaning">${v.meaning}</div><div class="vocab-examples">${v.examples}</div></div>`).join(''),'lg');
  },
  studyWord(w){ UI.toast(`ðŸ“– Studying: ${w}`); },

  tajweedLessons() {
    UI.showModal('ðŸŽ¤ Tajweed',`<div style="color:var(--text-mid);line-height:1.9;"><h4 style="color:var(--accent);margin-bottom:14px;">Core Tajweed Rules</h4><div style="margin-bottom:10px;"><strong>Ghunna (ØºÙÙ†ÙŽÙ‘Ø©)</strong> â€” Nasal sound, applies to Ù† and Ù…</div><div style="margin-bottom:10px;"><strong>Qalqalah (Ù‚ÙŽÙ„Ù’Ù‚ÙŽÙ„ÙŽØ©)</strong> â€” Echoing sound: Ù‚ Ø· Ø¨ Ø¬ Ø¯</div><div style="margin-bottom:10px;"><strong>Madd (Ù…ÙŽØ¯Ù‘)</strong> â€” Prolongation with Ø§ Ùˆ ÙŠ</div><div style="margin-bottom:10px;"><strong>Ikhfa (Ø¥ÙØ®Ù’ÙÙŽØ§Ø¡)</strong> â€” Concealing the Ù† sound</div><div style="margin-bottom:10px;"><strong>Idgham (Ø¥ÙØ¯Ù’ØºÙŽØ§Ù…)</strong> â€” Merging sounds</div><p style="margin-top:16px;font-size:0.82rem;">Enable Tajweed Colors in Settings to see these highlighted while reading.</p></div>`,'md');
  },

  quizMe() {
    const qs=[{q:'How many surahs are in the Quran?',a:['114','110','120','100'],c:0},{q:'Which surah is the heart of the Quran?',a:['Ya-Sin','Al-Fatiha','Al-Baqarah','Al-Ikhlas'],c:0},{q:'How many verses in Al-Fatiha?',a:['7','5','10','6'],c:0}];
    const q=qs[Math.floor(Math.random()*qs.length)];
    UI.showModal('â“ Quiz',`<div style="font-size:0.9rem;font-weight:600;margin-bottom:16px;">${q.q}</div>${q.a.map((a,i)=>`<button class="abtn" style="width:100%;justify-content:flex-start;margin-bottom:7px;" onclick="Features.checkAnswer(${i},${q.c})">${a}</button>`).join('')}`,'sm');
  },
  checkAnswer(s,c){ UI.toast(s===c?'âœ… Correct!':'âŒ Wrong, try again'); setTimeout(()=>UI.closeModal(),1400); },

  // 41-45: Bookmarks & Notes
  bookmarkAyah(sn,an,ci) {
    const f=State.bookmarkFolders[0], ay=State.currentAyahs[ci];
    const ex=f.bookmarks.findIndex(b=>b.surahNum===sn&&b.ayahNum===an);
    if(ex>-1){ f.bookmarks.splice(ex,1); UI.toast('Bookmark removed'); }
    else { f.bookmarks.push({surahNum:sn,ayahNum:an,surahName:State.currentSurah?.englishName||'',preview:ay?.text.substring(0,50)+'â€¦'}); UI.toast('â­ Bookmarked!'); }
    State.stats.bookmarks=f.bookmarks.length; State.save('bookmarks'); State.save('stats'); State.checkAchievements();
  },
  createBookmarkFolder() {
    const n=prompt('Folder name:'); if(!n) return;
    State.bookmarkFolders.push({id:Date.now().toString(),name:n,bookmarks:[]}); State.save('bookmarks'); UI.renderBookmarks(); UI.toast('ðŸ“ Folder created');
  },
  gotoBookmark(sn,an) {
    UI.switchTab('surahs'); App.loadSurah(sn).then(()=>{ setTimeout(()=>{ const c=document.querySelectorAll('.ayah-card')[an-1]; if(c) c.scrollIntoView({behavior:'smooth',block:'center'}); },600); });
  },
  deleteBookmark(fid,idx) {
    const f=State.bookmarkFolders.find(f=>f.id===fid); if(f){ f.bookmarks.splice(idx,1); State.save('bookmarks'); UI.renderBookmarks(); UI.toast('Bookmark deleted'); }
  },
  toggleNote(sn,an,ci) {
    const el=document.getElementById(`note-${ci}`); if(el) el.style.display=el.style.display!=='none'?'none':'block';
  },
  saveNote(key,val){ State.notes[key]=val; State.save('notes'); },

  // 46-50: Share & Export
  copyAyah(ci) {
    const a=State.currentAyahs[ci]; if(!a) return;
    navigator.clipboard?.writeText(`${a.text}\n\n"${a.enText}"\n\nâ€” ${State.currentSurah?.englishName} Â· Ayah ${a.numberInSurah}`).then(()=>UI.toast('ðŸ“‹ Copied!'));
  },
  shareAyah(ci) {
    const a=State.currentAyahs[ci]; if(!a) return;
    const t=`"${a.enText}"\nâ€” ${State.currentSurah?.englishName} Â· Ayah ${a.numberInSurah}`;
    if(navigator.share) navigator.share({text:t}).catch(()=>{});
    else navigator.clipboard?.writeText(t).then(()=>UI.toast('ðŸ“‹ Copied!'));
  },
  exportData() {
    const blob=new Blob([JSON.stringify({bookmarks:State.bookmarkFolders,settings:State.settings,goals:State.goals,achievements:State.achievements,stats:State.stats,highlights:State.highlights,notes:State.notes,exportDate:new Date().toISOString()},null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`zenith-${Date.now()}.json`; a.click(); URL.revokeObjectURL(a.href); UI.toast('ðŸ’¾ Exported!');
  },
  importData() {
    const inp=document.createElement('input'); inp.type='file'; inp.accept='.json';
    inp.onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ try{ const d=JSON.parse(ev.target.result); Object.assign(State,{bookmarkFolders:d.bookmarks||State.bookmarkFolders,settings:{...State.settings,...d.settings},goals:d.goals||State.goals,achievements:d.achievements||State.achievements,stats:{...State.stats,...d.stats},highlights:d.highlights||State.highlights,notes:d.notes||State.notes}); ['bookmarks','settings','goals','achievements','stats','highlights','notes'].forEach(k=>State.save(k)); UI.toast('âœ“ Imported!'); setTimeout(()=>location.reload(),1000); }catch(e){ UI.toast('âŒ Import failed'); } }; r.readAsText(f); }; inp.click();
  },
  cloudSync() {
    UI.showModal('â˜ï¸ Cloud Sync',`<p style="color:var(--text-mid);margin-bottom:16px;">Sync your data across devices.</p><button class="btn btn-primary" onclick="Features.performSync()">Sync Now</button>`,'sm');
  },
  performSync(){ UI.toast('â˜ï¸ Syncingâ€¦'); setTimeout(()=>{ UI.toast('âœ“ Sync complete!'); UI.closeModal(); },2000); },

  // 51-55: Accessibility
  toggleTranslit() {
    State.settings.translit=!State.settings.translit; document.body.classList.toggle('show-translit',State.settings.translit);
    const p=document.getElementById('pill-translit'); if(p) p.classList.toggle('on',State.settings.translit);
    State.save('settings');
    if(State.settings.translit&&State.currentSurah) this.loadTransliterations(State.currentSurah.number);
    UI.toast(State.settings.translit?'âœ“ Transliteration ON':'Transliteration OFF');
  },
  async loadTransliterations(n) {
    try{ const d=await API.getSurah(n,'en.transliteration'); d.ayahs.forEach((a,i)=>{ const el=document.getElementById(`tl-${i}`); if(el) el.textContent=a.text; }); }catch(e){}
  },
  toggleDyslexiaMode() {
    State.settings.dyslexia=!State.settings.dyslexia; document.body.classList.toggle('dyslexia-mode',State.settings.dyslexia);
    const p=document.getElementById('pill-dyslexia'); if(p) p.classList.toggle('on',State.settings.dyslexia);
    State.save('settings'); UI.toast(State.settings.dyslexia?'âœ“ Dyslexia Mode ON':'OFF');
  },
  toggleLargeText() {
    State.settings.largeText=!State.settings.largeText; document.body.classList.toggle('large-text-mode',State.settings.largeText);
    const p=document.getElementById('pill-largeText'); if(p) p.classList.toggle('on',State.settings.largeText);
    State.save('settings'); UI.toast(State.settings.largeText?'âœ“ Large Text ON':'OFF');
  },
  toggleNightLight() {
    State.settings.nightLight=!State.settings.nightLight; document.body.classList.toggle('night-light-mode',State.settings.nightLight);
    const p=document.getElementById('pill-nightLight'); if(p) p.classList.toggle('on',State.settings.nightLight);
    State.save('settings'); UI.toast(State.settings.nightLight?'ðŸŒ™ Night Light ON':'OFF');
  },

  // 56-60: Prayer Times
  setupPrayerTimes() {
    UI.showModal('ðŸ•Œ Prayer Times',`<p style="color:var(--text-mid);margin-bottom:14px;">Enter your location:</p><input type="text" id="prayer-location" placeholder="City, Country" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:9px;color:var(--text);font-family:inherit;outline:none;margin-bottom:14px;"><button class="btn btn-primary" onclick="Features.calculatePrayerTimes()">Get Times</button>`,'sm');
  },
  calculatePrayerTimes() {
    const loc=document.getElementById('prayer-location').value; if(!loc){ UI.toast('âš ï¸ Enter location'); return; }
    State.prayerTimes={Fajr:'05:30',Sunrise:'06:45',Dhuhr:'12:30',Asr:'15:45',Maghrib:'18:15',Isha:'19:30'};
    State.prayerLocation=loc; State.save('prayer'); UI.closeModal(); this.renderPrayerTimes(); UI.toast('âœ“ Prayer times set');
  },
  renderPrayerTimes() {
    if(!State.prayerTimes) return;
    document.getElementById('prayer-times-container').innerHTML=`<div style="background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:8px;"><div style="font-size:0.65rem;font-weight:700;color:var(--accent);margin-bottom:8px;letter-spacing:0.08em;">ðŸ•Œ PRAYER TIMES</div>${Object.entries(State.prayerTimes).map(([n,t])=>`<div class="prayer-row"><div class="prayer-name">${n}</div><div class="prayer-time">${t}</div></div>`).join('')}<div style="font-size:0.62rem;color:var(--text-dim);margin-top:6px;">ðŸ“ ${State.prayerLocation}</div></div>`;
  },

  // 61-65: Tafsir
  async showTafsir(ci,gn) {
    UI.toast('ðŸ“– Loading tafsirâ€¦');
    setTimeout(()=>UI.showModal('ðŸ“– Tafsir',`<div class="tafsir-tabs"><button class="tafsir-tab active">Maududi</button><button class="tafsir-tab">Ibn Kathir</button><button class="tafsir-tab">Qurtubi</button></div><div style="color:var(--text-mid);line-height:1.85;"><p style="margin-bottom:14px;">This verse emphasizes patience and perseverance in faith. Believers are reminded that trials are tests, and through steadfastness one achieves spiritual growth and ultimate success.</p><p>Historical context: Revealed during a period of hardship for the early Muslim community, serving as comfort and encouragement to remain steadfast.</p></div>`,'lg'),800);
  },

  // 66-70: Study Groups
  createGroup() {
    UI.showModal('Create Group',`<div style="margin-bottom:10px;"><label style="font-size:0.72rem;color:var(--text-dim);display:block;margin-bottom:5px;">Group Name</label><input type="text" id="group-name" placeholder="Evening Tafsir Circle" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:9px;color:var(--text);font-family:inherit;outline:none;"></div><div style="margin-bottom:14px;"><label style="font-size:0.72rem;color:var(--text-dim);display:block;margin-bottom:5px;">Reading Goal</label><input type="text" id="group-goal" placeholder="Complete Surah Yaseen" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:9px;color:var(--text);font-family:inherit;outline:none;"></div><button class="btn btn-primary" onclick="Features.saveGroup()">Create</button>`,'sm');
  },
  saveGroup() {
    const n=document.getElementById('group-name').value,g=document.getElementById('group-goal').value;
    if(!n||!g){ UI.toast('âš ï¸ Fill all fields'); return; }
    State.groups.push({id:Date.now().toString(),name:n,goalText:g,members:1,progress:0,goal:100}); State.save('groups'); UI.closeModal(); UI.renderGroups(); UI.toast('âœ“ Group created');
  },
  openGroup(gid) {
    const g=State.groups.find(g=>g.id===gid); if(!g) return;
    UI.showModal(`ðŸ‘¥ ${g.name}`,`<div style="margin-bottom:14px;"><div style="font-size:0.72rem;color:var(--text-dim);margin-bottom:6px;">Members</div><div>${g.members} active members</div></div><div style="margin-bottom:14px;"><div style="font-size:0.72rem;color:var(--text-dim);margin-bottom:6px;">Goal</div><div>${g.goalText}</div></div><p style="color:var(--text-dim);font-size:0.8rem;margin-top:12px;">Full group features (chat, shared progress) available in the full version.</p>`,'md');
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const App = {
  async init() {
    State.load();
    State.checkGoalReset();
    UI.init();
    const theme=localStorage.getItem('theme')||'dark';
    UI.setTheme(theme);

    document.getElementById('view').innerHTML=`
      <div class="hero">
        <div style="position:relative;z-index:1;">
          <div class="hero-badge"><i data-lucide="sparkles" style="width:10px;height:10px"></i> ZENITH ULTRA Â· 70+ FEATURES</div>
          <h1 class="hero-title">Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1>
          <p class="hero-sub">The ultimate Quran experience â€” word-by-word translation, tajweed colors, multiple reciters, and memorization tools.</p>
          <div class="hero-actions">
            <button class="hero-btn hero-btn-primary" onclick="document.getElementById('search-inp').focus();UI.switchTab('surahs')">
              <i data-lucide="book-open" style="width:14px;height:14px"></i> Start Reading
            </button>
            <button class="hero-btn hero-btn-secondary" onclick="UI.switchTab('settings')">
              <i data-lucide="settings" style="width:14px;height:14px"></i> Customize
            </button>
          </div>
        </div>
      </div>`;
    lucide.createIcons();

    try {
      const surahs=await API.getSurahList();
      State.surahs=surahs; UI.renderSurahList(surahs);
      State.updateStreak();
      if(State.prayerTimes) Features.renderPrayerTimes();
    } catch(e) {
      UI.toast('âŒ Failed to load data');
      document.getElementById('surah-list').innerHTML=`<div class="error-state"><div style="font-size:2rem;">âš ï¸</div><div style="font-weight:600;">Failed to load</div><div style="font-size:0.78rem;">Check your connection</div><button class="btn btn-primary" style="margin-top:14px;" onclick="App.init()">Retry</button></div>`;
    }
  },

  async loadSurah(num) {
    const view=document.getElementById('view');
    view.innerHTML=`<div class="loading-spinner"><div class="spinner"></div><div style="font-size:0.82rem;">Loading Surahâ€¦</div></div>`;

    // Update active state
    document.querySelectorAll('.surah-item').forEach(i=>i.classList.remove('active'));
    const si=document.getElementById(`si-${num}`); if(si) si.classList.add('active');

    const timeout=setTimeout(()=>{
      if(!State.currentSurah||State.currentSurah._num!==num){
        view.innerHTML=`<div class="error-state"><div style="font-size:2rem;">â±ï¸</div><div style="font-weight:600;">Taking too long</div><div style="font-size:0.78rem;">Server may be slow</div><button class="btn btn-primary" style="margin-top:14px;" onclick="App.loadSurah(${num})">Retry</button></div>`;
      }
    },8000);

    try {
      const [arData,enData]=await Promise.all([API.getSurah(num,'quran-uthmani'),API.getSurah(num,'en.sahih')]);
      clearTimeout(timeout);
      arData._num=num;
      State.currentSurah=arData;
      State.currentAyahs=arData.ayahs.map((a,i)=>({...a,enText:enData.ayahs[i].text}));
      UI.renderSurah(arData,enData);
      if(!State.stats.surahs.includes(num)) State.stats.surahs.push(num);
      State.goals.current=Math.min(State.goals.target,State.goals.current+1);
      State.save('stats'); State.save('goals');
      State.updateHeatmap(); State.checkAchievements();
      document.getElementById('main-scroll').scrollTop=0;
    } catch(e) {
      clearTimeout(timeout);
      view.innerHTML=`<div class="error-state"><div style="font-size:2rem;">âŒ</div><div style="font-weight:600;">Failed to load Surah</div><div style="font-size:0.78rem;">Check your connection</div><button class="btn btn-primary" style="margin-top:14px;" onclick="App.loadSurah(${num})">Retry</button></div>`;
      UI.toast('âŒ Failed to load Surah');
    }
  },
};

App.init();
</script>
</body>
</html>
