<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Omni ‚Äî Elite Edition</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;700&family=Amiri+Quran&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg:#02070d; --bg2:#0a121e; --glass:rgba(15,30,50,0.6); --p:#38bdf8; --pd:rgba(56,189,248,0.1);
            --pb:rgba(56,189,248,0.2); --t:#e2eff8; --td:rgba(226,239,248,0.4);
            --taj-m: #fb7185; --taj-g: #34d399; --taj-q: #38bdf8;
            --font-ar:'Amiri Quran', serif; --tr: all 0.4s cubic-bezier(0.16,1,0.3,1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--t); display: flex; height: 100dvh; overflow: hidden; }

        /* NAV RAIL */
        .nav-rail { width: 85px; border-right: 1px solid var(--pb); display: flex; flex-direction: column; align-items: center; padding: 25px 0; gap: 20px; background: var(--bg2); z-index: 1000; }
        .btn { background: transparent; border: 1px solid transparent; color: var(--t); cursor: pointer; padding: 12px; border-radius: 18px; transition: var(--tr); opacity: 0.6; position: relative; }
        .btn:hover, .btn.on { opacity: 1; background: var(--pd); color: var(--p); border-color: var(--p); }
        .badge { position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; background: var(--p); border-radius: 50%; box-shadow: 0 0 10px var(--p); }

        /* MAIN STAGE */
        main { flex: 1; overflow-y: auto; padding: 40px; scroll-behavior: smooth; }
        .container { max-width: 950px; margin: 0 auto; position: relative; }

        /* TOP DASHBOARD */
        .dash { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 40px; }
        .stat-card { background: var(--glass); border: 1px solid var(--pb); border-radius: 24px; padding: 25px; display: flex; align-items: center; gap: 20px; }

        /* AYAH CARDS */
        .ayah-row { padding: 40px; border-bottom: 1px solid var(--pb); border-radius: 24px; transition: 0.3s; margin-bottom: 10px; cursor: pointer; }
        .ayah-row:hover { background: var(--pd); }
        .arabic { font-family: var(--font-ar); font-size: 3.2rem; direction: rtl; line-height: 2.8; margin-bottom: 15px; display: flex; flex-wrap: wrap; justify-content: flex-start; gap: 15px; }
        
        /* WORD TOOLTIPS */
        .word-unit { position: relative; display: inline-block; }
        .word-unit:hover .tooltip { opacity: 1; transform: translateY(-10px); visibility: visible; }
        .tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--p); color: var(--bg); font-family: 'DM Sans'; font-size: 0.7rem; font-weight: bold; padding: 4px 10px; border-radius: 6px; white-space: nowrap; opacity: 0; visibility: hidden; transition: 0.2s; pointer-events: none; z-index: 10; }

        /* SIDEBARS */
        .drawer { position: fixed; right: 0; top: 0; width: 450px; height: 100%; background: var(--bg2); border-left: 1px solid var(--pb); transform: translateX(100%); transition: var(--tr); z-index: 2000; padding: 40px; overflow-y: auto; }
        .drawer.open { transform: translateX(0); }
        textarea { width: 100%; height: 150px; background: var(--pd); border: 1px solid var(--pb); border-radius: 15px; color: white; padding: 15px; font-family: inherit; margin-top: 15px; outline: none; }

        /* PLAYER DOCK */
        .player { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 800px; background: rgba(5,15,30,0.9); backdrop-filter: blur(50px); border: 1px solid var(--pb); border-radius: 100px; padding: 15px 35px; display: flex; align-items: center; gap: 25px; z-index: 3000; }
        .p-fill { height: 100%; background: var(--p); width: 0%; transition: width 0.1s linear; box-shadow: 0 0 15px var(--p); }
    </style>
</head>
<body>

<nav class="nav-rail">
    <div style="font-family:var(--font-ar); font-size:2.5rem; color:var(--p); margin-bottom:10px">ŸÇ</div>
    <button class="btn on" onclick="App.view('home')"><i data-lucide="layout-grid"></i></button>
    <button class="btn" onclick="App.toggleDrawer('notes')"><i data-lucide="pen-tool"></i><div class="badge"></div></button>
    <button class="btn" onclick="App.toggleDrawer('settings')"><i data-lucide="settings-2"></i></button>
    <div style="flex:1"></div>
    <button class="btn" onclick="App.toggleOrder()" id="order-btn"><i data-lucide="list-ordered"></i></button>
</nav>

<main id="scroller">
    <div class="container" id="viewport">
        </div>
</main>

<div id="notes" class="drawer">
    <h2>Reflection Journal</h2>
    <p style="opacity:0.5; font-size:0.9rem">Your private thoughts on verses.</p>
    <div id="active-note-target" style="margin-top:20px; color:var(--p); font-weight:bold"></div>
    <textarea id="note-input" placeholder="What does this verse mean to you?"></textarea>
    <button class="btn on" style="width:100%; margin-top:10px" onclick="App.saveNote()">Save Reflection</button>
    <div id="notes-list" style="margin-top:40px"></div>
</div>

<div id="settings" class="drawer">
    <h2>Audio & Preferences</h2>
    <div style="margin-top:30px">
        <label style="font-size:0.7rem; opacity:0.5">SELECT RECITER</label>
        <select id="reciter-select" onchange="App.setReciter(this.value)" style="width:100%; padding:15px; background:var(--pd); color:white; border:1px solid var(--pb); border-radius:12px; margin-top:10px">
            <option value="ar.alafasy">Mishary Rashid Alafasy</option>
            <option value="ar.husary">Mahmoud Khalil Al-Husary</option>
            <option value="ar.minshawi">Mohamed Siddiq El-Minshawi</option>
        </select>
    </div>
    <div style="margin-top:30px">
        <label style="font-size:0.7rem; opacity:0.5">DAILY GOAL (AYAHs)</label>
        <input type="number" id="goal-input" value="10" onchange="App.setGoal(this.value)" style="width:100%; padding:15px; background:var(--pd); color:white; border:1px solid var(--pb); border-radius:12px; margin-top:10px">
    </div>
</div>

<div class="player">
    <button class="btn on" onclick="App.togglePlay()"><i data-lucide="play" id="play-icon"></i></button>
    <div style="flex:1">
        <div style="display:flex; justify-content:space-between; font-size:0.75rem; font-weight:bold; margin-bottom:8px">
            <span id="p-surah">SELECT SURAH</span>
            <span id="p-time">00:00</span>
        </div>
        <div style="width:100%; height:4px; background:var(--pb); border-radius:2px; overflow:hidden">
            <div class="p-fill" id="progress-bar"></div>
        </div>
    </div>
    <div style="display:flex; gap:10px">
        <button class="btn" onclick="App.step(-1)"><i data-lucide="skip-back"></i></button>
        <button class="btn" onclick="App.step(1)"><i data-lucide="skip-forward"></i></button>
    </div>
</div>

<audio id="audio-core"></audio>

<script>
const App = (() => {
    let state = {
        surahs: [], currentSurah: null, reciter: 'ar.alafasy',
        notes: JSON.parse(localStorage.getItem('q_notes') || '{}'),
        khatm: JSON.parse(localStorage.getItem('q_khatm') || '[]'),
        goal: localStorage.getItem('q_goal') || 10,
        isChronological: false, activeAyahIdx: 0
    };
    const audio = document.getElementById('audio-core');

    const init = async () => {
        const res = await fetch('https://api.alquran.cloud/v1/surah');
        const d = await res.json();
        state.surahs = d.data;
        renderHome();
        lucide.createIcons();
        audio.ontimeupdate = () => {
            document.getElementById('progress-bar').style.width = (audio.currentTime/audio.duration*100)+'%';
            document.getElementById('p-time').innerText = Math.floor(audio.currentTime/60) + ":" + Math.floor(audio.currentTime%60).toString().padStart(2,'0');
        };
        audio.onended = () => App.step(1);
    };

    const renderHome = () => {
        const streak = state.khatm.length;
        const sorted = state.isChronological ? [...state.surahs].sort((a,b) => a.revelationOrder - b.revelationOrder) : state.surahs;
        
        document.getElementById('viewport').innerHTML = `
            <div class="dash">
                <div class="stat-card">
                    <div style="font-size:2.5rem">üåô</div>
                    <div><h3>Reading Streak</h3><p style="color:var(--p); font-weight:bold">${streak} Ayahs Completed</p></div>
                </div>
                <div class="stat-card">
                    <div><h3>Daily Goal</h3><p style="opacity:0.6">${state.khatm.length}/${state.goal} Ayahs</p></div>
                </div>
            </div>
            <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:15px">
                ${sorted.slice(0, 20).map(s => `
                    <div class="stat-card" style="cursor:pointer; transition:0.3s" onclick="App.loadSurah(${s.number})">
                        <div style="flex:1"><small>#${s.number}</small><h4>${s.englishName}</h4></div>
                        <div style="font-family:var(--font-ar); color:var(--p); font-size:1.5rem">${s.name}</div>
                    </div>
                `).join('')}
            </div>`;
    };

    const loadSurah = async (id) => {
        const [ar, en] = await Promise.all([
            fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-uthmani`).then(r => r.json()),
            fetch(`https://api.alquran.cloud/v1/surah/${id}/en.sahih`).then(r => r.json())
        ]);
        state.currentSurah = ar.data;
        let html = `<h1 style="text-align:center; font-family:var(--font-ar); font-size:5rem; padding:60px 0">${ar.data.name}</h1>`;
        ar.data.ayahs.forEach((v, i) => {
            const words = v.text.split(' ').map(w => `<span class="word-unit">${w}<div class="tooltip">Word Translation</div></span>`).join(' ');
            html += `
                <div class="ayah-row" id="ay-${i}" onclick="App.playAyah(${i}, ${v.number})">
                    <div class="arabic">${words}</div>
                    <div style="opacity:0.7; font-size:1.1rem">${en.data.ayahs[i].text}</div>
                    ${state.notes[`${id}:${i+1}`] ? `<div style="margin-top:15px; color:var(--p); font-size:0.8rem">üìù ${state.notes[`${id}:${i+1}`]}</div>` : ''}
                </div>`;
        });
        document.getElementById('viewport').innerHTML = html;
        document.getElementById('scroller').scrollTop = 0;
    };

    return {
        init, view: (v) => v === 'home' && renderHome(),
        toggleOrder: () => { state.isChronological = !state.isChronological; renderHome(); },
        toggleDrawer: (id) => { document.querySelectorAll('.drawer').forEach(d => d.id !== id && d.classList.remove('open')); document.getElementById(id).classList.toggle('open'); },
        setReciter: (r) => state.reciter = r,
        setGoal: (g) => { state.goal = g; localStorage.setItem('q_goal', g); },
        playAyah: (idx, gid) => {
            state.activeAyahIdx = idx;
            audio.src = `https://cdn.islamic.network/quran/audio/128/${state.reciter}/${gid}.mp3`;
            audio.play();
            document.getElementById('p-surah').innerText = `${state.currentSurah.englishName} : ${idx+1}`;
            document.getElementById('play-icon').setAttribute('data-lucide', 'pause');
            
            if(!state.khatm.includes(gid)) { state.khatm.push(gid); localStorage.setItem('q_khatm', JSON.stringify(state.khatm)); }
            
            // Mark for notes
            state.activeKey = `${state.currentSurah.number}:${idx+1}`;
            document.getElementById('active-note-target').innerText = `Adding note to ${state.activeKey}`;
            
            document.querySelectorAll('.ayah-row').forEach(r => r.style.borderColor = 'transparent');
            document.getElementById(`ay-${idx}`).style.borderColor = 'var(--p)';
            lucide.createIcons();
        },
        togglePlay: () => { if(audio.paused) audio.play(); else audio.pause(); document.getElementById('play-icon').setAttribute('data-lucide', audio.paused ? 'play' : 'pause'); lucide.createIcons(); },
        step: (d) => { const next = state.activeAyahIdx + d; if(state.currentSurah.ayahs[next]) App.playAyah(next, state.currentSurah.ayahs[next].number); },
        saveNote: () => {
            const val = document.getElementById('note-input').value;
            if(state.activeKey && val) {
                state.notes[state.activeKey] = val;
                localStorage.setItem('q_notes', JSON.stringify(state.notes));
                alert("Reflection saved!");
                App.loadSurah(state.currentSurah.number);
            }
        }
    };
})();
document.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>
