<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanctuary V8 | Sovereign Engine</title>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Amiri:wght@400;700&family=Lateef:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --emerald: #10b981;
            --glass: rgba(6, 40, 30, 0.9);
            --bg: #020f0c;
            --border: rgba(16, 185, 129, 0.2);
        }

        body.theme-velvet { --emerald: #8b5cf6; --glass: rgba(20, 10, 40, 0.9); --bg: #0a0515; --border: rgba(139, 92, 246, 0.2); }
        body.theme-ocean { --emerald: #0ea5e9; --glass: rgba(10, 30, 50, 0.9); --bg: #020617; --border: rgba(14, 165, 233, 0.2); }

        * { box-sizing: border-box; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        body { 
            margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); color: #ecfdf5; 
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            background-image: radial-gradient(circle at 50% -20%, #064e3b 0%, #020f0c 100%);
        }

        body.theme-velvet { background-image: radial-gradient(circle at 50% -20%, #2e1065 0%, #0a0515 100%); }
        body.theme-ocean { background-image: radial-gradient(circle at 50% -20%, #0c4a6e 0%, #020617 100%); }

        .deep-glass {
            background: var(--glass);
            backdrop-filter: blur(50px) saturate(200%);
            border: 1px solid var(--border);
            border-top: 1px solid rgba(255,255,255,0.15);
            border-radius: 32px;
        }

        #viewport.loading { opacity: 0.4; filter: blur(15px); pointer-events: none; transform: scale(0.98); }

        /* TAJWEED PARSING COLORS */
        .tajweed-active .taj-ghunnah { color: #ff5722 !important; font-weight: bold; }
        .tajweed-active .taj-qalqalah { color: #03a9f4 !important; font-weight: bold; }
        .tajweed-active .taj-madd { color: #e91e63 !important; font-weight: bold; }
        .tajweed-active .taj-ikfa { color: #ffeb3b !important; }
        .tajweed-active .taj-marker { opacity: 0.8; color: var(--emerald); }

        header { height: 80px; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; flex-shrink: 0; }
        
        main { 
            display: grid; grid-template-columns: 300px 1fr 320px; 
            gap: 20px; padding: 0 20px;
            flex: 1; overflow: hidden;
            margin-bottom: 110px; 
        }

        .silo { overflow-y: auto; padding: 25px; scrollbar-width: none; height: 100%; }
        .silo::-webkit-scrollbar { width: 0; }

        .card {
            padding: 16px; margin-bottom: 12px; border-radius: 20px; cursor: pointer;
            background: rgba(255,255,255,0.03); border: 1px solid transparent;
        }
        .card:hover, .card.active { background: var(--emerald); border-color: white; color: white; }

        .ayah-block {
            padding: 35px; margin-bottom: 25px; border-radius: 24px;
            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);
        }

        .q-text { font-family: 'Amiri'; font-size: 2.8rem; text-align: right; line-height: 2.4; direction: rtl; }
        .script-indopak .q-text { font-family: 'Lateef'; font-size: 3.2rem; line-height: 1.8; }

        .focus-mode .ayah-block {
            min-height: 60vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
            border: none;
            background: transparent;
        }
        .focus-mode .q-text { text-align: center; font-size: 3.5rem; }

        .drawer { position: fixed; top: 0; right: -450px; width: 380px; height: 100%; z-index: 9999; padding: 40px; border-radius: 40px 0 0 40px; }
        .drawer.open { right: 0; box-shadow: -20px 0 60px rgba(0,0,0,0.8); }

        .player-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 1100px; height: 85px; padding: 0 40px; display: flex; align-items: center; justify-content: space-between; z-index: 5000; }
        .play-btn { width: 55px; height: 55px; border-radius: 50%; background: var(--emerald); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <header>
        <div style="display: flex; align-items: center; gap: 20px;">
            <div style="color: var(--emerald); font-weight: 800; font-size: 1.4rem; letter-spacing: 1px;"><i data-lucide="shield"></i> SOVEREIGN V8</div>
            <div style="display: flex; gap: 15px; font-size: 0.7rem; font-weight: 700; opacity: 0.6; border-left: 1px solid var(--border); padding-left: 20px;">
                <div id="stat-xp">0 XP</div>
                <div id="stat-time">0m Active</div>
            </div>
        </div>
        <div style="display:flex; gap:12px;">
            <div class="card" style="padding:10px;" onclick="App.ui.toggle('account')"><i data-lucide="user"></i></div>
            <div class="card" style="padding:10px;" onclick="App.ui.toggle('settings')"><i data-lucide="settings"></i></div>
        </div>
    </header>

    <div id="settings-drawer" class="deep-glass drawer">
        <div style="display:flex; justify-content:space-between; align-items:center;"><h3>Sovereign Core</h3><i data-lucide="x" onclick="App.ui.toggle('settings')" style="cursor:pointer;"></i></div>
        <div style="margin-top:35px; display:flex; flex-direction:column; gap:25px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span>Indo-Pak Script</span>
                <input type="checkbox" id="pref-indopak" onchange="App.ui.refresh()" style="accent-color:var(--emerald); width:20px; height:20px;">
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span>Verse Focus</span>
                <input type="checkbox" id="pref-focus" onchange="App.ui.refresh()" style="accent-color:var(--emerald); width:20px; height:20px;">
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span>Tajweed Assist</span>
                <input type="checkbox" id="pref-tajweed" onchange="App.ui.refresh()" style="accent-color:var(--emerald); width:20px; height:20px;">
            </div>
            <select id="pref-theme" class="card" style="width:100%; background:var(--bg); color:white; border:1px solid var(--border);" onchange="App.ui.setTheme(this.value)">
                <option value="emerald">Emerald Sanctuary</option>
                <option value="velvet">Midnight Velvet</option>
                <option value="ocean">Deep Ocean</option>
            </select>
        </div>
    </div>

    <div id="account-drawer" class="deep-glass drawer">
        <div style="display:flex; justify-content:space-between; align-items:center;"><h3>User Matrix</h3><i data-lucide="x" onclick="App.ui.toggle('account')"></i></div>
        <div style="margin-top:40px;">
            <div class="card" style="text-align:center; padding:30px;">
                <div id="stat-rank" style="font-size: 0.6rem; color: var(--emerald); text-transform:uppercase;">Seeker</div>
                <h2 style="margin:5px 0;">Identity Logged</h2>
            </div>
        </div>
    </div>

    <main>
        <aside class="deep-glass silo" id="surah-target"></aside>
        <section id="viewport" class="deep-glass silo"><div id="reader-target"></div></section>
        <aside class="deep-glass silo">
            <h4 style="color:var(--emerald); margin-top:0; letter-spacing:1px;">SENTINEL AI</h4>
            <div id="ai-output" style="font-size: 0.85rem; opacity: 0.8; line-height: 1.8;">Matrix online. Select a sign to begin extraction.</div>
        </aside>
    </main>

    <div class="deep-glass player-bar">
        <div id="np-surah" style="width:200px;"><b>Ready</b></div>
        <div style="display:flex; gap:25px; align-items:center;">
            <i data-lucide="skip-back" style="cursor:pointer;" onclick="App.logic.prev()"></i>
            <button class="play-btn" onclick="App.audio.toggle()"><i data-lucide="play" id="play-icon"></i></button>
            <i data-lucide="skip-forward" style="cursor:pointer;" onclick="App.logic.next()"></i>
        </div>
        <div style="width:200px; text-align:right;"><i data-lucide="volume-2"></i></div>
    </div>

    <audio id="core-audio"></audio>

    <script>
        const App = {
            state: { 
                chapters: [], currentId: 1, tajweed: false, focus: false, indopak: false, loading: false,
                xp: parseInt(localStorage.getItem('sov-xp')) || 0,
                secondsRead: parseInt(localStorage.getItem('sov-time')) || 0
            },

            async init(retries = 3) {
                try {
                    const res = await fetch('https://api.alquran.cloud/v1/surah');
                    if (!res.ok) throw new Error();
                    const json = await res.json();
                    this.state.chapters = json.data;
                    this.ui.renderList(this.state.chapters);
                    this.logic.load(1);
                    this.track();
                    this.ui.updateStats();
                } catch (e) {
                    if (retries > 0) setTimeout(() => this.init(retries - 1), 2000);
                }
            },

            track() {
                setInterval(() => {
                    if (!document.hidden && !this.state.loading) {
                        this.state.secondsRead++;
                        if (this.state.secondsRead % 5 === 0) {
                            this.state.xp += 2;
                            this.ui.updateStats();
                            localStorage.setItem('sov-xp', this.state.xp);
                            localStorage.setItem('sov-time', this.state.secondsRead);
                        }
                    }
                }, 1000);
            },

            ui: {
                renderList(list) {
                    document.getElementById('surah-target').innerHTML = list.map(s => `
                        <div class="card" id="s-${s.number}" onclick="App.logic.load(${s.number})">
                            <div style="font-size:0.65rem; opacity:0.4;">ID: ${s.number}</div>
                            <b>${s.englishName}</b>
                        </div>`).join('');
                    lucide.createIcons();
                },
                toggle(id) {
                    const el = document.getElementById(`${id}-drawer`);
                    document.querySelectorAll('.drawer').forEach(d => { if(d !== el) d.classList.remove('open') });
                    el.classList.toggle('open');
                },
                refresh() {
                    App.state.tajweed = document.getElementById('pref-tajweed').checked;
                    App.state.focus = document.getElementById('pref-focus').checked;
                    App.state.indopak = document.getElementById('pref-indopak').checked;
                    
                    const target = document.getElementById('reader-target');
                    const view = document.getElementById('viewport');
                    
                    target.classList.toggle('tajweed-active', App.state.tajweed);
                    view.classList.toggle('focus-mode', App.state.focus);
                    view.classList.toggle('script-indopak', App.state.indopak);
                },
                updateStats() {
                    const mins = Math.floor(App.state.secondsRead / 60);
                    document.getElementById('stat-xp').innerText = `${App.state.xp} XP`;
                    document.getElementById('stat-time').innerText = `${mins}m Active`;
                    let rank = "Seeker";
                    if(App.state.xp > 500) rank = "Scholar";
                    if(App.state.xp > 2000) rank = "Guardian";
                    document.getElementById('stat-rank').innerText = rank;
                },
                setTheme(val) {
                    document.body.classList.remove('theme-velvet', 'theme-ocean');
                    if(val !== 'emerald') document.body.classList.add(`theme-${val}`);
                }
            },

            logic: {
                async load(id) {
                    if (id < 1 || id > 114 || App.state.loading) return;
                    App.state.loading = true;
                    App.state.currentId = id;
                    const viewport = document.getElementById('viewport');
                    viewport.classList.add('loading');
                    
                    document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
                    document.getElementById(`s-${id}`)?.classList.add('active');

                    try {
                        const [ar, en] = await Promise.all([
                            fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-tajweed`).then(r => r.json()),
                            fetch(`https://api.alquran.cloud/v1/surah/${id}/en.sahih`).then(r => r.json())
                        ]);

                        // Improved Bismillah logic
                        const bismillah = "بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ";
                        let html = `<h1 style="text-align:center; font-family:Amiri; font-size:3.5rem; color:var(--emerald); margin-bottom:40px;">${ar.data.name}</h1>`;
                        
                        html += ar.data.ayahs.map((v, i) => {
                            let text = v.text;
                            if(id !== 1 && id !== 9 && i === 0) text = text.replace(bismillah, "").trim();
                            
                            // GREEDY TAJWEED PARSER: Fixes the "letters" issue
                            text = text.replace(/\[h:([^\]]+)\]/g, '<span class="taj-ghunnah">$1</span>')
                                       .replace(/\[q:([^\]]+)\]/g, '<span class="taj-qalqalah">$1</span>')
                                       .replace(/\[m:([^\]]+)\]/g, '<span class="taj-madd">$1</span>')
                                       .replace(/\[i:([^\]]+)\]/g, '<span class="taj-ikfa">$1</span>')
                                       .replace(/\[n:([^\]]+)\]/g, '<span class="taj-ghunnah">$1</span>')
                                       .replace(/\[l:([^\]]+)\]/g, '<span>$1</span>') // Hidden rule marker
                                       .replace(/\[p:([^\]]+)\]/g, '<span>$1</span>') // Hidden rule marker
                                       .replace(/\[\w:([^\]]+)\]/g, '<span class="taj-marker">$1</span>'); 

                            return `<div class="ayah-block">
                                <div class="q-text">${text}</div>
                                <div style="opacity:0.7; margin-top:20px; font-size:1.1rem; font-weight:300;">${en.data.ayahs[i].text}</div>
                                <div style="margin-top:20px; font-size:0.7rem; color:var(--emerald); opacity:0.5; font-weight:700;">SIGN ${id}:${v.numberInSurah}</div>
                            </div>`;
                        }).join('');

                        document.getElementById('reader-target').innerHTML = html;
                        viewport.scrollTop = 0;
                        document.getElementById('np-surah').innerHTML = `<b>${ar.data.englishName}</b>`;
                        
                        // Load full surah audio source
                        const audio = document.getElementById('core-audio');
                        audio.src = `https://cdn.islamic.network/quran/audio-surah/128/ar.alafasy/${id}.mp3`;
                        
                        setTimeout(() => { viewport.classList.remove('loading'); App.state.loading = false; lucide.createIcons(); }, 300);
                    } catch (e) { App.state.loading = false; viewport.classList.remove('loading'); }
                },
                next() { if(App.state.currentId < 114) this.load(App.state.currentId + 1); },
                prev() { if(App.state.currentId > 1) this.load(App.state.currentId - 1); }
            },

            audio: {
                toggle() {
                    const a = document.getElementById('core-audio');
                    const icon = document.getElementById('play-icon');
                    if(a.paused) { 
                        a.play().catch(e => console.log("Engine standby.")); 
                        icon.setAttribute('data-lucide', 'pause'); 
                    }
                    else { a.pause(); icon.setAttribute('data-lucide', 'play'); }
                    lucide.createIcons();
                }
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
