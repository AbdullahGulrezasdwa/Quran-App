<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sanctuary Quran</title>
  <link rel="icon" href="https://quran.com/favicon.ico">
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&family=Amiri+Quran&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary: #fbbf24; --bg: #030712; --card: #111827; --text: #f3f4f6; --muted: #9ca3af;
      --border: rgba(255,255,255,0.08); --arabic-font: 'Amiri Quran', serif;
      --nav-w: 90px; --side-w: 450px; --player-h: 120px;
      --quran-size: 5.5rem; --quran-weight: 400; --verse-spacing: 80px;
    }

    /* Production 67% Zoom Fix */
    html { transform: scale(0.67); transform-origin: top left; width: 149.25%; height: 149.25%; overflow: hidden; }

    /* THEME DEFINITIONS */
    body.t-dark-gold { --bg: #000; --card: #0a0a0a; --primary: #fbbf24; }
    body.t-midnight-emerald { --bg: #022c22; --card: #064e3b; --primary: #34d399; }
    body.t-deep-ocean { --bg: #0f172a; --card: #1e293b; --primary: #38bdf8; }
    body.t-sepia { --bg: #2d241e; --card: #3d3028; --primary: #d97706; }
    body.t-carbon { --bg: #121212; --card: #181818; --primary: #ffffff; }

    * { box-sizing: border-box; transition: background 0.2s, border 0.2s; }
    body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; }

    nav { width: var(--nav-w); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 30px 0; gap: 25px; flex-shrink: 0; background: var(--bg); z-index: 10; }
    main { flex: 1; overflow-y: auto; scroll-behavior: smooth; position: relative; }
    aside { width: var(--side-w); border-left: 1px solid var(--border); background: var(--card); padding: 40px; overflow-y: auto; flex-shrink: 0; display: none; }
    aside.visible { display: block; }

    .container { max-width: 1200px; margin: 0 auto; padding: 60px 40px 300px 40px; }

    /* QURAN TEXT ENGINE */
    .ayah-row { padding: var(--verse-spacing) 40px; border-bottom: 1px solid var(--border); border-radius: 20px; }
    .ayah-row.active { background: rgba(255,255,255,0.03); border: 1px solid var(--primary); }
    .arabic { font-family: var(--arabic-font); font-size: var(--quran-size); font-weight: var(--quran-weight); direction: rtl; line-height: 2.2; text-align: right; display: block; }
    .translation { font-size: 2.2rem; line-height: 1.8; color: var(--muted); margin-top: 30px; }

    /* MEMORIZATION OVERLAY */
    body.memo-mode .translation { display: none; }
    body.memo-mode .arabic { filter: blur(20px); opacity: 0.2; }
    body.memo-mode .revealed .arabic { filter: blur(0); opacity: 1; }

    /* MODAL SYSTEM */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { background: var(--card); padding: 50px; border-radius: 40px; border: 1px solid var(--border); width: 700px; }
    
    .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 30px; }
    .theme-btn { padding: 20px; border-radius: 15px; border: 1px solid var(--border); cursor: pointer; text-align: center; font-weight: 600; }

    .player-bar { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); width: 92%; height: var(--player-h); background: rgba(10,10,10,0.95); backdrop-filter: blur(30px); border: 1px solid var(--border); border-radius: 40px; display: flex; align-items: center; justify-content: space-between; padding: 0 60px; z-index: 100; }
    
    .btn { background: var(--card); color: var(--text); border: 1px solid var(--border); padding: 18px 30px; border-radius: 20px; cursor: pointer; font-size: 1.3rem; display: inline-flex; align-items: center; gap: 12px; }
    .btn:hover { border-color: var(--primary); }
    .btn-play { background: var(--primary); color: #000; border-radius: 50%; width: 90px; height: 90px; justify-content: center; border: none; }
  </style>
</head>
<body class="t-dark-gold">

  <nav>
    <div style="color:var(--primary); margin-bottom: 40px;"><i data-lucide="book-open-check" size="40"></i></div>
    <div class="btn" style="border:none;" onclick="updateRoute('home')"><i data-lucide="home" size="32"></i></div>
    <div class="btn" id="memo-btn" style="border:none;" onclick="toggleMemorization()"><i data-lucide="brain" size="32"></i></div>
    <div class="btn" style="border:none;" onclick="toggleModal('appearance-modal')"><i data-lucide="palette" size="32"></i></div>
    <div class="btn" style="border:none;" onclick="toggleModal('settings-modal')"><i data-lucide="settings-2" size="32"></i></div>
  </nav>

  <main id="scroll-main">
    <div class="container" id="view-container"></div>
  </main>

  <aside id="sidebar">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 id="side-title" style="font-size: 2.2rem;">Tafsir</h2>
        <button class="btn" onclick="toggleSidebar()"><i data-lucide="x"></i></button>
    </div>
    <div id="side-content" style="margin-top: 40px; font-size: 1.6rem; line-height: 1.8;"></div>
  </aside>

  <div id="appearance-modal" class="modal" onclick="toggleModal('appearance-modal')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2>Select Appearance</h2>
        <div class="theme-grid">
            <div class="theme-btn" onclick="setTheme('t-dark-gold')">Midnight Gold</div>
            <div class="theme-btn" onclick="setTheme('t-midnight-emerald')">Deep Emerald</div>
            <div class="theme-btn" onclick="setTheme('t-deep-ocean')">Ocean Blue</div>
            <div class="theme-btn" onclick="setTheme('t-sepia')">Warm Sepia</div>
            <div class="theme-btn" onclick="setTheme('t-carbon')">Carbon Mono</div>
        </div>
    </div>
  </div>

  <div id="settings-modal" class="modal" onclick="toggleModal('settings-modal')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2>Reading Settings</h2>
        <label>Arabic Font Size</label>
        <input type="range" style="width:100%; margin:20px 0;" min="3" max="10" step="0.5" value="5.5" oninput="updateStyle('--quran-size', this.value + 'rem')">
        <label>Line Spacing</label>
        <input type="range" style="width:100%; margin:20px 0;" min="40" max="200" step="10" value="80" oninput="updateStyle('--verse-spacing', this.value + 'px')">
        <button class="btn btn-primary" style="width:100%;" onclick="toggleModal('settings-modal')">Save</button>
    </div>
  </div>

  <div class="player-bar">
    <div style="width: 400px;">
        <div id="p-title" style="font-size: 1.8rem; font-weight: 700;">Sanctuary Quran</div>
        <div id="p-subtitle" class="text-muted" style="font-size: 1.3rem;">Pick a verse to begin</div>
    </div>
    <button class="btn-play" onclick="toggleAudio()"><i data-lucide="play" id="main-play"></i></button>
    <div style="width: 400px; text-align: right;">
        <button class="btn" onclick="toggleSidebar()">INFO <i data-lucide="info"></i></button>
    </div>
  </div>

  <audio id="audio-player"></audio>

  <script>
    const App = {
      isMemoMode: false,
      currentAyahIndex: 0,
      totalAyahs: 0,
      currentSurah: 0,

      async init() {
        lucide.createIcons();
        window.addEventListener('keydown', (e) => {
          if (e.code === 'Space' && this.isMemoMode) {
            e.preventDefault();
            this.revealNext();
          }
        });
        const res = await fetch('https://api.alquran.cloud/v1/surah');
        const data = await res.json();
        this.chapters = data.data;
        this.router();
      },

      router() {
        const params = new URLSearchParams(window.location.search);
        const surahId = params.get('surah');
        if (surahId) this.renderReader(surahId);
        else this.renderHome();
      },

      async renderHome() {
        let html = `<h1 style="font-size:4rem; margin-bottom:60px;">Library</h1><div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap:30px;">`;
        html += this.chapters.map(s => `
          <div class="btn" style="display:block; padding:40px; text-align:left;" onclick="updateRoute('surah', ${s.number})">
            <h3 style="font-size:2.2rem; margin:0 0 10px 0;">${s.englishName}</h3>
            <p style="opacity:0.6; font-size:1.2rem;">${s.numberOfAyahs} Verses</p>
          </div>
        `).join('') + `</div>`;
        document.getElementById('view-container').innerHTML = html;
        lucide.createIcons();
      },

      async renderReader(id) {
        this.currentSurah = id;
        const [ar, en] = await Promise.all([
          fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-uthmani`).then(r => r.json()),
          fetch(`https://api.alquran.cloud/v1/surah/${id}/en.sahih`).then(r => r.json())
        ]);
        
        this.totalAyahs = ar.data.numberOfAyahs;
        let html = `<h1 style="text-align:center; font-family:var(--arabic-font); font-size:7rem; margin-bottom:100px; color:var(--primary);">${ar.data.name}</h1>`;
        
        ar.data.ayahs.forEach((ayah, i) => {
          html += `<div class="ayah-row" id="ayah-${i}">
            <div class="arabic">${ayah.text} <span style="font-size:1.5rem; color:var(--primary);">(${i+1})</span></div>
            <div class="translation">${en.data.ayahs[i].text}</div>
            <div style="margin-top:30px; display:flex; gap:15px;">
                <button class="btn" onclick="App.loadTafsir(${id}, ${i+1})"><i data-lucide="book-text"></i> Tafsir</button>
                <button class="btn" onclick="App.playVerse(${id}, ${i+1}, ${i})"><i data-lucide="play-circle"></i> Play</button>
            </div>
          </div>`;
        });
        document.getElementById('view-container').innerHTML = html;
        document.getElementById('p-title').innerText = ar.data.englishName;
        lucide.createIcons();
      },

      async loadTafsir(surah, ayah) {
        const side = document.getElementById('sidebar');
        side.classList.add('visible');
        document.getElementById('side-content').innerHTML = "Loading Tafsir...";
        const res = await fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${ayah}/ar.jalalayn`);
        const data = await res.json();
        document.getElementById('side-content').innerHTML = `<p style="direction:rtl; text-align:right; font-family:var(--arabic-font); font-size:2.2rem;">${data.data.text}</p>`;
      },

      playVerse(surah, ayah, index) {
        this.currentAyahIndex = index;
        const player = document.getElementById('audio-player');
        // Simple map for Alafasy
        let absolute = 0;
        for(let i=0; i<surah-1; i++) absolute += this.chapters[i].numberOfAyahs;
        absolute += ayah;

        player.src = `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${absolute}.mp3`;
        player.play();
        
        document.querySelectorAll('.ayah-row').forEach(r => r.classList.remove('active'));
        document.getElementById(`ayah-${index}`).classList.add('active');
        document.getElementById(`ayah-${index}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        document.getElementById('main-play').setAttribute('data-lucide', 'pause');
        lucide.createIcons();
      },

      revealNext() {
        const row = document.getElementById(`ayah-${this.currentAyahIndex}`);
        if(row) {
            row.classList.add('revealed');
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            this.currentAyahIndex++;
        }
      }
    };

    function toggleMemorization() {
        App.isMemoMode = !App.isMemoMode;
        document.body.classList.toggle('memo-mode');
        document.getElementById('memo-btn').classList.toggle('active');
        App.currentAyahIndex = 0;
        document.querySelectorAll('.ayah-row').forEach(r => r.classList.remove('revealed'));
        if(App.isMemoMode) {
            document.getElementById('sidebar').classList.add('visible');
            document.getElementById('side-content').innerHTML = `<h3>Memorization Mode</h3><p>Spacebar to reveal next verse.</p>`;
        }
    }

    function toggleAudio() {
        const p = document.getElementById('audio-player');
        if(p.paused) p.play(); else p.pause();
        document.getElementById('main-play').setAttribute('data-lucide', p.paused ? 'play' : 'pause');
        lucide.createIcons();
    }

    function setTheme(t) { document.body.className = t; toggleModal('appearance-modal'); }
    function toggleModal(id) { const m = document.getElementById(id); m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; }
    function updateStyle(p, v) { document.documentElement.style.setProperty(p, v); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('visible'); }
    function updateRoute(t, v) {
        const url = new URL(window.location);
        if(t === 'surah') url.searchParams.set('surah', v);
        else url.searchParams.delete('surah');
        window.history.pushState({}, '', url);
        App.router();
    }

    window.onload = () => App.init();
  </script>
</body>
</html>
