<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign | Neural Elite</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --p: #10b981; --bg: #020617; --surf: #0f172a; --text: #f8fafc; --sub: #94a3b8; --border: #1e293b; 
            --ar-size: 2.8rem; --en-size: 1.1rem;
        }
        [data-theme="sepia"] { --bg: #f5f2e9; --surf: #e8e4d9; --text: #2d241e; --sub: #5d534a; --border: #d1cdc0; --p: #8b5e3c; }
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Navigation Sidebar */
        nav { width: 80px; background: var(--surf); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 25px 0; gap: 20px; z-index: 100; }
        .nav-link { color: var(--sub); cursor: pointer; padding: 12px; border-radius: 12px; transition: 0.2s; }
        .nav-link.active { color: var(--p); background: rgba(16,185,129,0.1); }

        /* Main Workspace */
        main { flex: 1; display: flex; flex-direction: column; position: relative; }
        .progress-bar { height: 4px; background: var(--p); width: 0%; position: absolute; top: 0; left: 0; transition: 0.3s; z-index: 1000; }
        header { padding: 20px 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg); }
        #content { flex: 1; overflow-y: auto; padding: 40px; scroll-behavior: smooth; }

        /* Arabic Text & Tajweed */
        .ayah { padding: 45px 0; border-bottom: 1px solid var(--border); transition: 0.3s; position: relative; }
        .ayah.memorized { border-left: 4px solid var(--p); background: rgba(16, 185, 129, 0.02); }
        .ar { font-family: 'Amiri', serif; font-size: var(--ar-size); text-align: right; direction: rtl; line-height: 2.5; margin-bottom: 15px; color: var(--p); }
        .tj-ghunnah { color: #f43f5e; font-weight: bold; }
        .tj-qal { color: #3b82f6; font-weight: bold; }
        
        /* Word by Word */
        .word { display: inline-block; cursor: pointer; transition: 0.2s; border-radius: 4px; padding: 0 4px; }
        .word:hover { background: rgba(16, 185, 129, 0.15); transform: translateY(-2px); }

        /* Overlays */
        #side-panel { position: fixed; right: -450px; top: 0; width: 400px; height: 100%; background: var(--surf); border-left: 1px solid var(--border); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1001; padding: 35px; box-shadow: -10px 0 30px rgba(0,0,0,0.5); overflow-y: auto; }
        #side-panel.open { right: 0; }

        /* HUD */
        #hud { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--surf); border: 1px solid var(--border); padding: 12px 25px; border-radius: 50px; display: flex; align-items: center; gap: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.4); z-index: 99; backdrop-filter: blur(10px); }
        .control-btn { color: var(--sub); cursor: pointer; border: none; background: none; transition: 0.2s; }
        .control-btn:hover { color: var(--p); transform: scale(1.1); }
        
        /* AI Elements */
        .ai-status { font-size: 0.65rem; padding: 4px 8px; border-radius: 4px; background: var(--border); margin-left: 10px; }
        .ai-bubble { background: rgba(255,255,255,0.03); border-left: 3px solid var(--p); padding: 15px; margin-top: 15px; font-size: 0.95rem; line-height: 1.6; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>

    <nav>
        <div class="nav-link active" id="btn-home" onclick="Sovereign.setView('home')"><i data-lucide="home"></i></div>
        <div class="nav-link" id="btn-hifz" onclick="Sovereign.setView('hifz')"><i data-lucide="brain"></i></div>
        <div class="nav-link" onclick="Sovereign.cycleTheme()"><i data-lucide="palette"></i></div>
    </nav>

    <main>
        <div class="progress-bar" id="reading-progress"></div>
        <header>
            <div style="display:flex; align-items:center;">
                <h2 id="header-title" style="margin:0">Sovereign</h2>
                <span id="ai-indicator" class="ai-status">AI OFFLINE</span>
            </div>
            <div id="header-actions">
                <input type="text" placeholder="Quick Search..." oninput="Sovereign.search(this.value)" style="background:var(--surf); border:1px solid var(--border); color:white; padding:8px 15px; border-radius:20px; outline:none; width: 250px;">
            </div>
        </header>
        <div id="content"></div>
    </main>

    <div id="side-panel">
        <div style="display:flex; justify-content:space-between; margin-bottom: 20px;">
            <button onclick="Sovereign.closePanel()" style="background:none; border:none; color:var(--sub); cursor:pointer;"><i data-lucide="x"></i></button>
            <button id="ai-ask-btn" onclick="Sovereign.ai.reflect()" style="background:var(--p); border:none; color:white; padding:5px 12px; border-radius:5px; cursor:pointer; font-size:0.8rem;">Ask Sovereign AI</button>
        </div>
        <div id="panel-body">
            <h3 id="panel-word" style="font-family:'Amiri'; font-size: 3rem; color:var(--p); margin: 0;"></h3>
            <p id="panel-meta" style="color:var(--sub); text-transform:uppercase; font-size:0.7rem;"></p>
            <hr style="border:0.5px solid var(--border); margin: 20px 0;">
            <div id="panel-text" style="line-height:1.7;"></div>
        </div>
    </div>

    <div id="hud">
        <button class="control-btn" onclick="Sovereign.audio.prev()"><i data-lucide="rewind"></i></button>
        <button class="control-btn" onclick="Sovereign.audio.toggle()" id="play-trigger"><i data-lucide="play" style="fill: currentColor;"></i></button>
        <button class="control-btn" onclick="Sovereign.audio.next()"><i data-lucide="fast-forward"></i></button>
        <div id="hud-label" style="font-size: 0.8rem; color: var(--sub); border-left: 1px solid var(--border); padding-left: 15px; min-width: 120px;">Standby</div>
    </div>

    <script type="module">
        // Import WebGPU AI Engine
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        const db = new Dexie("SovereignElite");
        db.version(1).stores({ hifz: 'ayahKey, date', prefs: 'key, value' });

        window.Sovereign = {
            state: { currentSurah: null, currentAyah: 1, lastWord: '', chapters: [] },
            
            async init() {
                const res = await fetch('https://api.alquran.cloud/v1/surah');
                const data = await res.json();
                this.state.chapters = data.data;
                this.setView('home');
                lucide.createIcons();
                
                // Track Reading Progress
                document.getElementById('content').onscroll = (e) => {
                    const scrolled = (e.target.scrollTop / (e.target.scrollHeight - e.target.clientHeight)) * 100;
                    document.getElementById('reading-progress').style.width = scrolled + "%";
                };

                // Init AI (Quietly)
                this.ai.init();
            },

            async setView(view) {
                const container = document.getElementById('content');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.getElementById(`btn-${view}`).classList.add('active');

                if (view === 'home') this.renderIndex(container);
                if (view === 'hifz') this.renderHifz(container);
            },

            renderIndex(container) {
                document.getElementById('header-title').innerText = "Surah Index";
                container.innerHTML = `<div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    ${this.state.chapters.map(s => `
                        <div style="background:var(--surf); padding:20px; border-radius:15px; border:1px solid var(--border); cursor:pointer;" onclick="Sovereign.loadSurah(${s.number})">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <b>${s.number}. ${s.englishName}</b>
                                <span style="font-family:Amiri; color:var(--p); font-size:1.4rem;">${s.name}</span>
                            </div>
                            <small style="color:var(--sub)">${s.numberOfAyahs} Verses • ${s.revelationType}</small>
                        </div>
                    `).join('')}
                </div>`;
            },

            async loadSurah(id) {
                this.state.currentSurah = id;
                const container = document.getElementById('content');
                container.innerHTML = `<p>Opening Divine Decree...</p>`;
                
                const [ar, en, memorized] = await Promise.all([
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-uthmani`).then(r => r.json()),
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/en.sahih`).then(r => r.json()),
                    db.hifz.toArray()
                ]);

                const memKeys = new Set(memorized.map(m => m.ayahKey));

                document.getElementById('header-title').innerText = ar.data.englishName;
                container.innerHTML = ar.data.ayahs.map((v, i) => {
                    const key = `${id}:${i+1}`;
                    return `
                    <div class="ayah ${memKeys.has(key) ? 'memorized' : ''}" id="a-${i+1}">
                        <div class="ar">${this.applyTajweed(v.text, key)}</div>
                        <div class="en">${en.data.ayahs[i].text}</div>
                        <div style="margin-top:15px; display:flex; gap:10px;">
                            <button class="control-btn" onclick="Sovereign.audio.play(${id}, ${i+1})"><i data-lucide="play" style="width:14px"></i></button>
                            <button class="control-btn" onclick="Sovereign.markHifz('${key}')"><i data-lucide="bookmark" style="width:14px"></i></button>
                        </div>
                    </div>`;
                }).join('');
                lucide.createIcons();
                container.scrollTop = 0;
            },

            applyTajweed(text, ayahKey) {
                return text.split(' ').map(word => {
                    let tajweed = word
                        .replace(/([نّمّ])/g, '<span class="tj-ghunnah">$1</span>')
                        .replace(/([قطبجد])/g, '<span class="tj-qal">$1</span>');
                    return `<span class="word" onclick="Sovereign.openLexicon('${word}', '${ayahKey}')">${tajweed}</span>`;
                }).join(' ');
            },

            async openLexicon(word, key) {
                const cleanWord = word.replace(/<[^>]*>?/gm, '');
                this.state.lastWord = cleanWord;
                this.state.lastAyahKey = key;

                document.getElementById('panel-word').innerText = cleanWord;
                document.getElementById('panel-meta').innerText = `Verse ${key} | Linguistic Root Analysis`;
                document.getElementById('panel-text').innerHTML = `
                    <p>Root identification in progress... This word appears in the context of verse ${key}. 
                    Click <b>Ask AI</b> to get a deep-dive into the spiritual and grammatical significance of this specific term.</p>`;
                document.getElementById('side-panel').classList.add('open');
            },

            async markHifz(key) {
                await db.hifz.put({ ayahKey: key, date: Date.now() });
                document.getElementById(`a-${key.split(':')[1]}`).classList.add('memorized');
            },

            async renderHifz(container) {
                const items = await db.hifz.toArray();
                document.getElementById('header-title').innerText = "Hifz Vault";
                container.innerHTML = `<h3>Memorized Verses (${items.length})</h3>
                <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap:10px;">
                    ${items.map(i => `<div style="background:var(--surf); padding:15px; border-radius:10px; border:1px solid var(--p); text-align:center;">Verse ${i.ayahKey}</div>`).join('')}
                </div>`;
            },

            closePanel() { document.getElementById('side-panel').classList.remove('open'); },
            cycleTheme() {
                const current = document.body.getAttribute('data-theme');
                document.body.setAttribute('data-theme', current === 'sepia' ? 'midnight' : 'sepia');
            },

            audio: {
                player: new Audio(),
                play(s, a) {
                    const src = `https://everyayah.com/data/Alafasy_128kbps/${s.toString().padStart(3,'0')}${a.toString().padStart(3,'0')}.mp3`;
                    this.player.src = src;
                    this.player.play();
                    document.getElementById('hud-label').innerText = `Reciting ${s}:${a}`;
                    document.getElementById('play-trigger').innerHTML = '<i data-lucide="pause" style="fill:currentColor"></i>';
                    lucide.createIcons();
                },
                toggle() {
                    if (this.player.paused) this.player.play();
                    else this.player.pause();
                }
            },

            ai: {
                engine: null,
                async init() {
                    if (!navigator.gpu) return;
                    document.getElementById('ai-indicator').innerText = "AI READY (GPU)";
                },
                async reflect() {
                    const btn = document.getElementById('ai-ask-btn');
                    const output = document.getElementById('panel-text');
                    
                    btn.innerText = "Thinking...";
                    output.innerHTML += `<div class="ai-bubble" id="ai-loading">Sovereign Neural Engine is analyzing verse ${Sovereign.state.lastAyahKey}...</div>`;
                    
                    try {
                        if(!this.engine) {
                            this.engine = await webllm.createMLCEngine("Llama-3-8B-Instruct-q4f32_1-MLC");
                        }
                        
                        const prompt = `Explain the word "${Sovereign.state.lastWord}" in the context of Quran verse ${Sovereign.state.lastAyahKey}. Provide linguistic root and spiritual meaning.`;
                        const res = await this.engine.chat.completions.create({
                            messages: [{role: "user", content: prompt}]
                        });
                        
                        document.getElementById('ai-loading').remove();
                        output.innerHTML += `<div class="ai-bubble"><b>AI Reflection:</b><br>${res.choices[0].message.content}</div>`;
                    } catch (e) {
                        output.innerHTML = `<p style="color:red">WebGPU Model too large for this device. Using cloud-fallback (mock)...</p>
                        <div class="ai-bubble">The word "${Sovereign.state.lastWord}" carries deep weight in verse ${Sovereign.state.lastAyahKey}, often linked to the concept of absolute divine sovereignty.</div>`;
                    }
                    btn.innerText = "Ask Sovereign AI";
                }
            }
        };

        window.onload = () => Sovereign.init();
    </script>
</body>
</html>
