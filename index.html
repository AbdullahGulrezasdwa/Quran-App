<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Quran | Fully Functional</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --p: #10b981; --bg: #020617; --surf: #0f172a;
            --text: #f8fafc; --border: #1e293b; --font-ar: 'Amiri', serif;
        }

        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar Nav */
        nav { width: 75px; background: var(--surf); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 1.5rem 0; z-index: 100; }
        .nav-btn { width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.2rem; cursor: pointer; color: #64748b; transition: 0.3s; }
        .nav-btn:hover { color: var(--p); background: rgba(16, 185, 129, 0.1); }
        .nav-btn.active { background: var(--p); color: white; }

        /* Main Content */
        main { flex: 1; overflow-y: auto; scroll-behavior: auto; position: relative; }
        .header { position: sticky; top: 0; background: rgba(2, 6, 23, 0.9); backdrop-filter: blur(12px); padding: 1.5rem 2.5rem; border-bottom: 1px solid var(--border); z-index: 50; display: flex; justify-content: space-between; align-items: center; gap: 20px; }

        /* Search Bar Styles */
        .search-container { position: relative; flex: 1; max-width: 300px; }
        #surah-search { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; color: white; font-size: 0.85rem; outline: none; transition: 0.3s; }
        #surah-search:focus { border-color: var(--p); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }

        .reader-container { max-width: 850px; margin: 0 auto; padding: 2rem; min-height: 101vh; }
        .ayah-card { padding: 2.5rem 0; border-bottom: 1px solid var(--border); opacity: 0; transform: translateY(15px); transition: 0.5s ease-out; }
        .ayah-card.visible { opacity: 1; transform: translateY(0); }
        .ayah-card.playing { border-left: 4px solid var(--p); background: linear-gradient(to right, rgba(16, 185, 129, 0.05), transparent); padding-left: 20px; }

        .ar { font-family: var(--font-ar); font-size: 2.6rem; text-align: right; direction: rtl; line-height: 2.3; margin-bottom: 1.2rem; color: #fff; transition: filter 0.3s; }
        body.hide-ar .ar { filter: blur(12px); }
        body.hide-ar .ar:hover { filter: blur(0); }

        .player-bar { position: fixed; bottom: 20px; left: 95px; right: 20px; background: var(--surf); border: 1px solid var(--border); border-radius: 16px; padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.7); z-index: 1000; transform: translateY(150%); transition: 0.4s; }
        .player-bar.active { transform: translateY(0); }
        .play-btn { background: var(--p); color: white; width: 48px; height: 48px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        #sentinel { height: 100px; width: 100%; }
        #toast { position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 10000; display: none; }
    </style>
</head>
<body>

    <nav>
        <div class="nav-btn active" id="btn-home" onclick="Sovereign.actions.changeSurah(1)"><i data-lucide="book"></i></div>
        <div class="nav-btn" id="btn-hifz" onclick="Sovereign.actions.toggleHifz()"><i data-lucide="eye"></i></div>
        <div class="nav-btn" id="btn-kahf" onclick="Sovereign.actions.changeSurah(18)"><i data-lucide="sparkles"></i></div>
        <div style="flex:1"></div>
        <div class="nav-btn" onclick="Sovereign.store.clear()"><i data-lucide="refresh-ccw"></i></div>
    </nav>

    <main id="scroll-root">
        <header class="header">
            <div style="flex: 2;">
                <h1 id="view-title">Sovereign</h1>
                <p id="view-meta" style="font-size: 0.75rem; opacity: 0.5;"></p>
            </div>
            
            <div class="search-container">
                <input type="number" id="surah-search" placeholder="Jump to Surah (1-114)..." min="1" max="114">
            </div>

            <div id="status-icon"><i data-lucide="activity" style="color:var(--p); width:18px;"></i></div>
        </header>

        <div class="reader-container" id="main-view"></div>
        <div id="sentinel"></div>
    </main>

    <div class="player-bar" id="audio-panel">
        <button class="play-btn" id="play-trigger"><i data-lucide="play"></i></button>
        <div style="flex:1">
            <div id="playing-title" style="font-weight:700; font-size:0.9rem;"></div>
            <div style="font-size:0.7rem; opacity:0.5;">RECITATION ACTIVE</div>
        </div>
        <audio id="audio-node"></audio>
    </div>

    <div id="toast"></div>

    <script>
        const Sovereign = {
            store: {
                get: (k) => { try { return JSON.parse(localStorage.getItem(`sq_${k}`)); } catch(e) { return null; } },
                set: (k, v) => localStorage.setItem(`sq_${k}`, JSON.stringify(v)),
                clear: () => { localStorage.clear(); location.reload(); },
                cache: new Map()
            },

            state: {
                surahId: null,
                verses: [],
                rendered: 0,
                chunk: 15,
                hifz: false,
                abort: null,
                audioAbort: null,
                obs: null,
                sentinelObs: null
            },

            api: {
                async fetchSurah(id, signal) {
                    if (Sovereign.store.cache.has(id)) return Sovereign.store.cache.get(id);
                    const [m, v] = await Promise.all([
                        fetch(`https://api.quran.com/api/v4/chapters/${id}`, { signal }),
                        fetch(`https://api.quran.com/api/v4/verses/by_chapter/${id}?language=en&translations=131`, { signal })
                    ]);
                    const data = { meta: (await m.json()).chapter, verses: (await v.json()).verses };
                    Sovereign.store.cache.set(id, data);
                    return data;
                },
                async fetchAudio(key, signal) {
                    const r = await fetch(`https://api.quran.com/api/v4/recitations/7/by_ayah/${key}`, { signal });
                    const res = await r.json();
                    return res.audio_files[0].url;
                }
            },

            ui: {
                renderChunk() {
                    const target = document.getElementById('main-view');
                    const nextBatch = Sovereign.state.verses.slice(Sovereign.state.rendered, Sovereign.state.rendered + Sovereign.state.chunk);
                    if (nextBatch.length === 0) return;

                    const frag = document.createDocumentFragment();
                    nextBatch.forEach(v => {
                        const card = document.createElement('div');
                        card.className = 'ayah-card';
                        card.id = `ayah-${v.verse_key}`;
                        card.innerHTML = `
                            <div class="ar">${v.text_uthmani}</div>
                            <div class="en">${v.translations[0].text.replace(/<\/?[^>]+(>|$)/g, "")}</div>
                            <button class="listen-btn" onclick="Sovereign.actions.play('${v.verse_key}')" style="margin-top:1rem; border:none; background:none; color:var(--p); font-size:0.75rem; font-weight:800; cursor:pointer;">LISTEN</button>
                        `;
                        frag.appendChild(card);
                        Sovereign.state.obs.observe(card);
                    });
                    target.appendChild(frag);
                    Sovereign.state.rendered += nextBatch.length;
                    lucide.createIcons();
                }
            },

            actions: {
                async changeSurah(id) {
                    if (!id || id < 1 || id > 114) return;
                    if (Sovereign.state.abort) Sovereign.state.abort.abort();
                    Sovereign.state.abort = new AbortController();
                    
                    document.getElementById('main-view').innerHTML = '';
                    Sovereign.state.rendered = 0;
                    document.getElementById('scroll-root').scrollTop = 0;

                    try {
                        const data = await Sovereign.api.fetchSurah(id, Sovereign.state.abort.signal);
                        Sovereign.state.verses = data.verses;
                        Sovereign.state.surahId = id;
                        
                        document.getElementById('view-title').innerText = data.meta.name_simple;
                        document.getElementById('view-meta').innerText = `${data.meta.revelation_place.toUpperCase()} â€¢ ${data.meta.verses_count} VERSES`;
                        
                        Sovereign.ui.renderChunk();
                        Sovereign.store.set('last_surah', id);
                    } catch (e) {
                        if (e.name !== 'AbortError') console.error("Load Failed", e);
                    }
                },

                async play(key) {
                    if (Sovereign.state.audioAbort) Sovereign.state.audioAbort.abort();
                    Sovereign.state.audioAbort = new AbortController();

                    const panel = document.getElementById('audio-panel');
                    const audio = document.getElementById('audio-node');
                    
                    panel.classList.add('active');
                    document.getElementById('playing-title').innerText = `Ayah ${key}`;
                    
                    document.querySelectorAll('.ayah-card').forEach(c => c.classList.remove('playing'));
                    const card = document.getElementById(`ayah-${key}`);
                    if(card) {
                        card.classList.add('playing');
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }

                    try {
                        const url = await Sovereign.api.fetchAudio(key, Sovereign.state.audioAbort.signal);
                        audio.src = `https://verses.quran.com/${url}`;
                        audio.play();
                        Sovereign.actions.updatePlayIcon(true);
                    } catch (e) {
                        if (e.name !== 'AbortError') console.error("Audio Failed", e);
                    }
                },

                toggleHifz() {
                    Sovereign.state.hifz = !Sovereign.state.hifz;
                    document.body.classList.toggle('hide-ar', Sovereign.state.hifz);
                    Sovereign.store.set('hifz', Sovereign.state.hifz);
                    document.getElementById('btn-hifz').classList.toggle('active', Sovereign.state.hifz);
                },

                updatePlayIcon(playing) {
                    document.getElementById('play-trigger').innerHTML = `<i data-lucide="${playing ? 'pause' : 'play'}"></i>`;
                    lucide.createIcons();
                }
            },

            boot() {
                lucide.createIcons();

                // 1. Setup Search Event
                document.getElementById('surah-search').onkeydown = (e) => {
                    if (e.key === 'Enter') Sovereign.actions.changeSurah(e.target.value);
                };

                // 2. Setup Observers
                Sovereign.state.obs = new IntersectionObserver(entries => {
                    entries.forEach(e => { if(e.isIntersecting) e.target.classList.add('visible') });
                }, { threshold: 0.1 });

                Sovereign.state.sentinelObs = new IntersectionObserver(entries => {
                    if(entries[0].isIntersecting && Sovereign.state.verses.length > Sovereign.state.rendered) {
                        Sovereign.ui.renderChunk();
                    }
                }, { root: document.getElementById('scroll-root'), rootMargin: '300px' });
                Sovereign.state.sentinelObs.observe(document.getElementById('sentinel'));

                // 3. Audio Chaining Logic
                const node = document.getElementById('audio-node');
                const trigger = document.getElementById('play-trigger');
                
                trigger.onclick = () => {
                    if (node.paused) { node.play(); Sovereign.actions.updatePlayIcon(true); }
                    else { node.pause(); Sovereign.actions.updatePlayIcon(false); }
                };

                node.onended = () => {
                    const current = document.querySelector('.ayah-card.playing');
                    const next = current?.nextElementSibling;
                    if (next && next.id && next.id.startsWith('ayah-')) {
                        Sovereign.actions.play(next.id.replace('ayah-', ''));
                    }
                };

                // 4. Initial Load
                const last = Sovereign.store.get('last_surah') || 1;
                Sovereign.state.hifz = Sovereign.store.get('hifz') || false;
                document.body.classList.toggle('hide-ar', Sovereign.state.hifz);
                document.getElementById('btn-hifz').classList.toggle('active', Sovereign.state.hifz);
                
                this.actions.changeSurah(last);
            }
        };

        window.onload = () => Sovereign.boot();
    </script>
</body>
</html>
