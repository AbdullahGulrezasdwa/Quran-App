<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Sanctuary | Sovereign v1.3</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600&family=Amiri+Quran&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet" />
    
    <style>
        :root {
            --bg: #010c09; --card: #021a14; --primary: #10b981; --text: #ecfdf5; 
            --border: rgba(16, 185, 129, 0.15); --font-ar: 'Amiri Quran', serif; 
            --ar-size: 2.8rem; --gold: #fbbf24; --transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Themes */
        body.t-midnight { --bg: #020617; --card: #0f172a; --primary: #38bdf8; --text: #f1f5f9; }
        body.t-rose { --bg: #1c0a0a; --card: #2d1616; --primary: #fb7185; --text: #fff1f2; }
        body.t-dark-gold { --bg: #0d0d0d; --card: #1a1a1a; --primary: #d4af37; --text: #f2f2f2; }

        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; display: flex; height: 100vh; }
        
        /* Layout */
        .nav-rail { width: 80px; border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 25px 0; gap: 20px; background: var(--bg); z-index: 1000; }
        #main-stage { flex: 1; display: flex; overflow: hidden; position: relative; }
        main { flex: 1; overflow-y: auto; scroll-behavior: smooth; transition: var(--transition); padding: 0 40px; }
        body.settings-open main { flex: 0 0 calc(100% - 400px); opacity: 0.5; }

        /* Content */
        .content-max { max-width: 900px; margin: 0 auto; padding: 60px 0 300px 0; }
        .ayah-row { padding: 40px 0; border-bottom: 1px solid var(--border); transition: var(--transition); }
        .arabic { font-family: var(--font-ar); font-size: var(--ar-size); direction: rtl; line-height: 2.2; text-align: right; }
        .arabic-word { display: inline-block; cursor: pointer; transition: 0.2s; padding: 0 4px; border-radius: 8px; }
        .arabic-word:hover { background: var(--primary); color: var(--bg); transform: scale(1.1); }
        
        /* Buttons & Shadows */
        .btn-ui { 
            background: var(--card); border: 1px solid var(--border); color: var(--text); 
            cursor: pointer; padding: 12px; border-radius: 16px; transition: var(--transition);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
        }
        .btn-ui:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2); border-color: var(--primary); }
        .btn-ui:active { transform: translateY(0); scale: 0.95; }

        /* Floating Player */
        .player-dock { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(200%); 
            width: 90%; max-width: 750px; background: var(--card); border: 1px solid var(--border); 
            border-radius: 28px; padding: 18px 35px; display: flex; align-items: center; justify-content: space-between; 
            z-index: 2000; backdrop-filter: blur(20px); box-shadow: 0 20px 50px rgba(0,0,0,0.5); opacity: 0;
            transition: var(--transition);
        }
        body.surah-active .player-dock { transform: translateX(-50%) translateY(0); opacity: 1; }
        body.surah-active .player-dock.scrolled-down { transform: translateX(-50%) translateY(150%); opacity: 0; }

        .play-btn { 
            width: 58px; height: 58px; border-radius: 50%; background: var(--primary); 
            border: none; color: var(--bg); cursor: pointer; display: flex; 
            align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        /* Settings Drawer */
        .drawer { 
            position: fixed; right: -400px; top: 0; width: 400px; height: 100%; 
            background: var(--card); border-left: 1px solid var(--border); z-index: 3000; 
            transition: var(--transition); padding: 40px; overflow-y: auto; 
        }
        .drawer.open { right: 0; }

        /* Stats Cards */
        .home-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .stat-card { background: var(--card); padding: 25px; border-radius: 24px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        
        body.hifz-mode .arabic { filter: blur(12px); transition: 0.3s; }
        body.hifz-mode .arabic:hover { filter: blur(0); }
        body.hide-trans .translation { display: none; }
    </style>
</head>
<body>

    <nav class="nav-rail">
        <button class="btn-ui" onclick="Sanctuary.renderHome()"><i data-lucide="layout-grid"></i></button>
        <button class="btn-ui" onclick="Sanctuary.renderLibrary()"><i data-lucide="book-open"></i></button>
        <button class="btn-ui" id="hifz-toggle" onclick="Sanctuary.toggleHifz()"><i data-lucide="brain"></i></button>
        <button class="btn-ui" onclick="Sanctuary.toggleSettings()"><i data-lucide="settings"></i></button>
    </nav>

    <div id="main-stage">
        <main id="scroller">
            <div class="content-max" id="app-view"></div>
        </main>

        <div id="settings-panel" class="drawer">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px">
                <h2 style="margin:0">Preferences</h2>
                <button onclick="Sanctuary.toggleSettings()" class="btn-ui"><i data-lucide="x"></i></button>
            </div>
            
            <label style="font-size:0.8rem; opacity:0.6">READING SPEED</label>
            <input type="range" min="0.5" max="2" step="0.1" value="1" oninput="Sanctuary.updateSpeed(this.value)" style="width:100%; margin:15px 0; accent-color:var(--primary)">
            
            <label style="font-size:0.8rem; opacity:0.6; margin-top:20px; display:block">ARABIC FONT</label>
            <select onchange="Sanctuary.updateFont(this.value)" style="width:100%; padding:12px; background:var(--bg); color:white; border:1px solid var(--border); border-radius:12px; margin:10px 0">
                <option value="'Amiri Quran'">Uthmani Script</option>
                <option value="'Noto Sans Arabic'">IndoPak Script</option>
            </select>

            <div style="display:flex; justify-content:space-between; margin-top:30px">
                <span>Show Translation</span>
                <input type="checkbox" checked onchange="document.body.classList.toggle('hide-trans')">
            </div>
        </div>
    </div>

    <div class="player-dock">
        <div>
            <div id="p-surah" style="font-weight:600; font-size:1.1rem">Sanctuary</div>
            <div id="p-ayah" style="font-size:0.8rem; opacity:0.5">Ready to recite</div>
        </div>
        <div style="display:flex; align-items:center; gap:30px">
            <button class="btn-ui" style="background:none; border:none; box-shadow:none" onclick="Sanctuary.stepVerse(-1)"><i data-lucide="skip-back"></i></button>
            <button class="play-btn" onclick="Sanctuary.toggleAudio()">
                <i data-lucide="play" id="play-icon" fill="currentColor"></i>
                <i data-lucide="pause" id="pause-icon" fill="currentColor" style="display:none"></i>
            </button>
            <button class="btn-ui" style="background:none; border:none; box-shadow:none" onclick="Sanctuary.stepVerse(1)"><i data-lucide="skip-forward"></i></button>
        </div>
        <div style="width:100px; text-align:right">
            <i data-lucide="flame" style="color:var(--gold); vertical-align:middle"></i> <span id="streak-val">0</span>
        </div>
    </div>

    <audio id="core-audio"></audio>

    <script>
        // Use an IIFE to ensure Sanctuary is defined before any code calls it
        const Sanctuary = (() => {
            const state = { arData: null, curIdx: -1, hifz: false };
            let audio, scroller, dock;

            const init = async () => {
                audio = document.getElementById('core-audio');
                scroller = document.getElementById('scroller');
                dock = document.querySelector('.player-dock');
                
                audio.onended = () => Sanctuary.stepVerse(1);
                
                // Scroll Logic
                let lastScroll = 0;
                scroller.addEventListener('scroll', () => {
                    const current = scroller.scrollTop;
                    if (current > lastScroll && current > 150) dock.classList.add('scrolled-down');
                    else dock.classList.remove('scrolled-down');
                    lastScroll = current;
                });

                const res = await fetch('https://api.alquran.cloud/v1/surah');
                const data = await res.json();
                state.surahs = data.data;
                renderHome();
                lucide.createIcons();
            };

            const renderHome = () => {
                document.body.classList.remove('surah-active');
                const last = JSON.parse(localStorage.getItem('sanctuary_last'));
                const view = document.getElementById('app-view');
                
                view.innerHTML = `
                    <h1 style="font-size:2.5rem">The Noble Sanctuary</h1>
                    <div class="home-grid">
                        <div class="stat-card" onclick="Sanctuary.resume()" style="cursor:pointer; border-color:var(--primary)">
                            <small style="color:var(--primary)">LAST READ</small>
                            <h3>${last ? last.name : 'Start Journey'}</h3>
                            <p style="opacity:0.5">${last ? 'Verse ' + (last.idx + 1) : 'Select a Surah'}</p>
                        </div>
                        <div class="stat-card">
                            <small>PROGRESS</small>
                            <h3>15 mins</h3>
                            <p style="opacity:0.5">Daily Goal</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();
            };

            const renderLibrary = () => {
                document.body.classList.remove('surah-active');
                const view = document.getElementById('app-view');
                view.innerHTML = `<h1>Library</h1><div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:20px">` + 
                    state.surahs.map(s => `
                        <div class="btn-ui" onclick="Sanctuary.loadSurah(${s.number})" style="display:block; text-align:left; padding:25px">
                            <strong>${s.englishName}</strong><br>
                            <small style="opacity:0.5">${s.numberOfAyahs} Verses</small>
                        </div>
                    `).join('') + `</div>`;
                lucide.createIcons();
            };

            const loadSurah = async (id) => {
                document.body.classList.add('surah-active');
                const view = document.getElementById('app-view');
                view.innerHTML = `<div style="padding:100px; text-align:center">Loading Surah...</div>`;
                
                const [ar, en] = await Promise.all([
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-uthmani`).then(r => r.json()),
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/en.sahih`).then(r => r.json())
                ]);
                
                state.arData = ar.data;
                document.getElementById('p-surah').innerText = ar.data.englishName;
                
                let html = `<h2 style="text-align:center; font-family:var(--font-ar); font-size:3.5rem; margin-bottom:60px">${ar.data.name}</h2>`;
                ar.data.ayahs.forEach((v, i) => {
                    const words = v.text.split(' ').map(w => `<span class="arabic-word">${w}</span>`).join(' ');
                    html += `
                        <div class="ayah-row" id="v-${i}" onclick="Sanctuary.prepVerse(${v.number}, ${i})">
                            <div class="arabic">${words}</div>
                            <div class="translation" style="margin-top:20px; opacity:0.6">${en.data.ayahs[i].text}</div>
                        </div>`;
                });
                view.innerHTML = html;
            };

            const prepVerse = (gid, idx) => {
                state.curIdx = idx;
                audio.src = `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${gid}.mp3`;
                audio.play();
                updateUI(true);
                document.getElementById('p-ayah').innerText = `Verse ${idx + 1}`;
                document.getElementById(`v-${idx}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
                localStorage.setItem('sanctuary_last', JSON.stringify({id: state.arData.number, name: state.arData.englishName, idx: idx}));
            };

            const updateUI = (playing) => {
                document.getElementById('play-icon').style.display = playing ? 'none' : 'block';
                document.getElementById('pause-icon').style.display = playing ? 'block' : 'none';
                document.body.classList.toggle('playing', playing);
            };

            const resume = () => {
                const last = JSON.parse(localStorage.getItem('sanctuary_last'));
                if(last) loadSurah(last.id).then(() => setTimeout(() => prepVerse(state.arData.ayahs[last.idx].number, last.idx), 800));
            };

            return {
                init, renderHome, renderLibrary, loadSurah, prepVerse, resume,
                toggleAudio: () => { audio.paused ? audio.play() : audio.pause(); updateUI(!audio.paused); },
                toggleSettings: () => { document.getElementById('settings-panel').classList.toggle('open'); document.body.classList.toggle('settings-open'); },
                toggleHifz: () => { state.hifz = !state.hifz; document.body.classList.toggle('hifz-mode', state.hifz); },
                updateSpeed: (v) => { audio.playbackRate = v; document.getElementById('speed-val').innerText = v + 'x'; },
                updateFont: (f) => { document.documentElement.style.setProperty('--font-ar', f); },
                stepVerse: (d) => { const n = state.curIdx + d; if(state.arData?.ayahs[n]) prepVerse(state.arData.ayahs[n].number, n); }
            };
        })();

        document.addEventListener('DOMContentLoaded', Sanctuary.init);
    </script>
</body>
</html>
