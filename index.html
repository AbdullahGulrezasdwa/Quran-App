<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Quran | Architect Edition</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --p: #10b981; --bg: #020617; --surf: #0f172a;
            --text: #f8fafc; --border: #1e293b; --font-ar: 'Amiri', serif;
        }

        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar Navigation */
        nav { width: 75px; background: var(--surf); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 1.5rem 0; z-index: 100; }
        .nav-btn { width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.2rem; cursor: pointer; color: #64748b; transition: 0.3s; border: 1px solid transparent; }
        .nav-btn:hover { color: var(--p); background: rgba(16, 185, 129, 0.1); }
        .nav-btn.active { background: var(--p); color: white; }

        /* Content Hub */
        main { flex: 1; overflow-y: auto; scroll-behavior: auto; position: relative; }
        .header { position: sticky; top: 0; background: rgba(2, 6, 23, 0.9); backdrop-filter: blur(12px); padding: 1.5rem 2.5rem; border-bottom: 1px solid var(--border); z-index: 50; display: flex; justify-content: space-between; align-items: center; }

        .reader-container { max-width: 850px; margin: 0 auto; padding: 2rem; min-height: 101vh; }
        .ayah-card { padding: 2.5rem 0; border-bottom: 1px solid var(--border); opacity: 0; transform: translateY(15px); transition: 0.5s ease-out; }
        .ayah-card.visible { opacity: 1; transform: translateY(0); }
        .ayah-card.playing { border-left: 4px solid var(--p); background: linear-gradient(to right, rgba(16, 185, 129, 0.05), transparent); padding-left: 20px; }

        .ar { font-family: var(--font-ar); font-size: 2.6rem; text-align: right; direction: rtl; line-height: 2.3; margin-bottom: 1.2rem; color: #fff; }
        .en { font-size: 1.1rem; color: #94a3b8; line-height: 1.8; }

        /* UI States */
        body.hide-ar .ar { filter: blur(12px); }
        body.hide-ar .ar:hover { filter: blur(0); }

        /* Product Toolbars */
        .player-bar { position: fixed; bottom: 20px; left: 95px; right: 20px; background: var(--surf); border: 1px solid var(--border); border-radius: 16px; padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1.5rem; box-shadow: 0 10px 40px rgba(0,0,0,0.7); z-index: 1000; transform: translateY(150%); transition: 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .player-bar.active { transform: translateY(0); }
        .play-btn { background: var(--p); color: white; width: 48px; height: 48px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .play-btn:hover { transform: scale(1.05); }

        #sentinel { height: 100px; width: 100%; }
        #toast { position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 10000; display: none; }
    </style>
</head>
<body>

    <nav>
        <div class="nav-btn active" id="nav-1" onclick="Sovereign.actions.changeSurah(1)"><i data-lucide="book"></i></div>
        <div class="nav-btn" id="hifz-toggle" onclick="Sovereign.actions.toggleHifz()"><i data-lucide="eye"></i></div>
        <div class="nav-btn" id="nav-18" onclick="Sovereign.actions.changeSurah(18)"><i data-lucide="sparkles"></i></div>
        <div style="flex:1"></div>
        <div class="nav-btn" onclick="Sovereign.store.clear()"><i data-lucide="refresh-ccw"></i></div>
    </nav>

    <main id="scroll-root">
        <header class="header">
            <div>
                <h1 id="view-title" style="font-size: 1.5rem; font-weight: 700;">Sovereign</h1>
                <p id="view-meta" style="font-size: 0.75rem; opacity: 0.5; font-weight: 600;"></p>
            </div>
            <div id="status-icon"><i data-lucide="check-circle" style="color:var(--p); width:18px;"></i></div>
        </header>

        <div class="reader-container" id="main-view"></div>
        <div id="sentinel"></div>
    </main>

    <div class="player-bar" id="audio-panel">
        <button class="play-btn" id="play-trigger"><i data-lucide="play"></i></button>
        <div style="flex:1">
            <div id="playing-title" style="font-weight:700; font-size:0.9rem;"></div>
            <div id="playing-sub" style="font-size:0.7rem; opacity:0.5; text-transform:uppercase; letter-spacing:1px;">Continuous Recitation</div>
        </div>
        <audio id="audio-node"></audio>
    </div>

    <div id="toast"></div>

    <script>
        /**
         * SOVEREIGN ARCHITECT ENGINE
         * Modular components namespaced for scalability
         */
        const Sovereign = {
            // --- 1. DATA STORE & PERSISTENCE ---
            store: {
                get: (key) => JSON.parse(localStorage.getItem(`sq_${key}`)),
                set: (key, val) => localStorage.setItem(`sq_${key}`, JSON.stringify(val)),
                clear: () => { localStorage.clear(); location.reload(); },
                cache: new Map() // Memory cache for the current session
            },

            // --- 2. STATE MANAGER ---
            state: {
                surahId: null,
                verses: [],
                rendered: 0,
                chunk: 15,
                hifz: false,
                abort: null,
                audioAbort: null,
                obs: null,
                sentinelObs: null
            },

            // --- 3. API & FETCHING LAYER ---
            api: {
                async fetchSurah(id, signal) {
                    // Check Cache First
                    if (Sovereign.store.cache.has(id)) return Sovereign.store.cache.get(id);

                    const [m, v] = await Promise.all([
                        fetch(`https://api.quran.com/api/v4/chapters/${id}`, { signal }),
                        fetch(`https://api.quran.com/api/v4/verses/by_chapter/${id}?language=en&translations=131`, { signal })
                    ]);
                    
                    const data = { meta: (await m.json()).chapter, verses: (await v.json()).verses };
                    Sovereign.store.cache.set(id, data);
                    return data;
                },

                async fetchAudio(key, signal) {
                    const r = await fetch(`https://api.quran.com/api/v4/recitations/7/by_ayah/${key}`, { signal });
                    return (await r.json()).audio_files[0].url;
                }
            },

            // --- 4. RENDER ENGINE ---
            ui: {
                renderChunk() {
                    const target = document.getElementById('main-view');
                    const nextBatch = Sovereign.state.verses.slice(
                        Sovereign.state.rendered, 
                        Sovereign.state.rendered + Sovereign.state.chunk
                    );

                    const frag = document.createDocumentFragment();
                    nextBatch.forEach(v => {
                        const card = document.createElement('div');
                        card.className = 'ayah-card';
                        card.id = `ayah-${v.verse_key}`;
                        card.innerHTML = `
                            <div class="ar">${v.text_uthmani}</div>
                            <div class="en">${v.translations[0].text.replace(/<\/?[^>]+(>|$)/g, "")}</div>
                            <button onclick="Sovereign.actions.play('${v.verse_key}')" style="margin-top:1rem; border:none; background:none; color:var(--p); font-size:0.75rem; font-weight:800; cursor:pointer;">LISTEN</button>
                        `;
                        frag.appendChild(card);
                        Sovereign.state.obs.observe(card);
                    });

                    target.appendChild(frag);
                    Sovereign.state.rendered += nextBatch.length;
                },

                updateHeader(m) {
                    document.getElementById('view-title').innerText = m.name_simple;
                    document.getElementById('view-meta').innerText = `${m.revelation_place.toUpperCase()} â€¢ ${m.verses_count} VERSES`;
                }
            },

            // --- 5. ACTION CONTROLLER ---
            actions: {
                async changeSurah(id) {
                    const scrollNode = document.getElementById('scroll-root');
                    
                    // Abort previous fetch
                    if (Sovereign.state.abort) Sovereign.state.abort.abort();
                    Sovereign.state.abort = new AbortController();

                    document.getElementById('main-view').innerHTML = '';
                    Sovereign.state.rendered = 0;
                    
                    try {
                        const data = await Sovereign.api.fetchSurah(id, Sovereign.state.abort.signal);
                        Sovereign.state.verses = data.verses;
                        Sovereign.state.surahId = id;
                        
                        Sovereign.ui.updateHeader(data.meta);
                        Sovereign.ui.renderChunk();
                        
                        // Persistence
                        Sovereign.store.set('last_surah', id);

                        // Restore scroll or reset
                        const savedPos = Sovereign.store.get(`pos_${id}`) || 0;
                        scrollNode.scrollTop = savedPos;

                    } catch (e) {
                        if (e.name !== 'AbortError') Sovereign.actions.notify("Sync Error");
                    }
                },

                async play(key) {
                    if (Sovereign.state.audioAbort) Sovereign.state.audioAbort.abort();
                    Sovereign.state.audioAbort = new AbortController();

                    const panel = document.getElementById('audio-panel');
                    const audio = document.getElementById('audio-node');
                    
                    panel.classList.add('active');
                    document.getElementById('playing-title').innerText = `Ayah ${key}`;
                    
                    // Visual state
                    document.querySelectorAll('.ayah-card').forEach(c => c.classList.remove('playing'));
                    const card = document.getElementById(`ayah-${key}`);
                    if(card) card.classList.add('playing');

                    try {
                        const url = await Sovereign.api.fetchAudio(key, Sovereign.state.audioAbort.signal);
                        audio.src = `https://verses.quran.com/${url}`;
                        audio.play();
                    } catch (e) {
                        if (e.name !== 'AbortError') Sovereign.actions.notify("Audio Load Failed");
                    }
                },

                toggleHifz() {
                    Sovereign.state.hifz = !Sovereign.state.hifz;
                    document.body.classList.toggle('hide-ar', Sovereign.state.hifz);
                    Sovereign.store.set('hifz', Sovereign.state.hifz);
                    lucide.createIcons();
                },

                notify(msg) {
                    const t = document.getElementById('toast');
                    t.innerText = msg; t.style.display = 'block';
                    setTimeout(() => t.style.display = 'none', 3000);
                }
            },

            // --- 6. CORE INIT ---
            boot() {
                lucide.createIcons();
                
                // Load Settings
                Sovereign.state.hifz = Sovereign.store.get('hifz') || false;
                document.body.classList.toggle('hide-ar', Sovereign.state.hifz);

                // Setup Observers
                Sovereign.state.obs = new IntersectionObserver(entries => {
                    entries.forEach(e => { if(e.isIntersecting) e.target.classList.add('visible') });
                }, { threshold: 0.1 });

                Sovereign.state.sentinelObs = new IntersectionObserver(entries => {
                    if(entries[0].isIntersecting && Sovereign.state.verses.length > Sovereign.state.rendered) {
                        Sovereign.ui.renderChunk();
                    }
                }, { root: document.getElementById('scroll-root'), rootMargin: '300px' });
                
                Sovereign.state.sentinelObs.observe(document.getElementById('sentinel'));

                // Scroll Persistence Logger
                const root = document.getElementById('scroll-root');
                root.addEventListener('scroll', () => {
                    if (Sovereign.state.surahId) {
                        Sovereign.store.set(`pos_${Sovereign.state.surahId}`, root.scrollTop);
                    }
                }, { passive: true });

                // Audio Logic
                const node = document.getElementById('audio-node');
                node.onended = () => {
                    const current = document.querySelector('.ayah-card.playing');
                    const next = current?.nextElementSibling;
                    if (next && next.id) Sovereign.actions.play(next.id.replace('ayah-', ''));
                };

                // Initial Load
                const last = Sovereign.store.get('last_surah') || 1;
                this.actions.changeSurah(last);
            }
        };

        window.onload = () => Sovereign.boot();
    </script>
</body>
</html>
