<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sovereign Prime</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>

<style>
:root {
    --p: #10b981; --bg: #020617; --surf: #0f172a; --text: #f8fafc;
    --border: #1e293b; --ar-size: 2.8rem; --en-size: 1.1rem;
    --line: 2.5; --radius: 24px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); 
    display: flex; height: 100vh; overflow: hidden; transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

/* sidebar */
nav { width: 85px; background: var(--surf); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 2.5rem 0; z-index: 1000; }
.nav-btn { width: 55px; height: 55px; border-radius: 18px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; cursor: pointer; color: #475569; transition: 0.3s; position: relative; }
.nav-btn:hover, .nav-btn.active { color: var(--p); background: rgba(16, 185, 129, 0.1); }
.nav-btn.active::after { content: ''; position: absolute; left: -10px; height: 20px; width: 4px; background: var(--p); border-radius: 0 4px 4px 0; }

/* preferences drawer */
#drawer { 
    position: fixed; right: -420px; top: 0; width: 420px; height: 100%; 
    background: var(--surf); border-left: 1px solid var(--border); z-index: 2000; 
    padding: 3rem 2.5rem; transition: 0.6s cubic-bezier(0.19, 1, 0.22, 1); overflow-y: auto;
}
#drawer.open { right: 0; box-shadow: -40px 0 100px rgba(0,0,0,0.9); }
.s-section { margin-bottom: 2.5rem; }
.s-section h3 { font-size: 0.7rem; font-weight: 800; color: var(--p); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 1.5rem; }
.s-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; font-size: 0.95rem; }
select, input[type="range"] { background: var(--bg); color: white; border: 1px solid var(--border); padding: 10px 14px; border-radius: 12px; outline: none; font-family: inherit; }

/* reader core */
main { flex: 1; overflow-y: auto; scroll-behavior: smooth; position: relative; }
header { 
    position: sticky; top: 0; background: rgba(2, 6, 23, 0.96); backdrop-filter: blur(25px); 
    padding: 2rem 4rem; border-bottom: 1px solid var(--border); display: flex; 
    justify-content: space-between; align-items: center; z-index: 500; 
}
.search-bar { background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 16px; padding: 12px 24px; color: #fff; width: 350px; outline: none; transition: 0.4s; font-family: inherit; }
.search-bar:focus { width: 420px; border-color: var(--p); background: rgba(255,255,255,0.08); }

.reader { max-width: 1000px; margin: 0 auto; padding: 5rem 2rem; }
.ayah { padding: 4.5rem 0; border-bottom: 1px solid var(--border); opacity: 0; transform: translateY(30px); transition: 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); position: relative; cursor: pointer; }
.ayah.visible { opacity: 1; transform: translateY(0); }
.ayah.playing { border-left: 6px solid var(--p); padding-left: 35px; background: linear-gradient(90deg, rgba(16, 185, 129, 0.06) 0%, transparent 100%); }

.ar { font-family: 'Amiri', serif; font-size: var(--ar-size); direction: rtl; text-align: right; line-height: var(--line); margin-bottom: 1.8rem; color: #fff; transition: 0.3s; }
.en { font-size: var(--en-size); color: #94a3b8; line-height: 1.8; user-select: text; transition: 0.3s; max-width: 85%; }
.v-badge { position: absolute; left: -60px; top: 5rem; font-size: 0.75rem; font-weight: 800; color: var(--p); opacity: 0.4; background: rgba(16, 185, 129, 0.1); padding: 4px 10px; border-radius: 8px; }

/* memorization mode */
body.hifz .ar { filter: blur(24px); }
body.hifz .ar:hover { filter: blur(0); }

/* playback bar */
#player { 
    position: fixed; bottom: 35px; left: 125px; right: 35px; background: var(--surf); 
    border: 1px solid var(--border); border-radius: 32px; padding: 1.8rem 3rem; 
    display: flex; align-items: center; gap: 3rem; transform: translateY(300px); transition: 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1000;
}
#player.active { transform: translateY(0); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
.p-controls { display: flex; gap: 1.2rem; }
.btn-circle { width: 54px; height: 54px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
.btn-p { background: var(--p); color: white; box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4); }
.btn-s { background: transparent; color: #64748b; border: 1px solid var(--border); }
.btn-s.active { color: var(--p); border-color: var(--p); background: rgba(16, 185, 129, 0.05); }

#progress-container { flex: 1; }
#p-meta { font-weight: 800; color: var(--p); font-size: 1.1rem; margin-bottom: 10px; display: flex; justify-content: space-between; }
progress { width: 100%; height: 8px; border-radius: 20px; accent-color: var(--p); background: var(--bg); border: none; overflow: hidden; }
</style>
</head>
<body>

<nav>
    <div class="nav-btn active" onclick="location.reload()"><i data-lucide="book-open"></i></div>
    <div class="nav-btn" id="hifz-toggle" title="Memorization Mode"><i data-lucide="eye-off"></i></div>
    <div class="nav-btn" id="prefs-toggle"><i data-lucide="sliders"></i></div>
    <div style="flex:1"></div>
    <div class="nav-btn" onclick="localStorage.clear(); location.reload()"><i data-lucide="refresh-cw"></i></div>
</nav>

<div id="drawer">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:3rem;">
        <h2 style="font-weight:900; letter-spacing:-1px;">PREFERENCES</h2>
        <i data-lucide="x" id="close-drawer" style="cursor:pointer; opacity:0.5;"></i>
    </div>

    <div class="s-section">
        <h3>AUDIO ENGINE</h3>
        <div class="s-row"><span>Reciter</span>
            <select id="reciter-val">
                <option value="7">Mishary Rashid Alafasy</option>
                <option value="1">AbdulBaset AbdulSamad</option>
                <option value="6">Khalil al-Husary</option>
                <option value="12">Mahmoud Al-Banna</option>
                <option value="3">Abdur-Rahman as-Sudais</option>
            </select>
        </div>
        <div class="s-row"><span>Playback Speed</span>
            <select id="speed-val">
                <option value="0.5">0.5x</option>
                <option value="0.75">0.75x</option>
                <option value="1" selected>1.0x Normal</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
            </select>
        </div>
    </div>

    <div class="s-section">
        <h3>TYPOGRAPHY</h3>
        <div class="s-row"><span>Theme</span>
            <select id="theme-val">
                <option value="midnight">Midnight Galaxy</option>
                <option value="obsidian">Pure Obsidian</option>
                <option value="sepia">Warm Sepia</option>
            </select>
        </div>
        <div class="s-row"><span>Arabic Size</span><input type="range" data-v="--ar-size" min="1.8" max="6" step="0.1" value="2.8"></div>
        <div class="s-row"><span>Translation Size</span><input type="range" data-v="--en-size" min="0.8" max="2.5" step="0.1" value="1.1"></div>
        <div class="s-row"><span>Line Spacing</span><input type="range" data-v="--line" min="1.5" max="5" step="0.1" value="2.5"></div>
    </div>
</div>

<main id="main-scroll">
    <header>
        <div>
            <h1 id="surah-title" style="font-weight:900; letter-spacing:-1.5px; font-size:2.2rem;">Sovereign</h1>
            <p id="surah-info" style="font-size:0.8rem; opacity:0.5; font-weight:800; letter-spacing:1px;"></p>
        </div>
        <input class="search-bar" id="search" placeholder="Surah name or number (1-114)..."/>
    </header>
    <div class="reader" id="stage"></div>
    <div id="sentinel" style="height:150px;"></div>
</main>

<div id="player">
    <div class="p-controls">
        <button class="btn-circle btn-s" id="loop-toggle"><i data-lucide="repeat-1"></i></button>
        <button class="btn-circle btn-p" id="master-play"><i data-lucide="play"></i></button>
    </div>
    <div id="progress-container">
        <div id="p-meta"><span id="p-verse"></span><span id="p-time">0:00</span></div>
        <progress id="p-bar" value="0" max="1"></progress>
    </div>
    <audio id="core-audio"></audio>
</div>

<script>
const App = {
    state: { verses: [], rendered: 0, chunk: 15, reciter: 7, loop: false, hifz: false },

    async initSurah(query) {
        if (!query) return;
        const stage = document.getElementById('stage');
        stage.innerHTML = '<div style="text-align:center; padding:150px; opacity:0.2; font-weight:900; letter-spacing:4px;">SYNCING DATA...</div>';
        
        try {
            // Intelligent Lookup
            let id = query;
            if (isNaN(query)) {
                const chapters = await (await fetch('https://api.quran.com/api/v4/chapters')).json();
                const match = chapters.chapters.find(c => c.name_simple.toLowerCase().includes(query.toLowerCase()));
                id = match ? match.id : 1;
            }

            const [m, v] = await Promise.all([
                fetch(`https://api.quran.com/api/v4/chapters/${id}`),
                // Requesting multiple fields to ensure no data is missed
                fetch(`https://api.quran.com/api/v4/verses/by_chapter/${id}?language=en&translations=131&fields=text_uthmani,text_indopak,text_simple`)
            ]);
            
            const meta = await m.json();
            const data = await v.json();

            // FIXED TRANSLATION MAPPING
            this.state.verses = data.verses.map(v => ({
                key: v.verse_key,
                num: v.verse_number,
                ar: v.text_uthmani || v.text_indopak || v.text_simple,
                // The Fix: Hunting for the translation text inside the nested array
                en: v.translations?.[0]?.text?.replace(/<\/?[^>]+(>|$)/g, "") || "Translation Sync Error"
            }));

            document.getElementById('surah-title').innerText = meta.chapter.name_simple;
            document.getElementById('surah-info').innerText = `${meta.chapter.revelation_place.toUpperCase()} â€¢ ${meta.chapter.verses_count} VERSES`;
            
            stage.innerHTML = '';
            this.state.rendered = 0;
            this.renderChunk();
            localStorage.setItem('sq_last', id);
        } catch(e) { stage.innerHTML = '<div style="color:red; padding:50px;">Network Error. Please refresh.</div>'; }
    },

    renderChunk() {
        const stage = document.getElementById('stage');
        const batch = this.state.verses.slice(this.state.rendered, this.state.rendered + this.state.chunk);
        
        batch.forEach(v => {
            const el = document.createElement('div');
            el.className = 'ayah';
            el.id = `ayah-${v.key}`;
            el.innerHTML = `
                <span class="v-badge">${v.num}</span>
                <div class="ar">${v.ar}</div>
                <div class="en">${v.en}</div>
            `;
            el.onclick = () => this.playAyah(v.key);
            stage.appendChild(el);
            this.observer.observe(el);
        });
        this.state.rendered += batch.length;
        lucide.createIcons();
    },

    async playAyah(key) {
        const audio = document.getElementById('core-audio');
        document.getElementById('player').classList.add('active');
        document.getElementById('p-verse').innerText = `VERSE ${key}`;
        
        document.querySelectorAll('.ayah').forEach(a => a.classList.remove('playing'));
        const activeNode = document.getElementById(`ayah-${key}`);
        if(activeNode) {
            activeNode.classList.add('playing');
            activeNode.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        const r = await fetch(`https://api.quran.com/api/v4/recitations/${this.state.reciter}/by_ayah/${key}`);
        const res = await r.json();
        const url = res.audio_files?.[0]?.url;

        if (url) {
            audio.src = url.startsWith('http') ? url : `https://verses.quran.com/${url}`;
            audio.playbackRate = parseFloat(document.getElementById('speed-val').value);
            audio.play();
        }
    },

    boot() {
        lucide.createIcons();
        this.observer = new IntersectionObserver(entries => {
            entries.forEach(e => { if(e.isIntersecting) e.target.classList.add('visible') });
        }, { threshold: 0.1 });

        // Infinite Scroll
        new IntersectionObserver(e => {
            if(e[0].isIntersecting && this.state.verses.length > this.state.rendered) this.renderChunk();
        }).observe(document.getElementById('sentinel'));

        // Controls
        document.getElementById('prefs-toggle').onclick = () => document.getElementById('drawer').classList.toggle('open');
        document.getElementById('close-drawer').onclick = () => document.getElementById('drawer').classList.remove('open');
        
        document.getElementById('hifz-toggle').onclick = (e) => {
            this.state.hifz = !this.state.hifz;
            document.body.classList.toggle('hifz', this.state.hifz);
            e.currentTarget.classList.toggle('active', this.state.hifz);
        };

        // UI Customizers
        document.querySelectorAll('input[type="range"]').forEach(range => {
            range.oninput = (e) => {
                const isSize = e.target.dataset.v.includes('size');
                document.documentElement.style.setProperty(e.target.dataset.v, e.target.value + (isSize ? 'rem' : ''));
            };
        });

        document.getElementById('theme-val').onchange = (e) => {
            const themes = {
                midnight: {bg: '#020617', surf: '#0f172a', border: '#1e293b', text: '#f8fafc'},
                obsidian: {bg: '#000000', surf: '#0a0a0a', border: '#1a1a1a', text: '#ffffff'},
                sepia: {bg: '#f4f1ea', surf: '#e8e4d9', border: '#d1cdc0', text: '#433422'}
            };
            const t = themes[e.target.value];
            Object.entries(t).forEach(([k, v]) => document.documentElement.style.setProperty(`--${k}`, v));
        };

        // Audio Core Logic
        const audio = document.getElementById('core-audio');
        audio.onplay = () => { document.getElementById('master-play').innerHTML = '<i data-lucide="pause"></i>'; lucide.createIcons(); };
        audio.onpause = () => { document.getElementById('master-play').innerHTML = '<i data-lucide="play"></i>'; lucide.createIcons(); };
        
        audio.ontimeupdate = () => {
            document.getElementById('p-bar').value = audio.currentTime / audio.duration || 0;
            const mins = Math.floor(audio.currentTime / 60);
            const secs = Math.floor(audio.currentTime % 60);
            document.getElementById('p-time').innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
        };

        audio.onended = () => {
            if (this.state.loop) audio.play();
            else {
                const next = document.querySelector('.ayah.playing')?.nextElementSibling;
                if(next) this.playAyah(next.id.replace('ayah-', ''));
            }
        };

        document.getElementById('master-play').onclick = () => audio.paused ? audio.play() : audio.pause();
        document.getElementById('loop-toggle').onclick = (e) => {
            this.state.loop = !this.state.loop;
            e.currentTarget.classList.toggle('active', this.state.loop);
        };

        document.getElementById('search').onkeydown = (e) => { if(e.key === 'Enter') this.initSurah(e.target.value) };
        document.getElementById('reciter-val').onchange = (e) => this.state.reciter = e.target.value;

        this.initSurah(localStorage.getItem('sq_last') || 1);
    }
};

window.onload = () => App.boot();
</script>
</body>
</html>
