<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sanctuary Quran</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&family=Amiri+Quran&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary: #fbbf24; --bg-dark: #050505; --card-bg: #111111;
      --border: rgba(255, 255, 255, 0.05); --text-main: #f8fafc;
      --text-muted: #94a3b8; --arabic-font: 'Amiri Quran', serif; --arabic-size: 2.8rem;
    }

    /* THEMES */
    body.emerald { --primary: #10b981; --bg-dark: #022c22; --card-bg: #064e3b; }
    body.rose { --primary: #fb7185; --bg-dark: #1f0d11; --card-bg: #4c1d24; }
    body.slate { --primary: #94a3b8; --bg-dark: #0f172a; --card-bg: #1e293b; }

    .indopak { --arabic-font: 'Scheherazade New', serif; }
    .hide-translation .translation-text { display: none; }
    
    /* READING MODE STYLES */
    .reading-mode-active .ayah-box { display: inline; border: none; padding: 0; background: none; box-shadow: none; }
    .reading-mode-active .arabic-text { display: inline; line-height: 2.5; font-size: 2.2rem; }
    .reading-mode-active .translation-text, .reading-mode-active .bm-btn { display: none; }

    * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

    .app-container { display: flex; flex: 1; overflow: hidden; }
    nav.side-bar { width: 80px; border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 25px 0; gap: 30px; }
    .nav-icon { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); }
    .nav-icon.active { background: rgba(251, 191, 36, 0.1); color: var(--primary); }

    main { flex: 1; display: grid; grid-template-columns: 1fr 380px; overflow: hidden; }
    .viewport { overflow-y: auto; padding: 40px; scrollbar-width: none; scroll-behavior: smooth; }

    .section-header { font-size: 0.7rem; color: var(--primary); font-weight: 800; letter-spacing: 2px; margin: 30px 0 15px 0; text-transform: uppercase; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .surah-card { background: var(--card-bg); padding: 25px; border-radius: 20px; cursor: pointer; border: 1px solid transparent; }
    .surah-card:hover { border-color: var(--primary); transform: translateY(-3px); }

    #reader { display: none; max-width: 900px; margin: 0 auto; }
    .ayah-box { padding: 30px; margin-bottom: 20px; border-radius: 15px; cursor: pointer; border: 1px solid transparent; position: relative; }
    .ayah-box.active { border-color: var(--primary); background: rgba(251, 191, 36, 0.05); }

    /* COLLAPSIBLE PLAYER */
    .audio-bar { height: 90px; background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(10px); border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 40px; position: fixed; bottom: 0; width: 100%; z-index: 100; }
    .audio-bar.collapsed { transform: translateY(110%); }
    .player-trigger { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: var(--primary); color: black; display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 101; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }

    aside { border-left: 1px solid var(--border); padding: 25px; display: flex; flex-direction: column; gap: 20px; background: rgba(0,0,0,0.2); }
    .pill-btn { padding: 8px 16px; border-radius: 100px; border: 1px solid var(--border); background: none; color: white; cursor: pointer; font-size: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .pill-btn.active { border-color: var(--primary); color: var(--primary); }

    textarea { width: 100%; height: 200px; background: #000; color: white; border: 1px solid var(--border); border-radius: 12px; padding: 15px; resize: none; font-family: inherit; }
  </style>
</head>
<body>

  <div class="app-container">
    <nav class="side-bar">
      <div class="nav-icon active" onclick="closeReader()"><i data-lucide="home"></i></div>
      <div class="nav-icon" onclick="toggleSettings()"><i data-lucide="settings-2"></i></div>
    </nav>

    <main>
      <div class="viewport" id="scroll-root">
        <div id="dashboard">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1 style="font-family: serif;">Sanctuary Quran</h1>
            <button class="pill-btn" onclick="toggleSettings()"><i data-lucide="settings"></i> Settings</button>
          </div>

          <div id="continue-section" style="display:none; margin-bottom: 40px;">
            <div class="section-header">Ready to continue?</div>
            <button class="pill-btn active" style="padding:20px 30px; border-radius:15px;" onclick="resumeReading()">
              <i data-lucide="play-circle"></i> Resume: <span id="resume-name"></span>
            </button>
          </div>

          <div class="section-header">Library</div>
          <div id="surah-grid" class="grid"></div>
        </div>

        <div id="reader">
          <div style="display:flex; justify-content:space-between; margin-bottom:40px;">
            <button onclick="closeReader()" class="pill-btn">‚Üê LIBRARY</button>
            <div style="display:flex; gap:10px;">
                <button id="view-toggle" class="pill-btn" onclick="toggleViewMode()">VERSE BY VERSE</button>
                <button id="trans-toggle" class="pill-btn active" onclick="toggleTranslation()">TRANS: ON</button>
            </div>
          </div>
          <div id="reader-body"></div>
        </div>
      </div>

      <aside>
        <div style="display:flex; gap:15px; border-bottom:1px solid var(--border); padding-bottom:10px;">
          <div class="tab active" onclick="switchTab('Tafsir', this)">Tafsir</div>
          <div class="tab" onclick="switchTab('Notes', this)">Notes</div>
        </div>
        <div id="sidebar-content">
          <div id="insight-text" style="font-size: 0.95rem; line-height: 1.8; color: #cbd5e1;">Select a verse.</div>
          <div id="notes-area" style="display:none;">
            <p style="font-size:0.7rem; color:var(--text-muted);">Notes for Verse <span id="note-ayah-ref">-</span></p>
            <textarea id="note-input" placeholder="Type your reflections here..." oninput="saveNote()"></textarea>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <div class="player-trigger" id="p-trigger" onclick="expandPlayer()"><i data-lucide="chevron-up"></i></div>
  <div class="audio-bar" id="audio-bar">
    <div style="width:250px">
      <div id="audio-title" style="font-weight:700;">Ready</div>
      <div id="audio-subtitle" style="font-size:0.75rem; color:var(--text-muted);">Select a verse</div>
    </div>
    <div style="display:flex; align-items:center; gap:20px;">
      <i data-lucide="skip-back" onclick="changeAyah(-1)" style="cursor:pointer"></i>
      <button class="play-btn" onclick="togglePlayback()"><i data-lucide="play" id="play-icon"></i></button>
      <i data-lucide="skip-forward" onclick="changeAyah(1)" style="cursor:pointer"></i>
    </div>
    <div style="width:250px; text-align:right;"><i data-lucide="chevron-down" style="cursor:pointer" onclick="collapsePlayer()"></i></div>
  </div>

  <audio id="player"></audio>

  <div id="settings-modal" onclick="toggleSettings()" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); backdrop-filter:blur(8px); display:none; align-items:center; justify-content:center; z-index:1000;">
    <div class="modal-content" onclick="event.stopPropagation()" style="background:#0a0a0a; width:400px; padding:30px; border-radius:24px; border:1px solid var(--border);">
      <h3>Settings</h3>
      <label class="section-header">Theme</label>
      <div style="display:flex; gap:10px; margin-bottom:20px;">
        <div onclick="setTheme('')" style="width:30px; height:30px; border-radius:50%; background:#fbbf24; cursor:pointer;"></div>
        <div onclick="setTheme('emerald')" style="width:30px; height:30px; border-radius:50%; background:#10b981; cursor:pointer;"></div>
        <div onclick="setTheme('rose')" style="width:30px; height:30px; border-radius:50%; background:#fb7185; cursor:pointer;"></div>
        <div onclick="setTheme('slate')" style="width:30px; height:30px; border-radius:50%; background:#94a3b8; cursor:pointer;"></div>
      </div>
      <label class="section-header">Script</label>
      <select onchange="App.script = this.value; if(App.currentSurah) loadSurah(App.currentSurah);" style="width:100%; padding:10px; background:#181818; color:white; border-radius:8px;">
        <option value="uthmani">Uthmani</option>
        <option value="indopak">IndoPak</option>
      </select>
    </div>
  </div>

  <script>
    const App = {
      chapters: [], currentSurah: null, currentAyahIndex: 0, script: 'uthmani', 
      isReadingMode: false, lastScroll: 0, reciter: 'ar.alafasy',
      notes: JSON.parse(localStorage.getItem('sq-notes')) || {},

      async init() {
        lucide.createIcons();
        const res = await fetch('https://api.alquran.cloud/v1/surah');
        const data = await res.json();
        this.chapters = data.data;
        this.renderGrid(this.chapters);
        this.checkResume();
        
        document.getElementById('player').onended = () => changeAyah(1);
        document.getElementById('scroll-root').onscroll = (e) => this.handleScroll(e);
      },

      renderGrid(list) {
        document.getElementById('surah-grid').innerHTML = list.map(s => `<div class="surah-card" onclick="loadSurah(${s.number})"><div style="color:var(--primary); font-size:0.7rem; font-weight:700;">${s.number}</div><h3 style="margin:5px 0 0 0;">${s.englishName}</h3></div>`).join('');
      },

      checkResume() {
        const last = JSON.parse(localStorage.getItem('sq-last-read'));
        if (last) {
          document.getElementById('continue-section').style.display = 'block';
          document.getElementById('resume-name').innerText = `${last.name} (Verse ${last.aNum})`;
        }
      },

      handleScroll(e) {
        const st = e.target.scrollTop;
        const bar = document.getElementById('audio-bar');
        const trigger = document.getElementById('p-trigger');
        if (st > this.lastScroll && st > 100) { bar.classList.add('collapsed'); trigger.style.display = 'flex'; } 
        else if (st < this.lastScroll) { bar.classList.remove('collapsed'); trigger.style.display = 'none'; }
        this.lastScroll = st;
      }
    };

    async function loadSurah(id, startIdx = 0) {
      App.currentSurah = id;
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('reader').style.display = 'block';
      const edition = App.script === 'indopak' ? 'quran-indopak' : 'quran-uthmani';
      const [ar, en] = await Promise.all([
        fetch(`https://api.alquran.cloud/v1/surah/${id}/${edition}`).then(r => r.json()),
        fetch(`https://api.alquran.cloud/v1/surah/${id}/en.sahih`).then(r => r.json())
      ]);

      let html = `<h1 style="text-align:center; color:var(--primary); font-family:var(--arabic-font); font-size:4rem; margin-bottom:50px;">${ar.data.name}</h1>`;
      ar.data.ayahs.forEach((ayah, i) => {
        html += `<div class="ayah-box" id="ayah-${i}" onclick="playAyah(${i})">
            <div class="arabic-text">${ayah.text}</div>
            <div class="translation-text" style="color:var(--text-muted); margin-top:10px;">${en.data.ayahs[i].text}</div>
          </div>`;
      });
      document.getElementById('reader-body').innerHTML = html;
      if (startIdx > 0) setTimeout(() => playAyah(startIdx), 500);
      lucide.createIcons();
    }

    function playAyah(index) {
      App.currentAyahIndex = index;
      const player = document.getElementById('player');
      player.src = `https://cdn.islamic.network/quran/audio/128/${App.reciter}/${App.chapters[App.currentSurah-1].ayahs[index].number}.mp3`;
      
      document.querySelectorAll('.ayah-box').forEach(b => b.classList.remove('active'));
      const box = document.getElementById(`ayah-${index}`);
      box.classList.add('active');
      box.scrollIntoView({ behavior: 'smooth', block: 'center' });

      document.getElementById('audio-title').innerText = App.chapters[App.currentSurah-1].englishName;
      document.getElementById('audio-subtitle').innerText = `Verse ${index + 1}`;
      player.play();
      updatePlayIcon(true);
      
      const sName = App.chapters[App.currentSurah-1].englishName;
      localStorage.setItem('sq-last-read', JSON.stringify({id: App.currentSurah, aIdx: index, aNum: index+1, name: sName}));
      
      // Update Notes Ref
      document.getElementById('note-ayah-ref').innerText = `${sName} ${index+1}`;
      document.getElementById('note-input').value = App.notes[`${App.currentSurah}:${index}`] || '';
    }

    function toggleViewMode() {
      App.isReadingMode = !App.isReadingMode;
      document.getElementById('reader-body').classList.toggle('reading-mode-active');
      document.getElementById('view-toggle').innerText = App.isReadingMode ? "READING OPTION" : "VERSE BY VERSE";
    }

    function saveNote() {
      const key = `${App.currentSurah}:${App.currentAyahIndex}`;
      App.notes[key] = document.getElementById('note-input').value;
      localStorage.setItem('sq-notes', JSON.stringify(App.notes));
    }

    function switchTab(type, el) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('insight-text').style.display = type === 'Tafsir' ? 'block' : 'none';
      document.getElementById('notes-area').style.display = type === 'Notes' ? 'block' : 'none';
    }

    function setTheme(t) { document.body.className = t; if(App.script === 'indopak') document.body.classList.add('indopak'); }
    function collapsePlayer() { document.getElementById('audio-bar').classList.add('collapsed'); document.getElementById('p-trigger').style.display = 'flex'; }
    function expandPlayer() { document.getElementById('audio-bar').classList.remove('collapsed'); document.getElementById('p-trigger').style.display = 'none'; }
    function togglePlayback() { const p = document.getElementById('player'); if(p.paused) p.play(); else p.pause(); updatePlayIcon(!p.paused); }
    function updatePlayIcon(play) { document.getElementById('play-icon').setAttribute('data-lucide', play ? 'pause' : 'play'); lucide.createIcons(); }
    function changeAyah(dir) { const n = App.currentAyahIndex + dir; if(n >= 0 && n < App.chapters[App.currentSurah-1].numberOfAyahs) playAyah(n); }
    function closeReader() { document.getElementById('dashboard').style.display = 'block'; document.getElementById('reader').style.display = 'none'; App.checkResume(); }
    function resumeReading() { const last = JSON.parse(localStorage.getItem('sq-last-read')); loadSurah(last.id, last.aIdx); }
    function toggleSettings() { const s = document.getElementById('settings-modal'); s.style.display = s.style.display === 'flex' ? 'none' : 'flex'; }
    function toggleTranslation() { document.body.classList.toggle('hide-translation'); document.getElementById('trans-toggle').classList.toggle('active'); }

    window.onload = () => App.init();
  </script>
</body>
</html>
