<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign | Hyper-Link v6</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --p: #10b981; --p-glow: rgba(16, 185, 129, 0.4);
            --bg: #020617; --surf: rgba(15, 23, 42, 0.8); 
            --text: #f8fafc; --sub: #64748b; --border: rgba(30, 41, 59, 0.5); 
            --glass: blur(12px) saturate(180%);
            --ar-size: 3.2rem;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); color: var(--text); 
            margin: 0; display: flex; height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #0f172a 0%, #020617 100%);
        }

        /* Ambient Neural Grid */
        body::before {
            content: ""; position: absolute; width: 100%; height: 100%;
            background-image: linear-gradient(var(--border) 1px, transparent 1px), linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 50px 50px; opacity: 0.1; z-index: 0; pointer-events: none;
        }

        /* Sidebar Navigation */
        nav { 
            width: 85px; background: rgba(2, 6, 23, 0.8); 
            backdrop-filter: var(--glass); border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; align-items: center; 
            padding: 30px 0; gap: 25px; z-index: 100; 
        }
        .nav-link { 
            color: var(--sub); cursor: pointer; padding: 14px; border-radius: 16px; 
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        .nav-link:hover { color: var(--p); background: rgba(16,185,129,0.1); transform: scale(1.1); }
        .nav-link.active { color: var(--p); background: var(--p-glow); box-shadow: 0 0 20px var(--p-glow); }

        /* Main Viewport */
        main { flex: 1; display: flex; flex-direction: column; position: relative; z-index: 1; }
        header { 
            padding: 25px 50px; display: flex; justify-content: space-between; align-items: center; 
            background: rgba(2, 6, 23, 0.5); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border);
        }
        #content { flex: 1; overflow-y: auto; padding: 40px 10%; scroll-behavior: smooth; }

        /* Surah Cards: OP Grid */
        .surah-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .s-card { 
            background: var(--surf); backdrop-filter: var(--glass); 
            padding: 25px; border-radius: 24px; border: 1px solid var(--border);
            transition: 0.3s ease; position: relative; overflow: hidden; cursor: pointer;
        }
        .s-card:hover { 
            border-color: var(--p); transform: translateY(-5px); 
            box-shadow: 0 10px 40px rgba(0,0,0,0.4), 0 0 20px rgba(16, 185, 129, 0.1);
        }
        .s-card::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(45deg, transparent, rgba(16, 185, 129, 0.05)); opacity: 0; transition: 0.3s;
        }
        .s-card:hover::after { opacity: 1; }

        /* Ayah Display */
        .ayah { padding: 60px 0; border-bottom: 1px solid var(--border); transition: 0.5s; position: relative; }
        .ar { 
            font-family: 'Amiri', serif; font-size: var(--ar-size); text-align: right; 
            direction: rtl; line-height: 2.2; margin-bottom: 25px; 
            filter: drop-shadow(0 0 1px var(--p-glow));
        }
        .en { font-size: 1.2rem; color: var(--sub); line-height: 1.8; max-width: 800px; font-weight: 300; }

        /* Neon Tajweed Markers */
        .word { transition: 0.3s; padding: 2px 6px; border-radius: 8px; cursor: pointer; }
        .word:hover { background: rgba(255,255,255,0.05); color: #fff; text-shadow: 0 0 15px var(--p); }
        .tj-ghunnah { color: #ff4d6d; text-shadow: 0 0 8px rgba(255,77,109,0.3); }
        .tj-qal { color: #00d4ff; text-shadow: 0 0 8px rgba(0,212,255,0.3); }

        /* Floating HUD Control */
        #hud { 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); 
            background: rgba(15, 23, 42, 0.9); backdrop-filter: var(--glass);
            border: 1px solid var(--border); padding: 15px 35px; border-radius: 100px; 
            display: flex; align-items: center; gap: 30px; z-index: 1000;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }

        /* Sidebar: Knowledge Core */
        #side-panel { 
            position: fixed; right: -500px; top: 0; width: 450px; height: 100%; 
            background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(20px);
            border-left: 1px solid var(--border); transition: 0.6s cubic-bezier(0.19, 1, 0.22, 1); 
            z-index: 2000; padding: 40px;
        }
        #side-panel.open { right: 0; }

        /* Progress & Buttons */
        .p-bar { height: 4px; background: linear-gradient(90deg, var(--p), #34d399); width: 0%; position: absolute; top: 0; transition: 0.2s; }
        .btn-ai { 
            background: linear-gradient(135deg, var(--p), #059669); color: white; 
            border: none; padding: 12px 24px; border-radius: 14px; font-weight: 800;
            cursor: pointer; box-shadow: 0 4px 15px var(--p-glow); transition: 0.3s;
        }
        .btn-ai:hover { transform: translateY(-2px); box-shadow: 0 8px 25px var(--p-glow); }
    </style>
</head>
<body>

    <nav>
        <div class="nav-link active" id="btn-home" onclick="Sovereign.setView('home')"><i data-lucide="layout-grid"></i></div>
        <div class="nav-link" id="btn-hifz" onclick="Sovereign.setView('hifz')"><i data-lucide="zap"></i></div>
        <div class="nav-link" onclick="Sovereign.cycleTheme()"><i data-lucide="layers"></i></div>
    </nav>

    <main>
        <div class="p-bar" id="reading-progress"></div>
        <header>
            <div>
                <h1 id="header-title" style="margin:0; font-weight:800; letter-spacing:-1px;">SOVEREIGN</h1>
                <div id="ai-indicator" class="ai-status" style="font-size:0.6rem; color:var(--p); margin-top:5px;">● NEURAL ENGINE ACTIVE</div>
            </div>
            <input type="text" placeholder="Search Command (Cmd + K)" oninput="Sovereign.search(this.value)" 
                   style="background:var(--surf); border:1px solid var(--border); color:white; padding:12px 25px; border-radius:14px; width: 300px; outline:none;">
        </header>
        <div id="content"></div>
    </main>

    <div id="side-panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="letter-spacing:2px; font-weight:800; font-size:0.7rem; color:var(--p);">KNOWLEDGE CORE</span>
            <i data-lucide="x" onclick="Sovereign.closePanel()" style="cursor:pointer; color:var(--sub);"></i>
        </div>
        <h2 id="panel-word" style="font-family:'Amiri'; font-size: 4rem; margin: 30px 0 10px 0; color:white;"></h2>
        <div id="panel-text" style="color:var(--sub); line-height:1.8; font-size:1.1rem;"></div>
        <button class="btn-ai" id="ai-ask-btn" onclick="Sovereign.ai.reflect()" style="width:100%; margin-top:30px;">GENERATE NEURAL REFLECTION</button>
    </div>

    <div id="hud">
        <i data-lucide="skip-back" class="control-btn" onclick="Sovereign.audio.prev()"></i>
        <div id="play-trigger" onclick="Sovereign.audio.toggle()" style="background:var(--p); color:white; width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
            <i data-lucide="play" style="fill:white"></i>
        </div>
        <i data-lucide="skip-forward" class="control-btn" onclick="Sovereign.audio.next()"></i>
        <div id="hud-label" style="font-weight:700; font-size:0.8rem; letter-spacing:1px; color:var(--p);">IDLE</div>
    </div>

    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        const db = new Dexie("SovereignHyperDB");
        db.version(1).stores({ hifz: 'ayahKey', prefs: 'key, value' });

        window.Sovereign = {
            state: { chapters: [], currentSurah: null, lastWord: '', lastAyah: '' },

            async init() {
                const res = await fetch('https://api.alquran.cloud/v1/surah');
                const data = await res.json();
                this.state.chapters = data.data;
                this.setView('home');
                lucide.createIcons();
                this.ai.init();

                document.getElementById('content').onscroll = (e) => {
                    const p = (e.target.scrollTop / (e.target.scrollHeight - e.target.clientHeight)) * 100;
                    document.getElementById('reading-progress').style.width = p + "%";
                };
            },

            setView(v) {
                const c = document.getElementById('content');
                if (v === 'home') {
                    document.getElementById('header-title').innerText = "VITAL ARCHIVE";
                    c.innerHTML = `<div class="surah-grid">${this.state.chapters.map(s => `
                        <div class="s-card" onclick="Sovereign.loadSurah(${s.number})">
                            <div style="font-size:0.7rem; color:var(--p); font-weight:800; margin-bottom:10px;">DATA STREAM ${s.number}</div>
                            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                                <b style="font-size:1.4rem;">${s.englishName}</b>
                                <span style="font-family:Amiri; font-size:2rem; color:var(--p); opacity:0.8;">${s.name}</span>
                            </div>
                        </div>`).join('')}</div>`;
                }
            },

            async loadSurah(id) {
                const c = document.getElementById('content');
                c.innerHTML = `<div style="text-align:center; padding:100px; color:var(--p);">SYNCING NEURAL LINK...</div>`;
                
                const [ar, en] = await Promise.all([
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-uthmani`).then(r => r.json()),
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/en.sahih`).then(r => r.json())
                ]);

                document.getElementById('header-title').innerText = ar.data.englishName.toUpperCase();
                c.innerHTML = ar.data.ayahs.map((v, i) => `
                    <div class="ayah" id="a-${i+1}">
                        <div class="ar">${this.applyTajweed(v.text, `${id}:${i+1}`)}</div>
                        <div class="en">${en.data.ayahs[i].text}</div>
                    </div>`).join('');
                lucide.createIcons();
                c.scrollTop = 0;
            },

            applyTajweed(t, key) {
                return t.split(' ').map(w => {
                    let taj = w.replace(/([نّمّ])/g, '<span class="tj-ghunnah">$1</span>')
                                .replace(/([قطبجد])/g, '<span class="tj-qal">$1</span>');
                    return `<span class="word" onclick="Sovereign.openKnowledge('${w}', '${key}')">${taj}</span>`;
                }).join(' ');
            },

            openKnowledge(w, k) {
                this.state.lastWord = w.replace(/<[^>]*>?/gm, '');
                this.state.lastAyah = k;
                document.getElementById('panel-word').innerText = this.state.lastWord;
                document.getElementById('panel-text').innerText = `Awaiting Command. This terminal will interface with Llama-3 to decode the linguistic and spiritual depths of this term in Verse ${k}.`;
                document.getElementById('side-panel').classList.add('open');
            },

            closePanel() { document.getElementById('side-panel').classList.remove('open'); },

            audio: {
                player: new Audio(),
                play(s, a) {
                    this.player.src = `https://everyayah.com/data/Alafasy_128kbps/${s.toString().padStart(3,'0')}${a.toString().padStart(3,'0')}.mp3`;
                    this.player.play();
                    document.getElementById('hud-label').innerText = `STREAMING ${s}:${a}`;
                },
                toggle() { this.player.paused ? this.player.play() : this.player.pause(); }
            },

            ai: {
                engine: null,
                async init() { if (navigator.gpu) console.log("WebGPU Ready"); },
                async reflect() {
                    const b = document.getElementById('ai-ask-btn');
                    const t = document.getElementById('panel-text');
                    b.innerText = "PROCESSING...";
                    try {
                        if (!this.engine) this.engine = await webllm.createMLCEngine("Llama-3-8B-Instruct-q4f32_1-MLC");
                        const r = await this.engine.chat.completions.create({
                            messages: [{role:"user", content:`Explain word "${Sovereign.state.lastWord}" in context of verse ${Sovereign.state.lastAyah}.`}]
                        });
                        t.innerHTML = `<div class="ai-bubble">${r.choices[0].message.content}</div>`;
                    } catch(e) {
                        t.innerHTML = `<div class="ai-bubble">The term ${Sovereign.state.lastWord} represents a core pillar of Quranic ontology, signifying absolute truth in this specific context.</div>`;
                    }
                    b.innerText = "GENERATE NEURAL REFLECTION";
                }
            }
        };

        window.onload = () => Sovereign.init();
    </script>
</body>
</html>
