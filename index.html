<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sanctuary Quran</title>
  <link rel="icon" href="https://quran.com/favicon.ico">
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&family=Amiri+Quran&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary: #fbbf24; --bg: #030712; --card: #111827; --text: #f3f4f6; --muted: #9ca3af;
      --border: rgba(255,255,255,0.08); --arabic-font: 'Amiri Quran', serif;
      --nav-w: 90px; --side-w: 500px; --player-h: 120px;
      --quran-size: 5.5rem; --quran-weight: 400; --verse-spacing: 100px;
    }

    html { transform: scale(0.67); transform-origin: top left; width: 149.25%; height: 149.25%; overflow: hidden; }

    /* THEME REPOSITORY */
    body.t-dark-gold { --bg: #000; --card: #0a0a0a; --primary: #fbbf24; }
    body.t-emerald { --bg: #022c22; --card: #064e3b; --primary: #34d399; }
    body.t-ocean { --bg: #0f172a; --card: #1e293b; --primary: #38bdf8; }
    body.t-sepia { --bg: #2d241e; --card: #3d3028; --primary: #d97706; }

    * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; }

    /* LAYOUT ENGINE */
    nav { width: var(--nav-w); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 30px 0; gap: 25px; flex-shrink: 0; background: var(--bg); z-index: 100; }
    
    main { flex: 1; overflow-y: auto; scroll-behavior: smooth; display: flex; flex-direction: column; align-items: center; }
    
    /* This makes the text move left/center when sidebar closes */
    .container { width: 100%; max-width: 1400px; padding: 60px 80px 300px 80px; }

    aside { width: var(--side-w); border-left: 1px solid var(--border); background: var(--card); padding: 50px; overflow-y: auto; flex-shrink: 0; display: none; }
    aside.visible { display: block; }

    /* BISMILLAH SPECIAL STYLING */
    .bismillah-header { 
        font-family: var(--arabic-font); 
        font-size: 8rem; 
        text-align: center; 
        margin: 100px 0; 
        color: var(--primary); 
        text-shadow: 0 0 30px rgba(251, 191, 36, 0.2);
    }

    /* QURAN ENGINE */
    .ayah-row { padding: var(--verse-spacing) 0; border-bottom: 1px solid var(--border); width: 100%; }
    .arabic { font-family: var(--arabic-font); font-size: var(--quran-size); font-weight: var(--quran-weight); direction: rtl; line-height: 2.3; text-align: right; display: block; }
    
    .ayah-marker {
        display: inline-flex; align-items: center; justify-content: center;
        width: 1.5em; height: 1.5em; border: 4px solid var(--primary); border-radius: 50%;
        margin-right: 25px; font-family: 'Plus Jakarta Sans', sans-serif;
        font-size: 0.35em; font-weight: 800; vertical-align: middle; color: var(--primary);
        box-shadow: 0 0 15px rgba(251, 191, 36, 0.1);
    }

    .translation { font-size: 2.4rem; line-height: 1.8; color: var(--muted); margin-top: 40px; font-weight: 300; max-width: 90%; }
    
    .player-bar { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); width: 92%; height: var(--player-h); background: rgba(10,10,10,0.98); backdrop-filter: blur(40px); border: 1px solid var(--border); border-radius: 40px; display: flex; align-items: center; justify-content: space-between; padding: 0 60px; z-index: 1000; }
    
    .btn { background: var(--card); color: var(--text); border: 1px solid var(--border); padding: 18px 30px; border-radius: 20px; cursor: pointer; font-size: 1.3rem; display: inline-flex; align-items: center; gap: 12px; }
    .btn-play { background: var(--primary); color: #000; border-radius: 50%; width: 100px; height: 100px; justify-content: center; border: none; cursor: pointer; box-shadow: 0 10px 30px rgba(251, 191, 36, 0.3); }

    /* MODAL */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .modal-content { background: var(--card); padding: 50px; border-radius: 40px; border: 1px solid var(--border); width: 700px; }

    body.memo-mode .arabic { filter: blur(30px); opacity: 0.1; }
    body.memo-mode .revealed .arabic { filter: blur(0); opacity: 1; }
  </style>
</head>
<body class="t-dark-gold">

  <nav>
    <div style="color:var(--primary); margin-bottom: 40px;"><i data-lucide="book-marked" size="40"></i></div>
    <div class="btn" style="border:none;" onclick="updateRoute('home')"><i data-lucide="home" size="32"></i></div>
    <div class="btn" id="memo-btn" style="border:none;" onclick="toggleMemorization()"><i data-lucide="brain" size="32"></i></div>
    <div class="btn" style="border:none;" onclick="toggleModal('settings-modal')"><i data-lucide="settings" size="32"></i></div>
  </nav>

  <main id="scroll-main">
    <div class="container" id="view-container"></div>
  </main>

  <aside id="sidebar">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="font-size: 2.2rem;">Sanctuary Insight</h2>
        <button class="btn" onclick="toggleSidebar()"><i data-lucide="chevron-right"></i></button>
    </div>
    <div id="side-content" style="margin-top: 50px; font-size: 1.7rem; line-height: 1.8;"></div>
  </aside>

  <div id="settings-modal" class="modal" onclick="toggleModal('settings-modal')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 style="font-size: 2.2rem;">Preferences</h2>
        <label>Reading Theme</label>
        <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:15px; margin: 20px 0;">
            <button class="btn" onclick="setTheme('t-dark-gold')">Midnight Gold</button>
            <button class="btn" onclick="setTheme('t-emerald')">Deep Emerald</button>
            <button class="btn" onclick="setTheme('t-ocean')">Ocean Abyss</button>
            <button class="btn" onclick="setTheme('t-sepia')">Historical Sepia</button>
        </div>
        <label>Arabic Scale</label>
        <input type="range" style="width:100%; margin: 20px 0;" min="4" max="12" step="0.5" value="5.5" oninput="updateStyle('--quran-size', this.value + 'rem')">
        <button class="btn btn-primary" style="width:100%; margin-top:30px;" onclick="toggleModal('settings-modal')">Save</button>
    </div>
  </div>

  <div class="player-bar">
    <div style="width: 450px;">
        <div id="p-title" style="font-size: 2rem; font-weight: 700;">Sanctuary Quran</div>
        <div id="p-subtitle" class="text-muted" style="font-size: 1.4rem;">Select a verse to begin</div>
    </div>
    <button class="btn-play" onclick="toggleAudio()"><i data-lucide="play" id="main-play" size="40" fill="currentColor"></i></button>
    <div style="width: 450px; text-align: right;">
        <button class="btn" onclick="toggleSidebar()">EXPAND INSIGHT <i data-lucide="panel-right-open"></i></button>
    </div>
  </div>

  <audio id="audio-player"></audio>

  <script>
    const App = {
      isMemoMode: false,
      currentAyahIndex: 0,
      currentSurah: 0,

      async init() {
        lucide.createIcons();
        window.addEventListener('keydown', (e) => {
          if (e.code === 'Space' && this.isMemoMode) {
            e.preventDefault();
            this.revealNext();
          }
        });
        const res = await fetch('https://api.alquran.cloud/v1/surah');
        const data = await res.json();
        this.chapters = data.data;
        this.router();
      },

      router() {
        const params = new URLSearchParams(window.location.search);
        const surahId = params.get('surah');
        if (surahId) this.renderReader(surahId);
        else this.renderHome();
      },

      async renderHome() {
        let html = `<h1 style="font-size:5rem; margin-bottom:80px; text-align:center;">The Noble Sanctuary</h1><div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap:40px;">`;
        html += this.chapters.map(s => `
          <div class="btn" style="display:block; padding:50px; text-align:left;" onclick="updateRoute('surah', ${s.number})">
            <h3 style="font-size:2.6rem; margin:0 0 10px 0;">${s.englishName}</h3>
            <p style="opacity:0.6; font-size:1.4rem;">${s.numberOfAyahs} Ayahs • ${s.revelationType}</p>
          </div>
        `).join('') + `</div>`;
        document.getElementById('view-container').innerHTML = html;
        lucide.createIcons();
      },

      async renderReader(id) {
        this.currentSurah = id;
        const [ar, en] = await Promise.all([
          fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-uthmani`).then(r => r.json()),
          fetch(`https://api.alquran.cloud/v1/surah/${id}/en.sahih`).then(r => r.json())
        ]);
        
        let ayahs = ar.data.ayahs;
        let trans = en.data.ayahs;
        let html = "";

        // BISMILLAH HANDLER
        if (id != 1 && id != 9 && ayahs[0].text.includes("بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ")) {
            html += `<div class="bismillah-header">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</div>`;
            // Remove the first Ayah's Bismillah prefix if it's baked into the text
            ayahs[0].text = ayahs[0].text.replace("بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ", "").trim();
        }

        ayahs.forEach((ayah, i) => {
          if (ayah.text === "" && i === 0) return; // Skip if first ayah became empty after Bismillah removal
          html += `<div class="ayah-row" id="ayah-${i}">
            <div class="arabic">${ayah.text} <span class="ayah-marker">${i+1}</span></div>
            <div class="translation">${trans[i].text}</div>
            <div style="margin-top:40px; display:flex; gap:20px;">
                <button class="btn" onclick="App.loadTafsir(${id}, ${i+1})"><i data-lucide="scroll"></i> Tafsir</button>
                <button class="btn" onclick="App.playVerse(${id}, ${i+1}, ${i})"><i data-lucide="play"></i> Recite</button>
            </div>
          </div>`;
        });
        
        document.getElementById('view-container').innerHTML = html;
        document.getElementById('p-title').innerText = ar.data.englishName;
        lucide.createIcons();
      },

      async loadTafsir(surah, ayah) {
        toggleSidebar(true);
        document.getElementById('side-content').innerHTML = "Unfolding secrets...";
        const res = await fetch(`https://api.alquran.cloud/v1/ayah/${surah}:${ayah}/ar.jalalayn`);
        const data = await res.json();
        document.getElementById('side-content').innerHTML = `
            <div style="border-right: 4px solid var(--primary); padding-right:30px; margin-bottom:40px;">
                <h3 style="color:var(--primary); font-size:2rem;">Ayah ${ayah}</h3>
                <p style="direction:rtl; text-align:right; font-family:var(--arabic-font); font-size:2.8rem; line-height:2;">${data.data.text}</p>
            </div>
        `;
      },

      playVerse(surah, ayah, index) {
        this.currentAyahIndex = index;
        const player = document.getElementById('audio-player');
        let absolute = 0;
        for(let i=0; i<surah-1; i++) absolute += this.chapters[i].numberOfAyahs;
        absolute += ayah;
        player.src = `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${absolute}.mp3`;
        player.play();
        
        document.querySelectorAll('.ayah-row').forEach(r => r.classList.remove('active'));
        document.getElementById(`ayah-${index}`).classList.add('active');
        document.getElementById(`ayah-${index}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
        document.getElementById('main-play').setAttribute('data-lucide', 'pause');
        lucide.createIcons();
      },

      revealNext() {
        const row = document.getElementById(`ayah-${this.currentAyahIndex}`);
        if(row) {
            row.classList.add('revealed');
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            this.currentAyahIndex++;
        }
      }
    };

    function toggleMemorization() {
        App.isMemoMode = !App.isMemoMode;
        document.body.classList.toggle('memo-mode');
        document.getElementById('memo-btn').classList.toggle('active');
        App.currentAyahIndex = 0;
        document.querySelectorAll('.ayah-row').forEach(r => r.classList.remove('revealed'));
    }

    function toggleAudio() {
        const p = document.getElementById('audio-player');
        if(p.paused) p.play(); else p.pause();
        document.getElementById('main-play').setAttribute('data-lucide', p.paused ? 'play' : 'pause');
        lucide.createIcons();
    }

    function setTheme(t) { document.body.className = t; }
    function toggleModal(id) { const m = document.getElementById(id); m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; }
    function updateStyle(p, v) { document.documentElement.style.setProperty(p, v); }
    function toggleSidebar(forceOpen = false) { 
        const s = document.getElementById('sidebar');
        if(forceOpen) s.classList.add('visible'); else s.classList.toggle('visible');
    }
    function updateRoute(t, v) {
        const url = new URL(window.location);
        if(t === 'surah') url.searchParams.set('surah', v);
        else url.searchParams.delete('surah');
        window.history.pushState({}, '', url);
        App.router();
    }

    window.onload = () => App.init();
  </script>
</body>
</html>
