<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sovereign | Zenith</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>

<style>
:root {
    /* Main Theme Colors */
    --p: #10b981; --bg: #020617; --surf: #0f172a; --text: #f8fafc;
    --border: #1e293b; --ar-size: 2.8rem; --en-size: 1.1rem;
    --line: 2.5; --radius: 20px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); 
    display: flex; height: 100vh; overflow: hidden; transition: 0.4s;
}

/* Glassmorphism Sidebar */
nav { width: 85px; background: var(--surf); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 2.5rem 0; z-index: 1000; }
.nav-btn { width: 55px; height: 55px; border-radius: 16px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; cursor: pointer; color: #475569; transition: 0.3s; position: relative; }
.nav-btn:hover, .nav-btn.active { color: var(--p); background: rgba(16, 185, 129, 0.1); }
.nav-btn.active::after { content: ''; position: absolute; left: -10px; height: 20px; width: 4px; background: var(--p); border-radius: 0 4px 4px 0; }

/* Settings Drawer */
#drawer { 
    position: fixed; right: -420px; top: 0; width: 420px; height: 100%; 
    background: var(--surf); border-left: 1px solid var(--border); z-index: 2000; 
    padding: 3rem 2.5rem; transition: 0.6s cubic-bezier(0.19, 1, 0.22, 1); overflow-y: auto;
}
#drawer.open { right: 0; box-shadow: -30px 0 80px rgba(0,0,0,0.8); }
.s-section { margin-bottom: 2.5rem; }
.s-section h3 { font-size: 0.7rem; font-weight: 800; color: var(--p); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 1.5rem; }
.s-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; font-size: 0.95rem; }
select, input[type="range"] { background: var(--bg); color: white; border: 1px solid var(--border); padding: 8px 12px; border-radius: 10px; outline: none; }

/* Content Area */
main { flex: 1; overflow-y: auto; scroll-behavior: smooth; position: relative; }
header { 
    position: sticky; top: 0; background: rgba(2, 6, 23, 0.96); backdrop-filter: blur(25px); 
    padding: 2rem 4rem; border-bottom: 1px solid var(--border); display: flex; 
    justify-content: space-between; align-items: center; z-index: 500; 
}
.search-box { background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 14px; padding: 12px 20px; color: #fff; width: 320px; outline: none; transition: 0.4s; }
.search-box:focus { border-color: var(--p); background: rgba(255,255,255,0.08); }

/* Verse Typography */
.reader { max-width: 950px; margin: 0 auto; padding: 4rem 2rem; }
.ayah { padding: 4rem 0; border-bottom: 1px solid var(--border); opacity: 0; transform: translateY(20px); transition: 0.7s ease; cursor: pointer; position: relative; }
.ayah.visible { opacity: 1; transform: translateY(0); }
.ayah.playing { border-left: 5px solid var(--p); padding-left: 30px; background: linear-gradient(90deg, rgba(16, 185, 129, 0.05) 0%, transparent 100%); }

.ar { font-family: 'Amiri', serif; font-size: var(--ar-size); direction: rtl; text-align: right; line-height: var(--line); margin-bottom: 1.5rem; color: #fff; }
.en { font-size: var(--en-size); color: #94a3b8; line-height: 1.8; user-select: text; }
.v-num { position: absolute; left: -50px; top: 4.5rem; font-size: 0.8rem; font-weight: 800; color: var(--p); opacity: 0.5; }

/* Bottom Control Bar */
#player { 
    position: fixed; bottom: 30px; left: 120px; right: 30px; background: var(--surf); 
    border: 1px solid var(--border); border-radius: 28px; padding: 1.5rem 2.5rem; 
    display: flex; align-items: center; gap: 2.5rem; transform: translateY(250px); transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1000;
}
#player.active { transform: translateY(0); }
.p-btn { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
.p-main { background: var(--p); color: white; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3); }
.p-sec { background: transparent; color: #64748b; border: 1px solid var(--border); }
.p-sec.on { color: var(--p); border-color: var(--p); }

progress { flex: 1; height: 6px; border-radius: 10px; accent-color: var(--p); background: var(--bg); overflow: hidden; }
</style>
</head>
<body>

<nav>
    <div class="nav-btn active" onclick="location.reload()"><i data-lucide="book-open"></i></div>
    <div class="nav-btn" id="nav-hifz"><i data-lucide="eye-off"></i></div>
    <div class="nav-btn" id="nav-settings"><i data-lucide="sliders"></i></div>
    <div style="flex:1"></div>
    <div class="nav-btn" onclick="localStorage.clear(); location.reload()"><i data-lucide="refresh-ccw"></i></div>
</nav>

<div id="drawer">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:3rem;">
        <h2 style="font-weight:900;">PREFERENCES</h2>
        <i data-lucide="x" id="close-drawer" style="cursor:pointer; opacity:0.5;"></i>
    </div>

    <div class="s-section">
        <h3>AUDIO ENGINE</h3>
        <div class="s-row"><span>Reciter</span>
            <select id="reciter-opt">
                <option value="7">Mishary Rashid Alafasy</option>
                <option value="1">AbdulBaset AbdulSamad</option>
                <option value="6">Khalil al-Husary</option>
                <option value="12">Mahmoud Khalil Al-Banna</option>
            </select>
        </div>
        <div class="s-row"><span>Speed</span>
            <select id="speed-opt">
                <option value="0.75">0.75x</option>
                <option value="1" selected>Normal</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
            </select>
        </div>
    </div>

    <div class="s-section">
        <h3>APPEARANCE</h3>
        <div class="s-row"><span>Theme</span>
            <select id="theme-opt">
                <option value="midnight">Midnight Galaxy</option>
                <option value="obsidian">Pure Obsidian</option>
                <option value="sepia">Classic Sepia</option>
            </select>
        </div>
        <div class="s-row"><span>Arabic Size</span><input type="range" data-var="--ar-size" min="1.8" max="5.5" step="0.1" value="2.8"></div>
        <div class="s-row"><span>English Size</span><input type="range" data-var="--en-size" min="0.8" max="2" step="0.1" value="1.1"></div>
        <div class="s-row"><span>Line Height</span><input type="range" data-var="--line" min="1.5" max="4.5" step="0.1" value="2.5"></div>
    </div>
</div>

<main>
    <header>
        <div>
            <h1 id="s-title" style="font-weight:900; letter-spacing:-1px; font-size:2rem;">Zenith</h1>
            <p id="s-meta" style="font-size:0.8rem; opacity:0.5; font-weight:700;"></p>
        </div>
        <input class="search-box" id="search" placeholder="Enter Surah number (1-114)..."/>
    </header>
    <div class="reader" id="reader"></div>
    <div id="sentinel" style="height:100px;"></div>
</main>

<div id="player">
    <div style="display:flex; gap: 1rem;">
        <button class="p-btn p-sec" id="p-loop"><i data-lucide="repeat-1"></i></button>
        <button class="p-btn p-main" id="p-play"><i data-lucide="play"></i></button>
    </div>
    <div style="flex:1">
        <div id="p-label" style="font-weight:800; color:var(--p); font-size:1rem; margin-bottom:8px;"></div>
        <progress id="p-progress" value="0" max="1"></progress>
    </div>
    <audio id="audio"></audio>
</div>

<script>
const App = {
    state: { verses: [], rendered: 0, chunk: 15, loop: false, reciter: 7, hifz: false },

    async fetchSurah(id) {
        const target = document.getElementById('reader');
        target.innerHTML = '<div style="text-align:center; padding:100px; opacity:0.3; letter-spacing:2px;">LOADING REVELATION...</div>';
        
        try {
            // Fetching both Arabic and English Translation (ID 131 is Dr. Mustafa Khattab)
            const [m, v] = await Promise.all([
                fetch(`https://api.quran.com/api/v4/chapters/${id}`),
                fetch(`https://api.quran.com/api/v4/verses/by_chapter/${id}?language=en&translations=131&fields=text_uthmani`)
            ]);
            
            const meta = await m.json();
            const data = await v.json();

            this.state.verses = data.verses.map(v => ({
                key: v.verse_key,
                num: v.verse_number,
                ar: v.text_uthmani,
                en: v.translations?.[0]?.text.replace(/<\/?[^>]+(>|$)/g, "") || "Translation not found"
            }));

            document.getElementById('s-title').innerText = meta.chapter.name_simple;
            document.getElementById('s-meta').innerText = `${meta.chapter.revelation_place.toUpperCase()} â€¢ ${meta.chapter.verses_count} VERSES`;
            
            target.innerHTML = '';
            this.state.rendered = 0;
            this.render();
            localStorage.setItem('last_s', id);
        } catch(e) { console.error(e); }
    },

    render() {
        const target = document.getElementById('reader');
        const batch = this.state.verses.slice(this.state.rendered, this.state.rendered + this.state.chunk);
        
        batch.forEach(v => {
            const div = document.createElement('div');
            div.className = 'ayah';
            div.id = `v-${v.key}`;
            div.innerHTML = `
                <span class="v-num">${v.num}</span>
                <div class="ar">${v.ar}</div>
                <div class="en">${v.en}</div>
            `;
            div.onclick = () => this.play(v.key);
            target.appendChild(div);
            this.obs.observe(div);
        });
        this.state.rendered += batch.length;
        lucide.createIcons();
    },

    async play(key) {
        const audio = document.getElementById('audio');
        document.getElementById('player').classList.add('active');
        document.getElementById('p-label').innerText = `VERSE ${key}`;
        
        document.querySelectorAll('.ayah').forEach(a => a.classList.remove('playing'));
        document.getElementById(`v-${key}`)?.classList.add('playing');

        const r = await fetch(`https://api.quran.com/api/v4/recitations/${this.state.reciter}/by_ayah/${key}`);
        const res = await r.json();
        const url = res.audio_files?.[0]?.url;

        if (url) {
            audio.src = url.startsWith('http') ? url : `https://verses.quran.com/${url}`;
            audio.playbackRate = parseFloat(document.getElementById('speed-opt').value);
            audio.play();
        }
    },

    boot() {
        lucide.createIcons();
        this.obs = new IntersectionObserver(e => e.forEach(x => { if(x.isIntersecting) x.target.classList.add('visible') }), {threshold: 0.1});
        
        // Infinite Scroll
        new IntersectionObserver(e => {
            if(e[0].isIntersecting && this.state.verses.length > this.state.rendered) this.render();
        }).observe(document.getElementById('sentinel'));

        // Settings Listeners
        document.getElementById('nav-settings').onclick = () => document.getElementById('drawer').classList.toggle('open');
        document.getElementById('close-drawer').onclick = () => document.getElementById('drawer').classList.remove('open');
        
        document.querySelectorAll('input[type="range"]').forEach(i => {
            i.oninput = (e) => {
                const isSize = e.target.dataset.var.includes('size');
                document.documentElement.style.setProperty(e.target.dataset.var, e.target.value + (isSize ? 'rem' : ''));
            }
        });

        // Theme Switcher
        document.getElementById('theme-opt').onchange = (e) => {
            const themes = {
                midnight: {bg: '#020617', surf: '#0f172a', border: '#1e293b', text: '#f8fafc'},
                obsidian: {bg: '#000000', surf: '#0a0a0a', border: '#1a1a1a', text: '#ffffff'},
                sepia: {bg: '#f4f1ea', surf: '#e8e4d9', border: '#d1cdc0', text: '#433422'}
            };
            const t = themes[e.target.value];
            Object.entries(t).forEach(([k, v]) => document.documentElement.style.setProperty(`--${k}`, v));
        };

        // Audio Management
        const audio = document.getElementById('audio');
        audio.onended = () => {
            if(this.state.loop) audio.play();
            else {
                const next = document.querySelector('.ayah.playing')?.nextElementSibling;
                if(next) this.play(next.id.replace('v-', ''));
            }
        };

        document.getElementById('p-loop').onclick = (e) => {
            this.state.loop = !this.state.loop;
            e.currentTarget.classList.toggle('on', this.state.loop);
        };

        document.getElementById('p-play').onclick = () => audio.paused ? audio.play() : audio.pause();
        audio.ontimeupdate = () => document.getElementById('p-progress').value = audio.currentTime / audio.duration || 0;
        document.getElementById('search').onkeydown = (e) => { if(e.key === 'Enter') this.fetchSurah(e.target.value) };

        this.fetchSurah(localStorage.getItem('last_s') || 1);
    }
};

window.onload = () => App.boot();
</script>
</body>
</html>
