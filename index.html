<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign | Stable Edition</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --p: #10b981; --bg: #020617; --surf: #0f172a; --text: #f8fafc; --sub: #94a3b8; --border: #1e293b; 
        }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar Fix */
        nav { width: 70px; background: var(--surf); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 20px 0; gap: 20px; flex-shrink: 0; }
        
        /* Main Layout Fix */
        main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        header { padding: 20px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 20px; }
        
        .search-box { flex: 1; max-width: 400px; position: relative; }
        .search-box input { width: 100%; background: var(--surf); border: 1px solid var(--border); color: white; padding: 10px 15px; border-radius: 8px; outline: none; }
        
        #viewport { flex: 1; overflow-y: auto; padding: 30px; scroll-behavior: smooth; }

        /* Ayah Styling */
        .ayah-row { padding: 30px 0; border-bottom: 1px solid var(--border); }
        .ar { font-family: 'Amiri', serif; font-size: 2.5rem; text-align: right; direction: rtl; color: var(--p); line-height: 2.2; margin-bottom: 15px; }
        .en { color: var(--sub); line-height: 1.6; font-size: 1.1rem; }

        /* Audio HUD Fix (The floating bar in your screenshot) */
        #audio-bar { 
            background: var(--surf); border-top: 1px solid var(--border); padding: 15px 30px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .controls { display: flex; gap: 15px; align-items: center; }
        .btn-icon { background: none; border: none; color: var(--sub); cursor: pointer; padding: 5px; }
        .btn-icon:hover { color: var(--p); }

        /* Error Toast */
        #error-msg { display: none; background: #ef4444; color: white; padding: 10px; text-align: center; font-size: 0.9rem; }
    </style>
</head>
<body>

    <nav>
        <div class="btn-icon" onclick="App.renderIndex()"><i data-lucide="home"></i></div>
        <div class="btn-icon" onclick="App.showHifz()"><i data-lucide="target"></i></div>
    </nav>

    <main>
        <div id="error-msg">Connection issue. Retrying...</div>
        <header>
            <div>
                <h2 style="margin:0">Sovereign</h2>
                <small id="sub-head" style="color:var(--sub)">Universal Edition</small>
            </div>
            <div class="search-box">
                <input type="text" placeholder="Search Surah 1-114..." oninput="App.filter(this.value)">
            </div>
        </header>

        <div id="viewport"></div>

        <div id="audio-bar">
            <div id="now-playing" style="font-size: 0.8rem;">Select a Surah</div>
            <div class="controls">
                <button class="btn-icon" onclick="Audio.prev()"><i data-lucide="skip-back"></i></button>
                <button class="btn-icon" style="color:var(--p)" onclick="Audio.toggle()"><i data-lucide="play" id="play-icon"></i></button>
                <button class="btn-icon" onclick="Audio.next()"><i data-lucide="skip-forward"></i></button>
            </div>
            <select id="reciter-pick" onchange="Audio.reciter = this.value" style="background:var(--bg); color:white; border:1px solid var(--border); padding:5px; border-radius:4px;">
                <option value="Alafasy_128kbps">Mishary Alafasy</option>
                <option value="Abdul_Basit_Murattal_64kbps">Abdul Basit</option>
            </select>
        </div>
    </main>

    <script>
        const App = {
            chapters: [],
            
            async init() {
                try {
                    const res = await fetch('https://api.alquran.cloud/v1/surah');
                    if (!res.ok) throw new Error();
                    const data = await res.json();
                    this.chapters = data.data;
                    this.renderIndex();
                    document.getElementById('error-msg').style.display = 'none';
                } catch (e) {
                    document.getElementById('error-msg').style.display = 'block';
                    setTimeout(() => this.init(), 3000); // Auto-retry every 3 seconds
                }
                lucide.createIcons();
            },

            renderIndex() {
                const vp = document.getElementById('viewport');
                document.getElementById('sub-head').innerText = "Quran Index";
                vp.innerHTML = `<div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px;">
                    ${this.chapters.map(s => `
                        <div onclick="App.loadSurah(${s.number})" style="background:var(--surf); padding:15px; border-radius:10px; cursor:pointer; border:1px solid var(--border)">
                            <b>${s.number}. ${s.englishName}</b><br>
                            <small style="color:var(--sub)">${s.name}</small>
                        </div>
                    `).join('')}
                </div>`;
            },

            async loadSurah(id) {
                const vp = document.getElementById('viewport');
                vp.innerHTML = 'Loading verses...';
                
                try {
                    const [ar, en] = await Promise.all([
                        fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-uthmani`).then(r => r.json()),
                        fetch(`https://api.alquran.cloud/v1/surah/${id}/en.sahih`).then(r => r.json())
                    ]);

                    document.getElementById('sub-head').innerText = ar.data.englishName;
                    vp.innerHTML = ar.data.ayahs.map((v, i) => `
                        <div class="ayah-row">
                            <div class="ar">${v.text}</div>
                            <div class="en">${en.data.ayahs[i].text}</div>
                            <button onclick="Audio.play(${id}, ${i+1})" style="background:none; border:none; color:var(--p); cursor:pointer; margin-top:10px;">Play Verse</button>
                        </div>
                    `).join('');
                } catch (e) {
                    vp.innerHTML = '<b style="color:red">Failed to load Surah. Please check your internet.</b>';
                }
            }
        };

        const Audio = {
            player: new Audio(),
            reciter: 'Alafasy_128kbps',
            play(s, a) {
                const sP = s.toString().padStart(3,'0');
                const aP = a.toString().padStart(3,'0');
                this.player.src = `https://everyayah.com/data/${this.reciter}/${sP}${aP}.mp3`;
                this.player.play();
                document.getElementById('now-playing').innerText = `Playing ${s}:${a}`;
                document.getElementById('play-icon').setAttribute('data-lucide', 'pause');
                lucide.createIcons();
            },
            toggle() {
                if(this.player.paused) this.player.play();
                else this.player.pause();
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
