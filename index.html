<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Quran Legacy | V8 Engine</title>

    

    <script src="https://unpkg.com/lucide@latest"></script>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">

    

    <style>

        :root {

            --emerald: #10b981;

            --glass: rgba(6, 40, 30, 0.88);

            --bg: #020f0c;

            --border: rgba(16, 185, 129, 0.2);

        }



        body.theme-velvet {

            --emerald: #8b5cf6;

            --glass: rgba(20, 10, 40, 0.9);

            --bg: #0a0515;

            --border: rgba(139, 92, 246, 0.2);

        }



        body.theme-ocean {

            --emerald: #0ea5e9;

            --glass: rgba(10, 30, 50, 0.9);

            --bg: #020617;

            --border: rgba(14, 165, 233, 0.2);

        }



        * { box-sizing: border-box; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        

        body { 

            margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; 

            background: var(--bg); color: #ecfdf5; 

            height: 100vh; overflow: hidden;

            display: flex; flex-direction: column;

            background-image: radial-gradient(circle at 50% -20%, #064e3b 0%, #020f0c 100%);

        }



        body.theme-velvet { background-image: radial-gradient(circle at 50% -20%, #2e1065 0%, #0a0515 100%); }

        body.theme-ocean { background-image: radial-gradient(circle at 50% -20%, #0c4a6e 0%, #020617 100%); }



        .deep-glass {

            background: var(--glass);

            backdrop-filter: blur(50px) saturate(200%);

            border: 1px solid var(--border);

            border-top: 1px solid rgba(255,255,255,0.15);

            border-radius: 32px;

        }



        #viewport.loading {

            opacity: 0.4;

            filter: blur(12px);

            pointer-events: none;

            transform: scale(0.99);

        }



        /* Tajweed Color Mapping */

        .tajweed-active .taj-ghunnah { color: #ff5722 !important; font-weight: bold; }

        .tajweed-active .taj-qalqalah { color: #03a9f4 !important; font-weight: bold; }

        .tajweed-active .taj-madd { color: #e91e63 !important; font-weight: bold; }

        .tajweed-active .taj-ikfa { color: #ffeb3b !important; }



        header { height: 80px; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; flex-shrink: 0; }

        

        main { 

            display: grid; grid-template-columns: 300px 1fr 320px; 

            gap: 20px; padding: 0 20px;

            flex: 1; overflow: hidden;

            margin-bottom: 110px; 

        }



        .silo { overflow-y: auto; padding: 25px; scrollbar-width: none; height: 100%; }

        .silo::-webkit-scrollbar { width: 0; }



        .card {

            padding: 16px; margin-bottom: 12px; border-radius: 20px; cursor: pointer;

            background: rgba(255,255,255,0.03); border: 1px solid transparent;

        }

        .card:hover, .card.active { background: var(--emerald); border-color: white; color: white; }



        .ayah-block {

            padding: 35px; margin-bottom: 25px; border-radius: 24px;

            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);

        }



        .q-text { font-family: 'Amiri'; font-size: 2.8rem; text-align: right; line-height: 2.4; direction: rtl; }



        .drawer {

            position: fixed; top: 0; right: -450px; width: 380px; height: 100%;

            z-index: 9999; padding: 40px; border-radius: 40px 0 0 40px;

        }

        .drawer.open { right: 0; box-shadow: -20px 0 60px rgba(0,0,0,0.8); }



        .player-bar {

            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);

            width: 92%; max-width: 1100px; height: 85px; padding: 0 40px;

            display: flex; align-items: center; justify-content: space-between;

            z-index: 5000;

        }



        .play-btn {

            width: 55px; height: 55px; border-radius: 50%; background: var(--emerald);

            border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;

        }

    </style>

</head>

<body>



    <header>

        <div style="color: var(--emerald); font-weight: 800; font-size: 1.4rem; letter-spacing: 1px;">

            <i data-lucide="zap" style="margin-right:8px;"></i> V8 ENGINE

        </div>

        <div style="display:flex; gap:12px;">

            <div class="card" style="padding:10px;" onclick="App.ui.toggle('account')"><i data-lucide="user"></i></div>

            <div class="card" style="padding:10px;" onclick="App.ui.toggle('settings')"><i data-lucide="settings"></i></div>

        </div>

    </header>



    <div id="settings-drawer" class="deep-glass drawer">

        <div style="display:flex; justify-content:space-between; align-items:center;">

            <h3>Core Settings</h3>

            <i data-lucide="x" onclick="App.ui.toggle('settings')" style="cursor:pointer;"></i>

        </div>

        <div style="margin-top:35px; display:flex; flex-direction:column; gap:25px;">

            <div style="display:flex; justify-content:space-between; align-items:center;">

                <span>Tajweed Visualization</span>

                <input type="checkbox" id="pref-tajweed" onchange="App.ui.refreshTajweed()" style="accent-color:var(--emerald); width:20px; height:20px;">

            </div>

            <div>

                <label style="font-size: 0.75rem; opacity: 0.6; text-transform:uppercase;">Atmosphere</label>

                <select id="pref-theme" class="card" style="width:100%; margin-top:8px; background:var(--bg); color:white; border:1px solid var(--border);" onchange="App.ui.setTheme(this.value)">

                    <option value="emerald">Emerald Sanctuary</option>

                    <option value="velvet">Midnight Velvet</option>

                    <option value="ocean">Deep Ocean</option>

                </select>

            </div>

        </div>

    </div>



    <div id="account-drawer" class="deep-glass drawer">

        <div style="display:flex; justify-content:space-between; align-items:center;"><h3>User Matrix</h3><i data-lucide="x" onclick="App.ui.toggle('account')"></i></div>

        <div style="margin-top:40px;"><div class="card" style="text-align:center;"><h4>Active Seeker</h4><p style="opacity:0.6; font-size:0.8rem;">Session Authenticated</p></div></div>

    </div>



    <main>

        <aside class="deep-glass silo" id="surah-target"></aside>

        <section id="viewport" class="deep-glass silo"><div id="reader-target"></div></section>

        <aside class="deep-glass silo">

            <h4 style="color:var(--emerald); margin-top:0; letter-spacing:2px;">SENTINEL AI</h4>

            <div id="ai-output" style="font-size: 0.85rem; line-height: 1.8; opacity: 0.8;">Select a verse to initiate analysis.</div>

        </aside>

    </main>



    <div class="deep-glass player-bar">

        <div id="np-surah" style="width:200px;"><b>System Standby</b></div>

        <div style="display:flex; gap:25px; align-items:center;">

            <i data-lucide="skip-back" style="cursor:pointer;"></i>

            <button class="play-btn" onclick="App.audio.toggle()"><i data-lucide="play" id="play-icon"></i></button>

            <i data-lucide="skip-forward" style="cursor:pointer;"></i>

        </div>

        <div style="width:200px; text-align:right;"><i data-lucide="volume-2"></i></div>

    </div>



    <audio id="core-audio"></audio>



    <script>

        const App = {

            state: { chapters: [], currentId: 1, tajweed: false, loading: false },



            async init() {

                try {

                    const res = await fetch('https://api.alquran.cloud/v1/surah');

                    const json = await res.json();

                    this.state.chapters = json.data;

                    this.ui.renderList(this.state.chapters);

                    this.logic.load(1);

                } catch (e) { console.error("Engine failure during init", e); }

            },



            ui: {

                renderList(list) {

                    document.getElementById('surah-target').innerHTML = list.map(s => `

                        <div class="card" id="s-${s.number}" onclick="App.logic.load(${s.number})">

                            <div style="font-size:0.65rem; opacity:0.4;">ID: ${s.number}</div>

                            <b>${s.englishName}</b>

                        </div>

                    `).join('');

                    lucide.createIcons();

                },

                toggle(id) {

                    const drawers = ['settings', 'account'];

                    drawers.forEach(d => {

                        if(d !== id) document.getElementById(`${d}-drawer`).classList.remove('open');

                    });

                    document.getElementById(`${id}-drawer`).classList.toggle('open');

                },

                refreshTajweed() {

                    App.state.tajweed = document.getElementById('pref-tajweed').checked;

                    document.getElementById('reader-target').classList.toggle('tajweed-active', App.state.tajweed);

                },

                setTheme(val) {

                    document.body.classList.remove('theme-velvet', 'theme-ocean');

                    if(val !== 'emerald') document.body.classList.add(`theme-${val}`);

                }

            },



            logic: {

                async load(id) {

                    if (App.state.loading) return; 

                    App.state.loading = true;

                    

                    const viewport = document.getElementById('viewport');

                    viewport.classList.add('loading');

                    

                    document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));

                    document.getElementById(`s-${id}`)?.classList.add('active');



                    try {

                        const [ar, en] = await Promise.all([

                            fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-tajweed`).then(r => r.json()),

                            fetch(`https://api.alquran.cloud/v1/surah/${id}/en.sahih`).then(r => r.json())

                        ]);



                        const bismillah = "بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ";

                        let html = `<h1 style="text-align:center; font-family:Amiri; font-size:3.5rem; color:var(--emerald); margin-bottom:40px;">${ar.data.name}</h1>`;

                        

                        html += ar.data.ayahs.map((v, i) => {

                            let text = v.text;

                            

                            // 1. CLEAN BISMILLAH: Only if it's not Fatiha or Tauba, and it's verse 1

                            if(id !== 1 && id !== 9 && i === 0) {

                                text = text.replace(bismillah, "").trim();

                            }



                            // 2. ROBUST TAJWEED PARSER: Strips all bracket letters and converts to colored spans

                            text = text.replace(/\[h:([^\]]+)\]/g, '<span class="taj-ghunnah">$1</span>')

                                       .replace(/\[q:([^\]]+)\]/g, '<span class="taj-qalqalah">$1</span>')

                                       .replace(/\[m:([^\]]+)\]/g, '<span class="taj-madd">$1</span>')

                                       .replace(/\[n:([^\]]+)\]/g, '<span class="taj-ghunnah">$1</span>')

                                       .replace(/\[p:([^\]]+)\]/g, '<span>$1</span>')

                                       .replace(/\[l:([^\]]+)\]/g, '<span>$1</span>')

                                       .replace(/\[i:([^\]]+)\]/g, '<span class="taj-ikfa">$1</span>');



                            return `

                                <div class="ayah-block">

                                    <div class="q-text">${text}</div>

                                    <div style="opacity:0.7; font-size:1.05rem; margin-top:20px; font-weight:300; line-height:1.6;">${en.data.ayahs[i].text}</div>

                                    <div style="margin-top:25px; display:flex; justify-content:space-between; align-items:center; color:var(--emerald); font-size:0.75rem; font-weight:600;">

                                        <span>SIGN ${id}:${v.numberInSurah}</span>

                                        <div style="display:flex; gap:20px;">

                                            <i data-lucide="play" onclick="App.audio.playAyah(${v.number})" style="cursor:pointer; width:18px;"></i>

                                            <i data-lucide="brain" onclick="App.ai.derive('${id}:${v.numberInSurah}')" style="cursor:pointer; width:18px;"></i>

                                        </div>

                                    </div>

                                </div>`;

                        }).join('');



                        document.getElementById('reader-target').innerHTML = html;

                        viewport.scrollTop = 0;

                        document.getElementById('np-surah').innerHTML = `<b>${ar.data.englishName}</b>`;

                        

                        // Final UI sync

                        setTimeout(() => {

                            lucide.createIcons();

                            viewport.classList.remove('loading');

                            App.state.loading = false;

                        }, 100);



                    } catch (e) {

                        console.error("Load Error", e);

                        App.state.loading = false;

                        viewport.classList.remove('loading');

                    }

                }

            },



            ai: {

                derive(ref) {

                    const out = document.getElementById('ai-output');

                    out.innerHTML = `<div style="color:var(--emerald)">Computing Insight...</div>`;

                    setTimeout(() => {

                        out.innerHTML = `<b>Core Insight (${ref}):</b><br><br>The linguistic structure of this verse highlights a deliberate shift in tone, intended to refocus the listener on the attributes of Mercy. Scholar consensus suggests this phrasing was pivotal in early community guidance.`;

                    }, 600);

                }

            },



            audio: {

                toggle() {

                    const a = document.getElementById('core-audio');

                    const icon = document.getElementById('play-icon');

                    if(a.paused) { a.play(); icon.setAttribute('data-lucide', 'pause'); }

                    else { a.pause(); icon.setAttribute('data-lucide', 'play'); }

                    lucide.createIcons();

                },

                playAyah(n) {

                    const a = document.getElementById('core-audio');

                    a.src = `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${n}.mp3`;

                    a.play();

                    document.getElementById('play-icon').setAttribute('data-lucide', 'pause');

                    lucide.createIcons();

                }

            }

        };



        window.onload = () => App.init();

    </script>

</body>

</html>
