<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Quran App</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600&family=Amiri+Quran&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet" />
    
    <style>
        :root {
            /* DEFAULT: EMERALD GLASS */
            --bg: #010a08; --glass: rgba(5, 30, 25, 0.7); --primary: #10b981; --text: #ecfdf5; 
            --border: rgba(16, 185, 129, 0.3); --glow: rgba(16, 185, 129, 0.1); --font-ar: 'Amiri Quran', serif; 
            --ar-size: 3rem; --gold: #fbbf24; --transition: all 0.7s cubic-bezier(0.15, 1, 0.3, 1);
        }

        /* ATMOSPHERE THEMES */
        body.t-midnight { --bg: #02040a; --glass: rgba(15, 23, 42, 0.7); --primary: #38bdf8; --text: #f1f5f9; --border: rgba(56, 189, 248, 0.3); --glow: rgba(56, 189, 248, 0.1); }
        body.t-rose { --bg: #0a0204; --glass: rgba(30, 5, 15, 0.7); --primary: #fb7185; --text: #fff1f2; --border: rgba(251, 113, 133, 0.3); --glow: rgba(251, 113, 133, 0.1); }
        body.t-amethyst { --bg: #06020a; --glass: rgba(20, 5, 30, 0.7); --primary: #a78bfa; --text: #f5f3ff; --border: rgba(167, 139, 250, 0.3); --glow: rgba(167, 139, 250, 0.1); }
        body.t-gold { --bg: #050505; --glass: rgba(25, 25, 25, 0.8); --primary: #d4af37; --text: #ffffff; --border: rgba(212, 175, 55, 0.3); --glow: rgba(212, 175, 55, 0.1); }
        body.t-sea { --bg: #01080a; --glass: rgba(5, 20, 25, 0.7); --primary: #2dd4bf; --text: #f0fdfa; --border: rgba(45, 212, 191, 0.3); --glow: rgba(45, 212, 191, 0.1); }

        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; display: flex; height: 100vh; transition: var(--transition); }
        
        /* 3D NAV RAIL */
        .nav-rail { 
            width: 90px; border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; 
            padding: 35px 0; gap: 30px; background: rgba(255,255,255,0.03); backdrop-filter: blur(40px); z-index: 1000;
            box-shadow: 20px 0 50px rgba(0,0,0,0.3);
        }
        
        #main-stage { flex: 1; display: flex; overflow: hidden; position: relative; perspective: 1000px; }
        
        main { flex: 1; overflow-y: auto; scroll-behavior: smooth; transition: var(--transition); padding: 0 6%; transform-style: preserve-3d; }
        
        body.settings-open main { transform: translateX(-50px) rotateY(5deg) scale(0.92); opacity: 0.3; pointer-events: none; }

        /* 3D GLASS CARDS */
        .btn-ui { 
            background: var(--glass); border: 1px solid var(--border); color: var(--text); 
            cursor: pointer; padding: 16px; border-radius: 24px; transition: var(--transition);
            box-shadow: 0 15px 35px rgba(0,0,0,0.4), inset 0 2px 2px rgba(255,255,255,0.1); 
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(45px);
        }
        .btn-ui:hover { 
            transform: translateY(-8px) translateZ(20px); 
            box-shadow: 0 25px 50px rgba(0,0,0,0.6), 0 0 20px var(--glow); 
            border-color: var(--primary); color: var(--primary); 
        }

        /* PLAYER: FLOAT & GLOW */
        .player-dock { 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(0); 
            width: 85%; max-width: 950px; background: var(--glass); border: 1px solid var(--border); 
            border-radius: 45px; padding: 25px 45px; display: flex; align-items: center; justify-content: space-between; 
            z-index: 2000; backdrop-filter: blur(50px); 
            box-shadow: 0 40px 80px rgba(0,0,0,0.8), inset 0 1px 2px rgba(255,255,255,0.15);
            transition: transform 0.8s cubic-bezier(0.15, 1, 0.3, 1), opacity 0.5s ease;
        }
        .player-dock.hidden-scroll { transform: translateX(-50%) translateY(200%); opacity: 0; }
        body:not(.surah-active) .player-dock { display: none; }

        /* TYPOGRAPHY & FX */
        .arabic { font-family: var(--font-ar); font-size: var(--ar-size); direction: rtl; line-height: 2.5; text-align: right; text-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .ayah-row { padding: 70px 0; border-bottom: 1px solid var(--border); transition: var(--transition); transform-origin: center left; }
        .ayah-row.active { opacity: 1; transform: scale(1.03) translateZ(30px); background: linear-gradient(90deg, var(--glow), transparent); border-left: 4px solid var(--primary); padding-left: 30px; }
        .ayah-row:not(.active) { opacity: 0.3; filter: blur(1px); }

        .drawer { position: fixed; right: -100%; top: 0; width: 450px; height: 100%; background: var(--bg); border-left: 1px solid var(--border); z-index: 3000; transition: var(--transition); padding: 50px; overflow-y: auto; visibility: hidden; }
        .drawer.open { right: 0; visibility: visible; }
    </style>
</head>
<body class="t-midnight">

    <nav class="nav-rail">
        <div style="width:50px; height:50px; border-radius:15px; background:var(--primary); box-shadow:0 10px 20px var(--glow); margin-bottom:20px; display:flex; align-items:center; justify-content:center; color:var(--bg); font-weight:900;">A</div>
        <button class="btn-ui" onclick="Sanctuary.renderHome()"><i data-lucide="home"></i></button>
        <button class="btn-ui" onclick="Sanctuary.renderLibrary()"><i data-lucide="compass"></i></button>
        <button class="btn-ui" id="hifz-btn" onclick="Sanctuary.toggleHifz()"><i data-lucide="shield-off"></i></button>
        <div style="flex:1"></div>
        <button class="btn-ui" onclick="Sanctuary.toggleSettings()"><i data-lucide="layers"></i></button>
    </nav>

    <div id="main-stage">
        <main id="scroller">
            <div id="app-view"></div>
        </main>

        <div id="settings-panel" class="drawer">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:50px">
                <h1 style="margin:0; letter-spacing:-2px">Atmospheres</h1>
                <button onclick="Sanctuary.toggleSettings()" class="btn-ui"><i data-lucide="x"></i></button>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr; gap:15px">
                <button class="btn-ui" style="justify-content:start" onclick="document.body.className='t-midnight'"><div style="width:12px; height:12px; background:#38bdf8; border-radius:50%; margin-right:15px"></div> Midnight Blue</button>
                <button class="btn-ui" style="justify-content:start" onclick="document.body.className=''"><div style="width:12px; height:12px; background:#10b981; border-radius:50%; margin-right:15px"></div> Emerald Sanctuary</button>
                <button class="btn-ui" style="justify-content:start" onclick="document.body.className='t-rose'"><div style="width:12px; height:12px; background:#fb7185; border-radius:50%; margin-right:15px"></div> Rose Quartz</button>
                <button class="btn-ui" style="justify-content:start" onclick="document.body.className='t-amethyst'"><div style="width:12px; height:12px; background:#a78bfa; border-radius:50%; margin-right:15px"></div> Royal Amethyst</button>
                <button class="btn-ui" style="justify-content:start" onclick="document.body.className='t-gold'"><div style="width:12px; height:12px; background:#d4af37; border-radius:50%; margin-right:15px"></div> Onyx Gold</button>
                <button class="btn-ui" style="justify-content:start" onclick="document.body.className='t-sea'"><div style="width:12px; height:12px; background:#2dd4bf; border-radius:50%; margin-right:15px"></div> Deep Sea</button>
            </div>
        </div>
    </div>

    <div class="player-dock" id="player">
        <div style="flex:1">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <span id="p-surah" style="font-weight:600; font-size:1.2rem; letter-spacing:-1px">Surah</span>
                <span id="p-ayah" style="font-size:0.8rem; opacity:0.5; font-weight:bold">Ayah 0</span>
            </div>
            <div style="width:100%; height:8px; background:rgba(255,255,255,0.05); border-radius:10px; margin-top:15px; overflow:hidden">
                <div id="audio-progress-fill" style="height:100%; background:var(--primary); width:0%; box-shadow: 0 0 15px var(--primary)"></div>
            </div>
        </div>
        <div style="display:flex; align-items:center; gap:25px; margin:0 40px">
            <button class="btn-ui" style="background:none; border:none; box-shadow:none" onclick="Sanctuary.stepVerse(-1)"><i data-lucide="chevron-left"></i></button>
            <button onclick="Sanctuary.toggleAudio()" style="width:75px; height:75px; border-radius:50%; background:var(--primary); border:none; color:var(--bg); cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow: 0 20px 40px var(--glow)">
                <i data-lucide="play" id="play-icon" fill="currentColor"></i>
                <i data-lucide="pause" id="pause-icon" fill="currentColor" style="display:none"></i>
            </button>
            <button class="btn-ui" style="background:none; border:none; box-shadow:none" onclick="Sanctuary.stepVerse(1)"><i data-lucide="chevron-right"></i></button>
        </div>
    </nav>

    <audio id="core-audio"></audio>

    <script>
        const Sanctuary = (() => {
            const state = { surahs: [], arData: null, curIdx: -1, reciter: 'ar.alafasy', loop: false };
            let audio, lastScrollTop = 0;

            const init = async () => {
                audio = document.getElementById('core-audio');
                audio.onended = () => state.loop ? audio.play() : stepVerse(1);
                audio.ontimeupdate = () => {
                    document.getElementById('audio-progress-fill').style.width = (audio.currentTime / audio.duration * 100) + '%';
                };
                
                const scroller = document.getElementById('scroller');
                const player = document.getElementById('player');
                scroller.addEventListener('scroll', () => {
                    let st = scroller.scrollTop;
                    if (st > lastScrollTop && st > 200) player.classList.add('hidden-scroll');
                    else player.classList.remove('hidden-scroll');
                    lastScrollTop = st;
                });

                const res = await fetch('https://api.alquran.cloud/v1/surah');
                const d = await res.json();
                state.surahs = d.data;
                renderHome();
                lucide.createIcons();
            };

            const renderHome = () => {
                document.body.classList.remove('surah-active');
                const last = JSON.parse(localStorage.getItem('last_read'));
                document.getElementById('app-view').innerHTML = `
                    <div style="padding: 120px 0">
                        <h1 style="font-size:5rem; margin:0; letter-spacing:-4px">Sanctuary</h1>
                        <p style="opacity:0.4; font-size:1.3rem; margin-bottom:80px">Experience the Divine through Aura.</p>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:40px">
                            <div class="btn-ui" onclick="Sanctuary.resume()" style="padding:60px; border-color:var(--primary); align-items:start; flex-direction:column">
                                <h2 style="margin:10px 0; font-size:2.2rem">${last ? last.name : 'Al-Fatiha'}</h2>
                                <p style="opacity:0.5; margin:0">Continue from Verse ${last ? last.idx + 1 : '1'}</p>
                            </div>
                            <div class="btn-ui" onclick="Sanctuary.renderLibrary()" style="padding:60px; align-items:start; flex-direction:column">
                                <h2 style="margin:10px 0; font-size:2.2rem">Library</h2>
                                <p style="opacity:0.5; margin:0">Explore all 114 Surahs</p>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
            };

            const renderLibrary = () => {
                document.body.classList.remove('surah-active');
                document.getElementById('app-view').innerHTML = `
                    <div style="position:sticky; top:0; background:var(--bg); z-index:100; padding:50px 0 20px; border-bottom:1px solid var(--border)">
                        <h1 style="letter-spacing:-3px">The Library</h1>
                        <input type="text" class="btn-ui" placeholder="Quick find..." oninput="Sanctuary.filter(this.value)" style="width:100%; text-align:left; padding:20px 30px; font-size:1.1rem; border-radius:18px">
                    </div>
                    <div id="lib-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:30px; padding:40px 0 150px">
                        ${state.surahs.map(s => `
                            <div class="btn-ui surah-card" data-name="${s.englishName}" onclick="Sanctuary.loadSurah(${s.number})" style="display:block; text-align:left; padding:40px">
                                <div style="display:flex; justify-content:space-between; align-items:center">
                                    <div>
                                        <div style="font-size:0.7rem; color:var(--primary); font-weight:900; margin-bottom:10px">SURAH ${s.number}</div>
                                        <strong style="font-size:1.5rem">${s.englishName}</strong>
                                    </div>
                                    <div style="font-family:var(--font-ar); font-size:2rem; opacity:0.8">${s.name}</div>
                                </div>
                            </div>`).join('')}
                    </div>
                `;
                lucide.createIcons();
            };

            const loadSurah = async (id) => {
                document.body.classList.add('surah-active');
                const view = document.getElementById('app-view');
                view.innerHTML = `<div style="padding:200px 0; text-align:center; opacity:0.3; font-size:2rem">Manifesting Aura...</div>`;
                const [ar, en] = await Promise.all([
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-uthmani`).then(r => r.json()),
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/en.sahih`).then(r => r.json())
                ]);
                state.arData = ar.data;
                document.getElementById('p-surah').innerText = ar.data.englishName;
                let html = `<div style="padding:150px 0"><h2 style="text-align:center; font-family:var(--font-ar); font-size:6rem; margin-bottom:100px">${ar.data.name}</h2>`;
                ar.data.ayahs.forEach((v, i) => {
                    html += `<div class="ayah-row" id="v-${i}" onclick="Sanctuary.prepVerse(${v.number}, ${i})"><div class="arabic">${v.text}</div><div style="opacity:0.7; margin-top:30px; font-size:1.3rem; max-width:850px">${en.data.ayahs[i].text}</div></div>`;
                });
                view.innerHTML = html + `</div>`;
            };

            const prepVerse = (gid, idx) => {
                state.curIdx = idx;
                audio.src = `https://cdn.islamic.network/quran/audio/128/${state.reciter}/${gid}.mp3`;
                audio.play();
                document.querySelectorAll('.ayah-row').forEach(r => r.classList.remove('active'));
                const el = document.getElementById(`v-${idx}`);
                el.classList.add('active');
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                document.getElementById('play-icon').style.display = 'none';
                document.getElementById('pause-icon').style.display = 'block';
                document.getElementById('p-ayah').innerText = `Ayah ${idx + 1}`;
                localStorage.setItem('last_read', JSON.stringify({id: state.arData.number, name: state.arData.englishName, idx: idx}));
            };

            const stepVerse = (d) => {
                const n = state.curIdx + d;
                if(state.arData?.ayahs[n]) prepVerse(state.arData.ayahs[n].number, n);
            };

            return {
                init, renderHome, renderLibrary, loadSurah, prepVerse, stepVerse,
                filter: (q) => {
                    const term = q.toLowerCase();
                    document.querySelectorAll('.surah-card').forEach(c => c.style.display = c.dataset.name.toLowerCase().includes(term) ? 'block' : 'none');
                },
                resume: () => {
                    const last = JSON.parse(localStorage.getItem('last_read'));
                    last ? loadSurah(last.id).then(() => setTimeout(() => prepVerse(state.arData.ayahs[last.idx].number, last.idx), 800)) : loadSurah(1);
                },
                toggleAudio: () => { audio.paused ? audio.play() : audio.pause(); document.getElementById('play-icon').style.display = audio.paused ? 'block' : 'none'; document.getElementById('pause-icon').style.display = audio.paused ? 'none' : 'block'; },
                toggleSettings: () => { document.getElementById('settings-panel').classList.toggle('open'); document.body.classList.toggle('settings-open'); },
                toggleHifz: () => document.body.classList.toggle('hifz-mode'),
                toggleLoop: () => { state.loop = !state.loop; document.getElementById('loop-btn').style.color = state.loop ? 'var(--gold)' : 'inherit'; }
            };
        })();
        document.addEventListener('DOMContentLoaded', Sanctuary.init);
    </script>
</body>
</html>
