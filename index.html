<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign | Elite Custom</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { 
            /* 20 Customization Variables */
            --p: #10b981; --bg: #020617; --surf: #0f172a; --text: #f8fafc; 
            --border: #1e293b; --ar-font: 'Amiri', serif; --ar-size: 2.6rem;
            --en-size: 1.1rem; --line-height: 2.3; --card-gap: 2.5rem;
            --blur-strength: 12px; --anim-speed: 0.4s; --nav-width: 80px;
            --radius: 16px; --accent-glow: rgba(16, 185, 129, 0.2);
            --header-h: 80px; --hover-lift: -5px; --trans-opacity: 0.95;
            --font-weight-ar: 400; --shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* ⚡ FIX: Preventing text selection on click */
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; user-select: none; }
        
        /* Glassmorphism Sidebar */
        nav { width: var(--nav-width); background: var(--surf); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 1.5rem 0; z-index: 100; }
        .nav-btn { width: 52px; height: 52px; border-radius: var(--radius); display: flex; align-items: center; justify-content: center; margin-bottom: 1.2rem; cursor: pointer; color: #64748b; transition: all var(--anim-speed) cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid transparent; }
        .nav-btn:hover { color: var(--p); background: var(--accent-glow); transform: translateX(5px); border-color: var(--p); }
        .nav-btn.active { background: var(--p); color: white; box-shadow: 0 0 20px var(--accent-glow); }

        /* Settings Slide-out */
        #settings-panel { position: fixed; right: -350px; top: 0; width: 350px; height: 100%; background: var(--surf); border-left: 1px solid var(--border); z-index: 200; padding: 2rem; transition: var(--anim-speed) ease; overflow-y: auto; }
        #settings-panel.open { right: 0; box-shadow: -20px 0 60px rgba(0,0,0,0.8); }
        .setting-group { margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
        label { display: block; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; opacity: 0.6; }
        input[type="range"] { width: 100%; accent-color: var(--p); }

        /* Smooth Main Content */
        main { flex: 1; overflow-y: auto; scroll-behavior: smooth; position: relative; }
        .header { position: sticky; top: 0; height: var(--header-h); background: rgba(2, 6, 23, var(--trans-opacity)); backdrop-filter: blur(15px); padding: 0 3rem; border-bottom: 1px solid var(--border); z-index: 50; display: flex; justify-content: space-between; align-items: center; }
        
        .search-box { background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 10px; padding: 10px 15px; color: white; width: 250px; transition: 0.3s; font-family: inherit; }
        .search-box:focus { width: 320px; border-color: var(--p); outline: none; background: rgba(255,255,255,0.1); }

        /* Premium Ayah Cards */
        .reader-container { max-width: 900px; margin: 0 auto; padding: 4rem 2rem; }
        .ayah-card { padding: var(--card-gap) 2rem; border-radius: var(--radius); margin-bottom: 1rem; transition: all 0.4s ease; border: 1px solid transparent; cursor: pointer; position: relative; overflow: hidden; }
        .ayah-card:hover { background: rgba(255,255,255,0.02); border-color: var(--border); transform: translateY(var(--hover-lift)); }
        .ayah-card.playing { background: var(--accent-glow); border-color: var(--p); transform: scale(1.02); }

        .ar { font-family: var(--ar-font); font-size: var(--ar-size); text-align: right; direction: rtl; line-height: var(--line-height); margin-bottom: 1.5rem; transition: filter 0.5s ease; user-select: text; }
        .en { font-size: var(--en-size); color: #94a3b8; line-height: 1.8; user-select: text; }
        
        body.hide-ar .ar { filter: blur(var(--blur-strength)); }
        body.hide-ar .ar:hover { filter: blur(0); }

        /* Floating Player Bar */
        .player-bar { position: fixed; bottom: 30px; left: calc(var(--nav-width) + 30px); right: 30px; background: var(--surf); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.2rem 2rem; display: flex; align-items: center; gap: 2rem; z-index: 1000; transform: translateY(200px); transition: 0.6s cubic-bezier(0.18, 0.89, 0.32, 1.28); box-shadow: var(--shadow); }
        .player-bar.active { transform: translateY(0); }
        
        .play-btn { background: var(--p); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .play-btn:hover { transform: scale(1.1); box-shadow: 0 0 20px var(--p); }

        #sentinel { height: 200px; }
    </style>
</head>
<body>

    <nav>
        <div class="nav-btn active" id="nav-book"><i data-lucide="book-open"></i></div>
        <div class="nav-btn" id="nav-hifz"><i data-lucide="eye-off"></i></div>
        <div class="nav-btn" id="nav-settings"><i data-lucide="sliders"></i></div>
        <div style="flex:1"></div>
        <div class="nav-btn" id="nav-clear"><i data-lucide="trash-2"></i></div>
    </nav>

    <div id="settings-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
            <h2 style="font-weight:800; color:var(--p)">Appearance</h2>
            <i data-lucide="x" id="close-settings" style="cursor:pointer"></i>
        </div>
        
        <div class="setting-group">
            <label>Arabic Font Size</label>
            <input type="range" data-var="--ar-size" min="1.5" max="5" step="0.1" value="2.6">
        </div>
        <div class="setting-group">
            <label>Line Spacing</label>
            <input type="range" data-var="--line-height" min="1.5" max="4" step="0.1" value="2.3">
        </div>
        <div class="setting-group">
            <label>Hifz Blur Strength</label>
            <input type="range" data-var="--blur-strength" min="0" max="30" value="12">
        </div>
        <div class="setting-group">
            <label>Card Spacing</label>
            <input type="range" data-var="--card-gap" min="1" max="5" step="0.5" value="2.5">
        </div>
        <div class="setting-group">
            <label>English Text Size</label>
            <input type="range" data-var="--en-size" min="0.8" max="2" step="0.1" value="1.1">
        </div>
    </div>

    <main id="scroll-root">
        <header class="header">
            <div>
                <h1 id="view-title" style="font-size: 1.5rem; font-weight:800; letter-spacing:-1px;">Sovereign</h1>
                <p id="view-meta" style="font-size: 0.75rem; opacity: 0.5; font-weight:600;"></p>
            </div>
            <input type="text" class="search-box" id="surah-search" placeholder="Type Surah number or name...">
        </header>
        <div class="reader-container" id="main-view"></div>
        <div id="sentinel"></div>
    </main>

    <div class="player-bar" id="audio-panel">
        <button class="play-btn" id="play-trigger"><i data-lucide="play"></i></button>
        <div style="flex:1">
            <div id="playing-title" style="font-weight:800; font-size:1rem; color:var(--p)"></div>
            <div style="font-size:0.75rem; opacity:0.5; font-weight:700; letter-spacing:1px;">RECITATION ENGINE ACTIVE</div>
        </div>
        <audio id="audio-node"></audio>
    </div>

    <script>
        const Sovereign = {
            state: { surahId: 1, verses: [], rendered: 0, chunk: 12, hifz: false, abort: null, obs: null },

            actions: {
                async changeSurah(id) {
                    if (Sovereign.state.abort) Sovereign.state.abort.abort();
                    if (Sovereign.state.obs) Sovereign.state.obs.disconnect();

                    Sovereign.state.abort = new AbortController();
                    Sovereign.state.obs = new IntersectionObserver(e => e.forEach(x => { if(x.isIntersecting) x.target.classList.add('visible') }), { threshold: 0.05 });

                    document.getElementById('main-view').innerHTML = '';
                    Sovereign.state.rendered = 0;
                    document.getElementById('scroll-root').scrollTop = 0;

                    try {
                        const [m, v] = await Promise.all([
                            fetch(`https://api.quran.com/api/v4/chapters/${id}`, { signal: Sovereign.state.abort.signal }),
                            fetch(`https://api.quran.com/api/v4/verses/by_chapter/${id}?language=en&translations=131`, { signal: Sovereign.state.abort.signal })
                        ]);
                        
                        const meta = (await m.json()).chapter;
                        Sovereign.state.verses = (await v.json()).verses;
                        Sovereign.state.surahId = id;

                        document.getElementById('view-title').innerText = meta.name_simple;
                        document.getElementById('view-meta').innerText = `${meta.revelation_place.toUpperCase()} • ${meta.verses_count} VERSES`;
                        
                        Sovereign.ui.renderChunk();
                        localStorage.setItem('sq_last', id);
                    } catch (e) { if (e.name !== 'AbortError') console.error(e); }
                },

                async play(key) {
                    const audio = document.getElementById('audio-node');
                    document.getElementById('audio-panel').classList.add('active');
                    document.getElementById('playing-title').innerText = `Verse ${key}`;
                    
                    document.querySelectorAll('.ayah-card').forEach(c => c.classList.remove('playing'));
                    const card = document.getElementById(`v-${key}`);
                    if (card) {
                        card.classList.add('playing');
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }

                    const r = await fetch(`https://api.quran.com/api/v4/recitations/7/by_ayah/${key}`);
                    const res = await r.json();
                    audio.src = `https://verses.quran.com/${res.audio_files[0].url}`;
                    audio.play();
                }
            },

            ui: {
                renderChunk() {
                    const target = document.getElementById('main-view');
                    const nextBatch = Sovereign.state.verses.slice(Sovereign.state.rendered, Sovereign.state.rendered + Sovereign.state.chunk);
                    
                    nextBatch.forEach(v => {
                        const card = document.createElement('div');
                        card.className = 'ayah-card';
                        card.id = `v-${v.verse_key}`;
                        card.innerHTML = `
                            <div class="ar">${v.text_uthmani}</div>
                            <div class="en">${v.translations[0].text.replace(/<\/?[^>]+(>|$)/g, "")}</div>
                        `;
                        // ⚡ FIX: Direct click listener to prevent selection bug
                        card.addEventListener('mousedown', (e) => {
                            // Only trigger play if they didn't click to highlight text
                            if (window.getSelection().toString().length === 0) {
                                Sovereign.actions.play(v.verse_key);
                            }
                        });
                        target.appendChild(card);
                        Sovereign.state.obs.observe(card);
                    });
                    Sovereign.state.rendered += nextBatch.length;
                }
            },

            boot() {
                lucide.createIcons();

                // ⚡ Event Bindings
                document.getElementById('surah-search').onkeydown = (e) => { 
                    if(e.key === 'Enter') {
                        const val = e.target.value;
                        if (!isNaN(val)) Sovereign.actions.changeSurah(val);
                        e.target.value = '';
                    }
                };

                document.getElementById('nav-hifz').onclick = () => {
                    Sovereign.state.hifz = !Sovereign.state.hifz;
                    document.body.classList.toggle('hide-ar');
                    document.getElementById('nav-hifz').classList.toggle('active');
                };

                document.getElementById('nav-settings').onclick = () => document.getElementById('settings-panel').classList.add('open');
                document.getElementById('close-settings').onclick = () => document.getElementById('settings-panel').classList.remove('open');

                // ⚡ Live Theme Customizer
                document.querySelectorAll('#settings-panel input').forEach(input => {
                    input.oninput = (e) => {
                        const unit = e.target.dataset.var.includes('size') || e.target.dataset.var.includes('gap') || e.target.dataset.var.includes('strength') ? (e.target.dataset.var.includes('strength') ? 'px' : 'rem') : '';
                        document.documentElement.style.setProperty(e.target.dataset.var, e.target.value + unit);
                    };
                });

                // Infinite Scroll
                const sentinel = new IntersectionObserver(e => {
                    if(e[0].isIntersecting && Sovereign.state.verses.length > Sovereign.state.rendered) Sovereign.ui.renderChunk();
                }, { rootMargin: '400px' });
                sentinel.observe(document.getElementById('sentinel'));

                Sovereign.actions.changeSurah(localStorage.getItem('sq_last') || 1);
            }
        };

        window.onload = () => Sovereign.boot();
    </script>
</body>
</html>
