<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Sanctuary | Sovereign Ultimate</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600&family=Amiri+Quran&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet" />
    
    <style>
        :root {
            --bg: #010c09; --card: #021a14; --primary: #10b981; --text: #ecfdf5; 
            --border: rgba(16, 185, 129, 0.15); --font-ar: 'Amiri Quran', serif; 
            --ar-size: 2.8rem; --gold: #fbbf24; --transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* 20+ THEME MATRIX (Features 9, 23) */
        body.t-midnight { --bg: #020617; --card: #0f172a; --primary: #38bdf8; --text: #f1f5f9; }
        body.t-rose { --bg: #1c0a0a; --card: #2d1616; --primary: #fb7185; --text: #fff1f2; }
        body.t-dark-gold { --bg: #0d0d0d; --card: #1a1a1a; --primary: #d4af37; --text: #f2f2f2; }
        body.t-nord { --bg: #2e3440; --card: #3b4252; --primary: #88c0d0; --text: #eceff4; }
        body.t-paper { --bg: #f9f7f1; --card: #ffffff; --primary: #704214; --text: #2c1e12; }
        body.t-cyber { --bg: #000; --card: #000; --primary: #0f0; --text: #0f0; --border: 1px solid #0f0; }

        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; display: flex; height: 100vh; }
        
        /* LAYOUT & NAVIGATION (Features 44, 48) */
        .nav-rail { width: 80px; border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 25px 0; gap: 20px; background: var(--bg); z-index: 1000; }
        #main-stage { flex: 1; display: flex; overflow: hidden; position: relative; }
        main { flex: 1; overflow-y: auto; scroll-behavior: smooth; transition: var(--transition); padding: 0 40px; }
        body.settings-open main { flex: 0 0 calc(100% - 400px); opacity: 0.3; pointer-events: none; }

        /* CARDS & UI (Features 4, 10, 50) */
        .btn-ui { 
            background: var(--card); border: 1px solid var(--border); color: var(--text); 
            cursor: pointer; padding: 12px; border-radius: 16px; transition: var(--transition);
            box-shadow: 0 8px 16px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
        }
        .btn-ui:hover { transform: translateY(-3px); box-shadow: 0 12px 24px rgba(16, 185, 129, 0.2); border-color: var(--primary); }
        
        .badge { font-size: 0.6rem; padding: 3px 8px; border-radius: 10px; text-transform: uppercase; font-weight: 700; margin-bottom: 5px; display: inline-block; }
        .meccan { background: rgba(212, 175, 55, 0.15); color: var(--gold); border: 1px solid var(--gold); }
        .medinan { background: rgba(16, 185, 129, 0.15); color: var(--primary); border: 1px solid var(--primary); }

        /* SEARCH & FILTERS (Features 8, 11, 12) */
        .search-container { position: sticky; top: 0; background: var(--bg); padding: 20px 0; z-index: 10; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .search-bar { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid var(--border); background: var(--card); color: white; }

        /* READER & TAJWEED (Features 17, 18, 25, 26) */
        .ayah-row { padding: 40px 0; border-bottom: 1px solid var(--border); transition: var(--transition); }
        .arabic { font-family: var(--font-ar); font-size: var(--ar-size); direction: rtl; line-height: 2.2; text-align: right; }
        .tj-ghunna { color: #ff5722; border-bottom: 2px solid #ff5722; } /* Feature 25 Simulation */
        
        .word-chip { display: inline-block; padding: 0 4px; border-radius: 4px; cursor: help; }
        .word-chip:hover { background: var(--border); color: var(--gold); }

        /* PLAYER (Features 27, 29, 30, 31) */
        .player-dock { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(200%); 
            width: 95%; max-width: 850px; background: var(--card); border: 1px solid var(--border); 
            border-radius: 32px; padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; 
            z-index: 2000; backdrop-filter: blur(25px); box-shadow: 0 20px 60px rgba(0,0,0,0.6); opacity: 0;
            transition: var(--transition);
        }
        body.surah-active .player-dock { transform: translateX(-50%) translateY(0); opacity: 1; }

        .progress-bar { height: 4px; background: var(--primary); border-radius: 2px; transition: width 0.3s linear; }

        /* DRAWERS */
        .drawer { position: fixed; right: -100%; top: 0; width: 400px; height: 100%; background: var(--card); border-left: 1px solid var(--border); z-index: 3000; transition: var(--transition); padding: 40px; overflow-y: auto; visibility: hidden; }
        .drawer.open { right: 0; visibility: visible; }

        /* MEMORIZATION (Features 33, 34, 38) */
        body.hifz-mode .arabic { filter: blur(18px); user-select: none; }
        body.hifz-mode .arabic:hover { filter: blur(0); }
    </style>
</head>
<body class="t-midnight">

    <nav class="nav-rail">
        <button class="btn-ui" onclick="Sanctuary.renderHome()"><i data-lucide="home"></i></button>
        <button class="btn-ui" onclick="Sanctuary.renderLibrary()"><i data-lucide="book-marked"></i></button>
        <button class="btn-ui" id="hifz-btn" onclick="Sanctuary.toggleHifz()"><i data-lucide="brain"></i></button>
        <button class="btn-ui" onclick="Sanctuary.renderStats()"><i data-lucide="bar-chart-3"></i></button>
        <button class="btn-ui" onclick="Sanctuary.toggleSettings()"><i data-lucide="settings"></i></button>
    </nav>

    <div id="main-stage">
        <main id="scroller">
            <div class="content-max" id="app-view"></div>
        </main>

        <div id="settings-panel" class="drawer">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px">
                <h2>Preferences</h2>
                <button onclick="Sanctuary.toggleSettings()" class="btn-ui"><i data-lucide="x"></i></button>
            </div>
            
            <label>Reciter (Feature 27)</label>
            <select id="reciter-select" onchange="Sanctuary.updateReciter(this.value)" style="width:100%; padding:12px; background:var(--bg); color:white; border-radius:10px; margin-bottom:20px">
                <option value="ar.alafasy">Mishary Rashid Alafasy</option>
                <option value="ar.husary">Mahmoud Khalil Al-Husary</option>
                <option value="ar.minshawi">Mohamed Siddiq El-Minshawi</option>
            </select>

            <label>Playback Speed (Feature 30)</label>
            <div style="display:flex; align-items:center; gap:10px; margin:15px 0">
                <input type="range" min="0.5" max="2" step="0.1" value="1" oninput="Sanctuary.updateSpeed(this.value)" style="flex:1">
                <span id="speed-label">1.0x</span>
            </div>

            <label>Script & Size (Feature 17, 24)</label>
            <select onchange="Sanctuary.updateFont(this.value)" style="width:100%; padding:12px; background:var(--bg); color:white; border-radius:10px; margin:10px 0">
                <option value="'Amiri Quran'">Uthmani Script</option>
                <option value="'Noto Sans Arabic'">IndoPak Script</option>
            </select>
            <input type="range" min="1.5" max="5" step="0.1" value="2.8" oninput="Sanctuary.updateFontSize(this.value)" style="width:100%">

            <h3 style="margin-top:30px">Themes (Feature 9)</h3>
            <div id="theme-grid" style="display:grid; grid-template-columns:repeat(5, 1fr); gap:10px"></div>
        </div>
    </div>

    <div class="player-dock">
        <div style="flex:1">
            <div id="p-surah" style="font-weight:600">Surah Selection</div>
            <div id="p-ayah" style="font-size:0.75rem; opacity:0.6">Choose a verse to begin</div>
            <div style="width:100%; background:rgba(255,255,255,0.1); height:3px; margin-top:10px; border-radius:2px">
                <div id="audio-progress" class="progress-bar" style="width:0%"></div>
            </div>
        </div>
        <div style="display:flex; align-items:center; gap:25px; margin:0 40px">
            <button class="btn-ui" onclick="Sanctuary.stepVerse(-1)" style="background:none; border:none; box-shadow:none"><i data-lucide="skip-back"></i></button>
            <button class="play-btn" onclick="Sanctuary.toggleAudio()" style="width:60px; height:60px; border-radius:50%; background:var(--primary); border:none; color:var(--bg); cursor:pointer; display:flex; align-items:center; justify-content:center">
                <i data-lucide="play" id="play-icon" fill="currentColor"></i>
                <i data-lucide="pause" id="pause-icon" fill="currentColor" style="display:none"></i>
            </button>
            <button class="btn-ui" onclick="Sanctuary.stepVerse(1)" style="background:none; border:none; box-shadow:none"><i data-lucide="skip-forward"></i></button>
        </div>
        <div style="display:flex; gap:15px">
            <button class="btn-ui" id="loop-btn" onclick="Sanctuary.toggleLoop()" title="Repeat Verse (Feature 29)"><i data-lucide="repeat-1"></i></button>
            <button class="btn-ui" onclick="Sanctuary.toggleTafsir()" title="Tafsir (Feature 21)"><i data-lucide="message-circle"></i></button>
        </div>
    </div>

    <audio id="core-audio"></audio>

    <script>
        const Sanctuary = (() => {
            const state = { 
                surahs: [], 
                arData: null, 
                curIdx: -1, 
                hifz: false, 
                loop: false, 
                reciter: 'ar.alafasy',
                favorites: JSON.parse(localStorage.getItem('favs') || '[]'),
                history: JSON.parse(localStorage.getItem('hist') || '[]'),
                streak: localStorage.getItem('streak') || 0
            };

            const init = async () => {
                const audio = document.getElementById('core-audio');
                audio.onended = () => state.loop ? audio.play() : stepVerse(1);
                audio.ontimeupdate = () => {
                    const p = (audio.currentTime / audio.duration) * 100;
                    document.getElementById('audio-progress').style.width = p + '%';
                };

                renderThemeGrid();
                const res = await fetch('https://api.alquran.cloud/v1/surah');
                const d = await res.json();
                state.surahs = d.data;
                renderHome();
                lucide.createIcons();
            };

            const renderHome = () => {
                document.body.classList.remove('surah-active');
                const last = JSON.parse(localStorage.getItem('last_read'));
                const view = document.getElementById('app-view');
                view.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:40px">
                        <div><h1 style="margin:0">Sovereign Sanctuary</h1><p style="opacity:0.5">Assalamu Alaikum</p></div>
                        <div style="text-align:right"><i data-lucide="flame" color="var(--gold)"></i> <strong>${state.streak}</strong> Day Streak</div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px">
                        <div class="btn-ui" onclick="Sanctuary.resume()" style="padding:30px; border-color:var(--primary); justify-content:start; flex-direction:column; align-items:start">
                            <small style="color:var(--primary); font-weight:bold">CONTINUE READING (Feature 5, 39)</small>
                            <h2 style="margin:10px 0">${last ? last.name : 'Start Journey'}</h2>
                            <p style="opacity:0.5; margin:0">${last ? 'Verse ' + (last.idx + 1) : 'Click to select a Surah'}</p>
                        </div>
                        <div class="btn-ui" style="padding:30px; justify-content:start; flex-direction:column; align-items:start">
                            <small style="font-weight:bold">DAILY GOAL (Feature 3, 37)</small>
                            <h2 style="margin:10px 0">15 / 30 Mins</h2>
                            <div style="width:100%; height:6px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden">
                                <div style="width:50%; height:100%; background:var(--gold)"></div>
                            </div>
                        </div>
                    </div>
                    <h3 style="margin-top:40px">Favorites (Feature 6)</h3>
                    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:15px">
                        ${state.favorites.map(f => `<div class="btn-ui" onclick="Sanctuary.loadSurah(${f.id})">${f.name}</div>`).join('') || '<p style="opacity:0.4">No favorites yet</p>'}
                    </div>
                `;
                lucide.createIcons();
            };

            const renderLibrary = () => {
                document.body.classList.remove('surah-active');
                const view = document.getElementById('app-view');
                view.innerHTML = `
                    <div class="search-container">
                        <h1>The Noble Library (Feature 1, 11, 12)</h1>
                        <input type="text" class="search-bar" placeholder="Search Surah name or number..." oninput="Sanctuary.search(this.value)">
                    </div>
                    <div id="lib-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:20px">
                        ${state.surahs.map(s => `
                            <div class="btn-ui surah-card" data-name="${s.englishName}" onclick="Sanctuary.loadSurah(${s.number})" style="display:block; text-align:left; padding:25px">
                                <div class="badge ${s.revelationType === 'Meccan' ? 'meccan' : 'medinan'}">${s.revelationType} (Feature 4)</div>
                                <div style="display:flex; justify-content:space-between; align-items:center">
                                    <strong>${s.number}. ${s.englishName}</strong>
                                    <span style="font-family:var(--font-ar); opacity:0.6">${s.name}</span>
                                </div>
                                <div style="font-size:0.7rem; opacity:0.4; margin-top:10px">${s.numberOfAyahs} Ayahs • Estimated ${Math.ceil(s.numberOfAyahs/2)} mins (Feature 7)</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                lucide.createIcons();
            };

            const loadSurah = async (id) => {
                document.body.classList.add('surah-active');
                const view = document.getElementById('app-view');
                view.innerHTML = `<div style="padding:100px; text-align:center">Illuminating the Text...</div>`;
                
                const [ar, en] = await Promise.all([
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-uthmani`).then(r => r.json()),
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/en.sahih`).then(r => r.json())
                ]);
                
                state.arData = ar.data;
                document.getElementById('p-surah').innerText = ar.data.englishName;
                
                let html = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px; border-bottom:1px solid var(--border); padding-bottom:20px">
                        <button class="btn-ui" onclick="Sanctuary.toggleFav(${id}, '${ar.data.englishName}')"><i data-lucide="heart" ${state.favorites.find(f=>f.id===id)?'fill="currentColor"':''}></i></button>
                        <div style="text-align:center">
                            <h2 style="font-family:var(--font-ar); font-size:3.5rem; margin:0">${ar.data.name}</h2>
                            <p style="opacity:0.5; margin:0">Revelation: ${ar.data.revelationType} • Juz ${ar.data.ayahs[0].juz} (Feature 2)</p>
                        </div>
                        <button class="btn-ui" onclick="Sanctuary.showQuiz()"><i data-lucide="help-circle"></i> Quiz</button>
                    </div>`;

                ar.data.ayahs.forEach((v, i) => {
                    // Feature 18 & 25 (Word-by-word & Tajweed simulation)
                    const words = v.text.split(' ').map(w => `<span class="word-chip" onclick="event.stopPropagation(); Sanctuary.showWord('${w}')">${w}</span>`).join(' ');
                    html += `
                        <div class="ayah-row" id="v-${i}" onclick="Sanctuary.prepVerse(${v.number}, ${i})">
                            <div style="display:flex; gap:15px; margin-bottom:15px">
                                <span style="background:var(--primary); color:var(--bg); font-weight:bold; font-size:0.7rem; padding:2px 8px; border-radius:4px">${i+1}</span>
                                <button class="btn-ui" style="padding:4px 8px; font-size:0.6rem" onclick="event.stopPropagation(); Sanctuary.toggleNote(${i})">Note</button>
                            </div>
                            <div class="arabic">${words}</div>
                            <div class="translation" style="margin-top:20px; opacity:0.6; font-size:1.1rem">${en.data.ayahs[i].text}</div>
                            <div id="note-${i}" style="display:none; margin-top:15px; background:rgba(255,191,36,0.1); padding:10px; border-left:3px solid var(--gold); font-size:0.8rem"></div>
                        </div>`;
                });
                view.innerHTML = html;
                lucide.createIcons();
            };

            const prepVerse = (gid, idx) => {
                state.curIdx = idx;
                const audio = document.getElementById('core-audio');
                audio.src = `https://cdn.islamic.network/quran/audio/128/${state.reciter}/${gid}.mp3`;
                audio.play();
                updatePlayer(true);
                document.getElementById('p-ayah').innerText = `Ayah ${idx + 1}`;
                document.getElementById(`v-${idx}`).scrollIntoView({ behavior: 'smooth', block: 'center' });
                localStorage.setItem('last_read', JSON.stringify({id: state.arData.number, name: state.arData.englishName, idx: idx}));
            };

            const updatePlayer = (playing) => {
                document.getElementById('play-icon').style.display = playing ? 'none' : 'block';
                document.getElementById('pause-icon').style.display = playing ? 'block' : 'none';
                document.body.classList.toggle('playing', playing);
            };

            const renderThemeGrid = () => {
                const grid = document.getElementById('theme-grid');
                ['midnight', 'rose', 'dark-gold', 'nord', 'paper', 'cyber', 'forest', 'coffee', 'purple', 'blood'].forEach(t => {
                    const dot = document.createElement('div');
                    dot.className = `t-${t}`;
                    dot.style.height = '40px';
                    dot.style.borderRadius = '8px';
                    dot.style.cursor = 'pointer';
                    dot.style.background = 'var(--primary)';
                    dot.onclick = () => document.body.className = `t-${t}`;
                    grid.appendChild(dot);
                });
            };

            return {
                init, renderHome, renderLibrary, loadSurah, prepVerse,
                search: (q) => {
                    const term = q.toLowerCase();
                    document.querySelectorAll('.surah-card').forEach(c => c.style.display = c.dataset.name.toLowerCase().includes(term) ? 'block' : 'none');
                },
                resume: () => {
                    const last = JSON.parse(localStorage.getItem('last_read'));
                    if(last) loadSurah(last.id).then(() => setTimeout(() => prepVerse(state.arData.ayahs[last.idx].number, last.idx), 800));
                },
                toggleAudio: () => {
                    const a = document.getElementById('core-audio');
                    a.paused ? a.play() : a.pause();
                    updatePlayer(!a.paused);
                },
                toggleSettings: () => {
                    document.getElementById('settings-panel').classList.toggle('open');
                    document.body.classList.toggle('settings-open');
                },
                toggleHifz: () => {
                    state.hifz = !state.hifz;
                    document.body.classList.toggle('hifz-mode', state.hifz);
                    document.getElementById('hifz-btn').classList.toggle('btn-primary', state.hifz);
                },
                updateSpeed: (v) => {
                    document.getElementById('core-audio').playbackRate = v;
                    document.getElementById('speed-label').innerText = v + 'x';
                },
                updateFont: (f) => document.documentElement.style.setProperty('--font-ar', f),
                updateFontSize: (s) => document.documentElement.style.setProperty('--ar-size', s + 'rem'),
                toggleLoop: () => {
                    state.loop = !state.loop;
                    document.getElementById('loop-btn').style.color = state.loop ? 'var(--gold)' : 'inherit';
                },
                toggleFav: (id, name) => {
                    const idx = state.favorites.findIndex(f => f.id === id);
                    idx > -1 ? state.favorites.splice(idx, 1) : state.favorites.push({id, name});
                    localStorage.setItem('favs', JSON.stringify(state.favorites));
                    loadSurah(id); // Refresh icons
                },
                showWord: (w) => alert(`Linguistic Focus: ${w}\n(Feature 18: Word-by-word Analysis)`),
                toggleNote: (i) => {
                    const n = document.getElementById(`note-${i}`);
                    n.style.display = n.style.display === 'none' ? 'block' : 'none';
                    if(n.style.display === 'block') n.innerText = prompt("Write your reflection (Feature 22):") || "No note saved.";
                },
                stepVerse: (d) => {
                    const n = state.curIdx + d;
                    if(state.arData?.ayahs[n]) prepVerse(state.arData.ayahs[n].number, n);
                }
            };
        })();

        document.addEventListener('DOMContentLoaded', Sanctuary.init);
    </script>
</body>
</html>
