<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign | Custom Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { 
            --p: #10b981; --bg: #020617; --surf: #0f172a; --text: #f8fafc; --border: #1e293b; --ar: 'Amiri', serif;
            --ar-size: 2.6rem;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        nav { width: 75px; background: var(--surf); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 1.5rem 0; z-index: 100; }
        .nav-btn { width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.2rem; cursor: pointer; color: #64748b; transition: 0.3s; }
        .nav-btn.active { background: var(--p); color: white; }

        /* Customization Panel */
        #settings-panel { position: fixed; right: -300px; top: 0; width: 300px; height: 100%; background: var(--surf); border-left: 1px solid var(--border); z-index: 200; padding: 2rem; transition: 0.4s ease; }
        #settings-panel.open { right: 0; box-shadow: -20px 0 40px rgba(0,0,0,0.5); }

        /* Content Hub */
        main { flex: 1; overflow-y: auto; scroll-behavior: smooth; position: relative; }
        .header { position: sticky; top: 0; background: rgba(2, 6, 23, 0.9); backdrop-filter: blur(12px); padding: 1rem 2.5rem; border-bottom: 1px solid var(--border); z-index: 50; display: flex; justify-content: space-between; align-items: center; }
        
        .search-box { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; color: white; outline: none; width: 220px; transition: 0.3s; }
        .search-box:focus { border-color: var(--p); }

        .reader-container { max-width: 850px; margin: 0 auto; padding: 2rem; }
        .ayah-card { padding: 2.5rem 0; border-bottom: 1px solid var(--border); opacity: 0; transform: translateY(15px); transition: 0.5s; }
        .ayah-card.visible { opacity: 1; transform: translateY(0); }
        .ayah-card.playing { border-left: 4px solid var(--p); background: linear-gradient(to right, rgba(16, 185, 129, 0.05), transparent); padding-left: 20px; }
        
        .ar { font-family: var(--ar); font-size: var(--ar-size); text-align: right; direction: rtl; line-height: 2.3; margin-bottom: 1.2rem; }
        body.hide-ar .ar { filter: blur(12px); transition: 0.3s; }
        body.hide-ar .ar:hover { filter: blur(0); }

        .player-bar { position: fixed; bottom: 20px; left: 95px; right: 20px; background: var(--surf); border: 1px solid var(--border); border-radius: 16px; padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1.5rem; z-index: 1000; transform: translateY(150%); transition: 0.4s; }
        .player-bar.active { transform: translateY(0); }
        
        .btn-p { background: var(--p); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        #sentinel { height: 100px; width: 100%; }
    </style>
</head>
<body>

    <nav>
        <div class="nav-btn active" id="nav-book"><i data-lucide="book"></i></div>
        <div class="nav-btn" id="nav-hifz"><i data-lucide="eye"></i></div>
        <div class="nav-btn" id="nav-settings"><i data-lucide="settings"></i></div>
        <div style="flex:1"></div>
        <div class="nav-btn" id="nav-clear"><i data-lucide="trash-2"></i></div>
    </nav>

    <div id="settings-panel">
        <h2 style="margin-bottom: 1.5rem;">Settings</h2>
        <div style="margin-bottom: 2rem;">
            <label style="display:block; font-size:0.8rem; opacity:0.6; margin-bottom:0.5rem;">Arabic Font Size</label>
            <input type="range" id="font-slider" min="1.5" max="4" step="0.1" value="2.6" style="width:100%;">
        </div>
        <button class="btn-p" id="close-settings" style="width:100%;">Save & Close</button>
    </div>

    <main id="scroll-root">
        <header class="header">
            <div>
                <h1 id="view-title" style="font-size: 1.2rem;">Sovereign</h1>
                <p id="view-meta" style="font-size: 0.7rem; opacity: 0.5;"></p>
            </div>
            <input type="text" class="search-box" id="surah-search" placeholder="Surah name or number...">
        </header>
        <div class="reader-container" id="main-view"></div>
        <div id="sentinel"></div>
    </main>

    <div class="player-bar" id="audio-panel">
        <button class="btn-p" id="play-trigger" style="width:45px; height:45px; border-radius:50%; display:flex; align-items:center; justify-content:center; padding:0;">
            <i data-lucide="play"></i>
        </button>
        <div style="flex:1">
            <div id="playing-title" style="font-weight:700; font-size:0.9rem;"></div>
            <div style="font-size:0.7rem; opacity:0.5;">RECITATION ACTIVE</div>
        </div>
        <audio id="audio-node"></audio>
    </div>

    <script>
        const Sovereign = {
            store: {
                get: (k) => JSON.parse(localStorage.getItem(`sq_${k}`)),
                set: (k, v) => localStorage.setItem(`sq_${k}`, JSON.stringify(v)),
                clear: () => { localStorage.clear(); location.reload(); }
            },

            state: {
                surahId: 1,
                verses: [],
                rendered: 0,
                chunk: 15,
                hifz: false,
                obs: null,
                sentinel: null,
                abort: null
            },

            // SEARCH ENGINE: Supports Number (1) or Name (Baqarah)
            searchSurah(query) {
                const q = query.toLowerCase().trim();
                if (!q) return;
                
                // If it's a number, jump straight to it
                if (!isNaN(q)) {
                    this.actions.changeSurah(parseInt(q));
                    return;
                }

                // If it's text, we check our name map (Basic implementation)
                this.actions.notify(`Searching for "${q}"...`);
                // For a full product, you'd fetch the chapter list once and filter here.
            },

            actions: {
                async changeSurah(id) {
                    if (Sovereign.state.abort) Sovereign.state.abort.abort();
                    if (Sovereign.state.obs) Sovereign.state.obs.disconnect();

                    Sovereign.state.abort = new AbortController();
                    Sovereign.state.obs = new IntersectionObserver(e => e.forEach(x => { if(x.isIntersecting) x.target.classList.add('visible') }), { threshold: 0.1 });

                    document.getElementById('main-view').innerHTML = '';
                    Sovereign.state.rendered = 0;
                    document.getElementById('scroll-root').scrollTop = 0;

                    try {
                        const mRes = await fetch(`https://api.quran.com/api/v4/chapters/${id}`, { signal: Sovereign.state.abort.signal });
                        const vRes = await fetch(`https://api.quran.com/api/v4/verses/by_chapter/${id}?language=en&translations=131`, { signal: Sovereign.state.abort.signal });
                        
                        const meta = (await mRes.json()).chapter;
                        Sovereign.state.verses = (await vRes.json()).verses;
                        Sovereign.state.surahId = id;

                        document.getElementById('view-title').innerText = meta.name_simple;
                        document.getElementById('view-meta').innerText = `${meta.revelation_place.toUpperCase()} â€¢ ${meta.verses_count} VERSES`;
                        
                        Sovereign.ui.renderChunk();
                        Sovereign.store.set('last_surah', id);
                    } catch (e) { if (e.name !== 'AbortError') console.error(e); }
                },

                async play(key) {
                    const audio = document.getElementById('audio-node');
                    document.getElementById('audio-panel').classList.add('active');
                    document.getElementById('playing-title').innerText = `Ayah ${key}`;
                    
                    document.querySelectorAll('.ayah-card').forEach(c => c.classList.remove('playing'));
                    document.getElementById(`v-${key}`)?.classList.add('playing');

                    const r = await fetch(`https://api.quran.com/api/v4/recitations/7/by_ayah/${key}`);
                    const res = await r.json();
                    audio.src = `https://verses.quran.com/${res.audio_files[0].url}`;
                    audio.play();
                },

                toggleHifz() {
                    Sovereign.state.hifz = !Sovereign.state.hifz;
                    document.body.classList.toggle('hide-ar', Sovereign.state.hifz);
                    document.getElementById('nav-hifz').classList.toggle('active', Sovereign.state.hifz);
                    Sovereign.store.set('hifz', Sovereign.state.hifz);
                },

                notify(m) { console.log(`[Sovereign] ${m}`); }
            },

            ui: {
                renderChunk() {
                    const target = document.getElementById('main-view');
                    const nextBatch = Sovereign.state.verses.slice(Sovereign.state.rendered, Sovereign.state.rendered + Sovereign.state.chunk);
                    const frag = document.createDocumentFragment();

                    nextBatch.forEach(v => {
                        const card = document.createElement('div');
                        card.className = 'ayah-card';
                        card.id = `v-${v.verse_key}`;
                        card.dataset.key = v.verse_key;
                        card.innerHTML = `
                            <div class="ar">${v.text_uthmani}</div>
                            <div class="en">${v.translations[0].text.replace(/<\/?[^>]+(>|$)/g, "")}</div>
                            <button class="btn-recitate" data-key="${v.verse_key}" style="margin-top:1rem; border:none; background:none; color:var(--p); font-size:0.75rem; font-weight:800; cursor:pointer;">RECITATE</button>
                        `;
                        frag.appendChild(card);
                        Sovereign.state.obs.observe(card);
                    });
                    target.appendChild(frag);
                    Sovereign.state.rendered += nextBatch.length;
                }
            },

            boot() {
                lucide.createIcons();

                // 1. GLOBAL CLICK DELEGATION (Fixes "Unclickable" issue)
                document.addEventListener('click', (e) => {
                    const recitateBtn = e.target.closest('.btn-recitate');
                    if (recitateBtn) {
                        this.actions.play(recitateBtn.dataset.key);
                    }
                });

                // 2. SEARCH & SETTINGS
                document.getElementById('surah-search').onkeydown = (e) => { if(e.key === 'Enter') this.searchSurah(e.target.value); };
                
                document.getElementById('nav-settings').onclick = () => document.getElementById('settings-panel').classList.add('open');
                document.getElementById('close-settings').onclick = () => document.getElementById('settings-panel').classList.remove('open');
                
                document.getElementById('font-slider').oninput = (e) => {
                    document.documentElement.style.setProperty('--ar-size', `${e.target.value}rem`);
                };

                // 3. INFINITE SCROLL
                Sovereign.state.sentinel = new IntersectionObserver(e => {
                    if(e[0].isIntersecting && Sovereign.state.verses.length > Sovereign.state.rendered) Sovereign.ui.renderChunk();
                }, { root: document.getElementById('scroll-root'), rootMargin: '400px' });
                Sovereign.state.sentinel.observe(document.getElementById('sentinel'));

                // 4. STARTUP
                const last = Sovereign.store.get('last_surah') || 1;
                this.actions.changeSurah(last);
            }
        };

        window.onload = () => Sovereign.boot();
    </script>
</body>
</html>
