<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Singularity | v3.5 God-Module</title>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Plus+Jakarta+Sans:wght@300;800&family=Amiri:wght@400;700&family=Noto+Naskh+Arabic&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --p: #00f2ff; --p-dim: rgba(0, 242, 255, 0.1); --bg: #000; --surf: #0a0a0c; 
            --border: rgba(255,255,255,0.1); --fs-ar: 2.5rem; --f-ar: 'Amiri', serif; 
        }
        
        /* Themes */
        body.theme-bloodline { --p: #ff003c; --p-dim: rgba(255, 0, 60, 0.1); --bg: #050000; --surf: #0f0505; }
        body.theme-gold { --p: #ffcc00; --p-dim: rgba(255, 204, 0, 0.1); --bg: #080700; --surf: #121100; }
        body.theme-forest { --p: #00ff6a; --p-dim: rgba(0, 255, 106, 0.1); --bg: #000803; --surf: #001207; }

        body { background: var(--bg); color: #fff; margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; transition: 0.3s; }
        
        /* Layout */
        #scroll-progress { position: fixed; top: 0; left: 0; height: 3px; background: var(--p); width: 0%; z-index: 9999; box-shadow: 0 0 10px var(--p); }
        nav { width: 70px; border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 20px 0; gap: 20px; background: #050505; z-index: 100; }
        #view-port { flex: 1; overflow-y: auto; padding: 40px; scroll-behavior: smooth; }

        /* UI Components */
        .nav-btn { background: none; border: none; color: #64748b; cursor: pointer; padding: 12px; border-radius: 15px; transition: 0.3s; }
        .nav-btn:hover, .nav-btn.active { color: var(--p); background: var(--p-dim); }
        
        .ayah-card { padding: 40px; border: 1px solid var(--border); border-radius: 24px; background: var(--surf); margin-bottom: 30px; transition: 0.4s; position: relative; }
        .ayah-card:hover { border-color: var(--p); box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .ayah-card.memorized { border-left: 5px solid var(--p); }

        .ar { font-family: var(--f-ar); font-size: var(--fs-ar); text-align: right; direction: rtl; line-height: 2.2; margin-bottom: 20px; }
        .en-container { display: grid; grid-template-columns: 1fr; gap: 15px; border-top: 1px solid var(--border); padding-top: 20px; }
        .en-ver { color: #94a3b8; font-size: 1rem; line-height: 1.6; }
        .en-ver b { color: var(--p); font-family: 'Fira Code'; font-size: 0.7rem; margin-right: 8px; }

        /* HUDs */
        #audio-hud { position: fixed; bottom: 30px; right: 30px; background: var(--surf); border: 1px solid var(--p); padding: 20px; border-radius: 20px; display: none; align-items: center; gap: 20px; z-index: 200; box-shadow: 0 10px 50px rgba(0,0,0,0.8); }
        #cli-layer { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 10000; display: none; flex-direction: column; padding: 100px; font-family: 'Fira Code'; }
        #cli-input { background: none; border: none; color: var(--p); font-size: 3rem; outline: none; border-bottom: 2px solid var(--p); width: 100%; }

        /* Goal Tracker */
        #goal-ring { width: 40px; height: 40px; border-radius: 50%; border: 3px solid var(--border); border-top-color: var(--p); display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: var(--p); }

        .tag { font-size: 0.6rem; font-family: 'Fira Code'; background: var(--p-dim); color: var(--p); padding: 4px 8px; border-radius: 4px; }
        
        /* Scrollbar */
        #view-port::-webkit-scrollbar { width: 6px; }
        #view-port::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    </style>
</head>
<body>

    <div id="scroll-progress"></div>
    <div id="cli-layer">
        <div style="color:var(--p); margin-bottom: 20px;">[ COMMAND_INTERFACE_ACTIVE ] GOTO [S:A] | THEME [N] | FONT [S]</div>
        <input type="text" id="cli-input" spellcheck="false" autocomplete="off">
    </div>

    <div id="audio-hud">
        <div id="audio-meta">
            <div id="reciter-name" style="color:var(--p); font-size:0.7rem; font-family:'Fira Code';">AL-AFASY</div>
            <div id="ayah-coord" style="font-size:0.9rem; font-weight:800;">18:10</div>
        </div>
        <audio id="global-audio" onended="App.audio.next()"></audio>
        <div style="display:flex; gap:10px;">
            <button onclick="App.audio.toggle()" class="nav-btn"><i data-lucide="play-circle"></i></button>
            <input type="range" min="0.5" max="2" step="0.1" value="1" oninput="App.audio.setSpeed(this.value)" title="Speed">
        </div>
    </div>

    <main style="display:flex; height:100vh;">
        <nav>
            <button onclick="App.renderHome()" class="nav-btn" title="Home"><i data-lucide="layout-grid"></i></button>
            <button onclick="App.ui.toggleTafsir()" class="nav-btn" title="Tafsir Mode"><i data-lucide="book-open"></i></button>
            <button onclick="App.themes.cycle()" class="nav-btn" title="Theming"><i data-lucide="palette"></i></button>
            <button onclick="App.audio.showHUD()" class="nav-btn" title="Audio HUD"><i data-lucide="headphones"></i></button>
            <button onclick="App.user.export()" class="nav-btn" title="Export Data"><i data-lucide="download-cloud"></i></button>
            <div id="goal-ring" title="Daily Goal Progress">0%</div>
            <button onclick="App.sys.toggleWakeLock()" id="wake-btn" class="nav-btn" style="margin-top:auto"><i data-lucide="sun"></i></button>
        </nav>

        <section style="flex:1; display:flex; flex-direction:column;">
            <header style="height:75px; border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 30px; justify-content:space-between; background: rgba(3,3,3,0.8); backdrop-filter:blur(10px);">
                <div style="display:flex; align-items:center; gap:25px;">
                    <div id="zen-timer" style="font-family:'Fira Code'; color:var(--p); font-size:0.8rem;">[ 00:00:00 ]</div>
                    <input type="text" id="master-search" placeholder="Search Surah, Root, or Meaning..." 
                           style="background:var(--surf); border:1px solid var(--border); color:#fff; padding:10px 20px; border-radius:12px; width:350px; outline:none; transition:0.3s;"
                           oninput="App.ui.masterSearch(this.value)">
                </div>
                
                <div style="display:flex; gap:15px; align-items:center;">
                    <span class="tag">v3.5_GOD_MODULE</span>
                    <button class="nav-btn" onclick="App.cli.toggle()"><i data-lucide="terminal" style="width:18px"></i></button>
                </div>
            </header>

            <div id="view-port" onscroll="App.ui.handleScroll()"></div>
        </section>
    </main>

    <script>
        const db = new Dexie("GodModuleDB");
        db.version(1).stores({ surahs: 'id', userdata: 'id', meta: 'key' });

        const App = {
            state: {
                theme: localStorage.getItem('gm-theme') || 'singularity',
                reciter: 'ar.alafasy',
                fontSize: 2.5,
                showTafsir: false,
                chapters: [],
                currentSurah: null,
                dailyGoal: 10,
                readCount: 0
            },

            async init() {
                this.themes.apply(this.state.theme);
                this.router.init();
                this.zen.start();
                this.cli.init();
                lucide.createIcons();
                this.user.loadGoal();
            },

            router: {
                init() { window.onpopstate = () => this.handleURL(); this.handleURL(); },
                handleURL() {
                    const p = new URLSearchParams(window.location.search);
                    if(p.has('s')) App.loadSurah(p.get('s')); else App.renderHome();
                },
                push(s) { history.pushState({}, '', s ? `?s=${s}` : window.location.pathname); }
            },

            async renderHome() {
                const vp = document.getElementById('view-port');
                vp.innerHTML = `<div style="color:var(--p); font-family:'Fira Code';">SCANNING_COSMOS...</div>`;
                
                let chapters;
                const cached = await db.meta.get('chapters');
                if(cached) chapters = cached.data;
                else {
                    const res = await fetch('https://api.alquran.cloud/v1/surah');
                    const json = await res.json();
                    chapters = json.data;
                    await db.meta.put({key: 'chapters', data: chapters});
                }
                this.state.chapters = chapters;
                this.ui.drawDirectory(chapters);
            },

            async loadSurah(id) {
                this.state.currentSurah = id;
                const vp = document.getElementById('view-port');
                vp.innerHTML = `<div style="color:var(--p); font-family:'Fira Code';">PULLING_NODE_${id}...</div>`;
                
                const [ar, en1, en2] = await Promise.all([
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-uthmani`).then(r => r.json()),
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/en.sahih`).then(r => r.json()),
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/en.yusufali`).then(r => r.json())
                ]);

                vp.innerHTML = `
                    <div style="margin-bottom:60px; text-align:center;">
                        <h1 style="font-size:4rem; margin:0; font-family:'Amiri';">${ar.data.name}</h1>
                        <p style="color:var(--p); font-family:'Fira Code'; text-transform:uppercase;">${ar.data.englishName} | ${ar.data.revelationType}</p>
                    </div>
                    <div id="reader-grid">
                        ${ar.data.ayahs.map((v, i) => `
                            <div class="ayah-card" id="a-${v.numberInSurah}">
                                <div class="ar">${v.text}</div>
                                <div class="en-container">
                                    <div class="en-ver"><b>SAHIH</b> ${en1.data.ayahs[i].text}</div>
                                    <div class="en-ver" style="opacity:0.6;"><b>YUSUF</b> ${en2.data.ayahs[i].text}</div>
                                </div>
                                <div style="margin-top:20px; display:flex; gap:10px;">
                                    <button class="nav-btn" onclick="App.audio.play('${v.number}', '${id}:${v.numberInSurah}')"><i data-lucide="play" style="width:14px"></i></button>
                                    <button class="nav-btn" onclick="App.user.toggleHifz('${id}:${v.numberInSurah}')"><i data-lucide="check-circle" style="width:14px"></i></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
                lucide.createIcons();
                this.user.refreshHifz(id);
            },

            ui: {
                drawDirectory(list) {
                    const vp = document.getElementById('view-port');
                    vp.innerHTML = `<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:25px;">
                        ${list.map(s => `
                            <div class="ayah-card" style="margin:0; cursor:pointer;" onclick="App.router.push(${s.number}); App.loadSurah(${s.number})">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <span class="tag">ID_${s.number}</span>
                                    <span style="font-family:'Amiri'; font-size:1.5rem; color:var(--p);">${s.name}</span>
                                </div>
                                <div style="font-weight:800; font-size:1.3rem; margin:15px 0;">${s.englishName}</div>
                                <div style="font-size:0.7rem; color:#64748b;">${s.numberOfAyahs} AYHS | ${s.revelationType}</div>
                            </div>
                        `).join('')}
                    </div>`;
                },
                handleScroll() {
                    const vp = document.getElementById('view-port');
                    const pct = (vp.scrollTop / (vp.scrollHeight - vp.offsetHeight)) * 100;
                    document.getElementById('scroll-progress').style.width = pct + '%';
                    
                    // Daily Goal Logic
                    if(pct > 95 && !this.goalTracked) {
                        App.state.readCount++;
                        App.user.updateGoalUI();
                        this.goalTracked = true;
                    }
                },
                masterSearch(q) {
                    if(!q) return this.drawDirectory(App.state.chapters);
                    const filtered = App.state.chapters.filter(c => 
                        c.englishName.toLowerCase().includes(q.toLowerCase()) || c.number == q
                    );
                    this.drawDirectory(filtered);
                }
            },

            audio: {
                play(globalId, coord) {
                    const player = document.getElementById('global-audio');
                    const hud = document.getElementById('audio-hud');
                    document.getElementById('ayah-coord').innerText = coord;
                    hud.style.display = 'flex';
                    player.src = `https://cdn.islamic.network/quran/audio/128/${App.state.reciter}/${globalId}.mp3`;
                    player.play();
                },
                showHUD() { document.getElementById('audio-hud').style.display = 'flex'; },
                setSpeed(s) { document.getElementById('global-audio').playbackRate = s; }
            },

            user: {
                async toggleHifz(id) {
                    const exists = await db.userdata.get(id);
                    if(exists) await db.userdata.delete(id);
                    else await db.userdata.put({id, status: 'memorized'});
                    document.getElementById(`a-${id.split(':')[1]}`).classList.toggle('memorized');
                },
                async refreshHifz(surahId) {
                    const all = await db.userdata.toArray();
                    all.forEach(d => {
                        if(d.id.startsWith(surahId + ':')) 
                            document.getElementById(`a-${d.id.split(':')[1]}`)?.classList.add('memorized');
                    });
                },
                updateGoalUI() {
                    const pct = Math.min((App.state.readCount / App.state.dailyGoal) * 100, 100);
                    document.getElementById('goal-ring').style.borderTopColor = 'var(--p)';
                    document.getElementById('goal-ring').innerText = Math.floor(pct) + '%';
                },
                loadGoal() { /* Logic to persist reading goals */ }
            },

            themes: {
                apply(n) {
                    document.body.classList.remove('theme-bloodline','theme-gold','theme-forest');
                    if(n !== 'singularity') document.body.classList.add(`theme-${n}`);
                    App.state.theme = n; localStorage.setItem('gm-theme', n);
                },
                cycle() {
                    const l = ['singularity','bloodline','gold','forest'];
                    this.apply(l[(l.indexOf(App.state.theme)+1)%l.length]);
                }
            },

            cli: {
                toggle() { const el = document.getElementById('cli-layer'); el.style.display = (el.style.display==='flex')?'none':'flex'; if(el.style.display==='flex') document.getElementById('cli-input').focus(); },
                init() {
                    document.getElementById('cli-input').onkeydown = (e) => {
                        if(e.key==='Enter') {
                            const v = e.target.value.toLowerCase().trim();
                            if(v.startsWith('goto ')) App.loadSurah(v.split(' ')[1]);
                            if(v.startsWith('theme ')) App.themes.apply(v.split(' ')[1]);
                            this.toggle(); e.target.value='';
                        }
                    }
                }
            },

            zen: {
                start() {
                    let s = Date.now();
                    setInterval(() => {
                        let d = new Date(Date.now() - s);
                        document.getElementById('zen-timer').innerText = `[ ${d.toISOString().substr(11, 8)} ]`;
                    }, 1000);
                }
            },

            sys: {
                async toggleWakeLock() {
                    if(App.state.wakeLock) { App.state.wakeLock.release(); App.state.wakeLock=null; document.getElementById('wake-btn').style.color=''; }
                    else { App.state.wakeLock = await navigator.wakeLock.request('screen'); document.getElementById('wake-btn').style.color='var(--p)'; }
                }
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
