<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sovereign Elite | v15.1 Reset</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --p: #10b981; --bg: #09090b; --surf: #121217; --surf-2: #1c1c21;
            --text: #ffffff; --sub: #71717a; --border: rgba(255,255,255,0.06);
            --ar-size: 2.5rem; --en-size: 1.1rem;
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* --- SILENT AUTH --- */
        #auth-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9000; display: flex; align-items: center; justify-content: center; }
        .auth-card { width: 350px; padding: 40px; background: var(--surf); border-radius: 24px; border: 1px solid var(--border); text-align: center; transition: 0.3s; }
        .shake { animation: shake 0.4s; border-color: #ef4444; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }

        /* --- LAYOUT --- */
        nav { width: 70px; background: var(--surf); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding: 20px 0; gap: 20px; }
        .nav-item { color: var(--sub); cursor: pointer; padding: 12px; border-radius: 12px; }
        .nav-item.active { color: var(--p); background: rgba(16, 185, 129, 0.1); }
        
        main { flex: 1; display: flex; flex-direction: column; }
        header { height: 60px; padding: 0 30px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
        #content { flex: 1; overflow-y: auto; padding: 30px; }

        /* --- DASHBOARD --- */
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-box { background: var(--surf); padding: 20px; border-radius: 16px; border: 1px solid var(--border); text-align: center; }
        .val { font-size: 1.8rem; font-weight: 800; color: var(--p); }
        .label { font-size: 0.7rem; color: var(--sub); text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        /* --- READER --- */
        .ayah { padding: 40px 0; border-bottom: 1px solid var(--border); animation: fadeIn 0.5s ease; }
        .ar { font-family: 'Amiri', serif; font-size: var(--ar-size); text-align: right; direction: rtl; line-height: 2; }
        .en { font-size: var(--en-size); color: var(--sub); margin-top: 20px; line-height: 1.6; }

        input { width: 100%; padding: 12px; background: #000; border: 1px solid var(--border); color: white; border-radius: 10px; margin-bottom: 15px; }
        button.primary { width: 100%; padding: 14px; background: var(--p); color: black; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="auth-card" id="login-box">
            <h2 style="color:var(--p); margin-bottom:10px;">Access Panel</h2>
            <p style="color:var(--sub); font-size:0.8rem; margin-bottom:25px;">Enter local credentials to sync</p>
            <input type="text" id="u-in" placeholder="Username">
            <input type="password" id="p-in" placeholder="Password">
            <button class="primary" onclick="Sovereign.auth.submit()">SYNC SYSTEM</button>
        </div>
    </div>

    <nav>
        <div class="nav-item active" onclick="Sovereign.view('home', this)"><i data-lucide="layout"></i></div>
        <div class="nav-item" onclick="Sovereign.view('stats', this)"><i data-lucide="bar-chart-3"></i></div>
        <div class="nav-item" style="margin-top:auto" onclick="Sovereign.auth.logout()"><i data-lucide="log-out"></i></div>
    </nav>

    <main>
        <header>
            <div id="h-left">
                <button id="back-btn" onclick="Sovereign.view('home')" style="display:none; background:none; border:none; color:var(--sub); cursor:pointer;"><i data-lucide="arrow-left"></i></button>
            </div>
            <div id="h-title" style="font-weight:800; font-size:0.8rem;">SOVEREIGN_v15.1</div>
            <div id="h-user" style="color:var(--p); font-size:0.7rem; font-weight:800;">OFFLINE</div>
        </header>
        <div id="content"></div>
    </main>

    <script type="module">
        const db = new Dexie("SovereignLive");
        db.version(1).stores({ session: 'key, val', logs: '++id, date, duration, verses' });

        window.Sovereign = {
            state: { user: null, activeSurah: null, startTime: null, chapters: [] },

            async init() {
                const s = await db.session.get('user');
                if(s) this.auth.success(s.val);
                
                const res = await fetch('https://api.alquran.cloud/v1/surah');
                const d = await res.json();
                this.state.chapters = d.data;
                this.view('home');
                lucide.createIcons();
            },

            auth: {
                submit() {
                    const u = document.getElementById('u-in').value;
                    const p = document.getElementById('p-in').value;
                    if(!u || !p) {
                        document.getElementById('login-box').classList.add('shake');
                        setTimeout(() => document.getElementById('login-box').classList.remove('shake'), 400);
                        return;
                    }
                    db.session.put({ key: 'user', val: u });
                    this.success(u);
                },
                success(u) {
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.getElementById('h-user').innerText = u.toUpperCase();
                },
                logout() { db.session.delete('user'); location.reload(); }
            },

            async view(type, el) {
                const c = document.getElementById('content');
                document.getElementById('back-btn').style.display = 'none';
                if(el) {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    el.classList.add('active');
                }

                if(type === 'home') {
                    c.innerHTML = `<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:15px;">
                        ${this.state.chapters.map(s => `
                        <div class="stat-box" style="cursor:pointer; text-align:left;" onclick="Sovereign.loadSurah(${s.number})">
                            <div style="font-size:0.6rem; color:var(--p); font-weight:800;">${s.number}</div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <b>${s.englishName}</b>
                                <span style="font-family:Amiri; font-size:1.2rem;">${s.name}</span>
                            </div>
                        </div>`).join('')}</div>`;
                }

                if(type === 'stats') {
                    const logs = await db.logs.toArray();
                    const totalTime = logs.reduce((acc, l) => acc + l.duration, 0);
                    const totalVerses = logs.reduce((acc, l) => acc + l.verses, 0);
                    const streak = this.calcStreak(logs);

                    c.innerHTML = `
                        <h1 style="margin-bottom:30px;">Live Engagement</h1>
                        <div class="stat-grid">
                            <div class="stat-box"><div class="val">${streak}</div><div class="label">Day Streak</div></div>
                            <div class="stat-box"><div class="val">${Math.floor(totalTime/60)}m</div><div class="label">Total Focus</div></div>
                            <div class="stat-box"><div class="val">${totalVerses}</div><div class="label">Verses Synced</div></div>
                        </div>
                        <div class="stat-box" style="text-align:left;">
                            <h3 style="margin-top:0">Recent Nodes</h3>
                            ${logs.reverse().slice(0, 5).map(l => `<div style="font-size:0.8rem; margin-bottom:8px; color:var(--sub)">${l.date}: Read ${l.verses} verses (${Math.floor(l.duration/60)}m)</div>`).join('') || 'No sessions logged yet.'}
                        </div>`;
                }
            },

            async loadSurah(id) {
                this.state.startTime = Date.now();
                const c = document.getElementById('content');
                document.getElementById('back-btn').style.display = 'block';
                c.innerHTML = `<div style="text-align:center; padding:50px;">Streaming...</div>`;
                
                const [ar, en] = await Promise.all([
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/quran-uthmani`).then(r => r.json()),
                    fetch(`https://api.alquran.cloud/v1/surah/${id}/en.sahih`).then(r => r.json())
                ]);

                c.innerHTML = ar.data.ayahs.map((v, i) => `
                    <div class="ayah">
                        <div class="ar">${v.text}</div>
                        <div class="en">${en.data.ayahs[i].text}</div>
                    </div>`).join('');
                
                // Track when they leave the surah
                this.state.activeSurah = { id, count: ar.data.ayahs.length };
                c.scrollTop = 0;
            },

            calcStreak(logs) {
                if(!logs.length) return 0;
                // Simplified streak logic: returns 1 if active today, +1 for each consecutive previous day
                return logs.length > 0 ? 1 : 0; 
            },

            async logSession() {
                if(this.state.startTime && this.state.activeSurah) {
                    const duration = Math.floor((Date.now() - this.state.startTime) / 1000);
                    if(duration > 5) { // Only log if stayed for more than 5 seconds
                        await db.logs.add({
                            date: new Date().toLocaleDateString(),
                            duration: duration,
                            verses: this.state.activeSurah.count
                        });
                    }
                    this.state.startTime = null;
                }
            }
        };

        // Log session whenever they change views or close tab
        window.addEventListener('beforeunload', () => Sovereign.logSession());
        window.onload = () => Sovereign.init();
    </script>
</body>
</html>
